<h2 id="npm">npm</h2>
<p>　　npm 是 Node.js 的一个包管理器，Web 前端工程师也经常利用它来简化开发流程，看看如何愉快的使用 npm ，并且发布自己的包，让 npm 成为我们的开发利器。</p>
<blockquote>
<p><strong>Node.js：</strong><a href="https://www.npmjs.com/">https://www.npmjs.com/</a> <br />
<strong>npm：</strong><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></p>
</blockquote>
<p>　　npm 通常是伴随着 Node.js 一起安装的，只要安装了 Node.js，那么 npm 也就已经安装好了，可以在命令行运行以下命令查看版本：</p>
<pre><code class="hljs language-bash">node -v
npm -v
</code></pre>
<h2 id="换源">换源</h2>
<p>　　这是作为墙内的开发者必须掌握的一项技能，将 npm 的官方源替换为国内源，这样下载 npm 包速度也会更快，更不容易出错。</p>
<p>　　运行以下命令查看 npm 配置，其中有仓库源 <code>registry</code> 一项：</p>
<pre><code class="hljs language-bash">npm config list
npm config get registry     // 只查看 registry 配置
</code></pre>
<p>　　更换仓库源：</p>
<pre><code class="hljs language-bash">npm config <span class="hljs-built_in">set</span> registry &lt;<span class="hljs-built_in">source</span>&gt;

npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/         // 换回官方源
npm config <span class="hljs-built_in">set</span> registry https://registry.npm.taobao.org/    // 换到国内淘宝源
</code></pre>
<p>　　更换掉仓库源之后，再查看下是否更换成功。</p>
<p>　　<strong>请勿使用 cnpm 等其它类似工具，用官方 npm 换到国内源即可。</strong></p>
<blockquote>
<p>常用源切换工具 <a href="https://www.npmjs.com/package/nrm">nrm</a></p>
</blockquote>
<h2 id="常用命令">常用命令</h2>
<p>　　通常来说，我们只会利用 npm 来安装、卸载依赖包，或者在项目启动时进行初始化。</p>
<pre><code class="hljs language-bash">npm init [-y]   // 在当前文件夹初始化，生成一个 package.json 文件，-y 选项为全部默认

<span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-install</span>
npm install --global|-g &lt;package_name&gt;     // 在全局安装指定包
npm uninstall --global|-g &lt;package_name&gt;   // 卸载安装在全局的指定包

npm install [-P|--save] &lt;package_name&gt;     // 在当前项目本地安装生产环境依赖包，会列在 dependencies 中
npm uninstall [-S|--save] &lt;package_name&gt;   // 卸载安装在项目本地的 dependencies 中指定包

npm install -D|--save-dev &lt;package_name&gt;   // 在当前项目本地安装开发环境依赖包，会列在 devDependencies 中
npm uninstall -D|--save-dev &lt;package_name&gt; // 卸载安装在项目本地的 devDependencies 中指定包
</code></pre>
<p>　　这里值得一提的是，在 npm 5.2+ 之后，附带了一个 <code>npx</code> 命令，作用是<strong>执行包的二进制文件</strong>：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://www.npmjs.com/package/npx</span>
npx [options] [-p|--package &lt;pkg&gt;]... &lt;<span class="hljs-built_in">command</span>&gt; [command-arg]...

npx create-react-app my-app     // 执行 create-react-app 包的主命令
</code></pre>
<p>　　通过 <code>npx</code> 命令执行包的二进制文件有一个优点：<strong>不需要安装包，即可执行包的命令，对本地环境无污染。</strong></p>
<p>　　而且，在 npm 6.0+ 之后，<code>init</code> 命令可以接收一个新的选项：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-init</span>
npm init &lt;initializer&gt;

npm init react-app my-app       // same as : npx create-react-app my-app
</code></pre>
<p>　　其中 <code>&lt;initializer&gt;</code> 是一个以 <code>create-</code> 开头命名的包，算是对这种特殊命名的包的 <code>npx</code> 命令的简写方式。</p>
<h2 id="node-版本管理">Node 版本管理</h2>
<p>　　作为一名 Node.js 开发，如何在自己的设备上管理多个 Node 版本是一个相当重要的技能，而 npm 库中的 <a href="https://www.npmjs.com/package/n"><code>n</code></a> 模块就为我们提供了最佳解决方案，使用它可以在同一台设备上安装多个不同版本的 Node，并随时进行切换，同时也可以方便的升级、降级。</p>
<p>　　作为一个管理 Node 的工具，建议将其安装在全局：</p>
<pre><code class="hljs language-bash">npm install -g n
</code></pre>
<p>　　安装完成后，执行以下命令安装相应版本的 Node：</p>
<pre><code class="hljs language-bash">n &lt;version&gt; // eg: n 10.16.0
n latest    // 安装最新版 node
n lts       // 安装最新的 LTS 版本 node
</code></pre>
<p>　　查看已安装的所有版本的 Node：</p>
<pre><code class="hljs language-bash">n   // 貌似只能查看通过 n 模块安装的 node
</code></pre>
<p>　　切换 node 版本来执行命令：</p>
<pre><code class="hljs language-bash">n use &lt;version&gt; [args ...]    // 切换到已安装的另一个版本的 node 并执行命令
</code></pre>
<p>　　卸载 node：</p>
<pre><code class="hljs language-bash">n <span class="hljs-built_in">rm</span> &lt;version&gt;      // 卸载指定版本 node
n prune             // 卸载所有已安装 node 版本，但当前正在使用的 node 版本不会被卸载
</code></pre>
<blockquote>
<p>Windows 平台用户可以使用 <a href="https://github.com/coreybutler/nvm-windows">nvm-windows</a></p>
</blockquote>
<h2 id="npm-升级">npm 升级</h2>
<p>　　虽然 npm 是随 Node 一起安装的，但在之后通过 <code>n</code> 模块升级 Node 的过程中，npm 不会也跟着升级，需要我们手动升级：</p>
<pre><code class="hljs language-bash">npm install -g npm[@latest|&lt;version&gt;]
</code></pre>
<h2 id="发布-npm-包">发布 npm 包</h2>
<p>　　通常，我们只是下载安装 npm 库中的包来使用，辅助我们进行开发，但去了解如何利用 npm 发布包也是有必要的，这样我们也可以写一些自己的模块并进行发布供自己和他人使用。</p>
<h3 id="注册">注册</h3>
<p>　　首先需要去 npm 官网注册一个账号（无需翻墙）。如果想更换头像的话，还要去注册一个 <strong>Gravatar</strong> 并上传一张照片，才可以将这张照片作为头像。</p>
<blockquote>
<p><strong>npm：</strong><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></p>
</blockquote>
<h3 id="初始化">初始化</h3>
<p>　　在本地新建一个文件夹，并初始化：</p>
<pre><code class="hljs language-bash">npm init [-y]
</code></pre>
<p>　　然后，修改生成的 <code>package.json</code> 中的必要字段，例如 <code>name</code>、<code>author</code>、<code>homepage</code> 等等，具体的字段以及含义可以去查 npm 的官方文档。</p>
<p>　　<strong>这里需要注意的是，如果你将要发布的包，是别人通过 <code>require(&#39;package_name&#39;)</code> 来使用的话，请指定 <code>package.json</code> 中的 <code>main</code> 字段为该包的入口文件。或者，也可能你将要发布的包只是一个命令行工具，那么删除掉 <code>main</code> 字段，指定 <code>bin</code> 字段即可。当然 <code>main</code> 与 <code>bin</code> 是可以共存的。</strong></p>
<h3 id="编码">编码</h3>
<p>　　初始化完成后，就主要是我们编码了，建议将入口文件放在项目根目录下，其余代码文件都放在相应文件夹下：</p>
<pre><code>Package/
  - build/   <span class="hljs-comment">// 编译后用于生产环境的文件</span>
  - config/  <span class="hljs-comment">// 项目开发环境配置文件</span>
  - bin/     <span class="hljs-comment">// 项目命令行脚本文件</span>
  - scripts/ <span class="hljs-comment">// 项目 npm 脚本文件</span>
  - src/     <span class="hljs-comment">// 项目源码文件</span>
  - index.js <span class="hljs-comment">// 项目入口文件</span>
</code></pre>
<p>　　<strong>这里需要注意，<code>bin/</code> 中的命令行脚本文件，必须在每个文件的第一行指定 <code>#!/usr/bin/env node</code>，表明这是一个 node 脚本，以及执行该脚本的二进制文件系统路径。</strong></p>
<h3 id="发布前本地测试">发布前本地测试</h3>
<p>　　在编码完成并完善 <code>package.json</code> 文件后，我们可能需要测试才能确保最终发布后能被自己或者他人通过 npm 安装正常使用。</p>
<p>　　我们不需要反复进行<strong>发布--测试--修复--撤销发布--重新发布</strong>这个过程，npm 官方为我们提供了便捷的本地测试工具，也就是 <code>link</code> 命令。</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-link</span>
npm <span class="hljs-built_in">link</span>    // 在你将要发布的包根目录下执行该命令，如同将其安装到全局一样，更改文件及时生效，不需要重新 <span class="hljs-built_in">link</span>
    
npm <span class="hljs-built_in">link</span> &lt;package_name&gt;     // 在另外一个测试目录中执行该命令，如同 install
    
npm <span class="hljs-built_in">unlink</span>  // 测试完成后，在你将要发布的包根目录下执行该命令，<span class="hljs-built_in">unlink</span> 会将其从全局卸载
</code></pre>
<p>　　本地测试还是相当简单和方便的，也是无污染的。</p>
<h4 id="小技巧">小技巧</h4>
<p>　　这里有个小技巧可以不使用 <code>npm link</code> 命令就能在本地测试，而且是真的无污染：</p>
<pre><code class="hljs language-json"><span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;my-dev-module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;file:../my-dev-module/index.min.js&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="登录">登录</h3>
<p>　　发布前需要在命令行登录 npm <strong>官方仓库</strong>：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-adduser</span>
npm login [--registry=url] [--scope=@orgname]
</code></pre>
<p>　　<strong>注意：如果替换了官方源，一定要指定 <code>--registry=https://registry.npmjs.org/</code>，这样才能登录到官方仓库进行发布。</strong><code>--scope</code>则是命名空间，例如 <code>@babel</code>。</p>
<p>　　登录成功后，可以查看已登录用户：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-whoami</span>
npm <span class="hljs-built_in">whoami</span> [--registry &lt;registry&gt;]
</code></pre>
<h3 id="发布">发布</h3>
<p>　　登录后，即可通过 <code>publish</code> 命令发布包：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-publish</span>
npm publish [--access public]   // 在将要发布的包根目录执行
</code></pre>
<p>　　<strong>需要注意，如果发布的包带有命名空间，例如 <code>@babel/core</code>，需要指定发布限制范围 <code>--access</code>，默认为 <code>restricted</code>（受限制），如你的 npm 帐户不是付费帐户，必须指定为 <code>public</code>。</strong></p>
<h3 id="撤销发布">撤销发布</h3>
<p>　　通常，是在本地测试无误后进行发布，如果真的在发布后发现问题，导致不能正常使用，可以撤销发布：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-unpublish</span>
npm unpublish [&lt;@scope&gt;/]&lt;package_name&gt;[@&lt;version&gt;]
</code></pre>
<p>　　<strong>事实上，npm 官方不建议开发者使用 <code>unpublish</code> 命令来撤销发布，因为如果其它用户已经安装了该包作为依赖，并能正常使用的情况下该包被撤销，会导致其它用户无法再次安装该包。</strong>所以，尽可能用 <code>deprecate</code> 命令来表明该包已被弃用，即便用户安装成功，也会有醒目的提示告知用户已被弃用，用户则会及时寻找替代包。</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-deprecate</span>
npm deprecate &lt;package_name&gt;[@&lt;version&gt;] &lt;message&gt;
</code></pre>
<h3 id="退出登录">退出登录</h3>
<p>　　如果不是在自己的机器上工作，建议完成发布后退出登录，保证数据安全。退出登录与登录一样简单，同样需要指定 <code>--registry</code> 与 <code>--scope</code> 参数。</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># https://docs.npmjs.com/cli/v6/commands/npm-logout</span>
npm <span class="hljs-built_in">logout</span> [--registry=url] [--scope=@orgname]
</code></pre>
<h2 id="最佳实践">最佳实践</h2>
<p>　　以上，是使用 npm 工具本身的过程，但 npm 工具本质上是为维护和发布 Node 模块/包服务的，开发 Node 模块/包有一些很好的社区实践，这里大致记录一下开发 Node 模块/包过程中一些注意的关键点。</p>
<h3 id="模块包的类型">模块/包的类型</h3>
<p>　　根据用途，模块/包的类型大致可以分为以下几种，不同的类型需要做对应的处理。</p>
<ul>
<li>Node 包</li>
<li>Web 包</li>
</ul>
<p>　　Node 包一般来说发布时是不需要压缩的，JavaScript 代码也不需要编译，但需要标记一些特殊字段（如 <code>engines</code>）表明包所依赖的 Node 版本限制。</p>
<pre><code class="hljs language-json"><span class="hljs-comment">// https://docs.npmjs.com/cli/v6/configuring-npm/package-json#engines</span>
<span class="hljs-punctuation">{</span>   
  <span class="hljs-attr">&quot;engines&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;node&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;=0.10.3 &lt;0.12&quot;</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>　　而用于 Web 的包在发布前通常需要进行编译和压缩，目的是解决兼容性问题和资源加载优化，而这些工作一般借助 <strong>Babel</strong>、<strong>Rollup</strong> 等工具配合使用即可。另一方面，用于 Web 的包在开发过程中为了便于调试，所以引入的应该是未经编译和压缩的源码版本，而打包时再引入经过编译和压缩的版本，实现这个目的社区有一个比较通用的做法就是在入口文件使用 <code>NODE_ENV</code> 进行判断并导出相应版本文件，以下是 React 的入口文件示例：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>) { 
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./cjs/react.production.min.js&#x27;</span>); 
} <span class="hljs-keyword">else</span> { 
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./cjs/react.development.js&#x27;</span>); 
} 
</code></pre>
<p>　　通过下面这篇文章即可了解实现细节。</p>
<blockquote>
<p><a href="https://overreacted.io/how-does-the-development-mode-work/">https://overreacted.io/how-does-the-development-mode-work/</a></p>
</blockquote>
<h3 id="支持多个环境">支持多个环境</h3>
<p>　　纵观 Node.js 的发展历史，其生态中出现过多种模式，例如 <a href="https://github.com/amdjs/amdjs-api/blob/master/AMD.md">AMD</a>、<a href="http://www.commonjs.org/">CommonJS</a>、ESM(ECMAScript modules)，以及 <a href="https://github.com/umdjs/umd">UMD</a>，这种情况给包的开发带来一定困难，不过经过多年的发展社区已经形成一个约定（共识），可以很方便的解决该问题从而同时支持所有环境。</p>
<p>　　主要是通过对应字段导出不同的入口文件来实现，下面是一个示例：</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;main&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index.js&quot;</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index.esm.js&quot;</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">&quot;browser&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index.umd.js&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>　　具体实现可以通过下面这篇文章进行了解。</p>
<blockquote>
<p><a href="https://2ality.com/2017/04/setting-up-multi-platform-packages.html">https://2ality.com/2017/04/setting-up-multi-platform-packages.html</a></p>
</blockquote>
<h4 id="新的方案">新的方案</h4>
<p>　　 事实上，<code>main</code> 和 <code>browser</code> 字段在 npm 文档中有定义，查看文档：</p>
<blockquote>
<p><a href="https://docs.npmjs.com/cli/v6/configuring-npm/package-json#main">https://docs.npmjs.com/cli/v6/configuring-npm/package-json#main</a></p>
</blockquote>
<p> 　　而 <code>module</code> 字段后来并没有被 Node 社区采用，而是推出了新的模块入口点定义字段 <code>exports</code>，配合<strong>条件导出</strong>我们就可以实现支持多个环境。查看文档：</p>
<blockquote>
<p><a href="https://nodejs.org/dist/latest-v16.x/docs/api/packages.html#package-entry-points">https://nodejs.org/dist/latest-v16.x/docs/api/packages.html#package-entry-points</a></p>
</blockquote>
<p> 　　示例：</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;exports&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
    <span class="hljs-attr">&quot;import&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./index.esm.js&quot;</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">&quot;require&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./index.cjs.js&quot;</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">&quot;browser&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./index.umd.js&quot;</span> 
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">&quot;main&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./index.cjs.js&quot;</span><span class="hljs-punctuation">,</span> 
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="类型定义">类型定义</h3>
<p>　　JavaScript 并不是一个强类型语言，所以 IDE 要做类型推断和代码智能提示是比较困难的，尤其是编译、压缩、混淆后的代码对于用户使用有诸多不便，要不断的查询文档。然而，<a href="https://www.typescriptlang.org/">TypeScript</a> 的出现使这一状况得到了改善，如果源代码直接使用 TypeScript 编写，最终编译时生成<strong>类型定义文件</strong>，在发布 npm 模块/包时指定一个 <code>types</code> 字段即可，查看文档：</p>
<blockquote>
<p><a href="https://www.typescriptlang.org/docs/handbook/declaration-files/publishing.html">https://www.typescriptlang.org/docs/handbook/declaration-files/publishing.html</a></p>
</blockquote>
<p>　　对于使用 JavaScript 编写的源代码，事实上也可以利用 TypeScript 工具生成相应的类型定义文件，并随之一起发布，查看文档：</p>
<blockquote>
<p><a href="https://www.typescriptlang.org/docs/handbook/declaration-files/dts-from-js.html">https://www.typescriptlang.org/docs/handbook/declaration-files/dts-from-js.html</a></p>
</blockquote>
<p>　　在使用第三方库时，如果作者发布时没有附带类型定义文件，我们则可以去社区维护的 <a href="https://github.com/DefinitelyTyped/DefinitelyTyped">DefinitelyTyped</a> 仓库中看看，使用 npm 命令即可查询：</p>
<pre><code class="hljs language-bash">npm info @types/react
</code></pre>
<h3 id="参考资料">参考资料</h3>
<ul>
<li><a href="https://github.com/sarbbottam/write-an-open-source-js-lib">https://github.com/sarbbottam/write-an-open-source-js-lib</a></li>
<li><a href="https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html">https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html</a></li>
</ul>
