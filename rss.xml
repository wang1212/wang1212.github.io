<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>不如怀念 Blog</title>
        <link>https://wang1212.github.io</link>
        <description>不如怀念 Blog</description>
        <lastBuildDate>Sun, 20 Oct 2024 13:48:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh-Hans</language>
        <item>
            <title><![CDATA[Monorepo 中使用 TypeScript 的问题]]></title>
            <link>https://wang1212.github.io/2024/10/20/computer-technology/typescript/tools-ts-in-monorepo</link>
            <guid>https://wang1212.github.io/2024/10/20/computer-technology/typescript/tools-ts-in-monorepo</guid>
            <pubDate>Sun, 20 Oct 2024 13:48:00 GMT</pubDate>
            <description><![CDATA[在 Monorepo 中使用 TypeScript 时相比于单包仓库要复杂的多，会遇到一系列问题，这里记录一下这些问题的解决方案。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-10-23 01:12:00</em></p>
</blockquote>
<p>在 Monorepo 中使用 TypeScript 时相比于单包仓库要复杂的多，会遇到一系列问题，这里记录一下这些问题的解决方案。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="共享项目配置">共享项目配置<a href="https://wang1212.github.io/2024/10/20/computer-technology/typescript/tools-ts-in-monorepo#%E5%85%B1%E4%BA%AB%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="共享项目配置的直接链接" title="共享项目配置的直接链接">​</a></h2>
<p>为了降低维护成本，通常的做法是在项目根目录创建一个 <strong>tsconfig.base.json</strong> 配置文件作为公共的基础配置，同时在每个子包中再创建一个单独的配置文件并引用基础配置：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// tsconfig.base.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"compilerOptions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"target"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ESNext"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"include"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"src/**/*"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// packages/foo/tsconfig.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"extends"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"../../tsconfig.base.json"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"compilerOptions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"rootDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"src"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"outDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"dist"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// packages/bar/tsconfig.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"extends"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"../../tsconfig.base.json"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"compilerOptions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"rootDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"src"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"outDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"dist"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>很明显，这里没有把 <code>rootDir</code> 和 <code>outDir</code> 配置放到公共的基础配置中去，这是因为<strong>路径相关的配置（相对路径）在解析时行为不可预测，很容易出错</strong>，为了确保正确，必须将其放到各自的子包配置中去。显然，这样维护起来很麻烦。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>终于，TypeScript 官方在 <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-5.html#the-configdir-template-variable-for-configuration-files" target="_blank" rel="noopener noreferrer">5.5 版本发布时支持了 <code>${configDir}</code> 模板变量</a>，这使得路径相关配置更加明确，维护起来也更方便。</p></div></div>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// tsconfig.base.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"compilerOptions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"target"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ESNext"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"rootDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${configDir}/src"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"outDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${configDir}/dist"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"include"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"${configDir}/src/**/*"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="源代码跳转">源代码跳转<a href="https://wang1212.github.io/2024/10/20/computer-technology/typescript/tools-ts-in-monorepo#%E6%BA%90%E4%BB%A3%E7%A0%81%E8%B7%B3%E8%BD%AC" class="hash-link" aria-label="源代码跳转的直接链接" title="源代码跳转的直接链接">​</a></h2>
<p><strong>Monorepo 中的包依赖关系通常较为复杂，在维护过程中阅读源代码时会频繁遇到其它依赖包的代码调用</strong>，直接点击跳转会跳到对应的类型定义文件，这对于我们想直接查看依赖包的源代码来说极为不便。不过，我们可以结合 VSCode 和 TypeScript 编译配置来实现点击直接跳转到依赖包源代码的目的。</p>
<p>首先，需要配置一下 VSCode 中 JavaSCript/TypeScript 的 <code>Prefer Go To Source Definition</code> 配置项。</p>
<p>接下来，再配置一下 TypeScript 的编译配置 <a href="https://www.typescriptlang.org/tsconfig/#declarationMap" target="_blank" rel="noopener noreferrer"><code>declarationMap</code></a> 即可：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">"compilerOptions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"declaration"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"declarationMap"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"declarationDir"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${configDir}/types"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vite-与实时生成类型定义">Vite 与实时生成类型定义<a href="https://wang1212.github.io/2024/10/20/computer-technology/typescript/tools-ts-in-monorepo#vite-%E4%B8%8E%E5%AE%9E%E6%97%B6%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89" class="hash-link" aria-label="Vite 与实时生成类型定义的直接链接" title="Vite 与实时生成类型定义的直接链接">​</a></h2>
<p>现在，我们喜欢在开发模式下使用 Vite 这种 Bundless 模式的构建工具来加速我们的开发工作流，尤其是在 Monorepo 中编写库的使用示例时极为便利。</p>
<p>然而，当我们同时使用 TypeScript 时，<strong>实时构建类型定义文件也很重要，这有助于我们频繁的在多个子包之间修改代码而不会出错</strong>。当子包数量很多时，我们不可能为每个子包目录都启动一个执行 <code>tsc --watch</code> 的进程，这会由于进程太多产生严重的性能问题。</p>
<p>相反，我们可以考虑按需的方式，在 Vite 检测到文件热更新时来实时构建该子包新的类型定义文件，这可以通过一个简单的插件来实现。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> path </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'node:path'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'node:child_process'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildTypesPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'build-types-plugin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@see</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> https://vite.dev/guide/api-plugin.html#handlehotupdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">handleHotUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> file </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> relativePath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">relative</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> packagePath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> relativePath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'packages/'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> relativePath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">packagePath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">exec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">cd </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">packagePath</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> &amp;&amp; npm run build:types</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stderr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> date </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hours </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> date</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHours</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">padStart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> minutes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> date</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMinutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">padStart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> seconds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> date</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">padStart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">\x1b[90m</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">hours</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">minutes</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">seconds</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> [build:types]: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">error</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token string" style="color:#e3116c">'\x1b[0m'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">\x1b[90m</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">hours</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">minutes</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">seconds</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> [build:types] success</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'\x1b[0m'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="相关资料">相关资料<a href="https://wang1212.github.io/2024/10/20/computer-technology/typescript/tools-ts-in-monorepo#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99" class="hash-link" aria-label="相关资料的直接链接" title="相关资料的直接链接">​</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Monorepo" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Monorepo</a></li>
<li><a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-5.html#the-configdir-template-variable-for-configuration-files" target="_blank" rel="noopener noreferrer">https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-5.html#the-configdir-template-variable-for-configuration-files</a></li>
<li><a href="https://github.com/microsoft/TypeScript/issues/57485" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/TypeScript/issues/57485</a></li>
<li><a href="https://www.typescriptlang.org/tsconfig/#declarationMap" target="_blank" rel="noopener noreferrer">https://www.typescriptlang.org/tsconfig/#declarationMap</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>工具</category>
            <category>TypeScript</category>
            <category>Monorepo</category>
            <category>实践案例</category>
        </item>
        <item>
            <title><![CDATA[一次湖北自驾游]]></title>
            <link>https://wang1212.github.io/2024/07/12/life/tourism/tourism-hubei-enshi</link>
            <guid>https://wang1212.github.io/2024/07/12/life/tourism/tourism-hubei-enshi</guid>
            <pubDate>Wed, 17 Jul 2024 21:14:00 GMT</pubDate>
            <description><![CDATA[换工作的间隙有机会来一次自驾游，目的地选择了湖北，恰好有神农架和恩施两个著名旅游城市区域相邻。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-07-20 20:37:00</em></p>
</blockquote>
<p><u>2024-07-12</u>
<br>
<br></p>
<p>换工作的间隙有机会来一次自驾游，目的地选择了湖北，恰好有神农架和恩施两个景点聚集的区域相邻且非常适合自驾游。</p>
<p>恰逢“梅雨季”，全国到处都在下雨，从提前一个月开始计划时就时刻关注着天气，直到临近出发的前几天天气预报依然是雨下个不停，工作后好不容易有这么长的休假时间，难道只能躺在家里了？</p>
<p>时间越来越近，连续从抖音直播上关注着景区的实时天气，情况似乎并没有想象的那么差，一句大家常说的山里的天气说不准给了一定的信心。</p>
<p>自驾的路线选择了先到神农架，再到恩施，再途径安康回到西安，预计总共 6 天时间。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="神农架">神农架<a href="https://wang1212.github.io/2024/07/12/life/tourism/tourism-hubei-enshi#%E7%A5%9E%E5%86%9C%E6%9E%B6" class="hash-link" aria-label="神农架的直接链接" title="神农架的直接链接">​</a></h2>
<p>出行前看了网上攻略，神农架打算就去联票的六大景点，所以第一天计划一大清早出发，大约下午两三点就能到第一个景点天燕，逛完后继续前进晚上就可以在木鱼镇休息。</p>
<p>头一天晚上本打算是早早休息的，结果下午和朋友去吃了个便饭差点误了准备东西的时间，折腾下来休息的时候也到晚上十一点左右了，还准备第二天大早 7 点半就出发呢。这次之所以这么早出发，一方面是因为今天的路程有四五百公里，导航显示得七八个小时，另一方面是前几次都磨蹭到早上九点多出发，导致游玩的时间被严重挤压了。</p>
<p>六点多钟起床洗漱，把东西搬到车上，买了早餐垫了肚子后就出发了，此时刚好七点半。这一次还算顺利，一路上畅通无阻，全程两个人换着开车，本打算中午在比较大的服务区休息一下吃个午饭的，结果大家肚子都不是很饿，中途也因此少耽搁了很多时间。</p>
<p>下午两点半顺利到达天燕景区大门口，简单休息和用餐后，便开车直奔景区内部了。值得一提的是，神农架这几个景点大部分都是可以直接自驾进入景区的，所以游玩起来相对比较省力，时间也不会太紧张。天燕景区最被人所熟知的便是彩虹桥了，自驾大概半小时左右就到达彩虹桥景点了，不过这里不是很好停车。停好车后大概爬了 20 分钟左右才到达了彩虹桥跟前，一路的空气很清新，天气也很好，站在桥上能看见远处山间的云雾不一会便被吹散了，要是后面几天的天气能和今天一样好该多好呢。晃晃悠悠不一会便到下午五点多钟了，由于山路不好走，即便是三四十公里也得行驶一个多小时，也是时候启程继续前进到木鱼镇歇息了。</p>
<p>七点多就到木鱼镇了，这时候有了下雨的迹象，找了家生意比较好的当地菜馆，似乎并不是很合胃口。</p>
<p>比较好的是整个行程不需要走回头路，原计划第二天游玩木鱼镇周边的三个景点，第三天早上游玩大九湖，下午游玩神农顶，傍晚休息在去恩施的途中巴东县，主要是因为从神农顶直接去恩施需要五个多小时车程，还是太赶了。不过，临时决定，如果第二天天气还行，早上就快速逛完木鱼镇周边的三个景点，下午直接去神农顶，晚上休息在大九湖旁的坪阡古镇，第三天下午就有充足的时间开车去恩施了。</p>
<p>第二天七点钟早早的起床在镇子上吃了早餐，自驾去只有五公里远的官门山景点，这里主要是一些动植物生态馆，景区大门映入眼帘的便是大家经常在电视或者网络看到的一只野人拥抱小野人的石头雕塑。景区还是非常大的，我们只在感兴趣的几个景点停留了一下，其中之一便是蜜蜂园，有大量的蜂箱被悬挂在悬崖峭壁之上，场面很壮观，吸引了大量的游客在此拍照打卡，另一个则是比较令人失望的熊猫馆，由于一些原因导致没有看到任何一只大熊猫。</p>
<p>接下来十多分钟的车程就到了神农坛景点，这里也有景区宣传时经常拍的非常壮观的巨大的神农氏雕像，旁边还有一颗千年古树，这个景区并不大，拍照打卡完就可以结束了。今天的天气还算不错，即使下雨也是小雨而已，这会都已经有天晴的迹象了，趁着天气好下午直接安排神农顶。有趣的是，途径了一个非常漂亮的瀑布观景台，这不是一个收费的景点，就只是路边的一个简单的观景平台，可见一路上处处都是美景。</p>
<p>早上最后一个景点是天生桥，据说是很壮观的瀑布，距离也还好，车程二十分钟左右的样子，所以距离都很近的话一早上三个景点刚刚好。驾车进入景点还没停稳便被眼前的瀑布景象震撼了，步行观光路线的入口便是该景点最有名的瀑布了，一下子就能勾起游客的兴趣了。景区步行观光路线大概得半个小时才能走完，后半程基本上就是完全商业化的购物环节了。</p>
<p>十二点刚过，早上三个景点打卡的目标完成，20分钟车程去木鱼镇吃个午饭，抓紧时间去神农顶。午饭是一家重庆菜，算是这两天吃的最好的一顿了。</p>
<p>吃完饭天气看起来还算不错，不过在去景点的途中看到抖音上直播的博主说最高处神农顶上雾特别大，能见度特别差。果不其然，大概两点钟左右到了景区检票口时，景区工作人员还专门提醒了一下山上雾大，到时候注意打开双闪开慢点，这时就有点慌了，不过也只能继续前进了。</p>
<p>神农顶景区的海拔落差是特别大的，从 1000 多米到最高的 3000 多米，第一个景点是小龙潭，不过没有开放，随即便直接去了金猴岭，这里有被称为绿野仙踪的原始森林，一圈下来半个小时左右。然后就是步行到金猴溪了，这里途中也有一个很壮观的金猴飞瀑景色，非常适合打卡，来神农架最不好的就是想看的大熊猫和金丝猴都没有看到。</p>
<p>从金猴岭景点是需要走一段回头路的，接下来去下一个景点神农谷，快要到达的时候海拔突然急速上升，不一会便出现了非常大的雾，能见度特别差，赶紧减缓车速打开灯光谨慎驾驶，到这里其实是有点慌的，本身第一次开山路，因为神农架一路都是 347 国道，路况特别好也就觉得山路也还好，只要天气好的话也没什么，现在大雾再叠加山路还是以安全为主。此时海拔已经 2000 多米了，站在神农谷的观景台其实什么都看不到，周围全是云雾缭绕的，空气倒是很好，负氧离子含量很高。这个时候在地图上查了下接下来几个景点，最近的神农顶在沿路的一个岔路上，海拔要到 3000 多米，打算天气这么差就不去了，到时候看沿途其它景点天气如何再决定要不要停留逛一逛。</p>
<p>从神农谷继续前进，此时还是小雨，但由于大雾天气导致只能以时速二三十公里的速度前进，不一会便路过了去神农顶的岔路口，发现人特别多，遂决定既然来了就去路口停车看看，最后发现神农顶的打卡点就在路口停车区旁边，也算是没有白跑一趟。</p>
<p>不敢逗留太久，害怕天气越来越差，遂继续驾车前进，让人绝望的是海拔一直都在 2000 以上，雨也越来越大，雾也变重了，能见度更差了。缓慢的驾车前行过程中，时不时注意着经过的景点，在板壁岩这块打算停下来看看，这个时候雾大到什么程度，想找卫生间都看不见周围的东西，只能走近一点看看。板壁岩的景色还不错，不需要远眺，步行大概十多分钟就能逛完，这里有去黄山也看过的“飞来石”。</p>
<p>神农顶景区内也就剩下最后一个比较有名的太子娅景点了，走近一看才发现也是原始森林，由于在金猴岭那边已经看过类似的风景了，而且这边人烟稀少，遂决定赶紧下山赶在天黑前到达坪阡古镇。原以为随着下山海拔降低，大雾会消散一些，结果一直到坪阡古镇一路上还是有大雾，算是一次惊险而刺激的山路自驾之行了。</p>
<p>一天打卡完四个景点，给第三天留下了很充裕的时间，当然还在纠结天气不好的话，明天早上还去不去大九湖，毕竟这个景点是不允许自驾的，每个人还得额外买景交车的票且不便宜。</p>
<p>要不说运气还算不错呢，第三天早上起床后竟然没有下雨，既然来了就不要错过六大景点的的任何一个，直奔大九湖而去。大九湖因其高海拔平原上的九个湖泊而闻名，进入景区需要先乘坐四十分钟左右的大巴才能到达开始游玩的地方，虽说还未到达九个湖泊，但这途中亦有不少美景引人入胜。一号湖是人工湖暂未开放，直接从二号湖开始游玩，坐上小火车在接近二号湖时，被这靓丽的风景深深吸引，湖水中天空与山的倒影如一面镜子一样，在二号湖下车后游玩了约半个多小时，还看到了黑天鹅一家三口在湖边游玩，一只小天鹅被它的父母小心的呵护着尽兴的玩耍。</p>
<p>据说只有 2-6 号湖景色不错，从二号湖坐着小火车到三号湖下车后便一直沿着步行道走到了五六号湖，由于途中都是沼泽地所以风景比较一般，这时也下起了雨，遂加快了脚步，一直到五号湖时又天晴了。五六号湖在各自的对面，但五号湖的景色要更胜一筹，在这里拍照打卡的游客也特别的多。</p>
<p>接下来坐着公交车去七八号湖逛了一圈，发现没什么好的景色就没下车，紧接着去了鹿苑喂了梅花鹿，坐着歇息半个小时后就可以坐公交车直接去大巴换乘点了。感到幸运的是，坐到大巴车上时突然下起了大雨，要是再晚几分钟可要被淋成落汤鸡了，自从来了神农架运气一直还不错。</p>
<p>两三天的游玩也有些许劳累，竟在大巴车上睡着了，四十分钟又回到了景区门口，此时已经中午十二点钟了，打算直接驱车去坪阡古镇吃个午饭，下午慢悠悠的赶在晚上就可以到达恩施了。</p>
<p>吃完午饭小雨已经变成了中雨，根据导航显示晚上七点钟就可以到达恩施，随即出发。</p>
<p>坪阡古镇的海拔应该也不低，从坪阡古镇开了大概一个多小时一路上还是有大雾，搞得人还挺紧张的。一路上雨越来越大，途中突然出现了一片区域内的大暴雨，即便是雨刮器开到最高档，也看不清前面的路了，幸好路上的车不算多，雾也慢慢消散了，几分钟后便驶离了这段区域。来时以为山路难开，没想到路况很好，便放下心了，不曾想在神农顶景区内遇到了大雾，让人心里一紧，两天下来也已适应了大雾天气，只要开慢点谨慎驾驶即可，但刚才这段大暴雨的经历真是吓死了，雨滴快速落在前挡风玻璃上直接让驾车的人看不清前方路况和车辆，还是很危险的。</p>
<p>在去恩施的路上也是状况不断，在一个丁字路口突然遭遇堵车，此时雨也非常大，等待了十多分钟后便不想再等了，不然太耽搁时间了，遂选择另一条高速走的少一点但只多半个小时车程的路线，还是省道应该要好开一些，走到前面岔路口才发现原来要走的那条路被封了，因为阴雨天气太危险了。就这样一直到晚上八点才达到恩施的酒店。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="恩施">恩施<a href="https://wang1212.github.io/2024/07/12/life/tourism/tourism-hubei-enshi#%E6%81%A9%E6%96%BD" class="hash-link" aria-label="恩施的直接链接" title="恩施的直接链接">​</a></h2>
<p>由于天气原因，恩施的计划一直确定不下来，一开始是冲着恩施大峡谷来的，结果考虑到天气不好和大峡谷游玩时间太长的原因，便打算更改为地心谷和梭布垭石林两个景点。但从神农架这 3 天的情况来看，天气并没有想象的这么恶劣，而且恩施前两天的天气也还不错，遂决定早上看看天气再说。</p>
<p>恩施的景区距离市区都比较远，车程都在一到两个小时左右，早上起床后发现没有下雨随即决定去大峡谷景区。到达大峡谷景区时已经早上十点多了，景区的人特别的多，超出想象。</p>
<p>恩施大峡谷的体验很不好，在停车场出来后还得走个十多分钟才能到游客中心购票进入景区，检完票已经是十一点多了。据网上的攻略说即便是购买了所有能坐的交通工具，至少也得爬个四五个小时，七星寨三四个小时是肯定的，云龙地缝则需要一两个小时左右。考虑到天气变幻莫测，决定先去最耗时间七星寨，下来后再去云龙地缝，即先上山后下谷。</p>
<p>七星寨一开始是一段索道，剩下的就全是徒步了，一开始会经过著名的“一线天”，然后是一段悬崖峭壁上的步道，最后就可以到最为人们所熟知的“一炷香”景点了，这个景点如果不注意很容易错过，因为在步行过程中它是突然出现在身后的。在“一炷香”逗留打卡拍照后，继续前进的过程不一会就看到一团浓雾袭来，景点能见度瞬间变差，感叹到运气还是一如既往的好，七星寨不虚此行。七星寨全程步行确实需要三个多小时，但实际上在不到两个小时的时候就可以到达“一炷香”景点，后续的一个多小时多少有点无聊，全程雾很大，和神农顶一样站在山顶几乎看不太清周围的群山景象。</p>
<p>从七星寨下山后又回到了坐索道的地方，此时已经下午三点多，在云龙地缝入口处卖饭的地方简单填了填肚子，进入地缝景点。</p>
<p>刚进到云龙地缝的入口处就遭遇了十几分钟的拥堵排队，原因竟然是很多人下去走了十多分钟就原路返回了，要知道云龙地缝景点的步行道基本上是单行道，不走回头路的，让人无语至极，抱着这种心态来游玩不如躺家里，而且还不影响别人。由于云龙地缝因为天气原因只开放了二期，所以不到一个小时就到达了垂梯处，景点也基本游玩结束了。谷底的景色还是很不错的，尤其是最后的瀑布，对于北方人来说应该还是挺震撼的。</p>
<p>乘坐云龙地缝的垂梯到达上面后，可以眺望对面的群山，这就是刚开始爬七星寨一众景点所在的群山，此时下午五点钟左右，天气竟异常的好，远处的群山清晰可见，山间的云雾也已消散，如果先来地缝后上七星寨的话，此时应该站在山顶可以眺望到群山的壮观景色，可山里的天气谁又说的准呢。又是令人绝望的一小时步行才可到达景区入口处，说是不走回头路，好像也不是那么回事。</p>
<p>第四天的恩施大峡谷行程已经结束，原来的计划是恩施需要游玩两天，第五天的下午开始沿安康方向慢悠悠回家，都说恩施大峡谷包含了其它景区的所有景象，再去也就没多大意义了，凭空多出来的一天行程使我们突发奇想去重庆逛一天，毕竟导航显示也就三个多小时而已，此时也才下午五点多钟。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="重庆">重庆<a href="https://wang1212.github.io/2024/07/12/life/tourism/tourism-hubei-enshi#%E9%87%8D%E5%BA%86" class="hash-link" aria-label="重庆的直接链接" title="重庆的直接链接">​</a></h2>
<p>几年前来爬峨眉山时来重庆玩过，但其他人没来过，所以对于我来说属于故地重游了。出来玩的几天终于能睡个懒觉了，今天一直睡到早上九点多才起床，吃饭完已然十点多，计划坐地铁先去山城步道，然后再去十八步梯等等，基本上在渝中区绕一圈的样子，这在我之前来重庆时倒没走过的。</p>
<p>比较搞笑的是，大家半个多小时走完山城步道就已经不行了，这闷热的天气体感实在是不舒服，那不如坐地铁去磁器口吧。</p>
<p>磁器口之前也来过，但在来此地似乎已经不太一样了，也可能是印象太浅的缘故。大家随意逛了逛，买了小吃，尝了冰粉，实在太热还是选择回酒店休息一会，傍晚去洪崖洞和解放碑逛一圈。</p>
<p>傍晚六点多的洪崖洞已经是人群熙熙攘攘，再结合这闷热的天气，实属受罪，而且我们还是从上面进的景区，很多人来洪崖洞不是为了逛，而是为了看夜景，导致我们不得不沿步道从十二楼要下到江边去拍夜景。由于人群过于拥挤，打卡拍照后就没作过多的停留，打算直奔解放步行街，此时已经快到晚上九点钟。</p>
<p>重庆魔幻的地形是一种独特的风景，有时候也是一种烦恼，当我们打算去解放碑时，短短一公里多的距离却让我们犯了难。导航显示需要我们沿一开始从洪崖洞下山的步道原路返回上山，考虑到这么多人实在是不想再去凑这个热闹。于是，我们就沿着江边走，打算另辟蹊径，一路经过多方打听，耗时将近一个小时，终于找到一个还正在施工的停车场，乘坐停车场的电梯上到了十二楼，而这里距离解放碑步行街也就几百米的距离。</p>
<p>解放碑我之前也来过，晚上十点多的步行街人倒不是很多了，地铁也快停运了，简单的逛了逛之后就回酒店了。</p>
<p>重庆的这一天属于比较佛系了，算是这几天以来最轻松的一次行程。</p>
<p>重庆比恩施距离西安还要远，需要九个小时驾车六百多公里才能到达，由于一路路况很好，全程高速，早上十点多出发，下午六点多钟就已经安全到达了，这次自驾之旅圆满结束。</p>
<p>回家后的一周多从新闻了解到陕西南部和四川都发生了很严重的山洪灾害，全国其它地区也多有因天气引发的灾害发生，不由得感慨，要是再晚去几天可能就被困在路上了，这也充分说明了在天气不好的时候要避免驾车出游，尤其是去山区的路，很容易发生安全事故，任何时候都应保证自身安全。</p>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>生活</category>
            <category>旅游</category>
            <category>神农架</category>
            <category>恩施</category>
            <category>重庆</category>
        </item>
        <item>
            <title><![CDATA[解析 Rough.js 图形线填充实现：扫描线算法]]></title>
            <link>https://wang1212.github.io/2024/06/16/computer-technology/computer-graphics/scanline-algorithm</link>
            <guid>https://wang1212.github.io/2024/06/16/computer-technology/computer-graphics/scanline-algorithm</guid>
            <pubDate>Sun, 16 Jun 2024 19:11:00 GMT</pubDate>
            <description><![CDATA[由于比较好奇 Rough.js 的手绘风格是如何实现的，遂准备看看其源码实现，在这个过程中发现了一个依赖项包 hachure-fill，类似铅笔线的图形填充依赖此包实现，其源码比较简洁，从其实现中了解到一个计算机图形学领域的概念-“扫描线算法”。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-06-16 19:11:00</em></p>
</blockquote>
<p>由于比较好奇 <a href="https://roughjs.com/" target="_blank" rel="noopener noreferrer">Rough.js</a> 的手绘风格是如何实现的，遂准备看看其源码实现，在这个过程中发现了一个依赖项包 <a href="https://github.com/pshihn/hachure-fill" target="_blank" rel="noopener noreferrer"><code>hachure-fill</code></a>，类似铅笔线的图形填充依赖此包实现，其源码比较简洁，从其实现中了解到一个计算机图形学领域的概念-“扫描线算法（Scanline Algorithm）”。</p>
<p><img decoding="async" loading="lazy" src="https://roughjs.com/images/cap_demo.png" alt="Rough.js sample" class="img_ev3q"></p>
<p>如上图所示，在一个图形中用线进行填充，而不是某种颜色，为了实现该效果，需要基于该图形计算多条填充线段的坐标数据。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="源码分析">源码分析<a href="https://wang1212.github.io/2024/06/16/computer-technology/computer-graphics/scanline-algorithm#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" class="hash-link" aria-label="源码分析的直接链接" title="源码分析的直接链接">​</a></h2>
<p>首先，从 <code>hachure-fill</code> 简洁的源代码（v0.5.2）实现来进行分析其实现思路。</p>
<p>该库提供了以下 API：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">hachureFill</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">points</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Point</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> angle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Line</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了计算图形内的填充线数据，需要提供该图形的顶点数据 <code>points</code>，同时提供了视觉效果多样化的自定义配置，允许配置填充线的倾斜角度 <code>angle</code> 和间隔距离 <code>gap</code>。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/pshihn/hachure-fill/blob/master/src/hachure.ts#L41</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hachureLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygons</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Polygon </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Polygon</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hachureGap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hachureAngle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hachureStepOffset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Line</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> angle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hachureAngle</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> gap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hachureGap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> polygonList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygons</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> polygons</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> polygons</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'number'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">polygons </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Polygon</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> polygons </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Polygon</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rotationCenter</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Point </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> polygon </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> polygonList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">rotatePoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rotationCenter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> lines </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">straightHachureLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygonList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hachureStepOffset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> polygon </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> polygonList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">rotatePoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rotationCenter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rotateLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rotationCenter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据源码中 <code>hachureLines()</code> 函数的实现逻辑，<strong>其首先对目标图形顶点的数据进行了旋转操作，然后调用 <code>straightHachureLines()</code> 函数计算得到了多条填充线的数据，最后同时将目标图形的顶点和填充线数据又做了同样角度的逆旋转操作。</strong>（为什么要做旋转和逆旋转操作后面会进行解释）</p>
<p>至此，我们可以先直接来看看 <code>straightHachureLines()</code> 函数的实现逻辑。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/pshihn/hachure-fill/blob/master/src/hachure.ts#L62</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">straightHachureLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygons</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Polygon</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hachureStepOffset</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Line</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> vertexArray</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Point</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> polygon </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> polygons</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> vertices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">polygon</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">areSamePoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vertices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vertices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">vertices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      vertices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">vertices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vertices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vertices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vertexArray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vertices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> lines</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Line</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该函数首先对目标图形的顶点数据进行了简单的预处理，将所有多边形的顶点数组提取到 <code>vertexArray</code> 中，并<strong>确保每个多边形的第一个和最后一个点相同</strong>。这样做的原因大概基于两方面考虑：</p>
<ul>
<li>一是确保多边形闭合，如果第一个点和最后一个点不同，那么在后续处理边的时候，就会将最后一条边漏掉，导致结果不完整；</li>
<li>二是处理自相交多边形，自相交多边形是指多边形的边相互交叉的情况，对于这种情况，单个多边形实际上被分割成了多个子多边形，算法可以将自相交多边形视为多个独立的子多边形来处理，从而正确地生成内部线条。</li>
</ul>
<p>接下来则是填充线的完整计算逻辑实现。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/pshihn/hachure-fill/blob/master/src/hachure.ts#L62</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">straightHachureLines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polygons</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Polygon</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hachureStepOffset</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Line</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> lines</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Line</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Create sorted edges table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> edges</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EdgeEntry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> vertices </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> vertexArray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> vertices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> p1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vertices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> p2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vertices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ymin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          ymin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          ymax</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          x</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ymin </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          islope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> p1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymin </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymin </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> e2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Start scanning</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> activeEdges</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ActiveEdgeEntry</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> edges</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymin</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> iteration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edges</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymin </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> removed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">splice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ix </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      removed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> s</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> edge </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activeEdges </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ymax </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ae2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> ae2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ae2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ae2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// fill between the edges</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hachureStepOffset </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> gap </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> nexti </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nexti </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ce </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> activeEdges</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ne </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> activeEdges</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nexti</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          lines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ne</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    y </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> hachureStepOffset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    activeEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ae</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      ae</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ae</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hachureStepOffset </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ae</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">islope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iteration</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据以上源码来看，其大致分为几步：</p>
<ol>
<li><strong>将顶点数据转换为多条边数据 <code>edges</code></strong>；</li>
<li><strong>然后对边进行排序（根据最小 <code>y</code> 坐标）</strong>；</li>
<li><strong>然后从最小的 <code>y</code> 坐标开始向上迭代计算填充线（这个过程中每次迭代都会收集与当前 <code>y</code> 坐标相关的边 <code>activeEdges</code>，同时对其进行排序（按 <code>x</code> 坐标），计算当前 <code>y</code> 坐标水平线与两条边的交点即作为填充线数据）。</strong></li>
</ol>
<p>这里需要注意的是，每次迭代时，活动边 <code>activeEdges</code> 的 <code>x</code> 都会重新赋值一次，利用等比例缩放的原理根据 <code>y</code> 的步进计算得到 <code>x</code> 的步进。</p>
<p>实际上到这里，查询其它相关资料可以了解到，上述步骤是计算机图形学中 <strong>“扫描线算法（Scan-line Algorithm）”</strong> 的大致思路。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="扫描线算法">扫描线算法<a href="https://wang1212.github.io/2024/06/16/computer-technology/computer-graphics/scanline-algorithm#%E6%89%AB%E6%8F%8F%E7%BA%BF%E7%AE%97%E6%B3%95" class="hash-link" aria-label="扫描线算法的直接链接" title="扫描线算法的直接链接">​</a></h2>
<p>根据<a href="https://en.wikipedia.org/wiki/Scanline_rendering" target="_blank" rel="noopener noreferrer">维基百科</a>，扫描线算法实际上是<strong>一种图形渲染技术</strong>，一开始其作为一种高效的图形渲染技术而出现，后被应用到多个不同场景，例如我们这里所说的图形的线填充场景。</p>
<p>该算法的工作原理可以描述为以下几个关键步骤：</p>
<ol>
<li>初始化多边形的边数据表（Edge Table，其中需要计算出每条边的纵坐标极值，横坐标起始点以及斜率倒数 4 个关键值）；</li>
<li>创建活跃边表（Active Edge Table, AET，存储当前扫描线与哪些边相交）；</li>
<li>以所有边中最小的纵坐标初始化扫描线 <code>y=ymin</code>，开始向上迭代 <code>y</code>；</li>
<li>更新活跃边表（收集与当前扫面线相交的所有边）；</li>
<li>根据横坐标 <code>x</code> 对活跃边表中的边进行排序，以确定交点的顺序；</li>
<li>填充多边形，在活跃边表中的边按 <code>x</code> 坐标成对出现，每对之间的区域为多边形内部，绘制水平线进行填充；</li>
<li>根据边的斜率倒数更新活跃边表中边的 <code>x</code> 坐标，为下一行扫描做准备；</li>
<li>重复步骤 4-8 直至所有边被迭代完成。</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Scan-line_algorithm.svg/330px-Scan-line_algorithm.svg.png" alt="Scan-line_algorithm" title="维基百科示例图" class="img_ev3q"></p>
<p>如上图所示，纵坐标最小值为 A 点 <code>y</code> 值，从该位置依次向上迭代计算多条平行线（即 c、b、a 顺序），并在平行线的所有像素点处进行填充。</p>
<p>扫描线算法原理比较简单，可查看<a href="https://www.educative.io/answers/what-is-scanline-fill-algorithm" target="_blank" rel="noopener noreferrer">该文章中的动画示例</a>来更好的理解其过程。另外，该算法实现时要注意一些特殊情况，例如与扫描线平行的边需要忽略掉。</p>
<p>至此，可以解释为何一开始要执行图形顶点数据的旋转和逆旋转操作了，这是为了实现任意角度的填充线，因为经过旋转后在新的坐标系中可以利用扫描线算法进行迭代得到所有的水平填充线，再经过逆旋转操作可以将坐标系恢复最终得到预期角度的填充线数据。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/2024/06/16/computer-technology/computer-graphics/scanline-algorithm#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://github.com/pshihn/hachure-fill" target="_blank" rel="noopener noreferrer">https://github.com/pshihn/hachure-fill</a></li>
<li><a href="https://en.wikipedia.org/wiki/Scanline_rendering" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Scanline_rendering</a></li>
<li><a href="https://www.educative.io/answers/what-is-scanline-fill-algorithm" target="_blank" rel="noopener noreferrer">https://www.educative.io/answers/what-is-scanline-fill-algorithm</a></li>
<li><a href="https://computergraphics.stackexchange.com/questions/5134/why-is-the-scan-line-filling-algorithm-so-seemingly-over-complicated" target="_blank" rel="noopener noreferrer">https://computergraphics.stackexchange.com/questions/5134/why-is-the-scan-line-filling-algorithm-so-seemingly-over-complicated</a></li>
<li><a href="https://www.tutorialspoint.com/computer_graphics/polygon_filling_algorithm.htm" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/computer_graphics/polygon_filling_algorithm.htm</a></li>
<li><a href="https://www.cnblogs.com/larry1024/p/17683177.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/larry1024/p/17683177.html</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>计算机图形学</category>
            <category>数据可视化</category>
            <category>扫描线算法</category>
            <category>源码解析</category>
        </item>
        <item>
            <title><![CDATA[谈谈现阶段对 AI Agent 的理解]]></title>
            <link>https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent</link>
            <guid>https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent</guid>
            <pubDate>Fri, 22 Mar 2024 18:57:00 GMT</pubDate>
            <description><![CDATA[自 OpenAI 2022 年底发布了 ChatGPT 后不久就爆发了 AI 领域的技术热潮，经过一年多的迅速发展和迭代，当前（2024） Agent 已被认为是未来 AI 应用的主流形态。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-03-22 18:57:00</em></p>
</blockquote>
<p>自 OpenAI 2022 年底发布了 ChatGPT 后不久就爆发了 AI 领域的技术热潮，经过一年多的迅速发展和迭代，当前（2024） Agent 已被认为是未来 AI 应用的主流形态。</p>
<p>AI 技术在业务场景（产品）中顺利落地，需要工程侧和机器学习领域技术人员的共同配合，作为工程侧技术开发，理解 Agent 技术架构目前来看很有必要。结合去年在业务中利用 LLMs 技术做的一些 AIGC 业务场景探索的经验，以及对现有的 Agent 技术相关的资料的了解，简单谈谈现阶段对 AI Agent 技术的理解。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-ai-agent">什么是 AI Agent？<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E4%BB%80%E4%B9%88%E6%98%AF-ai-agent" class="hash-link" aria-label="什么是 AI Agent？的直接链接" title="什么是 AI Agent？的直接链接">​</a></h2>
<p>不管是查看维基百科还是一些学术论文或者技术博客，可以了解到 AI Agent（中文译为智能体）不是一个新的概念，已经出现了相当久。简单的来说，AI Agent 指的是能够<strong>自主感知环境</strong>、并<strong>采取行动</strong>实现目标的智能实体。</p>
<p>根据资料来看，AI Agent 具备一些关键能力：<strong>感知、学习、推理、行动（Sense, learn, reason, act）</strong>。这些其实也是利用 Agent 技术架构解决问题的关键所在。</p>
<p>现有类 ChatGPT 的产品（Claude、Gemini 等）已经被我们广泛的使用，能解决很多文本领域相关的问题，交互形式主要是单轮对话（简单问题）和多轮对话（较复杂问题）。鉴于很多客观原因，其存在一定局限性，因此这类产品目前还难以解决复杂问题、专业领域问题。原因有很多，例如当前大多数大语言模型（LLMs）属于静态模型，无法了解最新的知识，上下文 Token 限制（随着技术迭代已经被缓解）致使涉及到长文本的任务不能被很好的完成，通用模型不了解一些专业领域的知识等等。</p>
<p>那么，为了让 AI 技术能真正落地具备实用性，AI Agent 事实上是<strong>一种解决复杂问题、专业问题的系统性方案</strong>，一种基于 AI 模型构建应用的新范式。而且，现在的大多数 AI Agent 更多是基于大语言模型的 LLMs Agent，因为大语言模型展现出的优秀的自然语言处理（NLP）能力为未来产品应用的人性化交互设计奠定了坚实的基础。</p>
<p>目前业内对 AI Agent 技术架构的简单定义如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="agent-simple-architecture" src="https://wang1212.github.io/assets/images/agent-simple-architecture-4a441227d4d784b8ba2ea5804e7421c3.jpg" width="1131" height="766" class="img_ev3q"></p>
<p>其具备四个关键组件：<strong>代理模型（Agent Model）、工具（Tools）、外部存储（Memory）、规划器（Planner）</strong>。这里仅说明 AI Agent 的核心架构，不再具体去阐述这几部分的作用和具体实现，一方面是目前的技术还在迭代，变化很快，另一方面现有的其它资料针对这些内容有更详细、准确的解释。</p>
<p>让我们换个角度，看看从 ChatGPT 发布至今，大家利用 AI 技术解决问题路径的演变过程，将有助于我们更好地理解这些组件的必要性。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ai-技术的演变">AI 技术的演变<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#ai-%E6%8A%80%E6%9C%AF%E7%9A%84%E6%BC%94%E5%8F%98" class="hash-link" aria-label="AI 技术的演变的直接链接" title="AI 技术的演变的直接链接">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="提示词工程">提示词工程<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B" class="hash-link" aria-label="提示词工程的直接链接" title="提示词工程的直接链接">​</a></h3>
<p>一开始，ChatGPT 以聊天应用的形式发布，大家都在探讨如何仅通过简单的对话来更好的解决问题，提示词工程（Prompt Engineering）则成为了这一阶段的主角。在此期间，出现了很多非常有用的方案，例如思维链（CoT，Chain of Thought）、思维树（Tree  of Thoughts）等等，这些都是值得去深入了解学习的。</p>
<p>实际上，<strong>提示词工程</strong>技术应该是 AI Agent 技术的关键所在，与模型交互的过程需要设计提示词以得到更符合预期的输出。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="检索增强生成">检索增强生成<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90" class="hash-link" aria-label="检索增强生成的直接链接" title="检索增强生成的直接链接">​</a></h3>
<p>为了解决大语言模型无法了解新知识（专业领域知识）的问题，<strong>检索增强生成（Retrieval Augmented Generation, RAG）</strong> 技术因为低成本优势成为了最佳方案，核心思路是为大模型构建一个外部的知识数据库，而该知识库可以以极低的成本进行维护和高频更新。存储外部知识文档资料的数据库为向量数据库（Vector database），提供了比传统的文本检索（基于关键字匹配）技术更高效、准确的向量搜索（Vector search）方案。</p>
<p>这也是 AI Agent 架构需要<strong>外部存储组件</strong>的部分原因，<strong>向量数据库、向量搜索，以及嵌入（Embedding）技术</strong>是我们需要了解学习的新技术领域。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="浏览器自动化">浏览器自动化<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%87%AA%E5%8A%A8%E5%8C%96" class="hash-link" aria-label="浏览器自动化的直接链接" title="浏览器自动化的直接链接">​</a></h3>
<p>AI 技术热潮的再一次爆发，让人们又看到了通用人工智能（Artificial General Intelligence, AGI）的可能性，很多用户自发的在探索当前 AI 技术能力的边界。这一阶段，出现了一些利用浏览器自动化工具结合大语言模型完成需要人类介入才能完成的任务，例如人们经常检索信息的操作，打开谷歌搜索、输入查询关键字、上下滚动查看检索结果条目、点击某项结果查看更详细信息等等，更甚的还有在线购物场景案例，打开购物网站、查找商品、加入购物车等等。</p>
<p>以上的案例的思路都是仅利用大语言模型以自然语言的方式进行交互，并将模型输出转换为 GUI 自动化工具的输入来模拟人类交互以完成复杂任务。实际上，GUI 自动化工具在软件测试场景有所应用，考虑到其适用的平台及其它一些限制性因素，这并不算是一个完美的方案。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="webgpt">WebGPT<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#webgpt" class="hash-link" aria-label="WebGPT的直接链接" title="WebGPT的直接链接">​</a></h3>
<p>经过一年多时间的发展，ChatGPT 及其同类产品已经在背后做了大量优化，其中通过<strong>接入外部搜索引擎</strong>来解决大语言模型无法了解现实世界最新知识问题的方案已被广泛应用。这一方案正是 OpenAI 在 2022 年发表的有关 WebGPT 的论文中所探讨的内容。</p>
<p>这一阶段，实际上证明了大语言模型可以<strong>通过调用外部工具来完成任务</strong>的技术路径的可行性，也是目前 AI Agent 技术的核心思路。像 OpenAI 发布的 JSON 响应模式、函数调用（Function Call）功能都是大语言模型与外部工具进行交互的典型方案，值得一提的还有 Google 研究团队发布的 ReAct 范式，为大语言模型解决问题提供了新的思路，展示了其规划、推理、行动和根据结果迭代调整的路径模式。</p>
<p>基于以上内容的了解，随着大语言模型的更新和不断出现的新提示词范式，基础模型具备了将大任务拆分为小任务的规划能力，借助外部存储和调用外部工具来解决一些复杂问题已经具备可行性，而这正是 AI Agent 技术架构中几个关键组件的由来。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="案例">案例<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E6%A1%88%E4%BE%8B" class="hash-link" aria-label="案例的直接链接" title="案例的直接链接">​</a></h2>
<p>截至目前，业内都在大力跟进 AI Agent 技术的发展，目前还远未到技术收敛的时候，因此如何利用 AI Agent 很好地解决复杂系统问题还处于工程化实践探索的阶段。不过，可以通过一些案例了解一下业内的进展情况。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="autogpt">AutoGPT<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#autogpt" class="hash-link" aria-label="AutoGPT的直接链接" title="AutoGPT的直接链接">​</a></h3>
<p>AutoGPT 项目是业内较早实践 AI Agent 理念的，其核心思想在官方文档中也有所描述：</p>
<blockquote>
<p>The concept was (and still is) fairly simple: let an LLM decide what to do over and over, while feeding the results of its actions back into the prompt. This allows the program to iteratively and incrementally work towards its objective.</p>
</blockquote>
<p>简单的来说，就是通过类似多轮对话的方式，让大语言模型一遍又一遍地决定要做什么（这个过程中人类可以参与反馈），同时将其操作的结果反馈到提示中，这使得该程序能够迭代地、逐步地​​实现其目标。AutoGPT 项目架构中，组件（Components）是构成 Agent 的基本模块，而组件中的命令（Commands）定义了如何调用外部工具。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="hugginggpt">HuggingGPT<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#hugginggpt" class="hash-link" aria-label="HuggingGPT的直接链接" title="HuggingGPT的直接链接">​</a></h3>
<p>微软研究团队提出了一种 HuggingGPT 项目架构，其思路是基于大语言模型处理自然语言的优势使其充当中央控制器（规划器），在每一个子步骤中具体解决问题时则调用更适合该任务的其它机器学习模型（例如翻译、图片生成、视频生成模型），这有点类似于大模型领域的 MoEs 架构。</p>
<p><img decoding="async" loading="lazy" alt="HuggingGPT" src="https://wang1212.github.io/assets/images/HuggingGPT-c1be63c7054754ccdd3c880e5a969db6.jpg" width="1238" height="549" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="框架工具">框架工具<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E6%A1%86%E6%9E%B6%E5%B7%A5%E5%85%B7" class="hash-link" aria-label="框架工具的直接链接" title="框架工具的直接链接">​</a></h2>
<p>虽然 AI Agent 的技术架构较为简单，但具体到真实的业务开发中，需要处理大量的细节问题，而框架工具能帮助我们抽象掉底层细节。</p>
<p>先通过一个最简单的工具来理解 AI Agent 的实现思路。Hugging Face 提供了 JavaScript SDK 包，其中一个为 <code>@huggingface/agents</code>，用来实现最简单的 Agent 工具。先来看看怎么使用：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 1. 提出问题：执行生成代码操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> agent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">generateCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"Draw a picture of a rubber duck with a top hat, then caption this picture."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// code generated by the LLM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// async function generate() {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   const output = await textToImage("rubber duck with a top hat");</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   message("We generate the duck picture", output);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   const caption = await imageToText(output);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   message("Now we caption the image", caption);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   return output;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2. 回答问题：执行上一步生成的代码，并得到最终结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> messages</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Update</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> agent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">evaluateCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Update</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 结果可能是文本、文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Blob</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该项目的思路是生成代码片段，并通过执行这段代码调用外部工具得到最终结果，<strong>中间产物是代码片段</strong>。而这些代码片段实际上就是定义的外部工具的接口，来看看如何定义一个工具：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> englishToGermanTool</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Tool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"englishToGerman"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"Takes an input string in english and returns a german translation. "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  examples</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prompt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"translate the string 'hello world' to german"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">const output = englishToGerman("hello world")</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tools</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"englishToGerman"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prompt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"translate the string 'The quick brown fox jumps over the lazy dog` into german"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">const output = englishToGerman("The quick brown fox jumps over the lazy dog")</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tools</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"englishToGerman"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">call</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inference</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"string"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Input must be a string"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> inference</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">translation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      model</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t5-base"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      inputs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">translation_text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意上面高亮的行，是中间产物代码片段的不同案例，代表了调用该工具需要执行的代码，<strong>需要关注的是其中仅参数不同</strong>，<code>call</code> 字段则是该工具具体要执行的逻辑的实现，这里是定义了一个翻译工具，通过调用谷歌的 t5 模型来完成翻译任务。</p>
<p>通过 <code>@huggingface/agents</code> 项目我们可以了解到 AI Agent 技术中实现大语言模型与外部工具交互的方式，当然这种方式不仅只有这一种，接下来看看另一个项目 Vercel AI SDK 中定义外部工具的案例。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generateText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">openai</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'gpt-3.5-turbo'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tools</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    weather</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Get the weather in a location'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      parameters</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        location</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'The location to get the weather for'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function-variable function" style="color:#d73a49">execute</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> location </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        location</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        temperature</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">72</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">floor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prompt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'What is the weather in San Francisco and what attractions should I visit?'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上定义了一个查询地区温度的工具，与 <code>@huggingface/agents</code> 不同的是将 <code>code</code> 字段换成了 <code>parameters</code>，可以想象的是<strong>中间产物由代码片段变成了 JSON 格式参数对象</strong>，这其实比较符合 OpenAI 的函数调用功能设计。</p>
<p>除此之外，还可以了解的是 <strong>AutoGen</strong> 项目，这是微软团队发布的用来构建多代理架构应用的框架，官方文档比较详细，这里不再赘述。</p>
<p>需要额外提及的是，<strong>LangChain</strong> 是社区中主流的开发 AI 应用的开源框架，也提供了 Agent 开发能力。值得注意的是其对 Agent 模型做了分类，例如支持函数调用的 OpenAI 模型、擅长 XML 处理的 Claude 模型、基于结构化数据的简单模型、基于 ReAct 范式的简单模型等等，这意味着<strong>基础模型提供的能力不同，开发 Agent 时要处理的细节也不同</strong>，这是工程化开发中需要关注的。</p>
<p>综上，是现阶段对 AI Agent 的简单理解，主要关注的是其核心架构和技术原理，通过一些业内案例和框架工具了解部分技术实现细节。该领域的技术还在快速发展中，需要继续关注后续发展以更深入的了解产业落地情况和实践中遇到的问题。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/2024/03/22/computer-technology/ai/llm/agent#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Intelligent_agent" target="_blank" rel="noopener noreferrer">Intelligent agent</a></li>
<li><a href="https://aws.amazon.com/what-is/ai-agents/" target="_blank" rel="noopener noreferrer">What are AI Agents?</a></li>
<li><a href="https://www.leewayhertz.com/ai-agents/" target="_blank" rel="noopener noreferrer">Ai agents driving the next wave of digital transformation</a></li>
<li><a href="https://huggingface.co/blog/agents-js" target="_blank" rel="noopener noreferrer">Introducing Agents.js: Give tools to your LLMs using JavaScript</a></li>
<li><a href="https://www.latent.space/p/agents" target="_blank" rel="noopener noreferrer">The Anatomy of Autonomy: Why Agents are the next AI Killer App after ChatGPT</a></li>
<li><a href="https://lilianweng.github.io/posts/2023-06-23-agent/" target="_blank" rel="noopener noreferrer">LLM Powered Autonomous Agents</a></li>
<li><a href="https://www.promptingguide.ai/research/llm-agents" target="_blank" rel="noopener noreferrer">LLM Agents</a></li>
<li><a href="https://arxiv.org/abs/2404.11584v1" target="_blank" rel="noopener noreferrer">The Landscape of Emerging AI Agent Architectures for Reasoning, Planning, and Tool Calling: A Survey</a></li>
<li><a href="https://arxiv.org/html/2404.10981v1" target="_blank" rel="noopener noreferrer">A Survey on Retrieval-Augmented Text Generation for Large Language Models</a></li>
<li><a href="https://www.adept.ai/blog/act-1" target="_blank" rel="noopener noreferrer">ACT-1: Transformer for Actions</a></li>
<li><a href="https://openai.com/index/webgpt/" target="_blank" rel="noopener noreferrer">WebGPT: Improving the factual accuracy of language models through web browsing</a></li>
<li><a href="https://react-lm.github.io/" target="_blank" rel="noopener noreferrer">ReAct: Synergizing Reasoning and Acting in Language Models</a></li>
<li><a href="https://docs.agpt.co/autogpt/" target="_blank" rel="noopener noreferrer">AutoGPT Agent</a></li>
<li><a href="https://ar5iv.labs.arxiv.org/html/2303.17580" target="_blank" rel="noopener noreferrer">HuggingGPT: Solving AI Tasks with ChatGPT and its Friends in Hugging Face</a></li>
<li><a href="https://sdk.vercel.ai/docs/ai-sdk-core/tools-and-tool-calling" target="_blank" rel="noopener noreferrer">Vercel AI SDK: Tools and Tool Calling</a></li>
<li><a href="https://js.langchain.com/docs/modules/agents/agent_types/" target="_blank" rel="noopener noreferrer">LangChain: Agent Types</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>AI</category>
            <category>LLMs</category>
            <category>Agent</category>
        </item>
        <item>
            <title><![CDATA[精选资源：大语言模型（LLMs）]]></title>
            <link>https://wang1212.github.io/2024/03/01/awesome/llm</link>
            <guid>https://wang1212.github.io/2024/03/01/awesome/llm</guid>
            <pubDate>Fri, 01 Mar 2024 14:47:00 GMT</pubDate>
            <description><![CDATA[精选资源集合，有关大语言模型（LLMs）技术的资讯。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-05-11 22:40:00</em></p>
</blockquote>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>精选资源</div><div class="admonitionContent_BuS1"><p>这是一个系列，收集不同领域相关的精选（高价值）内容，包括深入分析文章、视频、工具等。</p><p><em>探索一项新兴技术出现的背景、动机，尤其是其背后的设计哲学，更甚的是在不断的版本演进过程中遇到了什么问题，产生了什么思考，以及是如何决策并得到最优解。</em></p></div></div>
<p>自从 2022 年底 <a href="https://openai.com/blog/chatgpt" target="_blank" rel="noopener noreferrer">OpenAI 发布 ChatGPT</a> 以来，过去的一年（2023）AI 领域再度爆发热潮，这一次<strong>大语言模型（Large Language Model, LLMs）</strong> 技术成为大家关注的核心。了解相关技术，探索其背后的技术原理和工程化技巧，为构建 AI 应用做好准备。</p>
<p>首先，什么是大语言模型（LLMs）？</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>LLM</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Large_language_model" target="_blank" rel="noopener noreferrer">Large language model</a></li>
</ul><p>偏技术性的解释：</p><ul>
<li><a href="https://developers.google.com/machine-learning/resources/intro-llms" target="_blank" rel="noopener noreferrer">Introduction to Large Language Models</a></li>
<li><a href="https://www.nvidia.com/en-us/glossary/large-language-models/" target="_blank" rel="noopener noreferrer">Large Language Models Explained</a></li>
<li><a href="https://www.elastic.co/what-is/large-language-models/" target="_blank" rel="noopener noreferrer">What is a large language model (LLM)?</a></li>
</ul><p>更详细的解释：</p><ul>
<li><a href="https://www.understandingai.org/p/large-language-models-explained-with" target="_blank" rel="noopener noreferrer">Large language models, explained with a minimum of math and jargon</a></li>
</ul></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="提示词工程">提示词工程<a href="https://wang1212.github.io/2024/03/01/awesome/llm#%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B" class="hash-link" aria-label="提示词工程的直接链接" title="提示词工程的直接链接">​</a></h2>
<p>快速上手使用类 ChatGPT 应用需要了解<strong>提示词工程（Prompt Engineering）</strong> 这一概念，通过不断的调整提示词来获得更好更接近预期的结果。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Prompt Engineering</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Prompt_engineering" target="_blank" rel="noopener noreferrer">Prompt engineering</a></li>
</ul><p>学习提示词工程：</p><ul>
<li><a href="https://www.promptingguide.ai/" target="_blank" rel="noopener noreferrer">Prompt Engineering Guide</a></li>
<li><a href="https://developers.google.com/machine-learning/resources/prompt-eng" target="_blank" rel="noopener noreferrer">Prompt Engineering for Generative AI</a>
<ul>
<li><a href="https://services.google.com/fh/files/misc/gemini-for-google-workspace-prompting-guide-101.pdf" target="_blank" rel="noopener noreferrer">Prompting guide 101</a></li>
</ul>
</li>
<li><a href="https://platform.openai.com/docs/guides/prompt-engineering" target="_blank" rel="noopener noreferrer">Prompt engineering</a></li>
</ul><p>社区优秀的提示词模板案例：</p><ul>
<li><a href="https://prompthero.com/" target="_blank" rel="noopener noreferrer">PromptHero</a></li>
</ul></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="机器学习">机器学习<a href="https://wang1212.github.io/2024/03/01/awesome/llm#%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0" class="hash-link" aria-label="机器学习的直接链接" title="机器学习的直接链接">​</a></h2>
<p>大语言模型背后是<strong>机器学习（Machine Learning）</strong> 领域的技术，为了更好的理解其技术原理，需要补充一些前置概念知识。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sota">SOTA<a href="https://wang1212.github.io/2024/03/01/awesome/llm#sota" class="hash-link" aria-label="SOTA的直接链接" title="SOTA的直接链接">​</a></h3>
<p>如何评估一个模型的好坏，State-of-the-Art(SOTA) 模型？</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>SOTA</div><div class="admonitionContent_BuS1"><ul>
<li><a href="https://www.e2enetworks.com/blog/what-is-sota-in-artificial-intelligence" target="_blank" rel="noopener noreferrer">What is SOTA in Artificial Intelligence?</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scaling-law">Scaling Law<a href="https://wang1212.github.io/2024/03/01/awesome/llm#scaling-law" class="hash-link" aria-label="Scaling Law的直接链接" title="Scaling Law的直接链接">​</a></h3>
<p>Scaling Law 是基于模型训练方面的实践经验的总结，代表<strong>损失（模型性能）与模型参数数量、数据集大小和用于训练的计算量呈幂律（power-law）关系</strong>，为大模型的设计和训练提供了理论指导。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Scaling Law</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Neural_scaling_law" target="_blank" rel="noopener noreferrer">Neural scaling law</a></li>
</ul><p>业界论文：</p><ul>
<li><a href="https://arxiv.org/abs/2001.08361" target="_blank" rel="noopener noreferrer">Scaling Laws for Neural Language Models</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="embeddings">Embeddings<a href="https://wang1212.github.io/2024/03/01/awesome/llm#embeddings" class="hash-link" aria-label="Embeddings的直接链接" title="Embeddings的直接链接">​</a></h3>
<p>机器通过<strong>嵌入（Embeddings）</strong> 技术来理解高维数据，例如文本、图像、音频、视频等等。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Embeddings</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Word_embedding" target="_blank" rel="noopener noreferrer">Word embedding</a></li>
</ul><p>偏技术性的解释：</p><ul>
<li><a href="https://aws.amazon.com/what-is/embeddings-in-machine-learning/" target="_blank" rel="noopener noreferrer">What Are Embeddings In Machine Learning?</a></li>
<li><a href="https://developers.google.com/machine-learning/crash-course/embeddings/video-lecture" target="_blank" rel="noopener noreferrer">Embeddings</a></li>
</ul><p>试一试：</p><ul>
<li><a href="https://huggingface.co/blog/getting-started-with-embeddings" target="_blank" rel="noopener noreferrer">Getting Started With Embeddings</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="transformer">Transformer<a href="https://wang1212.github.io/2024/03/01/awesome/llm#transformer" class="hash-link" aria-label="Transformer的直接链接" title="Transformer的直接链接">​</a></h3>
<p>目前，大语言模型基本上都属于 Transformer 模型，而 <strong>Transformer 是一种基于注意力机制的神经网络（neural network）架构</strong>，它在自然语言处理（NLP）任务中表现出色。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Transformer</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Transformer_(deep_learning_architecture)" target="_blank" rel="noopener noreferrer">Transformer (deep learning architecture)</a></li>
</ul><p>更好理解一点的解释：</p><ul>
<li><a href="https://blogs.nvidia.com/blog/what-is-a-transformer-model/" target="_blank" rel="noopener noreferrer">What Is a Transformer Model?</a></li>
<li><a href="https://ig.ft.com/generative-ai/" target="_blank" rel="noopener noreferrer">Generative AI exists because of the transformer</a></li>
</ul><p>偏技术性的解释：</p><ul>
<li><a href="https://huggingface.co/blog/andmholm/what-is-a-transformer" target="_blank" rel="noopener noreferrer">What is a Transformer?</a></li>
</ul><p>业界论文：</p><ul>
<li><a href="https://arxiv.org/abs/1706.03762" target="_blank" rel="noopener noreferrer">Attention Is All You Need</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="fine-tune">Fine-tune<a href="https://wang1212.github.io/2024/03/01/awesome/llm#fine-tune" class="hash-link" aria-label="Fine-tune的直接链接" title="Fine-tune的直接链接">​</a></h3>
<p>大语言模型通常都是基于大量的数据集进行训练的预训练模型（Pre-trained models），出于保证合规的目的，为了过滤掉一些有害信息，通常都会对模型做进一步微调（fine-tune），以让其生成更符合预期的结果。同时，<strong>微调是基于通用模型训练专有模型的重要方式</strong>。</p>
<p>微调的技术有很多，列举一些比较常见的。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sft">SFT<a href="https://wang1212.github.io/2024/03/01/awesome/llm#sft" class="hash-link" aria-label="SFT的直接链接" title="SFT的直接链接">​</a></h4>
<p>通常，语言模型的初始训练是无监督的，但微调是有监督的。<strong>有监督微调（Supervised fine-tuning）意味着使用标记数据更新预先训练的语言模型来完成特定任务</strong>，所使用的数据已提前检查过。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>SFT</div><div class="admonitionContent_BuS1"><ul>
<li><a href="https://klu.ai/glossary/supervised-fine-tuning" target="_blank" rel="noopener noreferrer">What is supervised fine-tuning?</a></li>
<li><a href="https://www.superannotate.com/blog/llm-fine-tuning" target="_blank" rel="noopener noreferrer">Fine-tuning large language models (LLMs) in 2024</a></li>
<li><a href="https://www.run.ai/guides/generative-ai/lora-fine-tuning" target="_blank" rel="noopener noreferrer">Understanding LLM Fine Tuning with LoRA</a></li>
</ul><p>偏技术性的：</p><ul>
<li><a href="https://huggingface.co/blog/peft" target="_blank" rel="noopener noreferrer">PEFT: Parameter-Efficient Fine-Tuning of Billion-Scale Models on Low-Resource Hardware</a></li>
</ul><p>一种特殊的微调技术，<strong>指令调优（Instruction Tuning）</strong>：</p><ul>
<li><a href="https://www.ibm.com/topics/instruction-tuning" target="_blank" rel="noopener noreferrer">What is instruction tuning?</a></li>
</ul><p>业界论文：</p><ul>
<li><a href="https://arxiv.org/abs/2106.09685" target="_blank" rel="noopener noreferrer">LoRA: Low-Rank Adaptation of Large Language Models</a></li>
<li><a href="https://arxiv.org/abs/2308.10792v5" target="_blank" rel="noopener noreferrer">Instruction Tuning for Large Language Models: A Survey</a></li>
</ul></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rlhf">RLHF<a href="https://wang1212.github.io/2024/03/01/awesome/llm#rlhf" class="hash-link" aria-label="RLHF的直接链接" title="RLHF的直接链接">​</a></h4>
<p>通过训练奖励模型（reward model），以<strong>强化学习（Reinforcement Learning）</strong> 的方式对语言模型做进一步的微调是 ChatGPT 获得成功的重要因素。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>RLHF</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Reinforcement_learning_from_human_feedback" target="_blank" rel="noopener noreferrer">Reinforcement learning from human feedback</a></li>
</ul><p>偏技术性的解释：</p><ul>
<li><a href="https://huggingface.co/blog/rlhf" target="_blank" rel="noopener noreferrer">Illustrating Reinforcement Learning from Human Feedback (RLHF)</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="moes">MoEs<a href="https://wang1212.github.io/2024/03/01/awesome/llm#moes" class="hash-link" aria-label="MoEs的直接链接" title="MoEs的直接链接">​</a></h3>
<p>大部分大语言模型都属于密集模型（dense models），参数量级越大计算（推理）成本越高，速度越慢，消耗的硬件内存也更大，为了应对这类问题，出现了一种新的模型架构，即<strong>混合专家（Mixture of Experts, MoEs）架构</strong>。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>MoEs</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Mixture_of_experts" target="_blank" rel="noopener noreferrer">Mixture of experts</a></li>
</ul><p>偏技术性的解释：</p><ul>
<li><a href="https://huggingface.co/blog/moe" target="_blank" rel="noopener noreferrer">Mixture of Experts Explained</a></li>
<li><a href="https://developer.nvidia.com/blog/applying-mixture-of-experts-in-llm-architectures/" target="_blank" rel="noopener noreferrer">Applying Mixture of Experts in LLM Architectures</a></li>
</ul><p>业界论文：</p><ul>
<li><a href="https://arxiv.org/abs/2404.05567" target="_blank" rel="noopener noreferrer">Dense Training, Sparse Inference: Rethinking Training of Mixture-of-Experts Language Models</a></li>
</ul></div></div>
<p>最后，基于以上这些概念，可以了解下 ChatGPT 的工作原理。</p>
<blockquote>
<p><a href="https://www.assemblyai.com/blog/how-chatgpt-actually-works/" target="_blank" rel="noopener noreferrer">How ChatGPT actually works</a></p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="应用技术">应用技术<a href="https://wang1212.github.io/2024/03/01/awesome/llm#%E5%BA%94%E7%94%A8%E6%8A%80%E6%9C%AF" class="hash-link" aria-label="应用技术的直接链接" title="应用技术的直接链接">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rag">RAG<a href="https://wang1212.github.io/2024/03/01/awesome/llm#rag" class="hash-link" aria-label="RAG的直接链接" title="RAG的直��接链接">​</a></h3>
<p><strong>检索增强生成（Retrieval-Augmented Generation, RAG）</strong> 是一种利用从外部来源获取的事实来提高生成式 AI 模型的准确性和可靠性的技术。简单的来说，现有的大语言模型基于静态数据进行预训练，在一些对数据实时性有要求的特定场景中无法获取最新数据信息，通过 RAG 技术则可以弥补这个缺陷，通过引入外部实时数据库的方式来增强大语言模型对实时数据的响应能力。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>RAG</div><div class="admonitionContent_BuS1"><ul>
<li><a href="https://blogs.nvidia.com/blog/what-is-retrieval-augmented-generation/" target="_blank" rel="noopener noreferrer">What Is Retrieval-Augmented Generation, aka RAG?</a></li>
</ul><p>偏技术性的解释：</p><ul>
<li><a href="https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/" target="_blank" rel="noopener noreferrer">Retrieval augmented generation: Keeping LLMs relevant and current</a></li>
</ul><p>业界论文：</p><ul>
<li><a href="https://arxiv.org/abs/2312.10997" target="_blank" rel="noopener noreferrer">Retrieval-Augmented Generation for Large Language Models: A Survey</a></li>
<li><a href="https://arxiv.org/abs/2404.10981v1" target="_blank" rel="noopener noreferrer">A Survey on Retrieval-Augmented Text Generation for Large Language Models</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="agent">Agent<a href="https://wang1212.github.io/2024/03/01/awesome/llm#agent" class="hash-link" aria-label="Agent的直接链接" title="Agent的直接链接">​</a></h3>
<p><strong>人工智能代理（AI Agent）</strong> 是一种构建 AI 应用的架构，相比于仅利用 RAG 技术能更好的解决更具体的问题，也是目前 AI 应用发展的重要趋势。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Agent</div><div class="admonitionContent_BuS1"><p>维基百科：</p><ul>
<li><a href="https://en.wikipedia.org/wiki/Intelligent_agent" target="_blank" rel="noopener noreferrer">Intelligent agent</a></li>
</ul><p>一些更详细的解释：</p><ul>
<li><a href="https://aws.amazon.com/what-is/ai-agents/" target="_blank" rel="noopener noreferrer">What are AI Agents?</a></li>
<li><a href="https://www.leewayhertz.com/ai-agents/" target="_blank" rel="noopener noreferrer">Ai agents driving the next wave of digital transformation</a></li>
</ul><p>偏技术性的：</p><ul>
<li><a href="https://huggingface.co/blog/agents-js" target="_blank" rel="noopener noreferrer">Introducing Agents.js: Give tools to your LLMs using JavaScript</a></li>
<li><a href="https://www.latent.space/p/agents" target="_blank" rel="noopener noreferrer">The Anatomy of Autonomy: Why Agents are the next AI Killer App after ChatGPT</a></li>
<li><a href="https://lilianweng.github.io/posts/2023-06-23-agent/" target="_blank" rel="noopener noreferrer">LLM Powered Autonomous Agents</a></li>
</ul><p>业界论文：</p><ul>
<li><a href="https://arxiv.org/abs/2404.11584v1" target="_blank" rel="noopener noreferrer">The Landscape of Emerging AI Agent Architectures for Reasoning, Planning, and Tool Calling: A Survey</a></li>
</ul></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="开发框架">开发框架<a href="https://wang1212.github.io/2024/03/01/awesome/llm#%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6" class="hash-link" aria-label="开发框架的直接链接" title="开发框架的直接链接">​</a></h3>
<p>一步一步开始构建 AI 应用可能是有趣的，但也是枯燥无聊的，且需要耗费大量时间，已经有大量的相关框架工具为我们抽象了低级别的复杂细节。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>开发框架</div><div class="admonitionContent_BuS1"><ul>
<li><a href="https://www.langchain.com/langchain" target="_blank" rel="noopener noreferrer">LangChain</a></li>
<li><a href="https://haystack.deepset.ai/" target="_blank" rel="noopener noreferrer">Haystack</a></li>
</ul><p>聊天应用：</p><ul>
<li><a href="https://github.com/lobehub/lobe-chat" target="_blank" rel="noopener noreferrer">Lobe Chat</a></li>
<li><a href="https://github.com/mckaywrigley/chatbot-ui" target="_blank" rel="noopener noreferrer">Chatbot UI</a></li>
</ul><p>RAG 应用：</p><ul>
<li><a href="https://www.llamaindex.ai/" target="_blank" rel="noopener noreferrer">LlamaIndex</a></li>
<li><a href="https://github.com/embedchain/embedchain" target="_blank" rel="noopener noreferrer">Embedchain</a></li>
</ul><p>低代码应用：</p><ul>
<li><a href="https://flowiseai.com/" target="_blank" rel="noopener noreferrer">FlowiseAI</a></li>
</ul><p>Agent 应用：</p><ul>
<li><a href="https://huggingface.co/blog/agents-js" target="_blank" rel="noopener noreferrer">@huggingface/agents</a></li>
<li><a href="https://microsoft.github.io/autogen/" target="_blank" rel="noopener noreferrer">AutoGen</a></li>
<li><a href="https://github.com/TransformerOptimus/SuperAGI" target="_blank" rel="noopener noreferrer">SuperAGI</a></li>
<li><a href="https://langroid.github.io/langroid/" target="_blank" rel="noopener noreferrer">Langroid</a></li>
</ul></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="社区平台">社区平台<a href="https://wang1212.github.io/2024/03/01/awesome/llm#%E7%A4%BE%E5%8C%BA%E5%B9%B3%E5%8F%B0" class="hash-link" aria-label="社区平台的直接链接" title="社区平台的直接链接">​</a></h2>
<p>要了解大语言模型技术发展的趋势，或者寻找相关技术资源，应该对常见的一些社区平台要有所了解。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>社区平台</div><div class="admonitionContent_BuS1"><ul>
<li><a href="https://huggingface.co/" target="_blank" rel="noopener noreferrer">Hugging Face</a></li>
<li><a href="https://openai.com/research/overview" target="_blank" rel="noopener noreferrer">OpenAI Research</a></li>
<li><a href="https://llama.meta.com/" target="_blank" rel="noopener noreferrer">Meta Llama</a></li>
<li><a href="https://deepmind.google/technologies/gemini/#introduction" target="_blank" rel="noopener noreferrer">Google Gemini</a></li>
<li><a href="https://www.anthropic.com/" target="_blank" rel="noopener noreferrer">Anthropic Claude</a></li>
</ul></div></div>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>精选资源</category>
            <category>计算机技术</category>
            <category>AI</category>
            <category>LLMs</category>
        </item>
        <item>
            <title><![CDATA[AIGC 在可视化生成场景的探索路径]]></title>
            <link>https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis</link>
            <guid>https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis</guid>
            <pubDate>Mon, 22 Jan 2024 16:51:00 GMT</pubDate>
            <description><![CDATA[记录一下自 2023 年中以来大概半年多时间中结合 AIGC 技术在可视化自动生成场景的探索尝试和实践经验。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-01-22 16:51:00</em></p>
</blockquote>
<p>2022 年接近年底时 OpenAI 发布了 ChatGPT3，实际上一开始业界还没有太大的反响，但在过了大概一个月即 12 月的时候，ChatGPT3 突然引爆了 AI 技术发展新的潮流，业内大部分企业与开发者都开始讨论 OpenAI 与它的产品 ChatGPT3，紧接着 2023 年则成了 “AI 元年”，业内都开始积极探索如何将这种对话聊天 AI 机器人的技术能力结合到自己的业务和产品中去，实现“智能化升级”，抓住下一个风口。</p>
<p>这里则是记录一下自 2023 年中以来大概半年多时间中结合 AIGC 技术在可视化自动生成场景进行的探索尝试和实践经验。通过对这段经历的回顾也能认识到对目前 AI 技术的认知变化，对未来更好的开发 AI 应用产品有一定的借鉴意义。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="可视化自动生成">可视化自动生成<a href="https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis#%E5%8F%AF%E8%A7%86%E5%8C%96%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90" class="hash-link" aria-label="可视化自动生成的直接链接" title="可视化自动生成的直接链接">​</a></h2>
<p>可视化图表可以直观的呈现数据集的趋势、分布等特征，人们因此可以更好的理解数据集。但是，对于普通用户来说，要完成数据分析是具有一定挑战性的，现有的工具软件也一直在通过各种方式降低用户门槛。</p>
<p>可视化自动生成正是为了解决上述问题的一个研究领域，业内像 Vega 推出了 <a href="https://vega.github.io/voyager/" target="_blank" rel="noopener noreferrer">Voyager</a> 项目来期望实现这一目标，通过图表推荐和数据洞察来尽可能自动化的完成数据分析任务。</p>
<p>现在，结合 AI 技术实现可视化自动生成和数据洞察是一次新的机会，像 <a href="https://www.tableau.com/" target="_blank" rel="noopener noreferrer">Tableau</a>、<a href="https://kanaries.net/rath" target="_blank" rel="noopener noreferrer">Rath</a>、<a href="https://www.highcharts.com/chat/gpt/" target="_blank" rel="noopener noreferrer">Highcharts</a> 等等都在积极进行探索尝试。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="探索路径">探索路径<a href="https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis#%E6%8E%A2%E7%B4%A2%E8%B7%AF%E5%BE%84" class="hash-link" aria-label="探索路径的直接链接" title="探索路径的直接链接">​</a></h2>
<p>下面，来简单回顾一下我们结合 AI 技术（大语言模型）和业务做的一些可视化生成场景的探索和实践结果，通过探索路径看看最终是如何成功将 AI 技术融合到可视化生成业务中的，另一方面也进一步了解目前 AI 技术的局限性。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="生成可视化图表代码">生成可视化图表代码<a href="https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis#%E7%94%9F%E6%88%90%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E8%A1%A8%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="生成可视化图表代码的直接链接" title="生成可视化图表代码的直接链接">​</a></h3>
<p>像 ChatGPT3 这些同类产品展现出的 AI 生成文本的卓越能力让人们非常感兴趣，另外对于开发者来说代码本质上也是以文本形式编辑和保存，这就出现了 AI 生成文本的一个很好的应用场景，即代码生成，事实上社区也是这样发展的，出现了很多用于完成代码生成的专家大语言模型，微软也推出了 Github Copilot 产品用于 AI 辅助编码。</p>
<p>基于这样一个背景，<strong>通过自然语言对话直接生成可视化图表代码来渲染可视化效果是一个非常理想的技术路径</strong>，这也是我们开始探索的起点。</p>
<p>我们选择了资讯这一业务场景，由于其满足流量高、更新频率高、时效性强、新闻资讯以纯文本形式呈现缺乏表现力、可视化质量要求不高等特点，非常适合做 AIGC 可视化的落地应用。为此，我们首先筛选出一批适合生成可视化图表的资讯数据集，基于 OpenAI 提供的 API 服务，通过提示词工程的方式来进行技术验证。</p>
<p>一开始，我们先验证其代码生成能力，即<strong>在上下文中给出图表模板代码和资讯文本，然后给出让其根据模版代码和资讯文本中的相关数据生成可视化代码的指令。</strong></p>
<p>很显然，我们遇到了大家都会遇到的问题，即大模型存在严重的“幻觉”，通过调整一些参数（例如 temperature）虽然能保证输出的稳定性，但依然无法确保准确性。另一方面，考虑到我们使用的是私有代码，尝试用一些开源项目（例如 echarts、chart.js）来进行验证，效果要好很多，这就意味着<strong>模型训练过程中提供私有代码库相关的训练集效果会大幅改善。</strong></p>
<p><strong>一次解决一个复杂的问题显然对 AI 模型来说有很大的难度（实际上对于人类也是如此），我们尝试将任务进行拆分，分步与 AI 模型交互来解决代码生成的问题</strong>。将其分解为以下几个步骤：</p>
<ul>
<li>提取数据集</li>
<li>图表推荐</li>
<li>代码生成</li>
<li>渲染可视化效果</li>
</ul>
<p>数据的准确性是用户的核心关注点，因此将数据集提取作为单独一步是非常有必要的；不同的数据集特征维度数量不同，可用于可视化呈现的形式也具有差异，提供默认的几类图表类型和相关信息，让 AI 模型结合资讯内容完成意图分析以推荐适合的可视化图表类型；最后一步，将数据集和对应类型图表的模板代码作为上下文提供给 AI 模型让其生成最终的代码。</p>
<p>从最终的结果来看，分步解决问题的确要比一次完成任务效果好很多，重要的是在每一步的结果产生后，我们可以<strong>利用工程化手段将一些错误合理的修复掉</strong>。当然，这里面有一个可能让很多人感觉疑惑的问题，即第三步的必要性，拥有数据集和图表类型后，为什么不能通过工程化手段直接生成最终代码？这是由于现有图表库的代码设计中不同类型图表的数据结构和解析逻辑不一致，导致工程侧难以实现该目标。另一方面，这里面也引申出一个很重要的问题，即要<strong>实现工程代码与 AI 模型交互的前提是 AI 模型的输出必须结构化（即代码可解析）</strong>，这也是为何 OpenAI 后来推出了 <a href="https://platform.openai.com/docs/guides/text-generation/json-mode" target="_blank" rel="noopener noreferrer">JSON Mode</a> 特性的原因，当然社区对此问题已经有大量的讨论，可以通过提示词工程和轮询的方式来解决。</p>
<p>虽然效果已经得到改善，但仍然存在几个致命的缺陷导致这套方案无法落地在真实业务场景中：AI 模型对数据数值是敏感的，比常规文本更容易出现幻觉，这也就导致数据无法确保百分百准确，而这是数据可视化的关键；生成的代码可成功执行的概率低于 50%，远低于目标，虽然可能通过私有代码库训练集微调的方式来改善，但根据一些开源项目的对比验证结果来看，直接生成代码的技术路径似乎并不可行。</p>
<p>结合以上分析，基于文本直接生成图表代码的方案宣告失败，但这一过程中我们积累了大量的宝贵经验。</p>
<p>期间，我们也在积极关注社区在这一领域的进展，发现有很多项目在做类似的事情，经过简单尝试发现效果差不多；还有一部分项目基于已有的数据集和上下文通过图表推荐的方式生成代码实现可视化生成的目标。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="图表推荐和生成代码">图表推荐和生成代码<a href="https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis#%E5%9B%BE%E8%A1%A8%E6%8E%A8%E8%8D%90%E5%92%8C%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="图表推荐和生成代码的直接链接" title="图表推荐和生成代码的直接链接">​</a></h3>
<p>经过分析，我们发现从文本中提取数据集实际上是不必要的，通常的场景是用户已有数据集的情况下通过描述需求来进行数据分析。另一方面，通过向资讯业务的同事深入了解后才知道很多有丰富数据的资讯新闻实际上是由机器人生成的，即先有数据集才有的资讯新闻内容。</p>
<p>据此，我们开始新方案的尝试，即<strong>结合标准的表格数据集和文本描述完成图表推荐再生成图表代码</strong>。具体步骤为：</p>
<ul>
<li>根据数据集和文本描述完成图表推荐</li>
<li>结合数据集和图表模板代码生成代码</li>
<li>渲染可视化效果</li>
</ul>
<p>这里，我们对数据集的格式进行了约束，要求必须提供表格结构的数据集（一维对象数组），这是分析了现有的数据分析产品之后做出的决定，因为<strong>表格结构是人们存储数据集的普遍格式，不需要进行预处理工作，标准的表格数据集约束隔离了业务，让任务变得更简单</strong>。为了实现这一目标，业务侧需要依赖数据编排服务将数据集标准化，图表库侧则将数据解析的逻辑放在了图表的模板代码中，表格结构约束相当于成为隔离业务和图表库的协议层。</p>
<p>这一方案中依然依赖于 AI 模型生成最终的图表代码，相比于之前的效果已经有所改善，但仍然存在类似的问题：AI 模型对数据数值是敏感的，在提供的数据集准确的情况下最终生成的代码中数值有很大概率会出错；在数据集量级比较大的情况下，AI 模型提示词的上下文 token 数据具有硬性限制，这一问题无法解决（虽然目前随着技术发展超长上下文已经实现，但输入 token 数量越多意味着 AI 模型推理的时间越长，且输出越不稳定和时间更长）。</p>
<p>基于目前所做尝试的结果，再结合社区中相关的讨论，大家普遍的共识是：AI 模型的能力目前尚不足以完成复杂的专业任务，在代码生成场景更适合以辅助工具的形式出现，而不是面向最终用户的产品。换句话说，<strong>AI 模型结合工程侧能力才是 AI 技术在业务中顺利落地的正确路径。</strong></p>
<p>在该方案的设计过程中，我们曾设想过将第二步代码生成也用工程化手段解决，但面临的困境是一个数据集如果数据维度较多，那么可利用该数据集生成不同的可视化效果，即便是同类型的图表，而这取决于用户意图，如何将用户意图翻译成代码逻辑用工程化手段基本是无法实现的。用简单的例子来说明，一个数据集中包含了一家公司的股价和利润率数据，它们均可用折线图或者柱状图来表达，最终可视化效果表达的是这家公司的股价还是利润率变化趋势取决于用户意图。</p>
<p>至此，我们基本已经明确几个关键点：数据集不经过 AI 模型处理，包含大量细节的代码片段也不应该由 AI 模型生成，AI 模型可以胜任图表推荐任务。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基于数据特征进行图表推荐">基于数据特征进行图表推荐<a href="https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis#%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E7%89%B9%E5%BE%81%E8%BF%9B%E8%A1%8C%E5%9B%BE%E8%A1%A8%E6%8E%A8%E8%8D%90" class="hash-link" aria-label="基于数据特征进行图表推荐的直接链接" title="基于数据特征进行图表推荐的直接链接">​</a></h3>
<p>在进行下一步尝试之前，我们开始思考如何优化工程侧的代码，以使其更适合 AIGC 任务。例如，一开始不同类型图表的数据集格式要求和数据解析逻辑实现不一致，这增加了问题的复杂性，我们通过引入标准化的表格数据集约束来解决了这一问题。通过进一步了解目前可视化领域主流项目的动向，分析其衍生项目（例如 <a href="https://altair-viz.github.io/" target="_blank" rel="noopener noreferrer">Vega-Altair</a>、<a href="https://observablehq.com/plot/what-is-plot" target="_blank" rel="noopener noreferrer">Plot</a>）的 APIs 设计后，我们发现其都<strong>遵循声明式的设计，并蕴含了图形语法的设计思想</strong>，而这让我们看到了新的可能性。</p>
<p>于是，我们提出新的方案：<strong>对图表库进行抽象封装设计，将数据解析逻辑抽象为声明式的数据编码配置，使其仅通过标准的表格数据集加几个数据编码配置参数即可渲染指定的可视化效果；基于可视化图表的数据特征训练 AI 可视化推荐模型。</strong></p>
<p>该方案经过验证，效果超出预期，并具备落地真实业务场景的可能性。在这一版本的方案中，工程侧的实现细节比较多，总的来说就做了两件事：一是对图表库的 APIs 进行了抽象封装，二是提供了 AI 可视化推荐模型的训练集。</p>
<p>具体的来说，我们在<strong>渲染一个可视化图表时需要提供两部分参数，标准的表格数据集和数据编码配置，后者可以理解为一个指定数据集中的哪些字段映射到图表中的指定维度</strong>，例如渲染一个柱状图需要 x 和 y 两个维度，对应的则是数据集中的两个不同字段。因此，我们可以<strong>声明数据编码配置参数的类型定义约束</strong>，例如柱状图的 x 维度要求为字符串类型数据，折线图的 x 维度要求为日期类型数据，这样就<strong>为图表推荐任务提供了判断标准，形成了训练 AI 可视化推荐的模型训练集。</strong></p>
<p>这里需要注意的是，我们之前一直说图表推荐的结果是适合可视化的图表类型，其实这是不准确的，因为<strong>一类图表可以有很多不同的用例</strong>，例如属于折线图类型的有单折线、多折线、堆叠折线等等。所以，<strong>AI 模型的训练集实际上代表的是一个个图表用例</strong>，模型最终推荐的结果也是对应的用例类型和数据编码配置参数，可以说<strong>图表推荐是根据数据集的特征来判断的，该结果也可以通过人工标注的方式进行调整。</strong></p>
<p>现阶段，基于该模式，我们已经成功将 AIGC 可视化能力落地在多个业务场景，快速生成可视化图表效果来帮助用户直观的了解数据集信息。后续面临的问题则是，常规的可视化图表效果不具备吸引力，且仅能表达数据集的显式信息，而这些问题均可以尝试结合 AI 技术来解决，例如基于自然语言的图表效果微调，AI 数据洞察等等。</p>
<p>另外，值得一提的是微软的 <a href="https://microsoft.github.io/lida/" target="_blank" rel="noopener noreferrer">LIDA</a> 项目，其目标是建立一个基于 LLMs 自动生成可视化和信息图表的系统，其设计较为复杂且更具备通用性，设计思想有一定的借鉴意义。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/2024/01/22/computer-technology/ai/aigc-data-vis#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://vega.github.io/voyager/" target="_blank" rel="noopener noreferrer">https://vega.github.io/voyager/</a></li>
<li><a href="https://www.highcharts.com/chat/gpt/" target="_blank" rel="noopener noreferrer">https://www.highcharts.com/chat/gpt/</a></li>
<li><a href="https://github.com/victordibia/data2vis" target="_blank" rel="noopener noreferrer">https://github.com/victordibia/data2vis</a></li>
<li><a href="https://altair-viz.github.io/" target="_blank" rel="noopener noreferrer">https://altair-viz.github.io/</a></li>
<li><a href="https://observablehq.com/plot/what-is-plot" target="_blank" rel="noopener noreferrer">https://observablehq.com/plot/what-is-plot</a></li>
<li><a href="https://microsoft.github.io/lida/" target="_blank" rel="noopener noreferrer">https://microsoft.github.io/lida/</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>AI</category>
            <category>数据可视化</category>
            <category>实践案例</category>
        </item>
        <item>
            <title><![CDATA[绍兴鲁迅故居之行]]></title>
            <link>https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing</link>
            <guid>https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing</guid>
            <pubDate>Sat, 16 Dec 2023 22:10:00 GMT</pubDate>
            <description><![CDATA[杭州待了好几年，早就通了地铁的邻市绍兴是个很好的闲游去处，话虽如此，却也一直缺乏行动，难得在这个冬季的周末完成此行。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-12-16 22:10:00</em></p>
</blockquote>
<p><u>2023-11-25</u>
<br>
<br></p>
<p>杭州待了好几年，早就通了地铁的邻市绍兴是个很好的闲游去处，话虽如此，却也一直缺乏行动，难得在这个冬季的周末完成此行。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="地铁-or-高铁">地铁 or 高铁<a href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing#%E5%9C%B0%E9%93%81-or-%E9%AB%98%E9%93%81" class="hash-link" aria-label="地铁 or 高铁的直接链接" title="地铁 or 高铁的直接链接">​</a></h2>
<p>为什么会产生这个疑问呢？因为计划一日游，所以时间略显紧张，地铁单程大概要两个小时，这样的话早上得起多早啊！</p>
<p>好的是，两市之间也有高铁，耗时仅 19 分钟，这意味着早上可以多睡一会懒觉了。不过，众所周知，高铁站大部分不一定在市中心，所以出发之前还是查了绍兴高铁站距离景点的距离，大约 10 公里的样子，还不算远，怎么算都比地铁耗时短。</p>
<p>绍兴在我的印象中比较吸引人的则是“鲁迅故居”了，看见百草园与三味书屋要感觉亲切很多，另一方面绍兴最有名的则是黄酒了。此外，在旅游 App 上查看，绍兴还有兰亭（可记得《兰亭序》？）、书圣故里（书法名家王羲之）等比较有名的景点，也是此行的计划安排。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="鲁迅故里">鲁迅故里<a href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing#%E9%B2%81%E8%BF%85%E6%95%85%E9%87%8C" class="hash-link" aria-label="鲁迅故里的直接链接" title="鲁迅故里的直接链接">​</a></h2>
<p>当天的天气很好，没想到冬天的游客也很多。到达鲁迅故居已是中午十一点钟了，打算先预约景点然后吃完饭再去逛一逛，不过看了一圈好像也没有特别想吃的，于是找了家人不多的炒年糕店，也是头一次吃到别有一番风味的炒年糕。</p>
<p>绍兴的黄酒很著名，当然也体现在景区的小吃上了，基本都会含黄酒，倒也挺有意思。</p>
<p>鲁迅故居的景点实际上包含了多个小景点（鲁迅故居、鲁迅祖居、百草园、三味书屋等），而且不是连在一起的，要从一个景点进去逛完出来再去另一个景点。</p>
<p>为了节省时间，先从人少的游客中心进到了祖居景点，里面也不算很大，陈列的东西也比较少。下一个则是紧挨着的纪念馆了，里面陈列的东西相当多，不仅有鲁迅相关的，还有一些其它绍兴名人相关的，比较让人印象深刻的则是周恩来总理了，来之前倒还没想到总理原本也是绍兴人啊。一路看着一些我们在课本上学过的鲁迅文集摘选颇有感慨，鲁迅弃医从文等一系列事迹让人深有感触。纪念馆中还有王羲之的《兰亭集序》手稿，看着这些熟悉的字句，不禁能回想起原来全篇背诵的场景。</p>
<p>接下来去了故居景点，里面的人流量有两三千，应该相比长假等热门时间要好一点，这也是核心景点了。从门口的简版地图来看，百草园就在宅子的最后边。故居比祖居看起来要大一些，不过据了解这些都是后来复原的，而且鲁迅可能成年后在绍兴并没有实际的长期生活过，这些都是他们的家族兄弟姐妹及其后人支持修建的。</p>
<p>百草园实际上就是鲁迅家的菜园子，鲁迅给其的称谓让其对别人来说颇感不一样，也许这就是鲁迅幽默的风格吧。</p>
<p>从故居出来之后已经是下午一点多钟了，这里就剩下最后一个三味书屋景点了，这也是在故居的对面，即鲁迅老师的家，看吧，鲁迅总是能把一件事情写出不一样的感觉。排队的人很多，耗时二十分钟才进门，里面的区域实际并不大，有意思的是鲁迅的课桌还在，上面似乎刻了一个“早”字。</p>
<p>来之前本来打算是绕着一圈连续逛好几个景点的，发现这一圈下来有些许的累，于是进行了短暂的歇息。来一次绍兴，当然得带点特产回去吧，黄酒是最好不过了，虽然现在的特产基本上网购都可以买到，但毕竟来一次，尝尝手工的倒也不错。</p>
<p>此刻已是下午两点，打算再去最后一个景点书圣故里，由于距离只有两三公里，所以就步行晃晃悠悠过去了。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="书圣故里">书圣故里<a href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing#%E4%B9%A6%E5%9C%A3%E6%95%85%E9%87%8C" class="hash-link" aria-label="书圣故里的直接链接" title="书圣故里的直接链接">​</a></h2>
<p>对于喜欢书法的人来说，有“书圣”之称的王羲之应该是比较熟悉的，其作品天下第一行书《兰亭序》更是为人所熟知。当然，我并不知其为绍兴人。</p>
<p>绍兴有书圣故里和兰亭两个景点，不知其有何不同，由于前者离得较近就选择去这里。</p>
<p>等到了目的地后，才发现这似乎算是一个开放式的小街巷，不算是一个被开发的景点。当然，作为北方人来这街巷走走看看也是不错的，领略一下江南的风土人情。</p>
<p>绍兴此行是比较轻松的，因为离得近，所以觉得以后还可以再来，行程安排就较为随意一些了，逛到哪是哪，走走看看就当散步了。</p>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>生活</category>
            <category>旅游</category>
            <category>绍兴</category>
        </item>
        <item>
            <title><![CDATA[解析 ECharts 设计：UniversalTransition 动画]]></title>
            <link>https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation</link>
            <guid>https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation</guid>
            <pubDate>Fri, 10 Nov 2023 19:23:00 GMT</pubDate>
            <description><![CDATA[ECharts 的 UniversalTransition 动画提供了一些复杂场景下过渡动画的解决方案，这类场景的难点在于让不规则图形或者不同形状的图形之间如何完成一个比较流畅的过渡动画，在业内比较熟知的类似技术则是 SVG Morph 动画。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-11-11 21:56:00</em></p>
</blockquote>
<p>ECharts 的 <a href="https://echarts.apache.org/zh/option.html#series-line.universalTransition" target="_blank" rel="noopener noreferrer">UniversalTransition 动画</a>提供了一些复杂场景下过渡动画的解决方案，这类场景的难点在于让<strong>不规则图形</strong>或者<strong>不同形状的图形</strong>之间如何完成一个比较流畅的过渡动画，在业内比较熟知的类似技术则是 SVG Morph 动画。</p>
<p>查看以下 ECharts 官方示例：</p>
<blockquote>
<ul>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=scatter-aggregate-bar" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=scatter-aggregate-bar</a></li>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=scatter-symbol-morph" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=scatter-symbol-morph</a></li>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=map-bar-morph" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=map-bar-morph</a></li>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=treemap-sunburst-transition" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=treemap-sunburst-transition</a></li>
</ul>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="svg-morph-动画">SVG Morph 动画<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#svg-morph-%E5%8A%A8%E7%94%BB" class="hash-link" aria-label="SVG Morph 动画的直接链接" title="SVG Morph 动画的直接链接">​</a></h2>
<p>在探究 ECharts 的 UniversalTransition 动画之前先来看看比较成熟的 SVG Morph 技术。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="css-方案">CSS 方案<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#css-%E6%96%B9%E6%A1%88" class="hash-link" aria-label="CSS 方案的直接链接" title="CSS 方案的直接链接">​</a></h3>
<p>通常，动画会优先采用 CSS 方案，一方面是因为方便，另一方面则是因为会有硬件加速的优势。实际上，SVG 的 Morph 动画也可以使用 CSS 来实现。查看以下示例：</p>
<blockquote>
<p><a href="https://codepen.io/chriscoyier/pen/NRwrNp" target="_blank" rel="noopener noreferrer">https://codepen.io/chriscoyier/pen/NRwrNp</a></p>
</blockquote>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">viewBox</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0 0 10 10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">svg-1</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">d</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">M2,2 L8,8</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token selector class" style="color:#00009f">.svg-1</span><span class="token selector pseudo-class" style="color:#00009f">:hover</span><span class="token selector" style="color:#00009f"> path</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">d</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"M8,2 L2,8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>&lt;path&gt;</code> 标签的 <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d" target="_blank" rel="noopener noreferrer"><code>d</code></a> 属性是一个 Presentation Attributes，所以可被用来作为 CSS 属性使用。不过，目前浏览器的支持度仅有 <a href="https://caniuse.com/mdn-svg_elements_path_d_path" target="_blank" rel="noopener noreferrer">70%</a> 多，兼容性并不高。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="smil-方案">SMIL 方案<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#smil-%E6%96%B9%E6%A1%88" class="hash-link" aria-label="SMIL 方案的直接链接" title="SMIL 方案的直接链接">​</a></h3>
<p>实际上，在 CSS 支持的更早之前，业内采用 <a href="https://www.w3.org/TR/REC-smil/" target="_blank" rel="noopener noreferrer">SMIL 技术</a>来实现 Web 上的矢量图形形变动画。来自 <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animate" target="_blank" rel="noopener noreferrer">MDN 文档</a>的示例如下：</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">viewBox</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0 0 10 10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2000/svg</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">rect</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">width</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">height</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">animate</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">attributeName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">rx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">values</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0;5;0</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">dur</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">10s</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">repeatCount</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">indefinite</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">rect</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可见，其实际上是类似 HTML 标签的形式，所以在应对一些高度复杂的动画场景时局限性比较大。</p>
<p>给出一个实际案例，状态管理库 jotai 的官方 GitHub 仓库 logo 动画的源文件：</p>
<blockquote>
<p><a href="https://raw.githubusercontent.com/pmndrs/jotai/master/img/title.svg" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/pmndrs/jotai/master/img/title.svg</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gsap-的-morphsvg-插件">GSAP 的 MorphSVG 插件<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#gsap-%E7%9A%84-morphsvg-%E6%8F%92%E4%BB%B6" class="hash-link" aria-label="GSAP 的 MorphSVG 插件的直接链接" title="GSAP 的 MorphSVG 插��件的直接链接">​</a></h3>
<p>要实现效果比较好的形变动画并不容易，目前，业内功能比较强大的工具库则是 <a href="https://gsap.com/docs/v3/Plugins/MorphSVGPlugin/" target="_blank" rel="noopener noreferrer">GSAP 的 MorphSVG 插件</a>，我们在其官方文档中可以看到其中的技术难点。</p>
<p><img decoding="async" loading="lazy" alt="gsap-svg-morph-plugin" src="https://wang1212.github.io/assets/images/gsap-svg-morph-plugin-7413a2b75c6b332db8698bbdacde2a58.webp" width="1396" height="437" class="img_ev3q"></p>
<p>在处理两个不同的 SVG 图形之间的形变过渡时，要确保其 <code>d</code> 属性包含的<strong>点数量是一致</strong>的，为了实现这个目标，则需要对其数据进行插值和优化处理，将其转换和细分为多段<strong>贝塞尔曲线</strong>。</p>
<p>为了更好的理解，可以参考以下这篇关于使用 D3.js 实现折线图过渡动画的文章：</p>
<blockquote>
<p><a href="https://bocoup.com/blog/improving-d3-path-animation" target="_blank" rel="noopener noreferrer">https://bocoup.com/blog/improving-d3-path-animation</a></p>
</blockquote>
<p>以上文章中对于不同点数量的折线图过渡动画的数据点插值尝试了多个方案，可以看出不同的插值算法对动画的效果影响是比较明显，这也是 SVG 形变动画中的难点。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="贝塞尔曲线为什么这么重要">贝塞尔曲线为什么这么重要？<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E4%B9%88%E9%87%8D%E8%A6%81" class="hash-link" aria-label="贝塞尔曲线为什么这么重要？的直接链接" title="贝塞尔曲线为什么这么重要？的直接链接">​</a></h2>
<p>查阅不同的资料，发现大家在实现 SVG 形变动画时，数据插值优化过程中都会将其转换为贝塞尔曲线进行处理，遂产生了好奇心，更进一步的探索才发现贝塞尔曲线是非常重要的一个数学函数和曲线，几乎所有的图形引擎都支持绘制贝塞尔曲线。</p>
<p>可参考以下这篇文章来简单的了解贝塞尔曲线在设计领域的重要性：</p>
<blockquote>
<p><a href="https://www.linearity.io/blog/bezier-curves/" target="_blank" rel="noopener noreferrer">https://www.linearity.io/blog/bezier-curves/</a></p>
</blockquote>
<p>根据维基百科：</p>
<blockquote>
<p>由于需要点阵化更精细的分辨率时，重新插值（补点）的计算量较小，<strong>贝塞尔曲线被广泛地在计算机图形中用来为平滑曲线建立模型</strong>。</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="echarts-的动画实现细节">ECharts 的动画实现细节<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#echarts-%E7%9A%84%E5%8A%A8%E7%94%BB%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82" class="hash-link" aria-label="ECharts 的动画实现细节的直接链接" title="ECharts 的动画实现细节的直接链接">​</a></h2>
<p>根据源码，ECharts 的 UniversalTransition 动画被实现为一个插件功能：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.3.3/src/animation/universalTransition.ts#L626</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">installUniversalTransition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">registers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EChartsExtensionInstallRegisters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerUpdateLifecycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'series:beforeupdate'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecMOdel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerUpdateLifecycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'series:transition'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecModel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO api provide an namespace that can save stuff per instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> globalStore </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUniversalTransitionGlobalStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO multiple to multiple series.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oldSeries </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updatedSeries </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optionChanged</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Use give transition config if its' give;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> transitionOpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seriesTransition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transitionOpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">each</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">normalizeToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transitionOpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opt </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">transitionSeriesFromOpt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Else guess from series based on transition series key.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updateBatches </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findTransitionSeriesBatches</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">each</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updateBatches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> updateBatches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">transitionBetween</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oldSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分析一些关键性源码，可以了解到其过渡动画的实现细节，直接来看看两个系列之间的过渡是如何实现的。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.3.3/src/animation/universalTransition.ts#L160</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transitionBetween</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oldList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransitionSeries</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  newList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransitionSeries</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  api</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ExtensionAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateOneToOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldDiffItems</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oldIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newDiffItems</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">newIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newSeries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hostModel </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> SeriesModel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO Mark this elements is morphed and don't morph them anymore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldEl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getItemGraphicEl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newEl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getItemGraphicEl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Can't handle same elements.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      newEl </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animateElementStyles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newSeries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// We can't use the elements that already being morphed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> isElementStillInChart</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">stopAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">stopAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If old element is doing leaving animation. stop it and remove it immediately.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">removeEl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hasMorphAnimation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">applyMorphAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">getPathList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">getPathList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">divide</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          newSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          newIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          updateMorphingPathProps</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">fadeInElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DataDiffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oldDiffItems</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newDiffItems</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">createKeyGetter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">createKeyGetter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'multiple'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updateOneToOne</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateManyToOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateOneToMany</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateManyToMany</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在应用 Morph 动画之前，对两个图形元素进行了遍历迭代，得到其包含的所有 <code>path</code> 实例。需要注意的是，ECharts 的底层绘图引擎是 ZRender，而其所有图形的基类就是 <code>Path</code>，这只是绘图层的抽象设计，与 svg 的 <code>&lt;path&gt;</code> 标签对象不是同一个概念。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.3.3/src/animation/morphTransitionHelper.ts#L110</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyMorphAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  from</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DescendentPaths </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DescendentPaths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  to</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DescendentPaths </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DescendentPaths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  divideShape</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UniversalTransitionOption</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'divideShape'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  seriesModel</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SeriesModel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dataIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">animateOtherProps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fromIndividual</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toIndividual</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rawFrom</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rawTo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animationCfg</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ElementAnimateConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">morphOneBatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MorphingBatch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fromIsMany</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateCount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forceManyOne</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchMany </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">many</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchOne </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">one</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchMany</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">forceManyOne</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Is one to one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchFrom</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromIsMany </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> batchMany</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batchOne</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchTo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromIsMany </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> batchOne </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batchMany</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isCombineMorphing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchFrom </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Keep doing combine animation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">morphOneBatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          many</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">batchFrom </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          one</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batchTo </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateCount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> individualAnimationCfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> animationDelay </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defaults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            delay</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animationDelay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">animateIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ElementAnimateConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> animationCfg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">morphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchTo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> individualAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">animateOtherProps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchTo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchTo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> individualAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fromIndividuals</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        toIndividuals</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromIsMany</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">combineMorph</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchMany</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchOne</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> separateAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">separateMorph</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchOne</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchMany</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> separateAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> morphBatches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">morphOneBatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">morphBatches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fromIsMany</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateIndex </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> morphBatches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">many</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ECharts 为了使不同的图表元素在动画过渡时更自然一些，提供了多种策略，允许图形分割、合并等。</p>
<p>从源码中可以看到，ECharts 只处理了一些业务逻辑，真正的图形变形逻辑实际上在 ZRender 中实现。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/ecomfe/zrender/blob/5.3.2/src/tool/morphPath.ts#L482</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">morphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fromPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  animationOpts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ElementAnimateConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">fromPath </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldDone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> animationOpts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// const oldAborted = animationOpts.aborted;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldDuring </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> animationOpts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">during</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">prepareMorphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> MorphingPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__morphT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">restoreToPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">restoreMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'buildPath'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">restoreMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'updateTransform'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Mark as not in morphing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> MorphingPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__morphT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Cleanup.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createPathProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dirtyShape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">animateTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    __morphT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defaults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">during</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dirtyShape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      oldDuring </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">oldDuring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">restoreToPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      oldDone </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">oldDone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// NOTE: Don't do restore if aborted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Because all status was just set when animation started.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// aborted() {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//     oldAborted &amp;&amp; oldAborted();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ElementAnimateConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animationOpts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据以上源码来看，ZRender 在对两个 <code>Path</code> 对象实例做 Morph 动画处理时，会先做一部分<strong>准备工作</strong>，然后劫持 <code>buildPath()</code> 和 <code>updateTransform()</code> 两个方法，再利用 <code>__morphT</code> 标记位完成整段动画，最终再将被劫持的方法还原。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/ecomfe/zrender/blob/5.3.2/src/tool/morphPath.ts#L396</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepareMorphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fromPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fromPathProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUpdatedPathProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toPathProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUpdatedPathProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fromBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toBezierCurves</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">alignBezierCurves</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pathToBezierCurves</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromPathProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pathToBezierCurves</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPathProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fromPathTransform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getComputedTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toPathTransform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getComputedTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateIdentityTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Transformable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  fromPathTransform </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyTransformOnBeziers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fromPathTransform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  toPathTransform </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyTransformOnBeziers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toPathTransform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Just ignore transform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">saveAndModifyMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'updateTransform'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> replace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> updateIdentityTransform </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> morphingData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findBestMorphingRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> tmpArr</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">saveAndModifyMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'buildPath'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PathProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面提到的准备工作是非常关键的，这个阶段 ZRender 会首先获取两个 Path 实例的<strong>绘图代理</strong>（为了同时支持 SVG、Canvas 等环境做的抽象设计），并将其<strong>转换为贝塞尔曲线</strong>的绘图指令组，然后将两段贝塞尔曲线组上的<strong>点数量进行对齐</strong>，然后对贝塞尔曲线应用变换。</p>
<p>以上就是 ECharts 的 UniversalTransition 动画实现细节，总结一下就是其与 SVG 的 Morph 动画实现思路一致，<strong>关键都在于对两个图形的路径点进行插值转换处理，并将点数量对齐</strong>，然后完成动画过渡。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="示例zrender-实现的-svg-morph-动画">示例：ZRender 实现的 SVG Morph 动画<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#%E7%A4%BA%E4%BE%8Bzrender-%E5%AE%9E%E7%8E%B0%E7%9A%84-svg-morph-%E5%8A%A8%E7%94%BB" class="hash-link" aria-label="示例：ZRender 实现的 SVG Morph 动画的直接链接" title="示例：ZRender 实现的 SVG Morph 动画的直接链接">​</a></h3>
<p>GSAP 的 MorphSVG 插件固然强大，但其只有注册为会员才能使用，并不是开源免费的方案，实际上用 ZRender 就可以做出类似的效果，这里给出 GSAP 官网文档示例的 ZRender 实现：</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">style</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css selector" style="color:#00009f">html</span><span class="token style language-css selector punctuation" style="color:#393A34">,</span><span class="token style language-css selector" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css selector" style="color:#00009f">  body</span><span class="token style language-css selector punctuation" style="color:#393A34">,</span><span class="token style language-css selector" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css selector" style="color:#00009f">  </span><span class="token style language-css selector id" style="color:#00009f">#container</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:#393A34">{</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">width</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">100</span><span class="token style language-css unit">%</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">height</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">100</span><span class="token style language-css unit">%</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">display</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> flex</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">flex-direction</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> column</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css punctuation" style="color:#393A34">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css selector class" style="color:#00009f">.nav</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:#393A34">{</span><span class="token style language-css punctuation" style="color:#393A34">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css selector class" style="color:#00009f">.chart</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:#393A34">{</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">flex</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">1</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">height</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">0</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css punctuation" style="color:#393A34">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">style</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">container</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">nav</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">nav</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">play</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">play</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">reset</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">reset</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">nav</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">chart</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">chart</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">https://cdn.bootcdn.net/ajax/libs/zrender/5.3.2/zrender.min.js</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> zr </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zrender</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> zrIns </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">init</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">getElementById</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">'chart'</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">path</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createFromString</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">"M490.1,280.649c0,44.459-36.041,80.5-80.5,80.5s-80.5-36.041-80.5-80.5s36.041-80.5,80.5-80.5 S490.1,236.19,490.1,280.649z"</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> to </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">path</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createFromString</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">"M149,245c2.7-36.7,16.11-69.08,40.1-97.06c27.04-31.6,60.92-47.39,101.63-47.39c15.48,0,38.48,2.45,69.02,7.29 c30.54,4.89,53.53,7.28,69.03,7.28c23.69,0,57.87,8.85,102.53,26.48c7.91,3.01,17.47,11.24,28.7,24.59 c6.38,7.89,16.26,19.77,29.62,35.57c3.04,2.14,7,5.32,11.86,9.6c4.86,4.22,8.19,6.06,10,5.46c0.62-1.84,2.15-4.4,4.58-7.74 c1.21-1.23,1.96-1.83,2.26-1.83c0.93,0.61,1.83,1.21,2.75,1.83c0.91,0.62,1.21,2.42,0.91,5.46c-0.62,5.47-0.91,7.14-0.91,5 c-0.33,3.06-0.76,5.01-1.37,5.95c-3.95,6.67-5.48,11.85-4.55,15.47c0.92,3.32,3.77,8.67,8.64,15.96c4.87,7.29,7.59,12.76,8.19,16.4 c-0.3,2.73-0.43,7.12-0.43,13.21l-4.57,11.38c0,8.51,9.86,23.11,29.62,43.78c9.44,4.22,14.12,18.83,14.12,43.71 c0,19.47-16.09,29.17-48.27,29.17c-4.26,0-8.81-0.13-13.68-0.47c-3.34-1.2-8.2-2.56-14.58-4.07c-7.59-0.93-12.76-3.49-15.48-7.77 c-4.88-6.95-12.78-13.51-23.71-19.58c-1.82-0.88-4.48-4.22-7.98-10.02c-3.5-5.77-6.61-9.42-9.33-10.95 c-2.72-1.49-6.68-1.81-11.86-0.88c-8.81,1.49-13.68,2.26-14.57,2.26c-2.14,0-5.25-0.6-9.34-1.83c-4.11-1.21-7.05-1.83-8.89-1.83 c-2.11,9.73-2.59,19.15-1.36,28.25c0.3,2.45,1.83,4.43,4.56,5.92c4.27,3.05,6.53,4.71,6.85,5.05c2.72,2.11,5.61,5.61,8.64,10.45 c0.62,1.85-0.52,4.95-3.42,9.34c-2.89,4.41-5.22,7.01-7.06,7.74c-1.81,0.79-5.77,1.18-11.85,1.18c-8.82,0-29.45-2.45-30.98-2.73 c-7.59-1.53-14.13-3.94-19.58-7.3c-2.76-1.81-5.91-10.33-9.56-25.52c-3.68-16.41-6.72-26.27-9.14-29.64 c-0.6-0.9-1.36-1.33-2.26-1.33c-1.53,0-4.05,1.49-7.53,4.56c-3.49,2.99-5.86,4.65-7.05,5.01c-4.24,17.9-6.4,26.4-6.4,25.47 c0,7.01,1.97,12.89,5.92,17.77c3.94,4.86,8.06,9.57,12.32,14.11c5.16,5.77,7.74,10.78,7.74,15.04c0,2.41-0.75,4.52-2.28,6.37 c-6.38,7.89-17.02,11.85-31.9,11.85c-16.71,0-27.64-2.28-32.79-6.84c-6.7-5.77-10.95-11.86-12.76-18.2 c-0.3-1.53-1.05-6.09-2.28-13.68c-0.61-4.58-1.98-7.29-4.08-8.18c-6.1-0.92-13.69-2.58-22.78-5.01c-1.84-1.21-3.81-4.26-5.94-9.12 c-3.93-9.4-6.83-15.79-8.66-19.13c-9.13-4.56-23.7-9.7-43.76-15.45c-0.92,1.83-1.35,4.37-1.35,7.72c3.34,4.26,8.34,10.8,15.03,19.58 c5.47,7.29,8.2,14.3,8.2,20.96c0,12.78-8.2,19.13-24.61,19.13c-12.45,0-20.96-0.88-25.52-2.71c-6.67-2.73-12.29-9.14-16.85-19.13 c-7.6-16.74-11.85-26.16-12.76-28.27c-4.87-11.23-8.2-21.13-10.01-29.65c-1.23-6.05-3.06-15.35-5.49-27.8 c-2.12-10.3-5.46-18.36-10.01-24.13C155.33,279.36,147.5,260.6,149,245z"</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">style</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">fill</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">stroke</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">x</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">y</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  to</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">style</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">fill</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">stroke</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">x</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">y</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  zrIns</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">add</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  zrIns</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">add</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">to</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:#36acaa">window</span><span class="token script language-javascript punctuation" style="color:#393A34">[</span><span class="token script language-javascript string" style="color:#e3116c">'play'</span><span class="token script language-javascript punctuation" style="color:#393A34">]</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#d73a49">onclick</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    to</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">false</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">morph</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">morphPath</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> to</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">duration</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">2e3</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:#36acaa">window</span><span class="token script language-javascript punctuation" style="color:#393A34">[</span><span class="token script language-javascript string" style="color:#e3116c">'reset'</span><span class="token script language-javascript punctuation" style="color:#393A34">]</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#d73a49">onclick</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">false</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    to</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">morph</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">morphPath</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">to</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">duration</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">2e3</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/echarts-zrender/morph-animation#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://echarts.apache.org/zh/option.html#series-line.universalTransition" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/zh/option.html#series-line.universalTransition</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d</a></li>
<li><a href="https://caniuse.com/" target="_blank" rel="noopener noreferrer">https://caniuse.com/</a></li>
<li><a href="https://www.w3.org/TR/REC-smil/" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/REC-smil/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animate" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animate</a></li>
<li><a href="https://gsap.com/docs/v3/Plugins/MorphSVGPlugin/" target="_blank" rel="noopener noreferrer">https://gsap.com/docs/v3/Plugins/MorphSVGPlugin/</a></li>
<li><a href="https://bocoup.com/blog/improving-d3-path-animation" target="_blank" rel="noopener noreferrer">https://bocoup.com/blog/improving-d3-path-animation</a></li>
<li><a href="https://en.wikipedia.org/wiki/B%C3%A9zier_curve" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/B%C3%A9zier_curve</a></li>
<li><a href="https://www.linearity.io/blog/bezier-curves/" target="_blank" rel="noopener noreferrer">https://www.linearity.io/blog/bezier-curves/</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>Web 前端</category>
            <category>数据可视化</category>
            <category>动画</category>
            <category>工具</category>
            <category>ECharts</category>
            <category>ZRender</category>
            <category>源码解析</category>
        </item>
        <item>
            <title><![CDATA[此行南京]]></title>
            <link>https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing</link>
            <guid>https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing</guid>
            <pubDate>Sun, 27 Aug 2023 18:30:00 GMT</pubDate>
            <description><![CDATA[夏日的短暂旅行放弃了千岛湖，转而选择了南京，领略了一下古都文化。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-08-27 18:30:00</em></p>
</blockquote>
<p><u>2023-08-25</u>
<br>
<br></p>
<p>夏日的短暂旅行放弃了千岛湖，转而选择了南京，领略了一下古都文化。</p>
<p>忘记什么时候看的新闻了，南京被称为“第一网红城市”，比成都还要厉害，现在还是不是第一倒也不重要了。</p>
<p>不知道是不是因为太热门的原因，临近出行的前几天才开始预定酒店，发现比预期的要贵一些。而且杭州去南京的高铁票几乎售罄，犹豫了几个小时就只能买站票了，要命的是返程也只有站票了，不过还好全程也只有一个半小时左右。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="去程的小插曲">去程的小插曲<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E5%8E%BB%E7%A8%8B%E7%9A%84%E5%B0%8F%E6%8F%92%E6%9B%B2" class="hash-link" aria-label="去程的小插曲的直接链接" title="去程的小插曲的直接链接">​</a></h2>
<p>计划是周五下午过去，周日下午回来，也就是两天两夜的行程。去程还出了一个小插曲，车票是下班后的两小时，去高铁站的时间绰绰有余，但没有预估到夏天是旅游的旺季，即便是提前二十多分钟到的高铁站，但在进站安检的时候排了很长的队，而距离发车已经只有七八分钟了。感觉运气不好的是，过了安检后才发现走错入口了，检票口在另一个入口处，此时距离发车也只有四五分钟了，而我还得从候车大厅的一端狂奔到另一端，中间隔了将近二十个检票口，人群也非常拥挤。等到了检票口是，发现距离发车还有一分钟，但已经显示停止检票了，当时都懵了，重点是今天去南京的票都已经售罄了，这一趟车赶不上就只能等明天早上了。恰好此时检票员还在检票口站着，跑过去立马询问了一下，检票员则迅速帮助我们检票然后放行，悬着的心终于放下了。</p>
<p>犹记得上一次也有类似的经历，还是没有吸取教训啊，以后出行的时间要留的宽裕一些。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="秦淮河夜景">秦淮河夜景<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E7%A7%A6%E6%B7%AE%E6%B2%B3%E5%A4%9C%E6%99%AF" class="hash-link" aria-label="秦淮河夜景的直接链接" title="秦淮河夜景的直接链接">​</a></h2>
<p>到达南京是晚上九点多一些，酒店定在了玄武湖附近，去酒店的途中会路过一些景点，比如夫子庙、秦淮河夜景，便临时改变了注意，原计划在周六晚上的行程改到了今天晚上。不得不说，在城市游玩的话，如果景点有直达的地铁会方便很多，还记得春节时候苏州的地铁不用刷卡直接免费乘坐也为游客省去了不少麻烦。</p>
<p>由于下午没有吃饭，所以选择先去老门东，据说这里的小吃很多。下了地铁后要步行好一会才到了老门东，实际上就是个步行街吧，晚上的人倒是挺多的。进去迅速逛了一圈，本来想找个吃饭的地方，结果发现没有什么好吃的，仅有的几家店人也超级多。随后去了步行街门口的一家店，尝了算是这里的特产的鸭血粉丝汤和一些小吃，其中灌汤包倒是很好吃，整体味道还不错，而且也不算贵。</p>
<p>老门东、夫子庙、秦淮河基本上都在一块，吃过饭后便打算直接步行去秦淮河看夜景了，天气倒也刚刚好，不热不闷，走在大街上还是挺舒服的。</p>
<p>秦淮河的夜景比预期的要差一些，一方面是人比较少，另一方面景区也比较小，也有可能是因为去的太晚了，但整体逛下来比原来想象的那种南京著名景点的感觉还是差不少。夫子庙由于去的太晚了，所以晚上也只能简单的在门口拍个照。不过话说回来，像这种古都文化的城市也许真正有意义的是其历史文化。</p>
<p>夜游行程结束到达酒店已经是晚上十一点多了。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第一天">第一天<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E7%AC%AC%E4%B8%80%E5%A4%A9" class="hash-link" aria-label="第一天的直接链接" title="第一天的直接链接">​</a></h2>
<p>第一天上午的行程计划是玄武湖、鸡鸣寺、总统府，结果因为太劳累，原本打算七点起床的，结果八点才起床，总统府的门票因为提前买的有固定时间，所以吃完早餐后就先去了那里。</p>
<p>打车大概半个多小时的样子到了景点门口，堵车很严重，于是趁停车的时候就赶紧下了车，如果要等到下车点估计至少还得堵个十几分钟。之前看攻略时说总统府的门票一定要提前一天预定，否则当天几乎买不到，果不其然，排队检票的队伍特别长，而且旁边已经提示门票售罄了。</p>
<p>提到“总统”两个字，大家应该很容易想到民国首任“临时大总统”孙中山先生，是的，总统府就是当时孙中山先生及其同事办公的地方，也可以类比为我们当代的国家中央行政单位。</p>
<p>总统府整体还是比较大的，具体的布局已经记不太清了，但是在某处看沙盘时，基本上应有的部门一个都不缺，我们熟知的教育部、工商部等等，这是令我印象比较深刻的。</p>
<p>话说在来之前听说南京博物院很有名，提前七天都约不到的那种，事实也正是如此，不过也有人说当日会放票，可以试试。有意思的是，在总统府内坐着休息的时候突发奇想，想看看能不能预约到南京博物院，没想到点进去后果真下午场有 100 多张票，赶紧下手预约成功。这样，下午的行程也由牛首山更改为南京博物院了。</p>
<p>想到玄武湖和鸡鸣寺时，已经不太想去了，一个是公园，一个就是个简单的寺庙，不同城市类似的地方已经去了很多次了，主要是也是因为时间比较紧张，天气有点炎热，不再想跑来跑去的了，这些景点错过的话倒也不觉得遗憾，如果错过南京博物院那倒是真的一大遗憾。</p>
<p>来之前，因为没有南京博物院的门票，所以计划去完总统府去牛首山的，中山陵预约到了周日早上，所以周六下午倒没有什么事情了，但牛首山据说只有几百米的海拔，山顶只不过有一个很漂亮的建筑，有很多网红来打卡，这倒不是特别令人感兴趣。以前很喜欢爬山，但都是爬那种大山，当然说不定去山顶俯瞰南京倒也是不错的选择。不过，既然预约到了南京博物院，那牛首山则可以不用去啦。</p>
<p>大概中午十二点多的样子，打车来到了南京博物院门口，放眼看去南京博物院的建筑还是挺有文化气息的。此时的天气已经比较热了，走进博物院的那一刻是多么舒服就不用多提了，空调很给力。说到这里，据说陕西省博物馆门票也日常难约，不过两地的文化不同，陕西省博物馆里面大多为青铜器，这里想必也大有不同，但春节时候去苏州博物馆时到挺令人印象深刻的，里面有江南地域的字画、丝绸藏品等等。</p>
<p>南京博物院里面比较大，要真正的看完至少也得一两个小时左右，不过没有预期的惊喜，不像网上说的那么有名，也可能是每个人的见识不同、经历不同，所以感受不一样吧。但是，来过此处此行南京便不再有遗憾了。</p>
<p>没有好好做攻略的后果就是来了南京不知道该吃什么，从博物院出来后肚子已经很饿了，打算吃完饭去看电影，于是找了家电影院附近的饭店，也算是小吃，应该挺有名的。没错，这次也少不了南京特色鸭血粉丝汤，尝起来味道也还不错，食材却没有昨晚的那家分量足，价格却是一样的。</p>
<p>饭后去看了已经上映半个多月，但口碑炸裂的《孤注一掷》，观影下来还不错，是大家关注的话题的诠释，但这个问题一直发生一直解决不了却是最值得令人深思的。</p>
<p>看完电影是旁晚时分，顺便去了不远处的玄武湖。湖上游船的人很多，还在排队，对于做了好几次的船的我来说，提不起游船的兴趣，便在湖边简单的休息了下，旁晚的天气还可以，有些许微风。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="次日">次日<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E6%AC%A1%E6%97%A5" class="hash-link" aria-label="次日的直接链接" title="次日的直接链接">​</a></h2>
<p>在充分休息了一晚之后，也迎来了短暂旅行的最后一天，今天早上起的比较早，为了赶去中山陵，因为据说中山陵耗费的时间比较长，而返程的高铁是下午五点，所以要赶在下午三点之前从中山陵出来。</p>
<p>去中山陵要先坐地铁，下了地铁后需要乘坐小公交专线才能到达中山陵的景点门口。大概早上九点多，开始排队入园。进去之后是一个餐厅，里面有卖喝的、以及糕点，顺路就买了一些糕点，味道确实不错，没有在其它地方尝过，算是一种特产吧。</p>
<p>来的时候还问了当地人，中山陵需要多长时间才能游完，有说慢点需要两个小时左右的，心里便有了数。但实际进去一看，预计一个小时足矣，如果不休息的话。</p>
<p>昨晚看了天气预报，今天似乎有雷阵雨，早晨还专门看了实时天气，显示未来几个小时不会下雨，但出门后看着天色以及吹的微风倒还是挺担心的。幸运的是，直到下午一点钟从中山陵景区往出走时天气依然很好，中途还去了音乐台，但比较令人失望，里面还在维修。</p>
<p>据说中山陵的台阶有 300 多个，象征了当时中国三亿多人民。据介绍，孙中山的遗体便在这后山之中。陵门上写着“天下为公”四个大字，在此处能感受到历史文化及其厚重感。</p>
<p>虽说中山陵里面并不大，但如果要结合导游的解说来真正的理解其包含的历史文化，不是简单的走马观花的话，两个小时倒也不为过。</p>
<p>从音乐台出来后，本打算去美龄宫再看看的，但午饭时间已过，肚子也挺饿的，就直接结束行程了，准备留点时间去商场找个餐厅吃饭顺便好好休息一下。误打误撞去了新街口的商圈，在网上简单的查了一下，发现还有一个美称“中华第一商圈”，开始还不明白，下了地铁就蒙了，地铁出口多达 20 多个，果真中华第一商圈。</p>
<p>找了一家餐厅点完菜等待的时刻，便是南京一行最后的闲暇时光了，两天的时间不长不短，该去的也去了，该看的也看了，最后离开的时候还来了个小小的震撼，倒也不虚此行。</p>
<p>此行南京，又一次说走就走的旅行。</p>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>生活</category>
            <category>旅游</category>
            <category>南京</category>
        </item>
        <item>
            <title><![CDATA[解析 Konva 设计：事件系统]]></title>
            <link>https://wang1212.github.io/2023/08/08/computer-technology/web-frontend/konva/event-system</link>
            <guid>https://wang1212.github.io/2023/08/08/computer-technology/web-frontend/konva/event-system</guid>
            <pubDate>Tue, 08 Aug 2023 21:21:00 GMT</pubDate>
            <description><![CDATA[绘图引擎支持丰富交互的前提是拥有一套事件系统，而在画布中如何拾取元素是实现的关键，从 Konva.js 的源码来看看其事件系统是如何设计的。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-06-02 19:47:00</em></p>
</blockquote>
<p>绘图引擎支持丰富交互的前提是拥有一套事件系统，而在画布中如何拾取元素是实现的关键，从 <a href="https://konvajs.org/" target="_blank" rel="noopener noreferrer">Konva.js</a> 的源码来看看其事件系统是如何设计的。</p>
<p><em>（之前分析过 ZRender 的源码实现，其采用了几何判断的方式来实现元素拾取，而 Konva.js 采用了不同的方案。）</em></p>
<!-- -->
<p>通常，画布（Canvas）元素作为原生 DOM 会提供相应的事件 APIs，但画布中绘制的内容由不同的绘图库进行抽象设计，基础元素（例如矩形、圆、线等）的事件由绘图库进行支持。</p>
<p>绘图库为了实现事件系统，一般的策略分为两步：<strong>首先，通过绑定画布元素的原生 DOM 事件来支持对用户交互事件的响应；其次，在响应画布的原生 DOM 事件时，获取坐标等信息在画布上进行元素拾取，来进一步判断触发交互事件的具体元素。</strong></p>
<p>其中，<code>Node</code> 是 Konva.js 中很重要的基类，几乎所有绘图相关的类（<code>Stage</code>、<code>Layer</code>、<code>Shape</code>）都继承自它，其实现了事件相关的 APIs（例如 <code>on()</code>、<code>off()</code> 等等）。</p>
<p>下面根据源码来分析具体逻辑的实现。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="绑定宿主环境事件">绑定宿主环境事件<a href="https://wang1212.github.io/2023/08/08/computer-technology/web-frontend/konva/event-system#%E7%BB%91%E5%AE%9A%E5%AE%BF%E4%B8%BB%E7%8E%AF%E5%A2%83%E4%BA%8B%E4%BB%B6" class="hash-link" aria-label="绑定宿主环境事件的直接链接" title="绑定宿主环境事件的直接链接">​</a></h2>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://konvajs.org/docs/overview.html</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// first we need to create a stage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> stage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Konva</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'container'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// id of container &lt;div&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  width</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  height</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>第一阶段，在 Konva.js 实例化过程中就会绑定宿主环境的事件。具体过程为，在实例化 <code>Stage</code> 时，会在内部直接绑定容器 DOM 元素的宿主事件（同时支持鼠标、触摸、指针三种类型事件）。</p>
<p>绑定宿主环境事件：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L177</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Stage</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Container</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Layer</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> StageConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">checkNoClip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_buildDOM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_bindContentEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_bindContentEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">Konva</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isBrowser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">EVENTS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">evt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">evt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> passive</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>画布元素的原生 DOM 事件的响应逻辑在 <code>Stage</code> 类中直接实现：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L589</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Stage</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Container</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Layer</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_pointermove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">evt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TouchEvent </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MouseEvent </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PointerEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPointersPositions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">evt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> processedShapesIds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> triggeredOnShape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> targetShape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_getTargetShape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_changedPointerPositions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PointerEvents</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCapturedShape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getIntersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> pointerId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> event </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> evt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pointerId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> differentTarget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> targetShape </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">differentTarget </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> targetShape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        targetShape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fireAndBubble</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointerout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">event </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        targetShape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fireAndBubble</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointerleave</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">event </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">processedShapesIds</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processedShapesIds</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isListening</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        triggeredOnShape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">differentTarget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fireAndBubble</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointerover</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">event </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetShape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fireAndBubble</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointerenter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">event </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetShape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">eventType </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'targetShape'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fireAndBubble</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointermove</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">event </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetShape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointerover</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            evt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            target</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            currentTarget</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pointerId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">eventType </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'targetShape'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">triggeredOnShape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_fire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointermove</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        evt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        currentTarget</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pointerId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_changedPointerPositions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述源码是 <code>pointermove</code> 事件的响应逻辑，其中<strong>最关键的便是对 <code>this.getIntersection(pos)</code> 的调用，这一步实现了指定坐标点的元素拾取</strong>。拾取到元素后，则会调用元素的 <code>_fireAndBubble()</code> 方法来触发用户绑定的事件回调。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L365</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Stage</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Container</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Layer</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * get visible intersection shape. This is the preferred</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   *  method for determining if a point intersects a shape or not</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@method</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@name</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Konva.Stage#getIntersection</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Object</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos.y</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Konva.Node</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@example</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * var shape = stage.getIntersection(</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">x: 50, y: 50</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getIntersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Vector2d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> layers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">children</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> layers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      n</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> layers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getIntersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>Stage</code> 类中，元素拾取过程是遍历所有的层（<code>Layer</code>），并调用其 <code>getIntersection()</code> 方法，因此真正的元素拾取逻辑实现在 <code>Layer</code> 中。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="元素拾取">元素拾取<a href="https://wang1212.github.io/2023/08/08/computer-technology/web-frontend/konva/event-system#%E5%85%83%E7%B4%A0%E6%8B%BE%E5%8F%96" class="hash-link" aria-label="元素拾取的直接链接" title="元素拾取的直接链接">​</a></h2>
<p>第二阶段，是元素拾取的具体实现，Konva.js 采用了<strong>缓存 Canvas 颜色拾取（Color Pick）</strong> 的判定策略，意味着<strong>每一个 <code>Layer</code> 都对应着两个 Canvas 元素：用于渲染的场景画布（SceneCanvas）和用于元素拾取的命中测试缓存画布（HitCanvas）。</strong></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Layer.ts#L57</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Layer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Container</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Group </span><span class="token class-name operator" style="color:#393A34">|</span><span class="token class-name"> Shape</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  canvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SceneCanvas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  hitCanvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HitCanvas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    pixelRatio</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>来看看 <code>getIntersection()</code> 方法是如何实现的：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Layer.ts#L321</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Layer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Container</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Group </span><span class="token class-name operator" style="color:#393A34">|</span><span class="token class-name"> Shape</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * get visible intersection shape. This is the preferred</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * method for determining if a point intersects a shape or not</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * also you may pass optional selector parameter to return ancestor of intersected shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@method</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@name</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Konva.Layer#getIntersection</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Object</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos.y</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Konva.Node</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@example</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * var shape = layer.getIntersection(</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">x: 50, y: 50</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getIntersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Vector2d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isListening</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isVisible</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// in some cases antialiased area may be bigger than 1px</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// it is possible if we will cache node, then scale it a lot</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> spiralSearchDistance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> continueSearch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">INTERSECTION_OFFSETS_LEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> intersectionOffset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">INTERSECTION_OFFSETS</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_getIntersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          x</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> intersectionOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> spiralSearchDistance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          y</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> intersectionOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> spiralSearchDistance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// we should continue search if we found antialiased pixel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// that means our node somewhere very close</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        continueSearch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">antialiased</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// stop search if found empty pixel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">antialiased</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// if no shape, and no antialiased pixel, we should end searching</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">continueSearch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        spiralSearchDistance </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_getIntersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Vector2d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> shape</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Shape</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> antialiased</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ratio </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hitCanvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pixelRatio</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hitCanvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getImageData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ratio</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ratio</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> p3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// fully opaque pixel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p3 </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> colorKey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_rgbToHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shape </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shapes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">HASH</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> colorKey</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          shape</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        antialiased</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p3 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// antialiased pixel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        antialiased</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// empty pixel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据以上源码来看，<strong>首先以拾取坐标为中心的 2×2 矩形中找出 5 个关键点（<code>INTERSECTION_OFFSETS</code>，中心和四个顶点）进行遍历，分别通过调用缓存画布（hitCanvas）的 <code>getImageData()</code> 来获取坐标点的像素值，然后在颜色与图形元素实例的映射表 <code>shapes</code> 中找到目标元素</strong>。这个过程中，实际上也考虑了抗锯齿像素对元素拾取产生的影响。</p>
<p>每一个元素实例都有一个唯一的 <code>colorKey</code>：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L184</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Shape</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Config </span><span class="token class-name keyword" style="color:#00009f">extends</span><span class="token class-name"> ShapeConfig </span><span class="token class-name operator" style="color:#393A34">=</span><span class="token class-name"> ShapeConfig</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Config</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// set colorKey</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRandomColor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> shapes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">colorKey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    shapes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每一个元素会同时在渲染画布和缓存画布中绘制一遍：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L572</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Shape</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Config </span><span class="token class-name keyword" style="color:#00009f">extends</span><span class="token class-name"> ShapeConfig </span><span class="token class-name operator" style="color:#393A34">=</span><span class="token class-name"> ShapeConfig</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Config</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getSceneFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sceneFunc </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'_sceneFunc'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getHitFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hitFunc </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'_hitFunc'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">drawScene</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">can</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SceneCanvas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bufferCanvas</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SceneCanvas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> canvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> can </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> layer</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCanvas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> canvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> SceneContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cachedCanvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_getCanvasCache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      drawFunc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSceneFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">drawHit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">can</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> HitCanvas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> skipDragCheck </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> layer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLayer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      canvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> can </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> layer</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hitCanvas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> canvas </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> canvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      drawFunc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hitFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sceneFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据源码可以看到，绘制时分别调用了 <code>sceneFunc()</code> 和 <code>hitFunc()</code>，但前者作为后者的备选项，也就是说默认情况下渲染两次实际上调用的都是 <code>sceneFunc()</code>，确保图形元素的绘制结果（即形状）一致（<code>hitFunc()</code> 可以自定义实现，参考<a href="https://konvajs.org/docs/events/Custom_Hit_Region.html" target="_blank" rel="noopener noreferrer">文档</a>）。不同的是，缓存画布中绘制时使用了元素的 <code>colorKey</code> 对应的颜色：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Context.ts#L984</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">HitContext</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Context</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_stroke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasHitStroke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ignore strokeScaleEnabled for Text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> strokeScaleEnabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStrokeScaleEnabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">strokeScaleEnabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> pixelRatio </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCanvas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPixelRatio</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pixelRatio</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pixelRatio</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_applyLineCap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> hitStrokeWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hitStrokeWidth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> strokeWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hitStrokeWidth </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'auto'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">strokeWidth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> hitStrokeWidth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAttr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'lineWidth'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strokeWidth</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAttr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'strokeStyle'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">colorKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_strokeFuncHit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">strokeScaleEnabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">restore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上就是 Konva.js 事件系统实现的大致原理。简单的来说，<strong>Konva.js 会在实例化每个元素时，为其生成一个 <code>colorKey</code>，该值实际上代表一个随机颜色，在绘制该元素时，会以该随机颜色为填充色将该元素图形同时绘制在缓存画布（HitCanvas）中，当用户在渲染画布（SceneCanvas）中进行交互时，会根据触发的 DOM 事件得到一个坐标，根据该坐标从缓存画布（HitCanvas）中拾取像素值，再根据该色值从元素与颜色映射表中获取元素实例。</strong></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="延伸重叠元素的拾取">延伸：重叠元素的拾取<a href="https://wang1212.github.io/2023/08/08/computer-technology/web-frontend/konva/event-system#%E5%BB%B6%E4%BC%B8%E9%87%8D%E5%8F%A0%E5%85%83%E7%B4%A0%E7%9A%84%E6%8B%BE%E5%8F%96" class="hash-link" aria-label="延伸：重叠元素的拾取的直接链接" title="延伸：重叠元素的拾取的直接链接">​</a></h2>
<p>上述分析中，实际上没有考虑到当多个元素在同一个坐标点重叠时的情况。根据上述实现，在渲染过程中，在同一个坐标点上后渲染的元素会覆盖掉之前渲染元素的颜色，最终拾取时得到的是最后一次渲染元素的颜色，这适用于大多数业务场景，仅获取最顶层元素。</p>
<p>实际上，Konva.js 提供了一个拾取重叠元素的 APIs <a href="https://konvajs.org/api/Konva.Stage.html#getAllIntersections__anchor" target="_blank" rel="noopener noreferrer"><code>getAllIntersections()</code></a>，来看看其源码实现：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Container.ts#L317</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">abstract</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Container</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">ChildType </span><span class="token class-name keyword" style="color:#00009f">extends</span><span class="token class-name"> Node </span><span class="token class-name operator" style="color:#393A34">=</span><span class="token class-name"> Node</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">ContainerConfig</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * get all shapes that intersect a point.  Note: because this method must clear a temporary</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * canvas and redraw every shape inside the container, it should only be used for special situations</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * because it performs very poorly.  Please use the </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@link</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Konva.Stage#getIntersection</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> method if at all possible</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * because it performs much better</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@method</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@name</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Konva.Container#getAllIntersections</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Object</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> pos.y</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Array</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> array of shapes</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getAllIntersections</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arr</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">find</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">Shape</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Shape'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isVisible</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">intersects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        arr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> arr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>遍历场景中的所有可见元素，并调用元素的 <code>intersects()</code> 方法进行相交测试：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L440</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Shape</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Config </span><span class="token class-name keyword" style="color:#00009f">extends</span><span class="token class-name"> ShapeConfig </span><span class="token class-name operator" style="color:#393A34">=</span><span class="token class-name"> ShapeConfig</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">Config</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * determines if point is in the shape, regardless if other shapes are on top of it.  Note: because</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   *  this method clears a temporary canvas and then redraws the shape, it performs very poorly if executed many times</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   *  consecutively.  Please use the </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@link</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Konva.Stage#getIntersection</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> method if at all possible</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   *  because it performs much better</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@method</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@name</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Konva.Shape#intersects</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Object</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> point</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> point.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Number</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> point.y</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">Boolean</span><span class="token doc-comment comment punctuation" style="color:#393A34;font-style:italic">}</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">intersects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> stage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">stage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bufferHitCanvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bufferHitCanvas</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bufferHitCanvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">drawHit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bufferHitCanvas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bufferHitCanvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getImageData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>依次将每个元素的缓存图像数据绘制到全局的缓存画布中，并拾取坐标点的像素颜色来判断是否相交。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/2023/08/08/computer-technology/web-frontend/konva/event-system#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://konvajs.org/" target="_blank" rel="noopener noreferrer">https://konvajs.org/</a></li>
<li><a href="https://konvajs.org/docs/events/Image_Events.html" target="_blank" rel="noopener noreferrer">https://konvajs.org/docs/events/Image_Events.html</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>Web 前端</category>
            <category>数据可视化</category>
            <category>Konva.js</category>
            <category>Canvas</category>
            <category>源码解析</category>
        </item>
        <item>
            <title><![CDATA[谈谈笔记记录和知识管理工具]]></title>
            <link>https://wang1212.github.io/2023/07/22/tools/notes-app</link>
            <guid>https://wang1212.github.io/2023/07/22/tools/notes-app</guid>
            <pubDate>Sat, 22 Jul 2023 23:00:00 GMT</pubDate>
            <description><![CDATA[对于大部分人来说，有一个适合自己需求，同时免费又好用的笔记应用或者知识管理工具是很难得的。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-07-22 23:00:00</em></p>
</blockquote>
<p>不管是在学校还是工作后，记录一直是个很好的习惯，方便积累经验并阶段性进行回顾总结。因此，对于大部分人来说，有一个适合自己需求，同时免费又好用的笔记应用或者知识管理工具是很难得的。</p>
<p>从大学开始就一直在坚持更新博客，期间有相当长一段时间博客几乎没怎么更新过，不过终归还是坚持下来了。随着时间的推移，发现认真写一篇博文耗费的时间成本太高，要么只能在周末抽空，要么就断断续续几天才能写完，这也直接导致坚持更新博客的难度加大。其实这件事情的本质不是对于记录这个行为本身产生了懈怠，而是有很多可以用来记录的小事，但要将其发布成一篇篇博文的代价太大，追求效率就容易在质量上大打折扣，还不如不写。以至于现在每每回过头来看，积攒了大量的待完成的小任务，而整理这些小任务也不是那么容易。</p>
<p>说了这么多，问题的本质在于平时一些小的知识记录缺乏一个比较有效的管理工具应用，因为以前都是直接用 Markdown 编辑器和文件夹进行管理的，为了方便同步，还会用网易有道云笔记这类软件进行记录，但一直觉得不怎么好用。</p>
<p>最开始使用的是 <a href="https://www.typora.io/" target="_blank" rel="noopener noreferrer">typora</a> 的测试版，因为其可以免费使用，后来其正式版发布后收费了就弃用了。有很多人说可以用破解版，我倒觉得没有必要，如此良心的软件，付不起钱就换个免费的吧。后来换了 <a href="https://www.zettlr.com/" target="_blank" rel="noopener noreferrer">Zettlr</a>，用了相当长一段时间，其功能和 UI 交互体验一直觉得很别扭，有时候觉得甚至不如在 VSCode 里面直接写 Markdown 来得方便。后来又改用 <a href="https://github.com/marktext/marktext" target="_blank" rel="noopener noreferrer">MarkText</a>，体验要好很多，不过这个开源项目好像维护的频率很低了。以上都只是 Markdown 文件编辑器，后来就开始慢慢了解一些笔记应用了。</p>
<p>Notable、VNote、Anki 这些简单的笔记应用都了解过，但始终觉得不是自己想要的东西。后来了解到了 <a href="https://joplinapp.org/" target="_blank" rel="noopener noreferrer">Joplin</a>，发现其比较契合自己的需求，简单使用了之后，发现其同步功能使用起来太麻烦，还有一些其它细节上的问题不是很合意，就放弃长期使用了。在这期间，还了解过一个开源的知识管理工具 <a href="https://github.com/zadam/trilium" target="_blank" rel="noopener noreferrer">Trilium Notes</a>，其功能异常强大，但也相当复杂，上手成本太高，一直没怎么有时间去仔细研究，而且也不支持中文，看作者的意思短期内也不打算支持。折腾了一圈后，还是暂时回到 Markdown 编辑器了。</p>
<p>直到近期，在看 ThoughtWorks Technology Radar 时，不经意看到博文里提到了团队知识管理工具，其中简单对比了 <a href="https://obsidian.md/" target="_blank" rel="noopener noreferrer">Obsidian</a> 和 <a href="https://logseq.com/" target="_blank" rel="noopener noreferrer">Logseq</a> 这两个工具，一时间竟引起了我的兴趣。知识图谱这个概念这几年听的比较多，但从没想过个人笔记记录和这个会产生什么关联。在简单的了解了这两款工具应用后，就联想到了 Trilium Notes，不同的是，前两者可能上手成本低一些，用户体验应该也会更好一些。遂打算下载安装试用一下，在简单的试用过后，发现 Logseq 这个应用比较好用，而且也是个开源社区维护的软件，对于一直偏爱于开源软件的我来说最合适不过了。</p>
<p>Obsidian 是一个商业软件，但对个人用户免费，也提供一些收费的增值服务，简单调研过后发现用户群应该也不少，而且口碑也很好，但我倒不怎么喜欢在个人的事情上用一些商业软件。**Obsidian 与 Logseq 有一个很大的不同点在于，前者是以大家熟悉的文件夹形式管理笔记的，但后者却是以块的形式和链接引用的方式来管理笔记，虽然它们都是基于图数据库的。**在一直写博客的过程中遇到过基于文件夹管理的文章，有时候很难做文件夹分类，而 Logseq 这种模式就感觉很适合，尤其是记录平时一些零碎的事情的时候。在使用了一段时间后，也了解了一些其它人使用后的对比体验和总结，<strong>发现像 Logseq 这种基于块的模式，写以前那种具有上下文的完整的一篇文章倒不是那么容易。</strong></p>
<p>最终，在深度使用后，发现 Logseq 可以解决以前零散的知识记录不好管理的问题，博客可以继续坚持更新，博文像是对平时记录的一些知识的一个全方位的总结，更具有意义。另一方面，Logseq 自身的功能以及插件提供的一些功能很方便，例如绘图、任务管理等等，这些都是平时记录东西或者做规划很常用的功能。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考">参考<a href="https://wang1212.github.io/2023/07/22/tools/notes-app#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://www.typora.io/" target="_blank" rel="noopener noreferrer">https://www.typora.io/</a></li>
<li><a href="https://www.zettlr.com/" target="_blank" rel="noopener noreferrer">https://www.zettlr.com/</a></li>
<li><a href="https://github.com/marktext/marktext" target="_blank" rel="noopener noreferrer">https://github.com/marktext/marktext</a></li>
<li><a href="https://joplinapp.org/" target="_blank" rel="noopener noreferrer">https://joplinapp.org/</a></li>
<li><a href="https://obsidian.md/" target="_blank" rel="noopener noreferrer">https://obsidian.md/</a></li>
<li><a href="https://logseq.com/" target="_blank" rel="noopener noreferrer">https://logseq.com/</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>工具</category>
            <category>笔记</category>
            <category>知识管理</category>
            <category>随笔杂谈</category>
        </item>
        <item>
            <title><![CDATA[结合 AI 技术构建可视化知识库的尝试]]></title>
            <link>https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base</link>
            <guid>https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base</guid>
            <pubDate>Mon, 19 Jun 2023 22:30:00 GMT</pubDate>
            <description><![CDATA[在 OpenAI 引领 AI 技术潮流的当下，LLM 成为很多企业跃跃欲试并尝试进行商业化的一个重要技术领域，其中结合 AI 技术进行知识库构建成为了开源社区在该领域最成功的经典案例，恰好团队也有机会基于此进行探索尝试。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2024-01-27 20:37:00</em></p>
</blockquote>
<p>在 OpenAI 引领 AI 技术潮流的当下，LLM 成为很多企业跃跃欲试并尝试进行商业化的一个重要技术领域，其中结合 AI 技术进行知识库构建成为了开源社区在该领域最成功的经典案例，恰好团队也有机会基于此进行探索尝试。</p>
<p>有此机会也是因为目前业务侧也在探索 AI 落地的应用场景和可能性，利用社区已经成熟的经验在团队基建方面进行探索尝试也是熟悉 AI 相关技术应用的一个很好的途径。</p>
<p>目前，利用 LLM 构建知识库，其核心是<strong>基于向量搜索（Vector Search）和机器学习（Machine Learning）技术提升搜索的效率和准确性</strong>，简单来说传统的搜索是基于关键字匹配，当你无法了解查找的目标的信息和关键字时，你可以以你认为相近的描述信息进行搜索，这大大增强了搜索体验。</p>
<blockquote>
<p>关于向量搜索推荐参考 <a href="https://www.elastic.co/cn/what-is/vector-search" target="_blank" rel="noopener noreferrer">Elastic 官方对其的描述</a>。</p>
</blockquote>
<p>站在业务层面来看，数据可视化属于一个细分领域，有一定的专业门槛，基于此提升普通开发者使用文档的搜索体验是再合适不过了。初期，我们主要关注的是文本数据的检索。</p>
<p>具体的技术方案可以大致概括为以下两个部分。</p>
<p>首先，准备数据集构建向量数据库：</p>
<!-- -->
<p>然后，实现向量搜素和 LLM 文本生成的查询链路：</p>
<!-- -->
<p>为了快速验证技术可行性，我们直接采用 <a href="https://www.langchain.com/" target="_blank" rel="noopener noreferrer">LangChain</a> 框架来构建产品原型。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="构建向量数据库">构建向量数据库<a href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base#%E6%9E%84%E5%BB%BA%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93" class="hash-link" aria-label="构建向量数据库的直接链接" title="构建向量数据库的直接链接">​</a></h2>
<p>虽然整个技术路径开源社区已有大量的成熟经验可供参考，但<strong>关键环节在于数据预处理和分割策略要视需求和具体情况而进行选择，其会对最终效果产生显著影响。</strong></p>
<p>近半年来，关于 AI 相关的商业化尝试也是一直备受关注，有一家创业公司的产品 <a href="https://markprompt.com/" target="_blank" rel="noopener noreferrer">MarkPrompt</a> 目标是解决技术文档的检索问题，与我们的需求非常相似。在其一篇<a href="https://markprompt.com/blog/content-structure" target="_blank" rel="noopener noreferrer">博客文章</a>中我们了解到了他们是如何处理技术文档的，再结合一些其它参考资料，我们最终选择也采用类似的策略，即<strong>技术文档一般大多以 Markdown 格式存在且篇幅较少，对其按标题为单位进行分割，构建向量数据库记录。</strong></p>
<p>此时，有三个问题待解决：</p>
<ol>
<li>收集原始数据，得到 Markdown 格式数据集；</li>
<li>实现对 Markdown 文件按标题进行分割；</li>
<li>选择向量数据库。</li>
</ol>
<p>第一步，考虑到方便后期对原始文档进行引用，不直接用文档的 Markdown 源文件，而是将在线文档网页抓取下来，利用工具库将 HTML 文件先进行预处理，去掉多余无用信息再转换为 Markdown 格式，同时保存其<strong>元信息</strong>。由于技术文档本身的简单性，效果还是不错的，这样也能兼顾到源文件不是 Markdown 格式的数据。</p>
<p>第二步，由于 LangChain 框架提供了一些处理文档的组件，所以寄希望于最好能用现成的方案，遗憾的是当时 LangChain 的 JavaScript 实现中并没有提供相关组件。不过，在查看 LangChain 的 Python 版本文档时，却发现了社区近期贡献的一个组件（<code>MarkdownHeaderTextSplitter</code>）刚好能满足按标题对 Markdown 文件进行分割的需求，这就致使了我们数据处理环节本来打算使用更熟悉的 Node 技术栈实现，结果最终全用了 Python 技术栈，不过代码倒也不复杂。</p>
<p>问题基本都顺利解决了，来到最后一步，向量数据库的选择。经过简单的调研，了解到 Redis 支持向量搜索，但目前公司内部运维资源具体情况也不太清楚，而且没有前端团队有过类似成功案例可借鉴，考虑到为了快速验证可行性和迅速上线测试版，寻求基于本地文件的向量数据库实现，Python 倒是有，但是目前线上只有 Node 服务环境，只能先看看有没有 Node 方案。</p>
<p>经过查找，找到了<strong>基于本地文件的向量数据库</strong>的 Node 方案 <a href="https://github.com/Stevenic/vectra#readme" target="_blank" rel="noopener noreferrer">vectra</a>，尴尬的是该库目前是 0.0.1 版本，而且发布于半个月前，不得已的情况下仔细看了其文档和源码大致的实现后，确定应该问题不大能满足基本需求，做了简单的验证后遂采用了此方案。</p>
<p>至此，以上三个问题均已解决。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文本嵌入服务">文本嵌入服务<a href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base#%E6%96%87%E6%9C%AC%E5%B5%8C%E5%85%A5%E6%9C%8D%E5%8A%A1" class="hash-link" aria-label="文本嵌入服务的直接链接" title="文本嵌入服务的直接链接">​</a></h2>
<p>实际上，这里面有一个重要的概念需要简单的解释一下，即文本数据是如何转换为向量数据入库的？</p>
<p>这里使用到了机器学习领域的<a href="https://en.wikipedia.org/wiki/Word_embedding" target="_blank" rel="noopener noreferrer">嵌入（Embeddings）</a>技术，简单来说就是<strong>将高维数据编码为低维空间的向量数据，在这里就是将文本数据编码为向量数据（数学表示形式）。</strong></p>
<p>公司内部提供了 OpenAI 的嵌入服务接口资源，但是每个团队有配额，考虑到上线后的调用量会消耗大量的 Token，做缓存的话初期比较麻烦，随即转变思路，结合前段时间对 AI 技术应用的一些细节的了解，<strong>一个大任务往往是由多个环节，甚至多个大小模型配合完成的</strong>，那嵌入服务是否也可以寻找开源方案自己部署呢？</p>
<p>当然是可以的，LangChain 就提供了基于 Google 的 <a href="https://js.langchain.com/docs/integrations/text_embedding/tensorflow" target="_blank" rel="noopener noreferrer">TensorFlow 机器学习框架的本地离线嵌入方案</a>，其使用的是 Google <a href="https://www.kaggle.com/models/google/universal-sentence-encoder/frameworks/TensorFlow1/variations/lite/versions/1" target="_blank" rel="noopener noreferrer">universal-sentence-encoder</a> 模型的 Lite 版本。</p>
<p>这个时候，出现了一个致命问题，即 Google 的这个嵌入模型只对英文进行了预训练，虽然在文档中找到了支持其它语言的方案，但效果肯定无法达到预期。比较幸运的是，公司内部有做 NLP 的团队，经过和同事沟通过后，推荐了<strong>专门针对中文做了预训练优化</strong>的 <a href="https://huggingface.co/moka-ai/m3e-small" target="_blank" rel="noopener noreferrer">m3e 嵌入模型</a>，经过简单调研和验证其效果确实不错。在 Hugging Face 上可以看到其有两个版本，我们初期选择了 m3e-small 版本，资源占用低，效果也能达到预期。</p>
<p>至此，使用 <a href="https://www.sbert.net/" target="_blank" rel="noopener noreferrer">SentenceTransformer</a> 框架配合 Flask 服务框架，寥寥几行代码就能实现在本地部署一个文本嵌入服务。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sentence_transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SentenceTransformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># model = SentenceTransformer('moka-ai/m3e-base')</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SentenceTransformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'moka-ai/m3e-small'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"&lt;p&gt;Hello, World!&lt;/p&gt;"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/embeddings"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'POST'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">embeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'texts'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"code"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"data"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"vectors"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="实现查询链路">实现查询链路<a href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base#%E5%AE%9E%E7%8E%B0%E6%9F%A5%E8%AF%A2%E9%93%BE%E8%B7%AF" class="hash-link" aria-label="实现查询链路的直接链接" title="实现查询链路的直接链接">​</a></h2>
<p>接下来就是实现具体的查询链路了，也是结合 LLM 构建知识库的优势所在。</p>
<p><strong>首先将用户的问句文本进行嵌入，转换为向量数据，再通过相似度匹配从之前构建的向量数据库中召回 TopK（一般选择 5 条）的记录，然后根据这些结果构建提示词（Prompt）模板，调用 LLM 的文本生成服务，获取到模型的输出结果，再做一定处理后返回给用户。</strong></p>
<p>整条查询链路较长，实际上最简化的版本不需要工程手段介入，但效果会比较差，之所以需要工程手段介入是因为根据具体的需求场景可以定制化，得到更好的结果。</p>
<p>例如，在构建向量数据库的过程中我们保留了每条记录的一些元信息，例如链接引用，这样就可以在得到 LLM 的输出后，再添加相关的链接信息，帮助用户在得不到预期的结果时，还可以主动查看相关的引用信息。</p>
<p>另外，为了使结果的信息展现更丰富（包含纯文本、代码片段、链接、图片等），会在提示词模板中要求 LLM 返回 Markdown 格式的结果，我们再渲染到页面上，为了保证结果的稳定性，我们还会对 LLM 的 Markdown 输出做进一步的校正。</p>
<p>所以，查询链路的实现关键在于<strong>如何结合多种能力将同一件事情做的更好</strong>。随着 LLM 的 Token 限制越来越宽容，我们可以在提示词中加入更多内容，这也催生了大量的优化手段来确保输出的质量，其中值得关注的是 RAG（retrieval augmented generation，检索增强生成）技术，可以参考 StackOverflow 一篇<a href="https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/" target="_blank" rel="noopener noreferrer">博文</a>对其的介绍。</p>
<p>总的来说，借此机会我们对构建 AIGC 产品涉及的技术有了进一步的了解，认识到目前 LLM 的能力域和局限性，当然更多的是 AI 技术带来的产品构建的想象力是值得我们对其持续关注的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://www.elastic.co/cn/what-is/vector-search" target="_blank" rel="noopener noreferrer">https://www.elastic.co/cn/what-is/vector-search</a></li>
<li><a href="https://en.wikipedia.org/wiki/Word_embedding" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Word_embedding</a></li>
<li><a href="https://js.langchain.com/docs/get_started/introduction" target="_blank" rel="noopener noreferrer">https://js.langchain.com/docs/get_started/introduction</a></li>
<li><a href="https://flask.palletsprojects.com/en/" target="_blank" rel="noopener noreferrer">https://flask.palletsprojects.com/en/</a></li>
<li><a href="https://huggingface.co/moka-ai/m3e-small" target="_blank" rel="noopener noreferrer">https://huggingface.co/moka-ai/m3e-small</a></li>
<li><a href="https://www.sbert.net/" target="_blank" rel="noopener noreferrer">https://www.sbert.net/</a></li>
<li><a href="https://www.tensorflow.org/js" target="_blank" rel="noopener noreferrer">https://www.tensorflow.org/js</a></li>
<li><a href="https://www.kaggle.com/models/tensorflow/universal-sentence-encoder" target="_blank" rel="noopener noreferrer">https://www.kaggle.com/models/tensorflow/universal-sentence-encoder</a></li>
<li><a href="https://github.com/Stevenic/vectra#readme" target="_blank" rel="noopener noreferrer">https://github.com/Stevenic/vectra#readme</a></li>
<li><a href="https://markprompt.com/blog/content-structure" target="_blank" rel="noopener noreferrer">https://markprompt.com/blog/content-structure</a></li>
<li><a href="https://www.pinecone.io/learn/chunking-strategies/" target="_blank" rel="noopener noreferrer">https://www.pinecone.io/learn/chunking-strategies/</a></li>
<li><a href="https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/" target="_blank" rel="noopener noreferrer">https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>AI</category>
            <category>向量搜索</category>
            <category>LangChain</category>
            <category>实践案例</category>
        </item>
        <item>
            <title><![CDATA[通过 Node.js 自定义加载器运行代码]]></title>
            <link>https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader</link>
            <guid>https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader</guid>
            <pubDate>Sun, 28 May 2023 23:07:00 GMT</pubDate>
            <description><![CDATA[鉴于 Node.js 的诸多历史遗留原因，目前文件有多种扩展名，在文件引用时很多开发者习惯不写扩展名，这在 ES Modules 代码中需要额外的命令行 flag 才能实现。但在 Node.js v19 的版本发布后，其中 `--experimental-specifier-resolution` 命令行 flag 被删除，为了能继续运行无扩展名的 ES Modules 代码，就需要借助自定义加载器来实现。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-05-28 23:07:00</em></p>
</blockquote>
<p>鉴于 Node.js 的诸多历史遗留原因，目前文件有多种扩展名，在文件引用时很多开发者习惯不写扩展名，这在 ES Modules 代码中需要额外的命令行 flag 才能实现。但在 Node.js v19 的版本发布后，其中 <code>--experimental-specifier-resolution</code> 命令行 flag 被删除，为了能继续运行无扩展名的 ES Modules 代码，就需要借助自定义加载器来实现。</p>
<p>目前，Node.js 文件的扩展名就有数种，比如常见的 <code>.js</code>、<code>.mjs</code>、<code>.cjs</code>、<code>.node</code>，之所以有这些东西存在，是因为了 Node.js 从最初的版本发展到现在，已历经了数个大版本的更新，有很沉重的历史包袱。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="commonjs扩展名不是必须的">CommonJS：扩展名不是必须的<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#commonjs%E6%89%A9%E5%B1%95%E5%90%8D%E4%B8%8D%E6%98%AF%E5%BF%85%E9%A1%BB%E7%9A%84" class="hash-link" aria-label="CommonJS：扩展名不是必须的的直接链接" title="CommonJS：扩展名不是必须的的直接链接">​</a></h3>
<p>相信很多使用 Node.js 的开发者目前熟悉的应该是 CommonJS 风格，其中<strong>不需要强制在代码中写文件的扩展名</strong>，这实际上和其它后端语言体验一致。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./foo.js'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// work!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./foo'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// work too!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="es-modules扩展名是必须的">ES Modules：扩展名是必须的<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#es-modules%E6%89%A9%E5%B1%95%E5%90%8D%E6%98%AF%E5%BF%85%E9%A1%BB%E7%9A%84" class="hash-link" aria-label="ES Modules：扩展名是必须的的直接链接" title="ES Modules：扩展名是必须的的直接链接">​</a></h3>
<p>在现如今 Node.js 已全面支持 ES Modules 的情况下，<strong>使用 ES Modules 编写代码默认必须写文件的扩展名</strong>，据官方文档说明，这与浏览器环境下的 <code>import</code> 行为一致。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#393A34">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#00009f">as</span><span class="token imports"> foo</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./foo.js'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// work!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#393A34">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#00009f">as</span><span class="token imports"> foo</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./foo'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// error, not work!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="--experimental-specifier-resolutionnode"><code>--experimental-specifier-resolution=node</code><a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#--experimental-specifier-resolutionnode" class="hash-link" aria-label="--experimental-specifier-resolutionnode的直接链接" title="--experimental-specifier-resolutionnode的直接链接">​</a></h3>
<p>为了实现用 ES Modules 编写代码，又不需要写文件扩展名，Node.js 在很久以前就给出了一个命令行的 flag 来应对这类问题。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ node --experimental-specifier-resolution=node index.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不过，近期在使用 Node.js v20 版本时，突然发现该 flag 失效了，导致写的没有扩展名的 ES Modules 代码无法运行。遂开始查阅官方文档，发现在 v18 的文档中该 flag 还可以索引，v20 的文档中已经无法索引了，在后续查阅资料的过程中终于从 <a href="https://nodejs.org/en/blog/announcements/v19-release-announce#custom-esm-resolution-adjustments" target="_blank" rel="noopener noreferrer">Node.js 的 v19 发布公告</a>中发现了问题。</p>
<blockquote>
<p>Node.js has removed the --experimental-specifier-resolution flag. Its functionality can now be achieved via custom loaders.</p>
</blockquote>
<p>Node.js v18 将是最后一个可以使用 <code>--experimental-specifier-resolution</code> 命令行 flag 的大版本。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="自定义加载器">自定义加载器<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A0%E8%BD%BD%E5%99%A8" class="hash-link" aria-label="自定义加载器的直接链接" title="自定义加载器的直接链接">​</a></h3>
<p>相信这一变化给很多人造成了困扰，对于我也是。官方给的方案是<strong>自定义加载器</strong>，但没有具体的文档说明，只能在 <a href="https://github.com/nodejs/node/pull/44859" target="_blank" rel="noopener noreferrer">v19 发布公告中提及的 Github Issue</a> 中寻得蛛丝马迹。</p>
<p>最终，为了解决这个问题，需要安装一个官方提供的<a href="https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader" target="_blank" rel="noopener noreferrer">自定义加载器包</a>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ npm i commonjs-extension-resolution-loader</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后改变运行文件的命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 以前</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ node --experimental-specifier-resolution=node index.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 现在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ node --experimental-loader=commonjs-extension-resolution-loader index.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但需要注意的是，使用该自定义加载器运行代码，如果遇到第三方包是 ES Modules，且没有指定 <code>package.json</code> 文件中的 <code>main</code> 字段将会出现找不到模块的错误。这是因为 CommonJS 规范模块解析依赖 <code>main</code> 字段，而 ES Modules 规范则推荐使用 <code>exports</code> 字段指定模块入口文件，详见<a href="https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points" target="_blank" rel="noopener noreferrer">官方文档</a>。</p>
<p>鉴于以上情况，如果是新项目，而且采用 ES Modules 编写代码，那还是带上文件扩展名遵循其规范比较好，放弃采用 flag 以及自定义加载器的方式运行代码，毕竟会带来一些额外的问题。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h3>
<ul>
<li><a href="https://nodejs.org/en/blog/announcements/v19-release-announce" target="_blank" rel="noopener noreferrer">https://nodejs.org/en/blog/announcements/v19-release-announce</a></li>
<li><a href="https://nodejs.org/docs/latest-v18.x/api/cli.html#--experimental-specifier-resolutionmode" target="_blank" rel="noopener noreferrer">https://nodejs.org/docs/latest-v18.x/api/cli.html#--experimental-specifier-resolutionmode</a></li>
<li><a href="https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader" target="_blank" rel="noopener noreferrer">https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader</a></li>
<li><a href="https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points" target="_blank" rel="noopener noreferrer">https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>Node.js</category>
        </item>
        <item>
            <title><![CDATA[WebGPU – Web 平台的通用计算 API]]></title>
            <link>https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu</link>
            <guid>https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu</guid>
            <pubDate>Sun, 14 May 2023 15:42:00 GMT</pubDate>
            <description><![CDATA[随着 Chrome v113 的发布，WebGPU API 已正式可用，预计其它平台也将很快发布正式支持，WebGPU 为 Web 平台现代 3D 图形化开发提供了一流的支持，不过相比于在 3D 图形开发领域的发展，其还有一个更值得关注的目标，即为 Web 平台带来通用计算 API 的一流支持。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-05-14 15:42:00</em></p>
</blockquote>
<p>随着 Chrome v113 的发布，WebGPU API 已正式可用，预计其它平台也将很快发布正式支持，WebGPU 为 Web 平台现代 3D 图形开发提供了一流的支持，不过相比于在 3D 图形开发领域的发展，其还有一个更值得关注的目标，即为 Web 平台带来通用计算 API 的一流支持。</p>
<p><img decoding="async" loading="lazy" alt="chrome113" src="data:image/webp;base64,UklGRnAhAABXRUJQVlA4WAoAAAAQAAAA7QIAdQEAQUxQSDsAAAABF9D/iAgwjiSpDd5kRRLknw4vkF4d0f8JCDdf+I//+I//+I//+I//+I//+I//+I//+I///jL+W/vsBABWUDggDiEAAJDAAJ0BKu4CdgE+kUifTCWkIyIikdkIsBIJZ278Ljl7X1ix5d/gbUZ3f7Uer949miQOfFvyn8pe3HnAP4B/gulr/+vQB///S49D/oAdJD/8fUA8uT2gP7vkr3mH+3drP9/+17s9/Pnuhy8/Q/8LzS/jn3I/M/2j2z/z3+38MflfqC/j/8k/135dcGgAD62f8j/B+Md87epn2c9gD+Y/1z/j/3LzwfCE9S9gT+bf3r9ofd1/uv249CX1P+1/wKfsJ/3/8N7dHsc9J0TfQzCGYQzCGYQzCGYQzCGYQzCGYOO9ruMGw22G2w22G2w22G2w22G2w22G2w3ouHPexAC9wXuC9wXuC9wXuC9wXuC9wXuC9YIqcooZfzL+ZfzL+ZfzL+ZfzL+ZfzL+Zfgsb9TpUzbYbbDbYbbDbYbbDbYbbDbYbbDaFsO3rAehmEMwhmEMwhmEMwhmEMwhmEMy6Bzhp4o4LCBL971CrkFVe5t0dyxnA2Q7A/4Grv3+mqz0oz8EcuXqqSvmxjgcDwdoCeKWhZLjgW1iavLjEbg11kLgxC74x3+hmELqDbTyAWfU65XEZ/sqntPq9kOJ/ROKMQSVq2vrJRqRPoh4UWWSET1JmfkLXI1VjH2b9cbWbUxHx5aO/g+C+tbZjZcTCUSf5c4+4aRPhKeP1f2eLs0OG2hJcC+ljibwul5fiP7yi+Z2AnjplolHfpath2DBJ1l17FEWC9aGrP1XlHO4C8GrPoIjLcYsILliwlZXCapzE1fDLygLY0JsyRafRF3pjHbHUCwCQs5y9RIdKb1L3b1SgDAEOmDAgeoKxeShAxGfeMWX8nTVfKpmB/TYuN3pGT8YeaczJ+pt5GAWT0cjurn2kWpSBP4OGQIFYfFVVMmnMmyfiaNogXdBxJYBTd4bsHbA43Dj7qPEi1LOVg+ZJUaLuQaJ2NcKs6Y/0p028zIa0bXhq7Mpzd0TiYFf0OAvFYTSRT2hkMHJNEjT4XeSe4AM1PGX8VxZoizEFwHuYq1GDZl9V4QpBnaDt5uBdjYgXZdav6crxvhXehoBwRTJ0BGZ/8K2TMQh+gZJLiModGuZ3yLOuA+LtENn6LPELI6ScNlrGK3ZPyT4jQvUKTFqp09Yj7C4PMVEYEvl9jN/qVBpifwW/Z01wtlAdLxIUCVeTxilUPymSWJqXfTCgqzMpUuRx0NWmxabEIC5rAIPOIaGn9dCyBjqgDhAQf4chnUrrFljhQx5EwTfOZuCUpCyTdLgmw2J3c9kDcGuv6ihUXEKsKQp4+z4UsOQWicwm8ar3gVPKVvKR8vuT2Nf5C2Fr/W6x1Nui83iA5/Gs2nlWl8lTmPsnntMIrJ4Vh5Wj36G68T1Wq7zHN1LpVjSywNC0YhaLRthxpnfXJwVw8APuJzjZm698yjGaOWqMgwTxaCGtPMXrzyIlhxxGiuabbTWDYez8v1sONSo9tyWliFG9yB6mJvzgI5ymF8MRUFtmHqq+7EfZFQJb9dFTP1Z+d6pJS89MWWW+/P+7eRyYvOxusWX2hW+nirP1Z7qFeURu/4O/jlT2RN82UFIslek4wBPRiKViu+eKpLxuO9NAHOpUgGnSE+bBY28+NAFZzrn0G5DBtJfYNIkE6R3WouuXlSIEE5DFnopzfkti+y5dyGaUHis06YKT5f5q9ULAIFCFKyrW0taUf0zgxre/NyZtsDBTlkkMv5l85bUVDunqzVRW+jGS0Za1NuoPkgxgt2XH26flasm3DzA9SqqHTVl6QdkwyoDa/0Co8PNcc94YYBqndwaVY9hilHE5e0XlFuDh2A5TQQYHvakaWpDtdHhU+P1btWf1ldHKOpoqOrquALxQWonpr1OgS608EAgXuAb31fsrYbbDbYbbDbYbbDbYbbDbYbbDbYY1CZjiUgC9wXuC9wXuC9wXuC9wXuC9wXuBWy7v/uC9wXuC9wXuC9wXuC9wXuC9wXuC4v5BZ+qZtsNthtsNthtsNthtsNthtsNthtG0XWK9wXuC9wXuC9wXuC9wXuC9wXuC9v8tiK4bbDbYbbDbYbbDbYbbDbYbbDbYc7Lek+C/4AA/v9R7NopFWhlS8l26sB2QsRnAqfuTtKfS+JPUfQtWpXYqAAAAAifobqokNhA0AAAA1BMD2Uv5AAAAACnLTAAAAAAmWtsAAAABgFDx6YD4//ldd1b2O3VvY7dW9jAGK1M++ZCezGgSZ9xUiF3zhnoGVKDc3x95QsYMbzqXFLpzBN500tbRPoAusIBF5QmSMwCcct4/LwgGfG84W6lAcp9izu6GDws76B0GkL0pf4xfgKfZwP8gk+oAYCyxMHbbfnfv5qPyOQmIKmcmWKRv9DMMhbn9IaZuMvb/w3aP5nFoWwkqD3+Z1UcAO4XDf4jPtPlxXPdqCefaqdCRcL3wtC1N9l+uIMfj+p3USzXqejbkEQ2rkteZ0b8QlixLfeOnCFxF44m4hn0iVzvNI9p0113jQo2uhBuS3u+Aw+ZtXpbRYqJ/D/+lJdkn4DSyz+cCA8uBbzVbkk+z8zbuQRreboeuz4BeXU637TXQYrEBrH44PJ7PsavxAs7cFf5ZnsNYh3dGSwk4J6c3b1Jy9/t8Srk/sItGGMTBa2pEs88q//ou59SmmvvEmkaNnv/F3jiI1WEbDubvfeACxYu57D+C6OS7HV+/E6Vy7awHGMqFLCJ7bzyXX+Rx1P/Vak7ROhDzGahkXDJ+Bcu60xH30VioM0wS6/VVhpmSnitMAQXJKJcFuPIYPf4pbKrL98pcXiBekXePblCxS5K1Kzn/dFrTCmFaPJqmEQY4mpfzBgp3xSaHQ/19fcmLrasCvvj8x2c2EPD5Xvj/uIsBqdW5ZOJ5L/3CKA27eIL8d61rANEKdfpaWj7YLVxD/czVqVA6E7zDTRl0fOBZzDwu7I9PB22ie2fhSpFr4tMsQEpK+uyx2HmMpt+Cqbm5oon8+TcdtXm70z5t3ppCC3HIMYfJ1QAGxiArjmCBgpBjWhF/3ipbGs8bJ+qbTLijcqfWbgAjmi/GQxZo/+HIX3boe0aAwHpJf027h7tpSvbAqew3d4huMIpuL/xJNms9iVy6rz2CWsj8VyuF04nKnJ3RyHKqb3IdXBBhKVMhl26LNmv7PL1QvwTnDv7o6dU7lUu8fbMafgv5KPJzzu6MdPkVVPpit8udsjujxJkqbarsgxD1ryYGeUipFL3EzZ8f6vRmSmFa/zdyoWWE2alVcQdyDRbPlNWFPvOudmShNbIIcdsQRn9/xi/SGaMQEcSi2BjDpZG3wInxn6YwK86yx6AkCZ35OI/FRefdcMUYVKIWYnYVPt2OTvKxkGHocViTsBcVCd6zArM/zBuzy9m5i1YoqD8NEcYXVTLHtZaWqhIYnyYe7bjYPVdQgmtmv3C2DBRtyRyBMjiSG+HGcJzrPuvC77WqRoB5htImNQMFrNNR5b4jHGtAkZpCpGSSL4YLr0m1U+O7XUdZu0qXcpTiGr9gE4RO9glHT2qEVSA5QFLVmQGPORheUrQiJIvMmbLvLTZZkb6BVKtlfmIuCkhfAZf7ZwTp9kPRgRQFy0Lm4k9/qcq3JaauXop3lEWOoWGmp+D3k+dbb7ZvrIiTFv+pVhCm8SssO4oRKnnGfj5QP8Aok0a2UWLLPE08maTzXy1PkWWCfS42uoxxLSlxsfiZMeKMaA74mSr6mGELZ42eX/qmkxOptHoAzLtLgOvOXQzciyB6SgNgMzMh1xYG68sNUWX8pj+eh8LhA0oVl659xOxPek3trOn6XSH179Jen40R8ulGXcHY5G2TIpB3+MgAZdjImcV+BfuH1FiiD0g3+xf0O7gmr2/tEOXbaK+Diz3JVz/IJ7wvMLO/6jUo6Vsz+/e/jA+6BtgAZ9POk93nAWXzA96Tf19v5dXCkSJDA6XiHmAreM8uQ2gQROi25fppjgYxvpRkBwWmMGKLlIcnVFWSHjOpxQQ+rgaMKg8YN8DhnxUfVht993maLmeD8w8LdP+f0D+OalC+Xza80+hDx+RJvj3e9kBSglN9iZL6jrkEF5TUFk9NUpZWmvsWs2ezEVshTRs5UPutmbs2FjnI14yhFK4S0K9yGtau+zor5kndNklqeSO88X6oacqb7Ngh+KzJejukGwTP/WntlTltLxEbcJdossMrfGhQu2+xlJIpuwdyx1ks2uW9aUht2B0YkkFiCzqysWxf6VLthnW+2R/wJ6cbRbRWdXylETL1mftj1DJueDfzRuzYgYWsU2vpbzFKdXbcbmqFJNs0fVYHmQLnFXu3yIsjT+OHfdMyuaKaV+FY9kA2poK6EJdxN0JYWIKACPSUnbev09rwI5qgqPgfUVE9+kMsyEYkWH51KIOW1iA1PTSljJAeNN0/dtjnLv5UQeEWQOOzw/oMCGk4mdSl64wTq+j59rvXmR3pa0qVZfkUDZLcH0kZkGAo0tARRw/xuy3fqy+WPyKIMFtKgpu24c2izP7i7MZ2OWwFVkW8FeQUZ55pv5oZ/ie57q9zC/82YnBS4Kxk/2aFMVv045//O5BKgx6FCFvMTB6+Zgl4HN/5hCvFi/Q8F1NpAprFxsd79f5E5U5RZfGCuRXHtW0aiRRzoPENnlng5aTlXK1Pt/svC0kyDEz2wc7kA3BI7E/BOaPeZrXJL2lGUw82peqkB875YT0Lej7vY5KdUexQNR3SSqDDcFtrl82uHJB6XYhduaYUaws7OFSModODez+iD54NlLCuwVZRZ8JvxGAK8CwYWxJ2XIuztZCk08LehlPAt4rvqXXExqTV0N11xxIZjAx8t4GVbleQ4OpXdSmMrBgvVs0yazA1/iL5S4LWE/PBPXIOR5JK66fhX7Uebb0nk5ilJDv9OGC8xZPlg45eS/vh1KalMBSO8e9gSf/DRKBPVCBiY7nSVufJ+UTSvbE9e4nTXNN+75cV2uL9//wN7vh+OYGFYpMMIFzOXiz02ixugMDBQfPFBmvP/XGpMQlZjeSoxkYHxpOrkFk22flv+jI2/Gpcletz0EwVMx5wDT/efK6wdpIm+uJsZZk9hJfqCfQKEPQCpl9zEGWMONBkfPrulPu452FdrRJt3ghQ1OlWmrKrXYDMzEz4S7xcSiaJrt9OqQ59thfRBHccnxfvyEykRBvM8yHSf9iPAFxMrdXhoLYUDKjIfUyStZLvrZW3ibnYabBQRwrE3ApSnX3onZkVFXbHpi3QQiEr93sByReyssul5c770ELUPIidpMvp4UAkFid+PXLzQdwLVAvRnAifuuUD4PYqTKQO10oow6Hs7fProLQDiqFUR/3Fr/FUmuHARL3PNcYGvAG76wzOXq1f9Ha5tKJO9rmNv4+msQsBBl6t3916sDvfKHFaVfjl3L7A4+a090htrX1NpnD1iYwNHr6T+Za8VpnsguVtiDrEgFXPk6ywfya5KUftKYiClGlJsGXpqN4WXt2I2fTOFGxno5zAOqJCbWbg6sUVKEXrh1DNeKLFg5uRR4fJYyTnRBOaZvXiYFvOtBhZmAqsZBEXovDU7CAMekHIokD2y9ce3gUMxZdZgppKhEEobgCYFWhd5dx2Uhc1wX9POf7lUBAqF7O2O1zFYqZ/g1coQ7rUJNRTGp7Sm9qk/UaqfmZR9iRwvj6Y8jCCAyf/Bv1PTey2G9Sopkb0eUoHcDpH4tchU5XuSrE8R1xxVanJ4Ug0tpzNHSrnvzwDNN6w2/LTkd8X649f99JnPjNtb+sz3WT0kqpUpshogC4fzdO638rOBDuAap1VZKE6iOhfunogyZoAFFtoqacNr7XSbo0w3oyABRhOa2sZ6sqUF+dKrbzQ/eRXBRNEFMvE4Odt5lxfc8FaVaXfH2y4X14BQbFHCN4xA8zG4TFHZEuX6ndVCSDdaIgZVeBko4KrHctQO6wbVGRlwe/Xvh1tBZ6w9Efl8bByLtsXqQ3BW1ui3dKSJtasTEhVsvTMUoEyutwoG433tA5bbSI9ITMFwbSXLWphWFFm1pYfh6xbZGUIfl95GxHbgHN+LzG4m7Qb2ekbpxnuk9D6po61Qqv7orlsSNFYAbPsTPt2DHOixdTHtt2bPBFxf4Tx+/HIvVXBPeCYMHFY8mmH7v3vVkVZswiZsMxDtlEh5usKXsbUX4Y90OGuOx5cBL5MdfGBCT32kvwuMu4XbuizTi2cBHYt+OeJdNcluzi+39IDTR5KGhHD2kB1tqGu59rZ5HQqzI+F8BSYfylOxDc5+3k5izmDYhKCnThd3fpZeMAucLMPyyr38Ovd8Cbpr0GiddWxDrNS/EZyKZ6RTp/Dp2KNMjN/GS9axBzhAYO+nM0Exvzd4drgmjwUEWf1y9TB0XWcYKPJ9ss91xefTtt8tzK+KrFOTGac8xg/pIrxDUhs4eQCAu4qCNC+Dvz/v/RRS+wiWvkzcPXwxtu/PfUNA4R8emfnHU4y1IeNg0Rv3MHUoEtEkngSvuotK3fUJMiLo2zrI8IVH5o7ypmua/WAjxWN97ChsKlpomUCDJTcf4iZCTnolCSjoOrnCdDNgg+qYKZgUgqzGWb8AkNceVtRS9cW5zvqxeeWMN5+9tipYnZh9dpUDnaPsn1ACNapuiDwSIoNikcqGM50LEet67mCjNohOavqvQNyRqlRmihdRgN/iZ3Xrn2lwAjTTAyFTLlXHXTf6oO7zFt12YPTZ5CHaGMT7wxSZZBEdV1aTvFdtEk7k82xisJQrSyzjLQUNkN+m7Bm5yVDhJxZ271URoEhGtbb7y+4MtWlH0Dil593SQXN3XNmL4iQ/ULQDPnOfvOFLxrL+jrLKabBdBW/DM2xmr6+R6hoqcfI+hnubHUVgP3Gx1ygi01ZBNSqYXGfT9gFZXgrOuBCKOQ0WoFcFs0URQ7Bn/p9aUliLELLWLapRVOIB9TuLxq2Tw7bt4sx38qNWwDybSnk1XXBMqgq9Et4TwXMMZWuvVqloX8GEl8MMqXjyIphTrrMUVFUHjVP3x/oNJ8vt0c512M6/ZkiETKNLHw9iWmUMDBut+kRDplVCmvwNNQu4B2TOXtQnLntqLkI8DtcEqMv8iMS3o6x+U/SBbGohIThxkZBLvxKk5QNqnkynl/V07df42Lco5i+GdZ52vJF7w9ME7TOMq6ksQaITcZkrzMOnahKVf6dBtBXvXzB9RkvW7UePTNGxZ97NFKttnb009wOkJ3WKoogcGaJBvNsuyPRZxUF92twyanhmrtSaoSJ+HPG54xK2jUZN79OXNyKPZoSH4jK7AfQ35EHWW+J4I92ouvo5ConqIBhCGzBPMqY1EGhzIdx5wLptNM4d1Ti9mvtFvfB3CjhzhHTGAp91o0Gh8Z3XH20P5SFgrMsNPj4KbcrT5227xjvZC/2iXJ9+lTIfVYb7LiVajsPakF/3+IyWnFEBCpNYUt3HKqR7B6bZbrLol1+Q3PDSTg/zHFhgs1fZHSV4nfo9GWcbQC4R/tUZvdjckmE8e5FvPnYeebZR+dVw7p1fKg0VQM6xeSl8lipsM4tcnEnB85yoQ1kPcYnNl0N6HwTgkVZVSOFVONBHSZ9anU00Bloj5GSqqO/8lO60OVHa/QPnntQq8mlLn3OY1DE8mh9FBk6sVSaK5O6QtQI5TfP5auXTs0DDFxR3ZhoL3lms/8MNub2Vyf09HUMgzXy/477+Cttrp7aseAL/ZDD1n+vFUM2pGdNoRevF/lH1KdhZaIhpMQ0fYczRhUlAK0oicvF0yd8ypKjY0ChWlAwNLfT1ySr+e9WArHkwUbGnQupSJUmaaovaYfXeeaEShYsjq6ITwExXbfSgNysLvWr+XRH6TAF9A3QTR0NeMZcxJbYTh6Yu4BNW/0IjfG482RveFYAO7cR/qgp3vXG4+tGsZasvVdfNvN63K1WwyJUNUPfHJBuLTGMoehzat3tpCTXukcXZV/L7fe5qWsvUz02DLAHpj/czfjvLQQtudsVNL92Equ9hGLPYroTZjSu26O1wkp2PY3Jr0+UFJwZMOIG92qINoyWSckskvXTt4V4yHdJicq+Zlc/h0aLskSDrc63TbdWK9yvn/oNJdOblLBn6akIA13CMyi2QCc11z/8e+7x3QpUM2L3Vy7cvDo0UXypcG1QKGmGiK7Hb8h2ZzKf27uHOYcIEp591KkbccTmV1oaaGXbTuSIuCpjDSIwFma4u81wNOdilpMlyE+HpTn4TDkyrQ1SEsiEDueJnqc7URiKq4veVCj/kG7Zk3lO9EkxjX8W/nFNfwWOVvTlqLJXyAIKMr7G+o/QJr8EiNkNkWBOgTQRuDytZTbEMEONCQrE/Dt9lZzczxyYHWH/B4cIQAUdFWQ9c6CYiLCY98T0eaA4kLbr+AF4K/7kcVb7M/BR48uSfNgUZyUMnTbGJmkk6dz6a6CvsOpDLPtGugTXIevL4yhnIU7LjTKrkaFvfICatcyd2/8POvsnvVNirN/WZuuvqC740H2MbWIKNMhM7e+rHV6nHkjBJynthas4scnJR8LFGPWrN00vFFpiWjGIY89DmLvadW9/dnUrW6jbf7Pw0ZwuNqXxNP7B/8QLQeyYwzkQQYdW87IlYiR1CCNo7+Qnyu+qz9aBVA9Fnmb2jEhFAc9qFe9mi4bh80e0NlnxeBOQuO1ScVPMAAAAAAD5UrmKrIBozmfJWEkPqTN32/DOe2wbH/UxI/Y83UJPfLlbSK7nJXS1EIB6qW8jFuyvz7SI7Q9zcMT0pK8TrbpuvHp5wvjEI/X1JxBOwjtqDff00a5++5uvd/exC5hlHwAwXw3NikKm2C/LYJ3yS8Dtid4MxfrAJQbP1NpU0vEMlSP2Fcuj7ioGfo7fFCDyJGASoPPW1OS0J3UehozYg/21DfxWvmhHqMA/+N4hzJ7z2PQF7LaqqF2T+6YbeNh2x0n1P61FV0OFmxLtV43r1PFA/D04Q/RF4TI5p56mzHALaBJIi+nvnGWMaU3lB8+QkPwTB3zRrekEYY1cdvWxOcpOP2mUHqeQC63Wpu9i+hczdOGMJR6jUp5zmZcVeptR2Ulfsy8C7WdVxAd9Rl8jW0cMeKlP98BtX8CYyWP84ikbIcvFUS5fPQ3Udrssj0Rk70Txrp4UTtF+vJ0rJG4xLYf1fejZK7Z2fOcSoNFXvyAxQqZPar/wWLpPqzkC+pW/k1Ym3bd6AdaETLY81q1KsPGYAVxasatOkAavRVTvXO/PL0L/vv6Vk7scwlV6PtKAvLYEcehDXfoi8qm8RlhRuPcgYK4lR7ZSwOE6lH2IW8mrca+McITFuaqqA11KmYcIn7XMq3bVsadAJN2MRyh17ZOfuwNkSrH8IkOiRjTf/iOvVkBGWhgv51qCduoX4CF+YcpVUU7XvUDgqBqj9GF9PDflEviNIRA/ciJhwqS20kNHe2wK3AZy8YGD2LZtxEooNiluPQPPrNLq9sucOsRsxDbtVvxxFFHc2ZKuZfohsJtaVbZuRmjD/u662FxdjDzExV5VrBtIO4vAeA4+N+iI/u/RAeZRynj8ygd00Q4/iyz5ihZPr/BH9e/SPSh/gW9LL/WqF20142AvcwpjpVpj7KCo5Yr/1QjcxrVvRLBMQiAFTUh59dk+MF4j/yH34ygI97tDidL8N1J0tnKKc2MllMyVl1xkfygfgyH6L4mrefuBid1W8+DQ+zA6O2Md/As6iXKKXPBkA6/F8ECs/o7SkWt18wkM5aJk9MLy+vrgWgg84Eq2GcrDZ57KTjU/1mHk/xOjFzy87fw1Xes3O6423rFCi7TnOJHwEBGe6yYEuXkz4dgaqks/eNJ0fDeVOVeesmwLdoCtR0Bqkuz64eZDVKV7K0TWpJj/LYbocIxCLiW6knQrNqYubgi0GdWvi8PCkibFfHrMEyobWfrfPVxuMX9MG+WxL70j3GnEukIlun7ZwT+q4PG8kyAp7IMzZcZRd/wwKkqEmwsEz8iMJZVZxDI/JpCIji2+ADUYkRzSi6er3KSKrV40rWgHo3XR2RtCYYMmrbA93doRL+DwZ+LCKyvvKn5PsnXSHlg0YNi+yHAmhEOKnQAkGpHaUtSDSxVpcwbHjhBOvFG/JZTIib9jW8c4LkZx04dZ6K1SSlGi1HmTg2wNwKHmDVwVuj7dNnOz74iTGLUD/51oB4oBNrBG0tvjxv8QbRB7rQxIcUUGN2DxwcNsnm7aSPm0hERRZWCl73vmb/I3U2Yo4VcDwjt7fTQ1TSBW5Ck64VT0GKG1s6A0NBdVj49u98jDch3IkA/Z/D/FLSOqOq6mDV/NWrSSgR5KPDI/vTl/kVTaRJiMvs0w1PgOwf5COWcRCgBJ0HJBLZG9/JQTWO7WeKPXFvTAYZfBwB/P43vRVs/AcajFeoxnRD0R65M7pHcqTwZzUMSvheebn+jU4hwezIdq68Gu/9EQo6w2Dh/9iBvNTR38maoro+yGAZZQhAfgHeL1ODXePJfuUiuecKdfP8S4U8KCH1/95IR84NuBRitzC9ljS3bYh/SmZfCe+2kpqmFZY8iRcWXwZ8eQHZ0H9+UlK1D1r4JJ3szPDngZ60qdsIOUj5kU/hcLtKTH5AqIpbypw4A3lluIgYd0bEkwxax+mRFQkZ7V6ATypHGf7BpRYVJqO+I8rWiF/VYwfmlMtl5R1Eb0aojc5+aB5EcY2kILY8pzyonLpwXXr7NNSkzHc8tHAF4kcmlKD5qwuMez7kC/bahWauBdDl9Wi2joxtIfOSYUdcPz6wV4UMXbBVYpBZjSL7279CNDYqLcY1Zks7BpreHpWQvZdIghO8CXsorcHqjp3Hw7GY7p/LpMMJr4IIjm6gMbE3G/sl8ByAkB66dd9MIWfxf0JCvVXlBUyKahKuYFtlV+x0L8pcxp9IljB0e40614dnZnn7XuJIsGB/KfJgzI39qVA/xba07axgmUmaRqWAF4YeuOF67eopuak4OVE5o1Hzst7jDuDyoguFR+IXeljRSkaNGtSybKnQkdyegN3oqicPlIHTKi5IoAuktiKjtHAHXwRbA53h1VOtdP8b7xXe8coM8gOcg6cuhi3ZGDS8rBedO6zJj1vy78D5phQoSLxCE+hXnZEcOSDa5x+6SewnIZj+EuZb7ZpIuq+AV2TSu5RaFxDq9lsTLhmzzkDd3M2WMVIQM+LZWDy2rq8onbfj6fXnaerxdT43+vY2GMJXDEsEtYddT8idiwlH9EDrSWl/9Qxpjthi4MLSJqJDPvhY1eEx365hhQZ4UAOiIAAAAAAJfIlwAAAAKtaqoHAAAAD0mKL+wAAAAGdCppAAAAAK8rbkRPMAAAAcqCeJ+ZmC4ayAAABIU/Md2fu61vKBjO/AA" width="750" height="374" class="img_ev3q"></p>
<p>在 <a href="https://developer.chrome.com/blog/new-in-chrome-113/#webgpu" target="_blank" rel="noopener noreferrer">Chrome 113 的发布日志页面</a>，Chrome 团队列举了个几个主流的工具库对 WebGPU 的支持情况，例如 Babylon.js、PlayCanvas、TensorFlow.js、Three.js。其中，有三个是大家比较熟悉的 Web 3D 图形开发绘图引擎/框架工具，而 TensorFlow.js 则与 3D 图形开发无关，是 Google 发布的机器学习框架工具。</p>
<p>很多人认为 WebGPU 将替代 WebGL，长期来看这应该是一个必然的结果，但短期内 WebGL 可能仍将是主流方案，不过这些观点都仅针对 Web 3D 图形开发领域。接下来先来看看官方是如何定义这两者的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="webgl-与-webgpu-的官方定义">WebGL 与 WebGPU 的官方定义<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#webgl-%E4%B8%8E-webgpu-%E7%9A%84%E5%AE%98%E6%96%B9%E5%AE%9A%E4%B9%89" class="hash-link" aria-label="WebGL 与 WebGPU 的官方定义的直接链接" title="WebGL 与 WebGPU 的官方定义的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="webgl" src="https://wang1212.github.io/assets/images/webgl-15ac431db41a5a81672fdfefe401996c.webp" width="1638" height="395" class="img_ev3q"></p>
<p>以上截图来自于 WebGL 标准的维护组织 <a href="https://www.khronos.org/webgl/" target="_blank" rel="noopener noreferrer">Khronos Group 的官方网站</a>，可以明确的看出 WebGL 标准的制定目标是为 Web 平台提供 3D 图形开发 API 支持。</p>
<p><img decoding="async" loading="lazy" alt="webgpu" src="https://wang1212.github.io/assets/images/webgpu-435b657e52daa6b7ff00b64506ec5e3a.webp" width="1288" height="182" class="img_ev3q"></p>
<p>另外，以上截图来自于 WebGPU 标准的制定组织 <a href="https://www.w3.org/TR/webgpu/" target="_blank" rel="noopener noreferrer">W3C 标准文件</a>，可以从上图的描述看出 WebGPU 的目标至少包含 <strong>3D 图形开发</strong>和<strong>计算</strong>两个领域。所以，WebGPU 的出现并不是纯粹的为了替代 WebGL，还为 Web 平台带来了更多可能性，比如通用计算领域。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="webgl-与-webgpu-的技术架构">WebGL 与 WebGPU 的技术架构<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#webgl-%E4%B8%8E-webgpu-%E7%9A%84%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84" class="hash-link" aria-label="WebGL 与 WebGPU 的技术架构的直接链接" title="WebGL 与 WebGPU 的技术架构的直接链接">​</a></h2>
<p>在讨论 WebGPU 的通用计算 API 之前先来简单了解一下其与 WebGL 的技术架构有何不同。</p>
<p><img decoding="async" loading="lazy" alt="technology-architecture-webgl" src="https://wang1212.github.io/assets/images/technology-architecture-webgl-3fa7e936ec40dddc526b68b9779688c6.webp" width="860" height="485" class="img_ev3q"></p>
<p>WebGL 程序由使用 JavaScript 编写的控制代码和使用 OpenGL ES 着色语言(G​​LSL ES)（一种似于 C 或 C++ 的语言）编写的着色器代码组合，并在计算中机器的图形处理元(GPU)上行。WebGL 是基于 OpenGL ES 标准针对 Web 平台的一个实现，而同时期与 OpenGL（ES）对等的是微软 Win 平台的 DirectX 11。</p>
<p><img decoding="async" loading="lazy" alt="technology-architecture-webgl-1" src="https://wang1212.github.io/assets/images/technology-architecture-webgl-1-ad44ae270abc59d0599ac36e2e814db5.webp" width="1266" height="465" class="img_ev3q"></p>
<p>随着硬件技术的发展，OpenGL 标准也在持续发展，至今最新的版本则是 4.x，而 WebGL 标准的发展则相对缓慢，直至去年（2022）初 Khronos Group 才宣布 WebGL 2.0 在所有的主流 Web 平台得到支持，其基于 OpenGL ES 3.0 标准制定。也就是说，距离 OpenGL ES 4.0 标准的 WebGL 标准还很遥远，可见 Web 平台即便是基于 WebGL 2.0 的实现也无法充分利用现代 GPU 的能力，这也许就是 WebGPU 出现的一个重要因素。</p>
<p><img decoding="async" loading="lazy" alt="technology-architecture-webgpu" src="https://wang1212.github.io/assets/images/technology-architecture-webgpu-699420c9d7c89839beb1eb5c2ce17476.webp" width="1078" height="422" class="img_ev3q"></p>
<p>与 WebGL 不同，WebGPU 不是任何现有的原生 API 的直接接口。它基于 Vulkan、Metal 和 Direct3D 12 提供的 API，旨在跨移动和桌面平台提供高性能。而且，WebGPU 使用 WGSL（一种类 Rust 的语言）着色语言编写着色器代码。</p>
<p>值得一提的是，在过去的一段时间里，随着 Apple 平台发布 Metal，OpenGL ES 在 Apple 平台逐渐被放弃，与此同时 Win 平台的 DirectX 12 发布也预示着 OpenGL 标准已经落后于现代图形开发领域的发展。面对这种情况，Khronos Group 也迅速推出了现代跨平台的图形开发标准 Vulkan。至此，Metal、DirectX 12、Vulkan 成为了更低级的、更接近现代 GPU 架构实现的图形开发标准，而 WebGPU 标准则基于这三者。</p>
<p><img decoding="async" loading="lazy" alt="technology-architecture" src="https://wang1212.github.io/assets/images/technology-architecture-587e6248d241bd7b48a4e3f001eedba9.webp" width="1240" height="635" class="img_ev3q"></p>
<p>下一代图形 API 是对 GPU 更低级别的抽象，也是更接近现在 GPU 架构的实现，对 GPU 有更高的控制权限和灵活性，同样的使用成本变高，但性能收益更高。</p>
<p>此外，通过 WebGL 和 WebGPU 各自所使用的着色器语言代码也可以明显感受到后者更加低级，基本上是对 GPU 内存的直接操作，所以拥有更高的性能符合我们的认知。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="web-平台的通用计算">Web 平台的通用计算<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#web-%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%80%9A%E7%94%A8%E8%AE%A1%E7%AE%97" class="hash-link" aria-label="Web 平台的通用计算的直接链接" title="Web 平台的通用计算的直接链接">​</a></h2>
<p>接下来便是本文关注的核心，即 WebGPU 为 Web 平台带来的通用计算领域的应用场景。通用图形处理单元（GPGPU）在 Web 平台还是一个略微陌生的概念，但在云计算等其它领域已是一个被大家所熟知的概念。</p>
<p>实际上，目前在 Web 平台也有一些大数据计算场景的应用，例如机器学习的离线支持，代表性工具就是文中刚开始提到的 TensorFlow.js。鉴于 Web 平台 JavaScript 单线程模型的限制，在 Web 客户端做大数据计算的性能限制很大，不过如果能利用现代 GPU 的数据计算能力，则可以解决此类问题。</p>
<p><img decoding="async" loading="lazy" alt="gpgpu" src="https://wang1212.github.io/assets/images/gpgpu-1ca12d5db3ed230317199a279c5f83e2.webp" width="1368" height="509" class="img_ev3q"></p>
<p>长期以来 Web 平台利用 GPU 能力的途径只有 WebGL API，也就是 3D 图形开发领域，如上图所示左侧的渲染管道，CPU 承担了相当多的计算任务，而 GPU 则解决的是绘图相关的任务。另一方面，在 GPGPU 技术中，CPU 仅承担一些必要的计算任务，GPU 可以单独完成一些纯计算类的任务，如上图右侧所示。</p>
<p>WebGPU 的出现为 Web 平台 GPGPU 提供了一流的支持，但在这之前，WebGL 时代也有相应的尝试。</p>
<p><img decoding="async" loading="lazy" alt="gpgpu-1" src="https://wang1212.github.io/assets/images/gpgpu-1-2e17ab31626c1c765b10b738d4d902e5.webp" width="1155" height="582" class="img_ev3q"></p>
<p>如上图所示，虽然 WebGL API 是用来绘图的，但可以将数据计算任务转换为绘图指令，得到绘制的结果后，再从像素数据转换为数据结果。通过一种间接的方式，也能基于 WebGL 为 Web 平台提供 GPGPU 技术的支持，但这种方式的问题在于将数据计算任务转换为绘图指令的过程是极其繁琐的。</p>
<p>接下来，来了解一下一个开源工具库 <a href="https://turbo.js.org/" target="_blank" rel="noopener noreferrer">turbo.js</a>，其就是做了上面所描述的事情，针对以上过程进行封装抽象降低了开发者的使用成本。</p>
<p><img decoding="async" loading="lazy" alt="turbojs" src="https://wang1212.github.io/assets/images/turbojs-2089428e42d07e42062677247acc2449.webp" width="1232" height="461" class="img_ev3q"></p>
<p>其官方展示了一个针对访问者机器的性能基准测试的结果，可见利用 GPU 完成计算任务相比于 CPU 的性能高出数倍。来看看如何使用：</p>
<p><img decoding="async" loading="lazy" alt="turbojs-1" src="https://wang1212.github.io/assets/images/turbojs-1-7d80ac1130f5019f711d0c888c78f1e6.webp" width="517" height="563" class="img_ev3q"></p>
<p>从给出的示例代码来看，本质上开发者需要将计算逻辑的代码转换为着色器代码，因为着色器程序是 GPU 硬件的可编程入口。再来看看其源码实现，验证下是否与上述描述一致。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/turbo/js/blob/master/turbo.js#L117</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">ipt</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fragmentShader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FRAGMENT_SHADER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">shaderSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fragmentShader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdlib </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">compileShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fragmentShader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> program </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createProgram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">attachShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vertexShader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">attachShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fragmentShader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">linkProgram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readPixels</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RGBA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FLOAT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ipt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//                                 ^ 4 x 32 bit ^</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> ipt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">subarray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ipt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是截取的一段 <code>run()</code> 的实现代码，可以比较清晰的看到是先利用数据进行图形绘制，然后再从绘制结果的像素数据中进行结果读取，符合之前所描述的实现思路。该工具库目前已经不再维护，还有另一个工具库 <a href="https://gpu.rocks/" target="_blank" rel="noopener noreferrer">GPU.js</a> 也值得参考。</p>
<p>虽然通过 WebGL API 也能实现 GPGPU 技术，但过程繁琐，还有一定的性能损失，而 WebGPU 为 GPGPU 技术提供了一流的支持。</p>
<div class="language-wgsl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-wgsl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Define global buffer size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const BUFFER_SIZE = 1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const shader = `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@group(0) @binding(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var&lt;storage, read_write&gt; output: array&lt;f32&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@compute @workgroup_size(64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @builtin(global_invocation_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  global_id : vec3u,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @builtin(local_invocation_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  local_id : vec3u,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Avoid accessing the buffer out of bounds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (global_id.x &gt;= ${BUFFER_SIZE}) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output[global_id.x] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f32(global_id.x) * 1000. + f32(local_id.x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码截取自 <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API#basic_compute_pipeline" target="_blank" rel="noopener noreferrer">MDN 文档</a>，可以看到通过 <code>@compute</code> 代码关键字表明了计算任务的处理能力是 WebGPU API 官方支持的，而其对应的绘图相关的代码关键字则为 <code>@vertex</code>、<code>@fragment</code>，这其实对应了不同类型的着色器，也即 GPU 流水线架构设计中的不同阶段。</p>
<p><img decoding="async" loading="lazy" alt="gpgpu-webgl" src="https://wang1212.github.io/assets/images/gpgpu-webgl-9d87296f1ecfcfb4cf93333a323b503c.webp" width="1356" height="637" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="gpgpu-webgpu" src="https://wang1212.github.io/assets/images/gpgpu-webgpu-a1a9d3c699924991e6bc055e82cceea1.webp" width="1344" height="630" class="img_ev3q"></p>
<p>以上两图来自 Chrome 开发者官方博客，概述了基于 WebGL 和 WebGPU 两种方案实现的 GPGPU 技术在机器学习领域的应用差异，很明显后者灵活性和可控性更高，也具备性能优势。</p>
<p>说句题外话，在 Web 平台上提高数据计算性能的方案不止有 GPGPU，还有 WebAssembly SIMD 技术，但后者对前端开发者的能力要求偏高，上手起来不是很容易，相比较来说，WebGPU API 的方案门槛更低一些。</p>
<p><img decoding="async" loading="lazy" alt="simd" src="https://wang1212.github.io/assets/images/simd-67c78419670f4089c9166c327c80c6d3.webp" width="720" height="499" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://developer.chrome.com/blog/new-in-chrome-113" target="_blank" rel="noopener noreferrer">https://developer.chrome.com/blog/new-in-chrome-113</a></li>
<li><a href="https://en.wikipedia.org/wiki/WebGL" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/WebGL</a></li>
<li><a href="https://www.khronos.org/webgl/" target="_blank" rel="noopener noreferrer">https://www.khronos.org/webgl/</a></li>
<li><a href="https://en.wikipedia.org/wiki/WebGPU" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/WebGPU</a></li>
<li><a href="https://www.w3.org/TR/webgpu/" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/webgpu/</a></li>
<li><a href="https://en.wikipedia.org/wiki/OpenGL_ES" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/OpenGL_ES</a></li>
<li><a href="https://en.wikipedia.org/wiki/WebGL" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/WebGL</a></li>
<li><a href="https://blog.devgenius.io/will-webgpu-be-the-webgl-killer-60a49509b806" target="_blank" rel="noopener noreferrer">https://blog.devgenius.io/will-webgpu-be-the-webgl-killer-60a49509b806</a></li>
<li><a href="https://forum.babylonjs.com/t/i-have-an-important-question-about-webgpu/36896" target="_blank" rel="noopener noreferrer">https://forum.babylonjs.com/t/i-have-an-important-question-about-webgpu/36896</a></li>
<li><a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-from-webgl.html" target="_blank" rel="noopener noreferrer">https://webgpufundamentals.org/webgpu/lessons/webgpu-from-webgl.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units</a></li>
<li><a href="https://turbo.js.org/" target="_blank" rel="noopener noreferrer">https://turbo.js.org/</a></li>
<li><a href="https://gpu.rocks/" target="_blank" rel="noopener noreferrer">https://gpu.rocks/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API#basic_compute_pipeline" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API#basic_compute_pipeline</a></li>
<li><a href="https://developer.chrome.com/blog/webgpu-io2023/" target="_blank" rel="noopener noreferrer">https://developer.chrome.com/blog/webgpu-io2023/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Single_instruction,_multiple_data</a></li>
<li><a href="https://v8.dev/features/simd" target="_blank" rel="noopener noreferrer">https://v8.dev/features/simd</a></li>
<li><a href="https://codelabs.developers.google.com/your-first-webgpu-app" target="_blank" rel="noopener noreferrer">https://codelabs.developers.google.com/your-first-webgpu-app</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>Web</category>
            <category>Web 前端</category>
            <category>WebGPU</category>
            <category>3D</category>
        </item>
        <item>
            <title><![CDATA[3D 开发：正向渲染与延迟渲染]]></title>
            <link>https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering</link>
            <guid>https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering</guid>
            <pubDate>Sat, 18 Mar 2023 14:30:00 GMT</pubDate>
            <description><![CDATA[相对于 2D 开发，3D 开发由于有大量的概念需要进行学习了解因此门槛较高，近期刚好针对 3D 图形渲染技术中的两种常见技术正向渲染和延迟渲染进行了简单的了解，在此做个简单的记录，另外通过了解这些概念的同时也对光照相关的知识有了更深入的了解。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-03-18 14:30:00</em></p>
</blockquote>
<p>相对于 2D 开发，3D 开发由于有大量的概念需要进行学习了解因此门槛较高，近期刚好针对 3D 图形渲染技术中的两种常见技术正向渲染和延迟渲染进行了简单的了解，在此做个简单的记录，另外通过了解这些概念的同时也对光照相关的知识有了更深入的了解。</p>
<p>在此之前，虽然已经进行了相当多的开发实践，但由于场景受限，一直对于 3D 开发中的光照技术应用的偏少，不过恰好近期在学习了解性能相关的知识，在了解到渲染这方面的知识概念时，才意识到光照在 3D 开发中的是一个非常重要的技术。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="渲染管线">渲染管线<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF" class="hash-link" aria-label="渲染管线的直接链接" title="渲染管线的直接链接">​</a></h2>
<p>无论是做普通的前端业务开发，还是数据可视化开发，了解程序性能瓶颈的一个关键方面是知道<strong>程序代码到 UI 视觉效果是如何实现（映射）的</strong>，也即<strong>渲染管线（Rendering Pipeline）</strong>。</p>
<p><img decoding="async" loading="lazy" alt="graphics-pipeline-0" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNEBCAgICAkICQoKCQ0ODA4NExEQEBETHBQWFBYUHCsbHxsbHxsrJi4lIyUuJkQ1Ly81RE5CPkJOX1VVX3dxd5yc0f/CABEIAJADOQMBIgACEQEDEQH/xAAxAAEAAwEBAQEAAAAAAAAAAAAABAUGAwIHAQEBAAMBAAAAAAAAAAAAAAAAAAECBAP/2gAMAwEAAhADEAAAAPv4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABnSmr/NpataskxWrIVqyFashWrIVqyFb+2I6bX5juKXtgAABNcejNWGSjCSjCSjCSjCSjCSjCSjCSjCSjCTcZ67re+Gba8+uUswjNNpKMJKMJKMJKMJKMJKMJKMJKMJKMJNznb2sXAzw5dY82zCM66ZKMJKMJKMJKMJKMJKMJKMJKMJKMJN5mtBWlwOedmtLmjPaLO6LryC9QAAAAAM1rclreHa8ESAAE1ww14AAAAAAAAAF3SXdb3wy7nLryljxqsAAAAAAAAAvaK9pFwM8I8iPNseOuoAAAAAAAABoM/oIpcDlmZrS5oz2izui68gvUAAAAADNa3Ja3h2vBEgABNcMNeAeD5/rcjB5d9hGr4ExequFE679o6uYtLSvrYaaDGS2/uss+nIELCvsK3vhl3UcuJLmaYapAqs3pM3RooWdhw0/ag9FpaZ6rLC5xGghdTrH5tZ9M/S4BYV9hRdDPWhmwps2ox11MzpszEZ7W1FRWuor6LsXnqnozc9OHOZ/JmW4RFvZ5PRHaXm/UtNd5nTTZZ1llFbsc81BElxImu0Wd0XbiF6/NN1kq6l9H7jwSfbfKriJ3lHEjzH0f3T3F6AZrW5LW8O14IkAAJrhhrwAK+wCvsAAAAAAAu6S7re+GXc5deUseNVgAAAAAOUKyAAC9or2kXAzwjyI82x466gAAAAAAAAGgz+gilwOWZmtLmjPaLO6LryC9QAAAAAM1rclreHa8ESAAE1wyS1YYySIySIySIySIySIySIySIySIySI13W3Fb3AzbXLr5ljElptGSRGSRGSRGSRGSRGSRGSRGSRGSRGvau5rFmM8I8jlNsYkuumMkiMkiMkiMkiMkiMkiMkiMkiMkiNoKi7rS0HPOzWlzRntFndF15BeoAAAAAGa1uS1vDteCJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/QD5laea+1bJWpiyVoslaLJWiyVoslaLJW/pz3FBtaXAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//EAC4QAAEDBAIBAwMEAgMBAAAAAAQAAwUBAgYUFTQgEBZAEzA1BxESMyFgFzFwgP/aAAgBAQABCAD/AOISSGRR3SHypOTlK1uv48Wv/fHiLjxFx4i48RceIuPEXHiLjxFx4i48RceIuPEXHiKgA1K/vYHNnRd1NqlaXUpWn+q5Zd+9sWIrxRypUNojgoZcFDLgoZcFDLgoZcFDLgoZcFDLgoZcFDLgoZcFDLgoZcFDLgoZBsssPyjLWJO1uh6MV85G+6wJ+6zdMW6Yt0xbpi3TFumLdMW6Yt0xbpi3TFumLdMW6Yt0xbpi3TFumLdMW6Yt0xQhBDpV9rnrK33th33Wbpi3TFumLdMW6Yt0xbpi3TFumLdMW6Yt0xbpi3TFumLdMW6Yt0xbpi3TFumKFffdedo56zDrjQlLm90xbpi3TFumLdMW6Yt0xbpi3TFumLdMW6Yt0xbpi3TFumLdMW6Yt0xbpi3TFCku31I+r65X3oZNfmg/gMd2WWIdM/7Ep0CPjQHcc8JilNG/40D/AHveE50qfGgbqW3E1r65X3oZNfmg/gMd2WWIdM/7Ep0CPjQHcc8JilNG/wCNA/3veE50qfGgbqW3E1r65X3oZNfmg/gMd2WWIdM/7Ep0CPjQHcc8JilNG/40D/e94TnSp8aBupbcTWvrlfehk1+aD+Ax3ZZYh0z/ALEp0CPHJJCUuknOPNmRA4mspcNk8cQa2JR3MI5u8uyg0ht5S19AGdjA4AIu5nIhXBSn7wMiENKoJdB5QUS+U0QJLxwgswU4Dk4JZTQt9ubRV41hNrbljrdjlnhGSAAJNbzPcuOL3Ljil8/xuJcFo5fPwsxG33x3hOSPFxRhtL4ghodsuV5MIOJbMfCycIopoa8jMIxl5+ywjKoxl9pmy7NImg9j9khPAAtjXVmsvpSGMcBrlDFgBpz/ALlF0zTLT5kMEBs26lf3pSvjGyUcC/fue5ccXuXHFK/qHjUWUMy6TNxEtHfUj/XMH3x8cPeYtdtClIqyLkpxmPetYV2TRdsbSQqXlFLo6SvZhcjoSE1eYzl0c46zbeVk4QxpYNGDWLJKf/g1lw15ood5+RDhEuMKRym5uRgqh8kwQfA3XkZfGsuv2WGZJGCcfW6LnhJN59iz0i5SMBcetM9y44vcuOKR/UXGY49oV+aloyUIh3gGvzQfhY5fLTEsycNSsbHU3RMwALfZsbay6PeNdDauzaJpdW6knPARtg9b4meDlbn2m7M+h7xmyrW3LHW7HG/VjuyyxDpn/YlOgR4O3/TbccUZBT745BdxrRgeFzEaURfIyx0ONWMkigb8io3jcSdHSwNj4MfJiw2NGUlzJOWi3NeMjG28ihigYogqKkJIN+6KkXAZS9t986eOibLIkIlvBHhr4WxxuHjG3PCMjwDia2Ge2scXtrHFL4Bjcs4LVy+AhYeNvsjvCbjuUijAlfLEujtiSt+Oyfs+OCQgd5B4H844mSgwHYm/HYc2OmALHxAibYbMLKmw8hRuBOo9DkHCSlw04cTNY3Kss3tNXtXM3QMcU7NVCf8AGNjY45+/c9tY4vbWOKV/TzGpQoZ50mEiImO+nH+uYMPkY4eyxLxFoFR5SHmBakzLrshGx1w8EewZGhyTzcywxZtyuOXwacAfIZ1X4sZ6zJMkfvDtfFnMqLvgzir5Z02SLjbn5WStkgBZECPxQy5698+ZxY2yOJkoMB2KvChzAiMNZd13/eNSPWMjYsy968321ji9tY4pH9OsZkT2in5qJjIsiHZAa/NB+ExM4a8++xLixskZg8oI3HZhDP6gdkELcSBmbLQtIZsCwCUmQbRiYM6/FrYR2XeJAgrLf+NH1j34CG8GO7LLEOmf9iU6BHlKxrEoA8E+o+NYA3PpfdgO454TFKaN/wB8hr67DzKi4oaLHuZY8YH+97wnOlT40DdS24mtfXK+9DJr80H8BjuyyxDpn/YlOgR8aA7jnhMUpo3/ABoH+97wnOlT40DdS24mtfXK+9DJr80H8BjuyyxDpn/YlOgR8aA7jnhMUpo3/Ggf73vCc6VPjQN1Lbia19cr70MmvzQfwGO7LLEOmf8AYkbLrwn7bNIxaRi0jFpGLSMWkYtIxaRi0jFpGLSMWkYtIxaRi0jFpGLSMWkYtIxaRi0jFCDvtFX3Oesq3e4HfbZpGLSMWkYtIxaRi0jFpGLSMWkYtIxaRi0jFpGLSMWkYtIxaRi0jFpGLSMWkYoVh5p52rnrMNuOh/xb0jFpGLSMWkYtIxaRi0jFpGLSMWkYtIxaRi0jFpGLSMWkYtIxaRi0jFpGLSMUM28xUirnrlfehk1+aD+Ax3ZZYh0z/wDVsubrbbGFq8ocWVDdI52GXOwy52GXOwy52GXOwy52GXOwy52GXOwy52GXOwy52GXOwy52GQbzLz8o81iTVbYej9f9VJHZKYdHfKjJOLrW2/kBaf4ryAi5ARcgIuQEXICLkBFyAi5ARcgIuQEXICLkBFyAioeNX/FgcGdKXU2qUpbSlKf+qf/EAEEQAAEEAAMDCAcGBAUFAAAAAAEAAgMEBRGSEhNRICExQFSTsbIUIjBBUlOUBjJCYXGzEDNykRUjNGBzJHCAgsH/2gAIAQEACT8A/wDCF4ZFG0ue4+4BTS1Kx+5BE4seRxkeOfP8gmuceLnuJ/uSozqcozqcozqcozqcozqcozqcozqcozqcozqcozqcozqcozqcozqct4w8WSvYf7tIUz7NH8bn88sI+IH8bQiCCMwR/tb7stgyPHEQt2gNWRULJY/R7Dtl4zGYcxYbW7sLDa3dhYbW7sLDa3dhYbW7sLDa3dhYbW7sLDa3dhYbW7sLDa3dhYbW7sLDa3dhYbW7sLDa3dhYbW7sKNrI22gGsaMgAYmFH/TTywN/oa7Ng0n2Di1wAyI5j0qzLrKsy6yrMusqzLrKsy6yrMusqzLrKsy6yrMusqzLrKsy6yrMusqzLrKsy6yrMusqzLrKsy6yrMusqzLrKsy6yrMusqZ7xuicnOJ945Dy0gt5wclZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVK9wDPeSeQ9zXbY5wclZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVZl1lWZdZVmXWVK9wAbltEnkcLHg1dlseaPqHax+yxdvk8rfYcB49W+SfEcji3x6t8HI+YOrcG8jhY8GrstjzR9Q7WP2WLt8nlb7DgPHq3yT4jkcW+PVvg5HzB1bg3kcLHg1dlseaPqHax+yxdvk8rfYcB49W+SfEcji3x6t8HI+YOrcG8jhY8GrstjzR9Q7WP2WLt8nlb7DgPHkzPEeFwsnsNaSBIXOB2Hf+qD319iN42AC4iQgDpI4qOxGZc9zJLGWRzf0FVrkhrTvim3cW0GbHMXkg8zVZe+pJgwma0E7BJmy2suKnuSxyOeyLf5SWJHbZ4Kpdh3GxtRywkSHeHJuyFWt1p3NLmMsxGMvA+FUMQk2sQfHG8QAMgYSAGSEdBb71atGKHEJo3mchxD/giA/BwCr260soJiFiLdiT+lVrphP8x4hzbF/WQU4OY9oc0j3g8m5BXa6MhplkbGCcx8SxzD/qY1jmH/AFMauRzxTEgyVpGTbsj4w0q/BPztJa13rj9WnnHJaHGJnqg9Bc47IX2pt1538Jmwwh559kNKvsmhZGAZ25ESOHqkgN95KrXKz5f5RsRGMSf0lQXJ44XFss8MJfEwji5MsTulqixFuGbe8aTlkBxUVuRvTKGREmD/AJeC3kz7AzhigYXveOICZaguxviaWSwgPiDj954d7isMxGCOtu8xNCGOfvHbPqZlU7pr1w07zdbIka78Ue0RmAi6SOUsEQjALpDJ0BoKGXJvV6+0z1d9I2PPUscw/wCpjWOYf9TGrjJYpmk76u9swYR7nhivwWAHgkMcCR+o6RyJnxSN3WT2OLXDORq+0NjEDNYDJoJJxYAi97+boyVO5YkLA8ivCZNlpJAJT5N2ZdyGbB3m9+DZ4qjfgsRVXyRiWDI/Dt8CGkglVbkO7ptlltTRBkLyAMy0hVrkMUrg2OeWEsieTwcqtyaxBsZxwxbZcHt2s2o3ZZK7IXSQ8z2fyyQIG8XLCsThlsPDWb2EM/8AvQFRvzmPLePggL2MzGfOVHanqWIppHthhDzNzZAN/NhGbk3Ea8k/pW7gcBG07Defft8iguTRwuLZZ4Yi+JhHFydI9lxj3QvjbtA7AB/XMqGxBPEA50U7N2/ZPv8A4361cua0tEsrYydSxzD/AKmNY5h/1MattfHJGHCxA4TsH5O2FdhsMysZmN4dlzN6V2Wx5o+R9orNB1e0YoK0MogJYOh5+LaV4zCFrnPsSANJaCTz5cAqWIbmWRrI7JrkQuLjkOdVbkksVt1aXYizbHsnZMjyDzMVe86qHbJuCAmDUt5NJP8AyYoG7ySQcWgKOeGeHLeQTs3cjQeg5KrfMJ/mPEObYf8AkIKcHMe0OaR0EHnB5Hax+yxdvk8rfYcB48hrnbLS7JozJy9wAWK+hvvPfJNA6q2Qja9xL0x+dSZjIpS0gSxmVpBCwmesKdpk80rwBH/l+6M+8FYTPaEmK2Qx0IDvX4P4BQvyZgpY5+RLA905fsbSoSySUZbJlrEFshbK484BWF34I2TwmVjhu5ZoufbawLA7dOsN+JHzbRcTu/xAk7Kwu68WsUkmjnij24g2YgAuKqvMsP2ikuMieC3fMasJtVYqtptiWWw3Y+5+FqqyNnNS2N0WEPLiX5cyY5r21IQ5rhkQQwAg8mnBYa2MloljbIAcx8SwPD/po1geH/TRqnHBFCSTHWjZDvCfjLQsPhg52gua31z+rjznkuDTKz1TwcDtBfZa1YnZwibNC545toOKaRarT78sY8NcfXccg73OAcq/2lkdDZjk/wCrkbuWFp+8sDtWZGPkEUsTQ6KUPJIL3KFxEeCljpMiWCR05fsbSqyB81u+YmlhBkDmeqWpmIbMeFxV5mU37udhAVTGnzPqBgfiD25nYlY/YaFhOIRTN3GTJYSC/OQE7CYDG5hYW+4tIyyUgkpYNI/c/m+TnZp5VGvY2Gervo2yZalgeH/TRrA8P+mjVNkUULSNzXY2EPJ97yxUIK4LwCWNAJ/U9J5EL5ZHbrJjGlzjlI1UmsnrvG8hgZs76J3M5uy1YTfu05IYvRGQ7QEZy9YPAIyKwKxLH/i0hEEZO2xgaMnxk5FwCgvxUZqEkcUd4+vvnDIbPBqw67WsR0o27yaPYic6Et5g5VvtRJJzAxvmaYNZChe1kgqCN5aQHZR8+yVWmMZZVdHkwne7uI5hnErB8T9LsSCKN3o53VeIniVgt29LJOfRJA9zYGxn7oJBGysOtSehuuCaFjDvQJiQDslUbUUbfTd4JYy10ebNkbfDNYJasSMfIIpYmh0UoeSQXlQuf6O24ZnAFzYzI3MAlQv3P+EbG82Tsbe+6M/40K1gta0NMsTZCNQWB4f9NGsDw/6aNVGsjjjDRXgaIGH83bCpQ12ZWMxGwNz5m9K7LY80fIqHfxudGN7Wftu2fgc0KKZu8me6lHL9/cNcHNao547TiyI1ty8GM9GkIgSzYpfiDv1aAFjOP1bAj3UlMPcWH8mAMI2SpsUgw5uGMrmWA7E8RHON6sSxS9L6KWOmtZlgbtg7ObmtQ6aN4+ddgr+QcjtY/ZYu3yeVvsOA8eU57Y5dnMsIDvVcHe8H+Dnn0m1JYftEHJ8nSBkBze2+SfEcji3x9vI+PeMczbjOy9u0Ms2n3EIyO25DI+SR20973dJceV8HI+YOrcG8jhY8GrstjzR9Q7WP2WLt8nlb7DgPHq3yT4jkcW+PVvg5HzB1bg3kcLHg1dlseaPqHax+yxdvk8rfYcB49W+SfEcji3x6t8HI+YOrcG8jhY8GrstjzR9Q7WP2WLt8nlb7Bpc4gZAc56VWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVC9g3RGbmke8chhc7McwGarS6Cq0ugqtLoKrS6Cq0ugqtLoKrS6Cq0ugqtLoKrS6Cq0ugqtLoKrS6Cq0ugqtLoKrS6Cq0ugqtLoKrS6Cq0ugqtLoKie0FnMXAjkMc47Y5gM1Wl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVWl0FVpdBVaXQVE9uYbltAjkcLHg1dlseaPqHax+yxdvk8rf8Aa33IrBjeeAmbsg6gApmRR+j2G7TzkMy5ixKt3gWJVu8CxKt3gWJVu8CxKt3gWJVu8CxKt3gWJVu8CxKt3gWJVu8CxKt3gWJVu8CxKt3gWJVu8CxKt3gUjXxOtAteDmCBEwIf6meWdv8AQ93qHSP9rMD4pGlr2n3gqGW3WH3J4ml8gHCRg58/zCc5p4OY4H+xCkOlykOlykOlykOlykOlykOlykOlykOlykOlykOlykOlykOlykOly3jzwZE95/s0FQvrUfxtfzSzD4cvwNKAAAyAH/dX/8QAJhEAAQMDBAMAAgMAAAAAAAAAAQARUQIQMRMwMnESICFQoUFgYf/aAAgBAgEBPwD+uikkLTK0ytMrTK0ytMrTPrTkdphCYQmEJhCYQmEJhCYQmEJhCrA8T8tTyHaYQmEJhCYQmEJhCYQmEJhCYQqwPE2GRt1YvRjYOT6U8h3t18TankO9uvibDI26sG9GNg5PpTyHd3IcsfoXkZ/SeqF5FwgS0lPUhavgbU8h3erP1eVXz4nqT1Mgavp/xEkMJvXxNhkWOCvodOU5X39pyyBKcoKrBvRiwLE/ynMryLJzc5PpTyHe3XxNqeQ726+JsMjbqwb0Y2Dk+lOR2nEpxKcSnEpxKcSnEpxKcSnEqsjxP21PIdpxKcSnEpxKcSnEpxKcSnEpxKrI8TYZG3Vi9GNg5P4wVMtQrUK1CtQrUK1CtQ/mP//EACYRAAEDAgcBAAIDAAAAAAAAAAEAElECEQMQITAxMnEgQVBggaH/2gAIAQMBAT8A/jpqsnhPCeE8J4Twnj5q61eJxkpxkpxkpxkpxkpxkpxkpxkpxkpxkrDJfTrunKnsFYQrCFYQrCFYQrCFYQrCFYQrCFWAw5187A4HnxV1q828PvT7unKjsPdvE6HOvnYHA8+KutXmbaS0XGhATKY/q6NNPF4TKbG+h1RFJMDRNoHI/I0ujycsPvTv09qcjwVqFcq5Wv8AqubIEq5QWJ0OdfOUfhWEJourDMcDz4q61eZg2N9jD70+7pyo7D3bxOhzr52BwPPirrV4mmCmmCmmCmmCmmCmmCmmCmmCmmCmmCsMF9Om6cqewVxKuJVxKuJVxKuJVxKuJVxKuJVZDDnXzsDgefrDTdMCYEwJgTAmBMH7j//Z" width="825" height="144" class="img_ev3q"></p>
<p>上图概括了 3D 开发渲染管线的大体流程，即：应用程序、几何图形和光栅化。简单来说，应用程序的代码是一系列绘图逻辑的高度抽象，而这些逻辑代码被编译为底层的几何图元绘制指令，经过一系列运算后交给图形处理器完成光栅化，最终呈现在终端显示器上，具体内容参考<a href="https://en.wikipedia.org/wiki/Graphics_pipeline" target="_blank" rel="noopener noreferrer">维基百科</a>等资料即可，这里不做赘述。</p>
<p>接下来主要是要了解一些常用概念，目的是对后续两种不同渲染技术进行分析说明时更容易理解。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="着色器">着色器<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E7%9D%80%E8%89%B2%E5%99%A8" class="hash-link" aria-label="着色器的直接链接" title="着色器的直接链接">​</a></h3>
<p>这里首先需要了解的便是着色器的概念，在计算机图形学中，<strong>着色器是一种计算机程序</strong>，负责在 3D 场景渲染过程中计算适当的亮度、暗度和颜色级别，这个过程也被称之为着色。</p>
<p>在探讨 3D 开发中的渲染管线时，一定要结合软硬件来思考，换句话说，图形处理器（GPU）被设计为流水线架构，分成多个阶段，其中某些阶段由底层硬件暴露给上层软件可编程接口，着色器则为这些可编程的阶段提供了运行的程序。所以，可灵活编程的着色器程序，为 3D 开发提供了强大的图形处理能力。</p>
<p><img decoding="async" loading="lazy" alt="graphics-pipeline-1" src="https://wang1212.github.io/assets/images/graphics-pipeline-1-0d9bc622037e675f36f6f41cae4320af.webp" width="1500" height="338" class="img_ev3q"></p>
<p>上图是图形处理器的流水线架构设计的一个大体示意图，也可看作是渲染管线的硬件实现，其中绿色部分是可编程的阶段，而各种不同阶段的程序对应不同类型的着色器。</p>
<p>其中，顶点着色器（Vertex shaders）是最成熟和最常见的 3D 着色器类型，并且为提供给图形处理器的每个顶点运行一次。目的是将每个顶点在虚拟空间中的 3D 位置转换为它出现在屏幕上的 2D 坐标（以及 Z 缓冲区的深度值）。顶点着色器可以操纵位置、颜色和纹理坐标等属性，但不能创建新的顶点。</p>
<p>几何着色器（Geometry shaders）程序在顶点着色器之后执行。它们将整个原语作为输入，可能带有邻接信息。例如，在三角形上操作时，三个顶点是几何着色器的输入。然后着色器可以输出零个或多个图元，这些图元被光栅化并且它们的片段最终传递给像素着色器。</p>
<p>来自光栅化阶段的每个片段的数据由片段着色器（像素着色器，Pixel shaders）处理。片段着色器的输出是每个要写入的颜色缓冲区的颜色列表、深度值和模板值。片段着色器无法为片段设置模板数据，但它们可以控制颜色和深度值。</p>
<p>以上三类常见着色器中片段着色器是着色器编程中接触最多的，也算是最核心的。</p>
<p>最后，给出一张 Vulkan （新一代现代图形卡抽象设计 API）文档中对于渲染管线的示意图，相信这幅图能以更直观的方式帮助我们理解渲染管线。</p>
<p><img decoding="async" loading="lazy" alt="graphics-pipeline-2" src="https://wang1212.github.io/assets/images/graphics-pipeline-2-5beeac64796c5b122aed507361479500.webp" width="403" height="643" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="渲染技术">渲染技术<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E6%B8%B2%E6%9F%93%E6%8A%80%E6%9C%AF" class="hash-link" aria-label="渲染技术的直接链接" title="渲染技术的直接链接">​</a></h2>
<p>在对前置概念渲染管线做了简单的了解之后，接下来便是本文的核心内容，两种不同的渲染技术。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="正向渲染">正向渲染<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E6%AD%A3%E5%90%91%E6%B8%B2%E6%9F%93" class="hash-link" aria-label="正向渲染的直�接链接" title="正向渲染的直接链接">​</a></h3>
<p>正（前）向渲染（Forward Rendering）又称正向着色，是大多数 3D 渲染引擎的默认渲染技术实现。</p>
<p>**这是一种直接的方式，渲染一个对象并用场景中所有的光源照亮它。如果场景中有大量的对象，则为场景中的每个对象分别执行此操作。**这句话总结了正向渲染技术的实现思路和技术原理，其非常符合我们人类思考的方式。</p>
<p>虽然很容易理解和实现，但它对性能的影响也很大，因为每个渲染对象都必须为每个渲染片段迭代每个光源，由于片段着色器输出被覆盖，正向渲染也往往会在深度复杂度高的场景（多个对象覆盖同一屏幕像素）中浪费大量片段着色器运行结果，导致大量的无效渲染。</p>
<p><img decoding="async" loading="lazy" alt="forward-rendering" src="https://wang1212.github.io/assets/images/forward-rendering-28604d660822eb1b075e009404a38ca7.webp" width="600" height="400" class="img_ev3q"></p>
<p>在上图中，每个几何图形被一次一个传递给渲染管线，经过顶点着色器、几何着色器、片段着色器等多个阶段后最终渲染到渲染目标（显示器），这也正是正向渲染技术处理渲染对象的流程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="延迟渲染">延迟渲染<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93" class="hash-link" aria-label="延迟渲染的直接链接" title="延迟渲染的直接链接">​</a></h3>
<p>延迟渲染（Deferred Rendering）技术似乎并不常见，但被市面上大多数 3D 渲染引擎所支持。</p>
<p><img decoding="async" loading="lazy" alt="deferred-rendering" src="https://wang1212.github.io/assets/images/deferred-rendering-fc3a7552fc4454b0bd5aa8b543313756.webp" width="640" height="353" class="img_ev3q"></p>
<p>上图是一个有大量动态光源的场景，而这也正是延迟渲染技术的典型应用场景。<strong>延迟渲染（着色）基于这样的想法，即我们将大部分繁重的渲染（如照明）推迟或推迟到后期。</strong></p>
<p>延迟着色由两个过程组成：在第一个过程中，称为几何通道，我们渲染一次场景并从我们存储在纹理集合中的对象中检索各种几何信息，称为 G 缓冲区; 考虑位置向量、颜色向量、法线向量和/或镜面反射值。场景的几何信息存储在 G 缓冲区然后用于（更复杂的）光照计算；我们在称为照明通道的第二个通道中使用 G 缓冲区中的纹理，在该通道中我们渲染一个屏幕填充的四边形，并使用存储在 G 缓冲区中的几何信息计算每个片段的场景照明；我们逐个像素地迭代 G 缓冲区。我们不是将每个对象从顶点着色器一直迭代到片段着色器，而是将其高级片段处理分离到后面的阶段。光照计算完全相同，但这次我们从相应的 G 缓冲区纹理中获取所有必需的输入变量，而不是顶点着色器（加上一些统一变量）。</p>
<p><img decoding="async" loading="lazy" alt="deferred-rendering-1" src="https://wang1212.github.io/assets/images/deferred-rendering-1-f33344303d90f0eface11d3ef5838965.webp" width="600" height="400" class="img_ev3q"></p>
<p>所以，延迟渲染很关键的一点是将光照计算这种非常耗性能的流程推迟到后期统一完成，避免了正向渲染技术中产生的大量无效渲染。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="特点对比">特点对比<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E7%89%B9%E7%82%B9%E5%AF%B9%E6%AF%94" class="hash-link" aria-label="特点对比的直接链接" title="特点对比的直接链接">​</a></h3>
<p>目前，大部分的 3D 渲染引擎默认采用就是正向渲染技术，例如 Three.js、Babylon.js、Unity 3D；将延迟渲染技术作为默认方案的很少，例如 Unreal Engine 4。另一方面，Three.js 也<a href="https://threejs.org/docs/#api/en/renderers/WebGLMultipleRenderTargets" target="_blank" rel="noopener noreferrer">支持延迟渲染技术</a>，而 Unity 3D 支持的渲染技术<a href="https://docs.unity3d.com/Manual/RenderingPaths.html" target="_blank" rel="noopener noreferrer">更多</a>，Unreal Engine 4 也提供了<a href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/ForwardRenderer/" target="_blank" rel="noopener noreferrer">正向渲染的支持</a>。</p>
<p>正向渲染容易理解，实现成本低，灵活度高，可以很好的处理透明度、Z 缓冲区、抗锯齿等场景；但在多光源的场景下，光照计算对性能影响很大，会导致大量的无效渲染，在简单场景下可以考虑用光照贴图替代真实光源。用类似大 O 表示法来表示正向渲染技术的渲染复杂度：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">正向渲染复杂度：O(num_geometry_fragments * num_lights)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>相对来说，延迟渲染实现成本较高，对着色器的支持有限，适合应用在大量动态光的场景，会极大的提升渲染性能，但需要支持多个渲染目标的显卡，高带宽以支持大量的缓冲区传输，内存消耗高，默认不支持透明度、抗锯齿等，不过业内有相应的解决方案。那么，延迟渲染技术的渲染复杂度则可表示为：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">延迟渲染复杂度：O(screen_resolution * num_lights)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对比两者的渲染复杂度，具体选用哪种渲染技术，取决于场景中的光源数量以及几何图形的量级等因素。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Graphics_pipeline" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Graphics_pipeline</a></li>
<li><a href="https://www.khronos.org/opengl/wiki/Shader" target="_blank" rel="noopener noreferrer">https://www.khronos.org/opengl/wiki/Shader</a></li>
<li><a href="https://en.wikipedia.org/wiki/Shader#Pixel_shaders" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Shader#Pixel_shaders</a></li>
<li><a href="https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Introduction" target="_blank" rel="noopener noreferrer">https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Introduction</a></li>
<li><a href="https://gamedevelopment.tutsplus.com/articles/forward-rendering-vs-deferred-rendering--gamedev-12342" target="_blank" rel="noopener noreferrer">https://gamedevelopment.tutsplus.com/articles/forward-rendering-vs-deferred-rendering--gamedev-12342</a></li>
<li><a href="https://learnopengl.com/Advanced-Lighting/Deferred-Shading" target="_blank" rel="noopener noreferrer">https://learnopengl.com/Advanced-Lighting/Deferred-Shading</a></li>
<li><a href="https://www.klab.com/jp/blog/tech/2021/unitydeferredrendering.html" target="_blank" rel="noopener noreferrer">https://www.klab.com/jp/blog/tech/2021/unitydeferredrendering.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/Deferred_shading" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Deferred_shading</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>计算机图形学</category>
            <category>Web</category>
            <category>Web 前端</category>
            <category>3D</category>
            <category>WebGL</category>
            <category>Three.js</category>
        </item>
        <item>
            <title><![CDATA[黄山之行]]></title>
            <link>https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan</link>
            <guid>https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan</guid>
            <pubDate>Sun, 12 Mar 2023 15:43:00 GMT</pubDate>
            <description><![CDATA[终于有机会一览黄山的风采，也算是疫情三年以来第一次游览一座名山，顺便也去了宏村，领略徽式建筑的风采。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-03-12 15:43:00</em></p>
</blockquote>
<p><u>2023-03-04</u>
<br>
<br></p>
<p>终于有机会一览黄山的风采，也算是疫情三年以来第一次游览一座名山，顺便也去了宏村，领略徽式建筑的风采。</p>
<p>由于这两年工作比较忙，对于旅行来说少了一些提前的准备和计划，最近两次的出游基本都是“说走就走”。自从去年底杭州西站开始运营以来，当时看到的从杭州西直达黄山北的宣传语一直在心中念念不忘，刚好春节后工作还稍微轻松一些，就便有了周末去黄山游玩一番的想法。</p>
<p>提前两三天买了高铁票，订了酒店，便期待着周五的到来。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="看黄山">看黄山<a href="https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan#%E7%9C%8B%E9%BB%84%E5%B1%B1" class="hash-link" aria-label="看黄山的直接链接" title="看黄山的直接链接">​</a></h2>
<p>通过与身边去过黄山的朋友了解，一般黄山一日游建议是前一天的晚上住在山脚下，否则第二天时间不太够，所以我的计划也是如此。周五五点半下了班，回房间收拾好东西，简单吃过晚饭，便直奔杭州西站。</p>
<p>杭州西站由于去年底才开始运营，目前客运量相比于杭州东要少得多，所以对于初次进入杭州西站的我来说，现代化的设计风格与空旷的站内给人也多少有些震撼。</p>
<p>晚上八点多钟的高铁，到达黄山北就已经晚上十点多了，好的是酒店老板提前一天联系了包车，才得以没在黄山北站逗留太长时间，十一点钟多一点就到了酒店，洗漱过后便早早的休息了。酒店大堂还有人在专门讲解黄山的游览路线，并推荐了多条路线还赠送了一张大地图。而且，第二天早上，酒店隔壁就是早餐店，大概七点半的样子酒店还会有车免费送到黄山风景区南大门的换乘中心。</p>
<p>记得上一次周内上完班直接去爬山还是华山，那一次是周五下班直奔华山，傍晚直接开始夜爬，凌晨看了日出，第二天中午就下山了。年轻的时候还是好，不过那个时候工作也没有现在这么忙。</p>
<p>这两天的天气还不错，刚好入春，气温开始上升，黄山也是大晴天，并没有想象中的冷。</p>
<p>第二天匆忙吃了早饭后，坐车到达黄山风景区的南大门换乘点时已经接近八点钟了，排队的人还是挺多的。黄山不愧是一座名山，平时淡季的游客也是相当多，当然也可能是疫情放开后的报复性旅游吧？</p>
<p>选择的路线是从后山的云谷索道上，下午再从前山的玉屏索道下，最后一站便是著名的迎客松。</p>
<p>以前爬山，华山和峨眉山是真的徒步上山再徒步下山，现在基本都是坐索道了，主要还是很多山要徒步上下的太耗费时间了，一天时间可能不太够，而且山顶的住宿条件很差还费用很高。</p>
<p>下了云谷索道后，便是今天开始爬山的旅程了。八点多钟时，计划中午十二点左右到达光明顶，下午的下山索道才赶得上。由于是大晴天，看不到云海，所以对于很多人来说，是略有遗憾的，但这也是没有办法的事情，毕竟雨过天晴的机会难得。如果山爬的多了，会发现景色都差不多，重要的是爬山的这个过程。</p>
<p>从后山上来后的爬山路比较平缓，是一个比较轻松的路线，反而从前山上来的话爬山路都比较陡峭，会比较累一些。当然，后山的风景也没有前山的好。</p>
<p>从八点多钟一直走到十点钟左右，一路的景色是比较平淡无奇的。北海有个著名的景点就是猴子观海，这是在路上走时不经意间看到远处有一个类似石猴的东西，用手机相机的数字变焦才能看清远处却是有一个高峰上有一个石头，形似石猴，向山谷眺望，正如其名猴子观海。这算是第一个小惊喜，不过按照网上查到的攻略，以及地图来看，若是去一趟猴子观海的景点再回来可能会赶不上下午的索道。不过，倒也不遗憾，很多景色是远观才有意思。</p>
<p>上午十点多钟大概也就到了西海区域，这里有一个高峰，即丹霞峰，据说是专门用来看日出和日落的。丹霞峰是个岔路口，需要原路上再原路下，当时想着时间还早就打算去一下，来回大概半个小时足够了。不过，丹霞峰下半段的上山路还是很陡峭的。</p>
<p>西海区域有个著名的西海大峡谷景点，不过最近没有开放，是个适合夏季旅游的人去，而且需要单独花一天时间去，毕竟黄山也是挺大的，一天是不可能游完的。</p>
<p>大概十一点钟，看地图才发现走了还不到一半，距离计划的中午十二点钟到的光明顶还比较远，正好也到了岔路口，不知是直接去光明顶呢，还是去排云亭，再去著名的飞来石，再下到光明顶。这里就要吐槽一下黄山景区了，指示牌上也不标记下一个景点多少距离（公里），路上石阶上也没有距离标记，看地图也看不明白，导致游客无法计划游玩行程，只能从网上去找攻略。鉴于早上两三个小时的经验，发现地图上画的景点虽然很远，但实际走下来都很近，考虑到离下午三四点还早，就决定多绕一圈去排云亭。</p>
<p>要说排云楼和排云亭有啥意思呢？看过了实际也就那么回事，之所以绕到这里来，还是想看看著名的飞来石。其实在丹霞峰顶的时候就能看到飞来石，只不过感觉距离非常的远。</p>
<p>十二点半左右的样子，终于到了飞来石景点，不过飞来石只是上面的一个小区域，而且上去的路只能一个人通过，游客都是排队先下几个人，再上几个人，轮流这样才能上去和下来。飞来石的侧边都是悬崖峭壁，而且只有左侧有护栏，右侧没有，站在上面还是感觉有点心慌的。而且，站在上面拍照发现根本拍不出来效果，还是离远了看才比较好。不过，从飞来石下来之后，往前走个几步路确实有个非常好的拍照点，我也发现黄山景区宣传飞来石景点的照片也是站在这里拍的。</p>
<p>路过飞来石之后，就是光明顶了，也是黄山的正中心位置，一路还算平坦，比较轻松，就是路程比较远。到达光明顶时大约下午一点钟，比预期的时间晚了一个小时，不过在看到指示牌上写着距离迎客松也仅有 5 公里后心里也不再着急了。只能说，到了光明顶才发现今天来黄山的人是真的多，几乎都没地方站人，从后山来的时候一路上都没发现有这么多人。相比于峨眉山的山顶，光明顶好像是一个用于气象研究的地点，倒也没有其它什么让人感觉有意思的景色。在这里逗留了半个多小时，吃了东西补充了体力后准备向最后一站迎客松出发。</p>
<p>如果说 5 公里的路程比较通畅的话，预期两个小时左右，也就是下午三点半左右就能到达迎客松，刚好能赶上四点半的下山索道。不过，去迎客松的路上有几段路还是很陡峭的，并不好走，尤其是百步云梯那块，当时人群已经非常拥挤了，百步云梯应该是人更多，只能走另一条路。其中，有一段几百米的路，人群拥挤到走不动的情况，这几百米几乎是花费了将近一个小时才走完，当时的心情是绝望的，没想到淡季的人都这么多。</p>
<p>到达迎客松时已经是四点半左右了，也就是说 5 公里的路程走了三个小时，好的是下山的玉屏索道也因为人多延长了运营时间，此时倒也不用着急了。迎客松作为一个非常著名的景点，我在小时候家里的挂画上就看到过，相信很多人也是以类似的方式了解到迎客松的。迎客松毕竟是一个有生命的植物，不像石头那样可以多年永存不变，近看时会发现迎客松的树枝已经用了很多钢索在牵引这，而且树上也有很多用来固定的东西，可见迎客松的生命在艰难的维持着。</p>
<p>很多人来黄山，就是为了看一眼迎客松，与其进行合照留念。在这里逗留了半小时后，五点钟的样子索道排队的人已经非常多了，为了早点下山休息也加入了排队的人群中。</p>
<p>下午六点半的时候，到了黄山脚下的汤口镇客运站，准备直接出发去宏村，此时黄山之行便暂告一段落。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="游宏村">游宏村<a href="https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan#%E6%B8%B8%E5%AE%8F%E6%9D%91" class="hash-link" aria-label="游宏村的直接链接" title="游宏村的直接链接">​</a></h2>
<p>宏村以徽式建筑而闻名，恰好黄山只游玩了一天时间，既然来一次，就顺便在周日再玩一下周边的宏村。</p>
<p>晚上住的是宏村内的民宿，环境还算不错。放下东西简单的休息过后，便在民俗老板的介绍下去吃了一家徽菜。徽菜和我们北方人吃的菜相差倒不是很大，口味也还可以，不像杭帮菜主要是以甜为主，很多北方人并不太适应。</p>
<p>晚上宏村的夜景也还算可以，主要是今天爬了黄山似乎也有点累了，所以看了一会夜景就回房间休息了。</p>
<p>睡了美美一觉后，早上起来看了宏村白天的景色，白墙灰顶的徽式建筑群倒也别有一番景致，加上南湖与月沼这些水景，增色不少。</p>
<p>宏村并不是很大，游玩的话两三个小时足矣，特产可能就是黄山的茶叶了，其它的倒也没有什么特色。总的来说，宏村适合夏天来休闲一下。</p>
<p>需要吐槽一下的是，宏村的门票偏贵，村内的东西也卖的偏贵，村里部分大院进去还要收费。</p>
<p>中午又挑了一家村里人气很火的徽菜馆，味道也似乎并没有昨晚的好。吃完午饭，在村里到处惬意的散步一个多小时，刚好饭点的人也很少，适合拍照。</p>
<p>下午两点多启程去黄山北站，回家。</p>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>生活</category>
            <category>旅游</category>
            <category>黄山</category>
            <category>宏村</category>
        </item>
        <item>
            <title><![CDATA[速读《设计原本》]]></title>
            <link>https://wang1212.github.io/2023/03/05/life/reading/index</link>
            <guid>https://wang1212.github.io/2023/03/05/life/reading/index</guid>
            <pubDate>Sun, 05 Mar 2023 16:47:00 GMT</pubDate>
            <description><![CDATA[在日常工作中，经常被糟糕的项目进度控制和需求变更等因素搞得人身心俱疲，为了缓解这类问题，产品设计、程序设计、项目管理等多个环节都需要参考一些优秀的案例，而《设计原本》就针对设计过程进行了较为深入的探讨，在阅读过后发现其中一些概念是日常在用的，但没有意识到的，也有我们一直追求的理想状态被作者认为是非理性的，值得一读。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-05-27 18:35:00</em></p>
</blockquote>
<p>在日常工作中，经常被糟糕的项目进度控制和需求变更等因素搞得人身心俱疲，为了缓解这类问题，产品设计、程序设计、项目管理等多个环节都需要参考一些优秀的案例，而《设计原本》就针对<strong>设计过程</strong>进行了较为深入的探讨，在阅读过后发现其中一些概念是日常在用的，但没有意识到的，也有我们大多数人一直追求的理想状态被作者认为是不合理的，值得一读。</p>
<p>在翻阅博文中读书相关分类的文章时，发现自 2021 年更新后一年多已经没有更新了，倒也不是这一年多没有看书，只是看书是断断续续的，也没有坚持持续性的记录下来。近段时间刚好不是很忙，看到电脑中之前收藏的一本电子书《设计原本》，便饶有兴致的看了起来。鉴于现在工作忙的原因，一般看书的时候都是下班后晚上进行速读，遇到好的内容会花多一些时间深入阅读，这本书是连续几个晚上，总共花费 6 个多小时阅读完的，虽然时间不多，但还是有一些收获的。</p>
<p>这本书总体来说，内容并不是偏向学术理论的，文中有大量的实际案例，更具备实用性。也是在这本书中，又一次见到了“银弹”的说法，对这个说法有了更深入的了解。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="关于理性模型的讨论">关于理性模型的讨论<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E5%85%B3%E4%BA%8E%E7%90%86%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%AE%A8%E8%AE%BA" class="hash-link" aria-label="关于理性模型的讨论的直接链接" title="关于理性模型的讨论的直接链接">​</a></h2>
<p>在阅读这本书的过程中，我被吸引的第一个关注点就是关于“理性模型”的讨论，实际上在这之前我对这个概念没有任何认知。</p>
<blockquote>
<p>将设计过程建模为一种系统化的、按部就班的过程的观念。</p>
</blockquote>
<p>以上是书中对“理性模型”这个概念的概述，这对很多人来说似乎稀松平常，如果进一步了解作者在后续过程中举例的软件开发领域的“瀑布模型”之后更会觉得原来不过如此。</p>
<p><img decoding="async" loading="lazy" alt="waterfall-model" src="data:image/webp;base64,UklGRkIcAABXRUJQVlA4IDYcAAAQrgCdASpYApEBPpFInEulpKMioXTbKLASCWlu9/5ay2m4duEV4DWYrcu86QG/UpG/NF+o9gH+Q8N/x359+5fld/a/n9xL9kmo18m+0n4j+2fuH8lu0347f5fqHfln80/v/20cVvs/+o/6fqF+tf03/i/3H1f/nf8p6J/Xr/BfaR9gH8z/nv+r+4r55/5/jjfg/977AX83/xPoo/9v+x9HP1B/3v8//mfkJ/nv9u/6H+KAzompu8+VEcI1tPwsH+uP36bPq3ErUhC43fJyVDD7h74Uc4hvD4cHaD0t0aNvhwdoPS3RDC8nyP5MPOhxGYV1f0jyKG/lILprBc9RIzASqbf6uZcUNy1o10detVTH1O8JUywWC6q35THY+YMmXvFEhCyeRezSlxZcmEocy5RLN6trFjrNwSBWRnwKuSTLFlp1v9WrtM5/RMHi7J6EubUa4LAsBqUgfMAcYw/dqnlQtDcyXI9t624LKd1WnXDJOPzgbMPktOzfnUFqEgRpEvrtP+MwRJ8/IZkPEmEfJSXpmc73TvySeg6bp1dwgsagQvsAYe35WqZU2Kty1Y2EsILLMbYpEy55qTu1j+pOcweVqPlZEy0ERv6+ckUDs0PkmmiyZRxPMhBFTQAq0q+Sl/IwceRUwmvNS/YDsh7B5WpEf/w+RpZse7Ywl3e/zMdliU35VxbymiaKC91lqqm7B+2XA1nMjmhD+xhoUNsbB5WpEgDou4JH+2jErCKuQVjKRL7n5FA8SBcuQ4ZpauBld/oN1rwKey5vGYPK06MpSXJK2WDrMRZfaR8d38Yz9RfaxSPv2zmvWHIvbaY48rUiQB0XgGUpQ0k8nfafwu6dLjA63AhQ8MuSrBZ2+6Z9iWddF4FPZUuurjXKt/h63ouP1WwKVVj/Ah3AihqrAC6Lzn0SdiUQxj1m58gDNyIkv/CUNYTpVaxmWCjfrnvU5XtWe+oollakSAOiyHZeRy2YYwAOgHAIRLKzXY9oxSEcQZAZtb2DfuqOCczB5WpEf/w+RbJgQnQeTSg0eBJGbWMnstbsbHVOuJu69fyTSmvqrObAvNJFM080z7FoOi8CnXKULPbf+LrirRBC2MVjr1NpPZuZ/bq8prsq/0OoPK1IhXxKBEb/xdcVDh4bGLW8DcrmBdHV8MoJ3d2xSPiIMHrE+6MT8gG1ZFikZ0NHFzshf0ubxllooP0gVqPojEvANN/TzbefLFoREL0CBsQXT6C2IOlsay0UH6QK1H0RiXgGm/sFN4RzfX+N43RCxlMF1uszSiXweVp0ZSiBJrlAp1sqdaV0WSfaf7wVBE5kJ7cQPAA28vdNd/AGVrUfMmzVxUOHhuteBQx1o2ICFQGs5RSNPY8ypT6tdbuQeTPAaqjyXgGqN/4utNSJF/J3W4vDkIjGIkI5qhJwBSMM2vFJW7i1q+FF7lWX55Q4AoU2Lb1u0ueXSXSapyZNhxURv/F1xUOHhsY2EBRxrY58qHwZ7qxxNoshNW5ItZVnTwz5N20BlKS0rUiFuteBQx1o2IB+R68unNcBlIJrFadSCjuLouyvZlz/cEHRdwrZc3eNK1Iq2jIOYwrhbg7QCjul5p/piL3QKlAEf2OulXWlhoQAsBt3U62VMNRKyEMWsPkAOgPu04l3r7NWWFbE58XczD5miwHpEf/OIbw8ZxhErKbQelsVfGyGBRXhl/zQ0OmS0vlhkYhyno52nIZzAZ9SIpkajwaX/oo4AIBCMj498QGML+mftSlvHJ4ROWHr8T8EQ95FLpGkRXjeZ3Afl1uKldKh/13Af9duJDLJ5RmigkgYpgzvbnVTqv/4vbfhLhTsaNG3w4O0Hpbo0bfDg7QelujAv/K6GOXZbrHEJi25uIAA/vrwR/UC/qM9z+Jiod/YVsplQDmpRryJs9lV/l+2MxTAF/wqlCt/ASqbskBTIlbxIIxnpu5mEZYahpbaGc5AGH9YNw3q0hSi7BlUVjmGTQ2EHsn2n9SbzvK8OBLbVRKcriP2UwZLbGRLvnyoTZ52ZLEieAEjIqRcHVozHxNouBbPIjahBENi1muDQ6dffin5nni7iZuXwVM5j24xSUpQTlIbHZT1Lbg9rzXYPSAQg388Uq50A2tbpcWn17tnHzJ7SITQGTW4X1bTuS2ke54rd2UWElLAlxW7sosJKYmRY0uMHlCcsJErQdoD8Rzx6dmA+wJAc8Vehn6NpIO6/b3MWgTo3oDxAtPl4mRRj2H40iJJeueFLisdU18i/ZzhWopaYdWBR3ROlEnQA2Tmo7b2nJluAlXciAycqnMqF/xw7ix8+wpAsGVdRJysYXt+JTbPThn4r24TtlsZaz9/yKxibWOw2EZo5Pvdx7/WRVwFfgDbhqQZKUBSZkdy0iDavybVqohWdFdcw/2V20/n/GK6p7Kj5GW3iQ2J+Jf+C1dzhdWC/aiL5SrWsvgT2qC/ZFY5vcj1uj27x9TdTXySwtG5fOBpAkMR5Qp6NrYiA9ILsVy5hJ4bs6I1ylPlNU3Ch9gW4ego7hOURMhfFlOYX9inIeJikZaS3D3iO0kd73+fOmZZMrzeegmd5WzlnzLBhSEoE2HnuJ2lZf7I3wzUbPTfwGh26rwTxlyHn4svBgo5ueKef1NHoNWz+KwnB9zKKJx8xI0f/w+iHzHJXaldAvgvSQRqwKWBVQWh5Vcn4Ht3fYwREexljhm7o18kE+MzOu1tIzWf24SiOqI6uSL7jySIBTIDqgS1HZj5fXTGKakAAAARKVZIGvyHz8vu/MtsaD7qSMEvf4BoQvw8GLkqMR7xngg0YNOsr5yWcNbcvKG/67CtplN6RsY6pTfwFJ+jC0X7Y9UKua3O86srhIc3/UWDUlMRI4uaC7JlUjLRNf3ajJkjdyptkDn/sn+gSXCSfOMvYVumVdgRYJ52B9qivLKPh2dWsejr8em27lbdZ+qwcbHKSQ5/seIQv2tgOzCTAFggyIlRsEKHi69OJHIBGk2WQPxI6gNolEQ2FEyKlo16quIJ6QTvlgCIwbxbq8c4q4JXOsjG843FcB8noa4ZD7RA0R67CYB5NAJepZMOPknRkd7VK+JM6FdVHLKSAUFiCEZSTKrvh09SjBh7B3/aN5jwb63SlLlfEvSNSKCzE5eMxT8gp7Fj8DylowduYbJPsUZHK6C1iVGyoe8tmPdsiMGklcxX025dyhBsAr6ozFWLs0D8FpUhPe8EtQOl3GYS/bf/0Hk6rL9MuBQECnsxkl3KNM44KH6QAxUtdk1dMeEXwmBJ40h7V2uXLXEJDsJpKf3yuwBjpeJUQoKyQEkrrl+xyIK0vroPakb+EN0XO/s+l9CpS6R59RHmpPbA2Sybwev+vC0EO7oC0LHVF2zcerej6I5wcd1totWjBV+wXOM+B6s3kEEqIXVIhz0WLnAwNzsoSVggW/Ifz+Z+Bjyiwd/pS0Ihj3wuzdD/7jwZqSmPdwiuzfCIubt7M35xzjMNIIn2aP6NF6d6l448PuOiOUrGx6MxLjj7UZRyirnvAuFJOe/CyHAmWrhVpkqdet55gzB/7nC7Lr+afU/MBdhniPCptz/PD6+Gurnt/l4KiYoLn8JcsBsEdsD/1ONksZ/bO2T30YBtKGP+ugjvs42QS/GdcL7edP6BbeuRrrFd1D4y3jLlVXDN+QGr2cmSynRhp6K8nxwnfXqLXBqltEnrPeoSF6vtxDDn2nW/pH0k6i30uTmM+js77NtKNwPqE9QBV+mth73XzyPMMEdvjxfu8Npqb32Iy4UyiPPxlvX9oA2Ao8Se9jDBDBYRpeMHq1B/fjKiYYxfL/DuuuUQsoEQrUn1U4bYTOfQ2qa8P+zYbFOtyGCQVIVGzSjurl7N5VS5oDJSu6PjgnRIBQGSVGs60VxkHhGriIUUK6rUAzdMiKIOXbQhRQGGnodlhwmBU5VygqPtYz6xKnj7LP4S+PebKj6D3nJHkWX8UBywIUdAKLkZpm1xgeE3nTAgsl0vviTD/N36P1pDFdRL88UrB8T359yGEkXOb1WTvp8HfEQMkTooUG4O1P9u95bPT5Dsvm85NHBpy3FKwH9E/eoKlC/mzZbR3UaCTnu9fABo7yMPMUOZsA4jVIUYei17guP7e2k9toBDMIr6FYfxd4s7wQBw0AJ135EE7zQaIJk6K6lN91tcrEAmeToczp0wE3tFAdJCwUkC2gTD100IN7r4jo8QA3/ikcWNHFYvxiAp/8quCjo0o3i+5c3NFp5xI+cH24DPOvsj3b68PtT9NDqaydb3l+pdyUPP1WyzfubYY0PRWBGGVPBbdghC5qvjRf54uJ33UzrwvVCX65abULpECXJ1x4aMcC4tHOvvnksM7n49akJbx/HsifxtzfN3vxKQeOQQmER8KO9FdWxr2x3jbAdW95IXHqvCogaiBRwA8gzkHgphDiwe139h8+haVzZooo4guZ6dVlgVVquFz3oAsoPyo9Vp37It8AK0aNb7/d7b+Vwqq4wZN03BUJEF/9Ee4x9SjVUmDtHacpOw9UfWwF7HZE6owgMYUedQqjgP8gNaq16kXBUg7fQbuhgd5EiGeovawDRLuVEmNgkocotv+m6Xtm04qkod/42OscTHRJjbPzUGwl+jY8L19A7vHNqJsgCsYxw1/Yt8dvOzxsxpQNHpFGEOQYkbiuf/10RNM0Ie8tkB9BBrkDieWXdZPoiuYWr+8JEOqhYUatdkIYj0EACfmgMF/pocQXVaHODu7ZBvVXClHiCWQq20GovPMghWiZyrAFbKPeqZzExjkTrlZVnouFmPghMCWHfTko/2OEPRoABfOtDx0KqIRk7cfniwvC54/vn9lUpokSphwaXQa8Vc+nXao3dBkPWKcFDQlefb5RDluBcN4RrReJ43IxI3I7umfFOQVVCVHaumu2XgmeL7kxpISqztsYccB+ORLPwzXjl1y2rx7Rv0P0hVO3AeQxnuRE0SkDj3G4X78U69Pv+Ume4Vee3nxr4UfKfGWft129utWi+4rpJx3krZso3UhsswFIi62rcp2BLSF+aiLOPuseQ9gOeGByNLf7pveuVUk/dYQBDFuduUZ/n6IRMf/j57zpe3tINCLpqp4CkTKThaDbmt8i/uDsqA/Eo+D/4QE7Ct9gQ5ynTPBbdgwzCb9O6wfd/L9Dw50IBH304UQObr/TKbBlspGMxbsC0t0NP5I2rW31wXa0ERzrImvvCWe2goqjpjwJPB5RlUXyThRaIcd0QvoHzUdlLxkTC6HiOwEUxewZsBR84FqLpBaHjNFulK72dTTtemWqmWCHnx8sj89PuxcbmoXyKrsWPsCk4TsKh3iQgw3O0FHW9O8tfW0jqtEnZy6+LNL39wz3ZxQZvlazFxoXk5LH+MS1bWc3RR1qLNF/tnypFI++PEGfqRGz65w19YWSz3Fkn7cZs7X1jWIInw/8uoefgo+uGPUbg400tVeE+6WbTOPEF7eZlbLjyFd3n3jUS6hgZPZFrqfVaCkX9l0PBi8MOVU5wllpYl576tkjt0J10i33iSPQVDhOP3zB1SMwfPar9v+zVj4oDC6+lZ66CeK7th0xU19AWFQY0TA6lLrx3Amm14TTHJl7qHrMbRatoygppL0OKIyyK4RYYzXP6H/L9Cpy6pM9FZy7idRieb0diywml3BElMCVCw72Dj8Vq6s9M+LK2T4Whoe15Jv4FhfISTUtpvzXF4jR/ZKkTW20ddeC096SzySSjCfPDSaq1eUNCTJ/JNtThF89ryEFzHBjDT1MvnAZXz/2LT/1HZBqHu1CrUzpHw8M5/nodNGyN7vXPZji7hJ/qLY6f1r8Ua/oUKTTeIGE0qWQSZ5X7k8QEEw3N9w27NnwiBjLnI48cqsoVOgXhNgl6bYNW73w4J91LM3XA7ttZpwQ5vhieLK9jefVctiT3yzI2kpHh+CJXllH74YRv8YErBO9K3A3/MW7PwXep06sPSzGglLJXEeYVmd9m2MWIfC2OK1JrEZQuXloGafBOtB7U9l6qwYBkYW9FKG6mnMkLSdlVvJMAataEVA3jgvx/pdBlsfpjKTZL6i+auQP1sxPDby/0/xeO2jkk4NdNxR+0ngyz6qvr6ommR5E0C40kkhJ5I6xP56uuCiJfwPDU+JDGPeMEZz77aJw60+OQUbWAPzGH5KXB1BfEAlBIz0ti5Fu9MNeyaXBNOtQ0eZ1KbyW2BB+1R458/quLYU1nrQdwB7feuDqcbSd2G/+2R77GSJCtWc4il6vDpl/rbVFjWCqbvUUSQkGPOauib7JnWlnfyKnJUqhsdNlUIvdSGNkTAW0A0r3r/IMr0cFFwE/Eb43RzbKsZ67lNvZ3apQMN1G8iv7VqMDp1EjPj0kw5aWBEQ2Qha04df8TYFfsUQtDoxZPpOV1YeSZey5ZM/FG8a4duOiYbw0pqEC2b4MCnhDzxjUm0EmH5tYCtQMnyPhyBkYwziveS+juktG5f8h3im9ELbZRSLgB4/E9ZkJf96rajJlenFMx8/9vSQg2FUNxr26JkokwwsMufzjy4F8zl6Rhu/3oBcaB6CaFYfFen9JrRtTWgMeLwHBCgG7tTIYm8WWB/8S2cZpq7EVzKrKSUQHGuhAoNSArjXPI76t1BNE4xX0rrVsPb00nNQzKU/A0aa3BtCF029WyVVGHvm/FL9yl6Fj2W5nEJMeMBJT6OIAGFtyjSkFzaB0/9EH0JO4TOSvOB7ifm3EC2TSEBIYTr8iSZQCZV6pIzbp8k5WETiotfggFrPB1CL7lGzl5JYh21iytlA1czHRdAQOz+OJ2vEENzKAbYgPx2QocyrPt3IsgFg60C5egzGT5nfR4PnULGzNgzT2w2QEvWnPfQVIAc+QdSJUFbns3NFNGQwgLUk+zpRrdmqJ4FSQNlo5nr27IkfUWPnHnzB5OhTFaeHMqX3YZEayPgw5NxatdUQOeAsZKALq3nOE6NAnWeyiO6oN4Be51u+kE2VJ4pIuc9ZcGiIuZrpp0AnIAFOINJ4UFkCe6qLXDSLIvF/yZQmPaCD92j9XMxSZZsp0tiO6kOBBO3XRaQR9ilcyt13rea87CGI+zVXN0ju3mVY5Pe1FQQVsRN8f31NJPehM7VJ1/opWlBd8KCSttGsT3NoM/hMyKx0zTsKJQuUCcLvBOjrAggchLNCX2fQtL7b5Dspi9nERWJEDlqyv9m80FEI3mwmShMzIWYZiZNFBihn4JNjj8Ysrj/7cKtCMU4C7OBowHxXIzIpC9Ph9D4ZoUFKcDI1Poz3TZ5ABTWXN63/1zcWh9cizgOBurSvUml3wEDt+sj2cOxVKIRIOrQ1FUo7VrFKND1my2l3gTojGFUu7hExaA47VYiipvcbQhxxdhOH1Vp0FUQbJ2eUtOsv8T97gkzR2qZAvXQHQcTdLoxw9BQtV9Xf/Ss7kxPItbp3BWqm3EwJ6PFjH2KBWlKcCZ6h29a3JiB1RthpZl1+sAFRIC83PZ9vk+q6M90THvEBR0Mo0U2ziYbx3k/cOfOJ0czFUay1vkxqOHKUhpkh9bT95t/9AZKrWs/RXtLHFfiLA6UUsY/Y7jkWTZ4k2h2DTZJp2uvCyuLPi44633F4FwncgbdottzWvp060nl762iDZBfO8frj8aWoHsDpOuiTTh1bGLly3HNVbQZOokmG1xfBVLhlfJKicQTsJome9T1xIGnV1KqmnY4JfD0NWqFRvUzR1LQR9SfNIHSfQbZYZBc3V87SotMRexk0Xlaun+pBGWLIXEpAW6vjen50ex9MJBL1uaIR5otRVlmthhVbRVALdLodyiomsED3yGdk5ugHVx3Qzter4FLXHr0hhXYvSdYUIE9/6LmgLPXDPD2POT91Nq6/LpL9pH/PYBIdxtrmSzQWpNj9FZ3LF1F3/G9ReiTNCo6b5xOFybW7cD9+H+5jYfePOg557vRWRXu9XhEOAjx1D3rRJARUvUaeDKRURB2RStwK6+1gRzsP5Z5FNX/5IeiiPz5J6VU5I2Oc3KVPTvthLrhICfH4Y2wQjW6ucmG+QfbML/dxHi1Klwq9e00p9iCoI1ozUbkPPR06J+9nGIXrzXFfrkx9FVdu4SOxz1LiYfRA4EX3ItT9fzr/AKCPOLU5pSkd0Dnipj2IG54e+nUCSL452VnLHnMi0cjoGpqzMQ/h94UPILd4MKbIj4RU/gWhaUU0Y0eTZaDM0DNIArcxQfjwafIcAmZMXQgPzuKr/xjwnFSxvaZ/za3X9TCK6DToPURJxSuxwGDSl4t8A0A6mj9P8o5yVO9Fczlz01DSpWF/CifxpLLOJa1BqOjj6kJtlX+BOvI42Icvdy2MewllB4r+e3raeBSEaRwZMi8waKnf3gFJOwJU4zd9vwjpuZiac08gCy5kCQuDZh5BQZ1H0iqqdnoh6SZt1FnzisRVWlWgSAvewL/OjVD9Pf/5Echgx1gnGC1ImFqYn4iwISLOB3PZUTBB9xLI6cyUpoxYk+NEQoAn7SqgnqQTPtt1e3vMXwLnGNH+A/KR5uJ19ldObHwP68EWHr26FGvOJJge9pHKB6PfhdfOWqoEJqViFDpYAkXnj5m3PJ8/B2e82yn2WD6XzAqhKuUDIZJL80LeUPVsVmreyTZeC7lVaJTb75gTExxMy9qCqnwYrD2+nE6PMOQCyGSU7j7EYbEcYqx6jrFAmNotw2rCbOgR4xAg48/ybFRMC3LRDtMddxbr8vMrA4Ge9Wr5bBQNw/+agXd0Rsg/Tw+21zBEOzKGcfQBBb5FBstkdkifMrPZ+Su/Y/LB1UHSjnxOnK9VOyXnN0wMQJ6LsyAIOZJ+n382Ybv6aOiLRfQQud0MmR0wmq9m3Ck06ecz4ZntKZMCdJOJAYl7ghir25oc7gX4teN/ANqXMpOHmXJij1vvRAxoXoETOnyaVLaN5gCawMt7nCZn3LPiS/hO8Bra4jOeL015g1HmOj1nMAg6QdDJ+IsyElZy7XzOYZAoh9lMgEvymS9hO9lHsFBPoSiUZsiWjrFc5r3/kO0vnYRA0fIcmX4uX8vzuZpTcGU7Yjdm1U10zuX0ialHmTVB/CYB/mzyhbc81T9ZSMKM+fQk2T4OrHqxJPRTFVIzBbLb2+L44AdpYM7B00K+ufFW/FfgBI0HWntvD5gnj1LBwa6w3haPpdtTDgftW3k7WYlykPl8otvOUmUB9BmB6IR5TpMJsfgdZHmgSH6pVFoDRDQ2Zf5hFFmt2XZ+elvWarMHsjegDKQAljqLSq/yHFPYhAakX9kHOzj91TuOHL1RFkTXAU7ZhVCEEwvtW97czQ7ICJq7TjnNRP4EgCAZbEEvYmvuQVze7flWSHWwyfmmBhlLrkTKCK217IPWT6Qwpx1W4CxZ0+NQqUz9PyVJIchgqkA9s7gT2cvDXgMvh6XlGa/2/T0Q8k9fvsH/J6OfscqDM4BB34G8s6PZclbTqShZkMQHB+pEpMtXuG2yfUnl7gCRfB/TiirswWv5eMXCoLV1lTMmiDIOQAABti1fSEwONOHIVNPlXbox2Tz3psKeR3TDR3bVJIx8YmJIGqebqNH2XnVjymRzmL0/cg5hJnmxhjBGT5y8eaNHieUeepyBJoQdg/X5s0EjV8UlR4kjJ9kc0oNfaWIk/bgzOo4PURZg3G+IAAUcR3PwSElUqkK8zZLT4AAAAAA" width="600" height="401" class="img_ev3q"></p>
<p>如上图所示，这就是软件开发领域的理性模型，即瀑布模型。乍一看这不就是我们每天开发软件的总体流程吗？</p>
<p>但是，本书的作者却不完全认同理性模型，认为这是过于理想化的东西，不符合现实情况。仔细想想也有道理，因为按这样的流程开发软件时，对于一些过程中的细节我们总会因为各种各样的现实情况而妥协或者采取折中方案。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="理性模型的优点">理性模型的优点<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E7%90%86%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BC%98%E7%82%B9" class="hash-link" aria-label="理性模型的优点的直接链接" title="理性模型的优点的直接链接">​</a></h3>
<p>针对理性模型的讨论，作者先叙述了其优点。</p>
<blockquote>
<p>与“先开始编码再说，先开始构建再说”的行为相比，任何将设计过程系统化的工作都可以视为一种长足的进步。它为设计项目的规划提供了清晰的步骤。它为日程规划和进度评估定义了明确的阶段里程碑。它为项目组织和人员配备指明了方向。它改进了设计团队的内部沟通。而在设计团队和其项目经理之间以及项目经理和其他利益攸关者之间而言，它对于沟通的改进尤为显著。新手很容易就可以上手。掌握了它，新手在面对分派给他的第一个设计任务时，就知道从何人手了。</p>
</blockquote>
<p>根据实际来看，以上叙述比较符合我们日常工作的感受。</p>
<blockquote>
<p>理性模型在特定的情形下会体现出更多的长处。在项目早期就给出目标的显式陈述、相关的必要条件以及约束说明，这有助于避免让团队陷于举棋不定的局面，也促使团队形成关于项目宗旨的统一认识。在开始编码或正式的制图工作开始之前做好整体的设计过程规划，就能够规避大量麻烦，也避免让许多努力付之东流。</p>
</blockquote>
<p>以上两部分内容算是对理性模型优点的总体概括，感觉还是比较深刻的，尤其是对于团队协作、设计项目管理等方面的考虑很到位。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="理性模型的缺陷">理性模型的缺陷<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E7%90%86%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%BC%BA%E9%99%B7" class="hash-link" aria-label="理性模型的缺陷的直接链接" title="理性模型的缺陷的直接链接">​</a></h3>
<p>接下来便是探讨了理性模型的缺陷，这部分内容其实也是最值得我们阅读和思考的。</p>
<p>首要的一点便是我们在初始阶段并不真正地知道目标是什么，理性模型最严重的缺陷在于，设计师们往往只有一个模糊不清的、不完整的既定目标，或者说是主要目的。</p>
<blockquote>
<p>设计中最困难的部分在于决定要设计什么。</p>
</blockquote>
<p>在我们日常的软件开发工作中，项目发起时大家都会明确目标，不过这个目标偏向于结果，对于项目或者产品本身没有太多具体的表述，如何具体去落地这个事情便成为了一个最大难题。这就会导致项目过程中出现频繁的需求变更，更甚者还需要进行目标修正，这一般会导致项目周期拉长，多次延期。当然，应对此类问题书中提了一种方案，那就是快速原型设计。</p>
<blockquote>
<p>设计师的主要任务乃是帮助客户发现他们想要的设计。</p>
</blockquote>
<p>快速原型设计采用一种迭代的过程和方式，来帮助客户逐渐明确需求，从而确定设计目标。也就是说，目标的迭代须作为设计过程的固有组成部分加以考虑。</p>
<p>其次，设计不是一蹴而就的，在一些高技术的领域，一个人很难有足够的知识在一开始就确定好设计目标，对于周期长的项目还会出现中途换人的情况，所以这实际是一种探索的过程。那么理性模型在这方面来看就过于理想化。</p>
<p>另一方面，项目进行过程中，很多设计决策并不是最终方案，实际上只能算是一个暂定方案，随着项目的进行，一些未考虑到的因素会被发现并影响既有的设计决策，同时客户的需求发生变化也会产生同样的结果。也就是说，在现实情况中，不可控因素有很多，理性模型注重的是按部就班、持续推进的单向工作流，但这明显不符合现实情况。</p>
<p>还有一种观点认为，设计师通常并不会按理性模型预想的步骤做事，这样只会限制他们的创造力。</p>
<p>最令我印象深刻则是，书中作者大胆指出，很多时候我们自己并不按理性模型设计的那样做事，但又要求别人如此做事，而这样的方式对于我们来说无法给别人提供很好的帮助。</p>
<p>基于以上所有的讨论，书中也做了几点总结，作为参考：</p>
<blockquote>
<p>一个正式的设计过程模型是必需的，目的是帮助组织设计工作、辅助为项目内部以及项目相关的沟通工作，亦有益于教学。</p>
<p>给予设计过程模式以可视化的几何表示至关重要，因为设计师们都擅长空间思维。他们最乐于学习、思考、分享和讨论有着明确儿何图像的模型。</p>
<p>对工程师来说，设计的理性模型是自然而然的。</p>
<p>线性的按部就班的理性模型具有很大的误导性。它并未能反映出设计师的真实工作，或是一流的设计思想家所认定的设计过程的本质。</p>
<p>坏的模型流毒甚广。它会导致需求的过早固定，从而导致过度膨胀的产品，以及日程表、预算和性能的灾难。</p>
<p>理性模型在实践中积重难返，尽管它有种种不足，而且对它早有大量有说服力的批判。这是因为它具有诱人的逻辑简单性，也是因为构建者和客户之间需要“合同”。</p>
</blockquote>
<p>通过阅读这些内容，给人感受最深的有两点：第一，我们预期的过程通常与我们实际做事的过程不相符；第二，理性模型（瀑布模型）是在没有更好的方案之时，为了快速达成某些前置目标而选取的方案。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="螺旋模型">螺旋模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E8%9E%BA%E6%97%8B%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="螺旋模型的直接链接" title="螺旋模型的直接链接">​</a></h3>
<p>在批评了理性模型之后，书中也探讨了一些其它模型的方案，其中螺旋模型作者认为比较合理。</p>
<p><img decoding="async" loading="lazy" alt="spiral-model" src="https://wang1212.github.io/assets/images/spiral-model-4fb901f142b73f7bad0b7a6674ecbcec.webp" width="1920" height="1600" class="img_ev3q"></p>
<blockquote>
<p>螺旋的形状当然表示的是过程。它将同一活动的连续反复彼此关联起来。这种几何形状很容易理解，而且令人印象深刻。该模型强调的是原型方法，它主张远在一个可以跑起来的原型成为可能之前，就从用户界面原型和用户测试起步。</p>
</blockquote>
<p>从瀑布模型和螺旋模型两者可视化表示的层面来看，从前者的线性模型变成了后者的迭代式模型，这意味着设计是一个不断重复的过程，这似乎更符合我们的现实情况。</p>
<p>当然，作者提出螺旋模型并不是目前最优的方案，但基于螺旋模型进行迭代和发展是一个非常有潜力的方向。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="其它设计过程模型">其它设计过程模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E5%85%B6%E5%AE%83%E8%AE%BE%E8%AE%A1%E8%BF%87%E7%A8%8B%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="其它设计过程模型的直接链接" title="其它设计过程模型的直接链接">​</a></h2>
<p>作者在书中探讨比瀑布模型更好的设计过程模型时当然没有武断地直接提出“螺旋模型”就是最好的，还提到了一些其它的模型进行了简单的分析讨论，考虑到其在有我们日常接触的系统的应用，所以提一下。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="共同演化模型">共同演化模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E5%85%B1%E5%90%8C%E6%BC%94%E5%8C%96%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="共同演化模型的直接链接" title="共同演化模型的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="coevolutionary-model" src="https://wang1212.github.io/assets/images/coevolutionary-model-0ea1239860fa48417f7ccbdb12b94431.webp" width="1202" height="593" class="img_ev3q"></p>
<p>如上图所示，共同演化模型实际上指的是需求问题和解决方案原型不断相互迭代完善的过程。</p>
<blockquote>
<p>共同演化模型当然强调了对于需求的递进式探索和构造。它的视觉表现令人难忘。它并不包罗万象：它没有伪装成将设计一构建一测试一部署一维护一扩展这些过程的所有方面都包含在内的样子。此外，该模型的几何图像也没有示意一个收敛的过程。</p>
</blockquote>
<p>作者认为，在它原始的构造形态中，并没有表示阶段里程碑和合同的节点。虽然该模型有它的闪光点，也比理性模型要好，但并不认为它已经充分完整。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="集市模型">集市模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E9%9B%86%E5%B8%82%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="集市模型的直接链接" title="集市模型的直接链接">​</a></h3>
<p>集市模型没有可参考的图片，但集市的概念对于我们来说是再也熟悉不过了，可以作以类比想象。</p>
<blockquote>
<p>Raymond 在他的集市过程中如是说：在用户与生产者社区中，某个成员发现了一个需要，然后开发出一个模块来满足它，并将该模块作为礼物提供给他的同伴使用。而这个将模块整合的过程，对于 Linux 社区而言，极大地受益于 Linux 的模块化结构，特别是它的管道和过滤器机制。同样的过程也适用于缺陷修复。某个成员在他所使用的模块中检测出一个缺陷，然后把它修复以使自己能完成手头的工作，尔后他就把这个修复成果作为礼物提供给社区。</p>
</blockquote>
<p>当然，对于一些很容易想到的疑问，书中也给出了答案。</p>
<blockquote>
<p>显然，人们编写新的模块，以及修复缺陷是为了使他们可以做到想做的事。但他们又为什么将自己的工作成果分发出来，尤其是这么一来必要的测试、文档撰写以及发布等，都要求人们去做大量的额外工作呢？8Raymond 的答案，我觉得有几分道理，那就是，这样做带来的激励和回报就是在社区中的威望。</p>
</blockquote>
<p>以及市场机制可能发挥的巨大作用。</p>
<blockquote>
<p>经常地，多个模块以及对于同一个缺陷的多个修复会同时提供给社区。Raymond 提出，这时市场机制（即使对于免费商品而言）会发挥作用。更好的工具、修复结果，会赢得更广泛的受众，而它的作者也相应地会赢得更高的威望。</p>
<p>这样，集市就逐渐地被很多电子化提供他们的数字产品的“供应商”填充。许多买家，以投票的方式，通过增加在全球化社区中以电子化形式表现的威望来对他们给予回报。</p>
</blockquote>
<p>现如今活跃在开源社区的大多数开发者都没有相应的收益，但开源社区运动依然进行的如火如荼，这就是威望这种礼物的巨大吸引力。</p>
<p>但是集市模型并不完全适合用来作为设计过程的指导模型，作者由于没有进行过实践，也只是给出了几条评论。简单的来说，集市模型产出的实际上是副产品，工具比产品多，而且没有经过大量测试的不合格产品占比很高；Linux 之所以在开源社区中如此成功，是因为有 Linus Torvalds 始终作为一个保持其概念完整性的关键首脑力量存在，以及 UNIX 已经提供了总体系统设计。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>书中还针对远程协作等内容做了论述，这里不再赘述，因为书中大量的示例结合上下文看会容易理解一些，这里提到的是一些偏概念性的，也是感觉这本书中最核心的内容。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="书">书<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E4%B9%A6" class="hash-link" aria-label="书的直接链接" title="书的直接链接">​</a></h2>
<ul>
<li>《设计原本》- [美] Jr·Frederick P·Brooks 著，王海鹏、高博 译</li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>生活</category>
            <category>阅读</category>
            <category>计算机技术</category>
            <category>程序架构设计</category>
        </item>
        <item>
            <title><![CDATA[疫情结束后第一次出游]]></title>
            <link>https://wang1212.github.io/2023/01/25/life/tourism/tourism</link>
            <guid>https://wang1212.github.io/2023/01/25/life/tourism/tourism</guid>
            <pubDate>Sat, 04 Feb 2023 21:34:00 GMT</pubDate>
            <description><![CDATA[疫情结束后的第一个春节，也是第一次春节假期出游，四天时间去了上海、苏州、杭州 3 个城市，领略了不同的风景。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-02-04 21:34:00</em></p>
</blockquote>
<p><u>2023-01-25</u>
<br>
<br></p>
<p>疫情结束后的第一个春节，也是第一次春节假期出游，四天时间去了上海、苏州、杭州 3 个城市，领略了不同的风景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="春节出游">春节出游<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%98%A5%E8%8A%82%E5%87%BA%E6%B8%B8" class="hash-link" aria-label="春节出游的直接链接" title="春节出游的直接链接">​</a></h2>
<p>这里说疫情“结束”似乎并不合理，因为用科学的角度来看，疫情是长期化的，总结一下就是“常伴你我身边，如影随形”。但在经历了过去三年防疫混乱的时代，用“结束”这个词语并不为过。</p>
<p>过去的三年，每个人都在断断续续承受着不同程度的精神压力，面对疫情冲击的同时全球经济环境也在恶化，就业环境开始变差，大公司在裁员，小公司可能直接破产，个人每天上班的过程中还可能被防疫政策“误伤”。总之，相信这三年已经成为很多人一生中最灰暗的一段人生经历，面对着身体与精神层面的双重压力。最终，在 2022 年底我们还是等来了曙光和希望，疫情“突然”结束了，这个混乱的时代也跟着结束了，所有的一切都在慢慢恢复，向着 2019 年，我们希望的岁月里变好。</p>
<p>2023 年的春节，年味慢慢也回来了，春运的数据也在恢复和高速增长，没有“核酸”的归途也畅通了不少。还记得四五年前就定了每年爬一座大山的目标，结果就坚持了两三年时间就遭遇了疫情这个黑天鹅事件，三年时间中几乎没有任何可以大胆出游爬山的机会。另一方面，现在工作也比以前要忙不少，很少有比较长的假期能出游。于是，在这样的背景下突发奇想准备在春节假期中挤压出 4 天时间出去游玩一下。</p>
<p>事实上，这是一次没有任何准备的出游，途中也遇到了很多有趣的事情，看新闻才知道今年春节假期的旅游出行数据恢复的很快，多个热门城市的景点都到了限流、甚至临时关停的地步。当然，也是阴差阳错的避开了这些人最多的景区，何其幸运。</p>
<p>对于要去游玩的地方，事先也没有规划和准备，只是大致上想在杭州附近的城市玩一玩，比如苏州、绍兴。预先计划的是初三晚上的飞机（杭州），初四到初七四天的游玩时间。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="出行的小插曲">出行的小插曲<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%87%BA%E8%A1%8C%E7%9A%84%E5%B0%8F%E6%8F%92%E6%9B%B2" class="hash-link" aria-label="出行的小插曲的直接链接" title="出行的小插曲的直接链接">​</a></h3>
<p>机票没有事先购买，只是偶尔会看几眼，直至初二晚上看的时候机票已经涨价很厉害，比几天前翻了一倍还多，于是也不着急买了，就想着反正也比较贵了，不如第二天临上飞机前再买，说不定还会降价，距离返岗还早机票也不会很快售罄。</p>
<p>由于是当天最后一趟飞杭州的航班，为了避免错过，就提前两个多小时赶去机场，不过在去机场的地铁上还在刷购票软件，期望能降价。突然，该航班的机票在各个平台显示已经售罄，这下直接懵了。心想，都已经在去机场的路上了，回去的话第二天早上再飞又得至少耽搁半天时间。于是，临时改变计划，看看杭州或者苏州周边的城市机场有没有票，看来看去只有上海浦东机场的最后一趟航班，价格也不贵，立即就买了。不过，半个小时后，飞杭州的航班机票又显示有了，不过这个时候已经没有什么意义了，不得不说以后还是得提前计划和买票。</p>
<p>原本这四天时间的安排中是没有考虑上海的，想着本身时间就短，主要把时间花在苏州这个城市，以后有时间了再去好好逛逛上海，却不曾想发生这样的小插曲。买了飞上海的航班机票后，还想着落地后直接去苏州，地图上了查了一下才发现浦东机场距离苏州太远，离苏州近的是虹桥机场，这下直接就打乱了之前预想的出行安排。遂决定，落地后先在上海休息一晚上，初四白天和傍晚在上海简单的逛一逛，晚上再乘高铁去苏州。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="上海一日游">上海一日游<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E4%B8%8A%E6%B5%B7%E4%B8%80%E6%97%A5%E6%B8%B8" class="hash-link" aria-label="上海一日游的直接链接" title="上海一日游的直接链接">​</a></h2>
<p>航班落地的时间应该是午夜 12 点左右，对于初次来上海，又没有提前计划的情况下来说，住宿的选择是个问题。刚开始想的是住到机场附近，最后决定先看看白天去哪逛，然后住在玩的区域附近。在上飞机前简单了查了一下旅游攻略，就一天的时间决定去看看上海外滩、豫园以及城隍庙这几个地方，于是下机后刚好还有个机场大巴（守航夜宵线），就选择直接去延安东路浙江中路下车找个地方住宿，旁边几公里内就是豫园、城隍庙以及外滩。</p>
<p>早晨 8 点半起床洗漱一下，还准备吃个上海人都吃的早餐食物，奈何离要去的豫园太近，路上还没怎么走就到了，就随便买了点东西垫了垫肚子。不得不说作为国际化大都市，上海地铁线路的覆盖还是很密集的，城区里地铁出行还是很方便的。而且，上海的很多路上都是带有历史记忆的故居、旧址等等，街道和主干道的命名也很有意思，用的是全国各地的城市名称。</p>
<p>初四的清晨，上海天气还不错，9 点左右路过科技馆，已经有大量的家长带着孩子进馆参观了。到了豫园附近，已经有很多人了，而且有很多维持秩序的执勤人员，找了半天问了好几次执勤人员才找到了豫园园林景区的入口，而且已经排了很长的队了。不过检票还算快，也就几分钟不到便进入了豫园内。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="豫园与城隍庙">豫园与城隍庙<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%B1%AB%E5%9B%AD%E4%B8%8E%E5%9F%8E%E9%9A%8D%E5%BA%99" class="hash-link" aria-label="豫园与城隍庙的直接链接" title="豫园与城隍庙的直接链接">​</a></h3>
<p>豫园内的园林景观是北方人少见的，还是有一定可观赏性的，不过想着还要去苏州园林，心里便觉得也许“不过如此”吧。豫园倒也不是很大，走走停停，拍拍照，大概不到一个小时的样子也就看完了，从后门出来后，向前走一段路就是刚才的入口排队的地方。相较于北方的环境，南方的生活与水相伴，有花有草，景色宜人。</p>
<p>不一会就到了中午，打算去吃一顿大餐来着，网上查了查发现有名的餐厅距离这里有点远，于是看看附近有什么餐厅，找了一家小杨生煎，走过去才发现是个不能堂食的店面，而且排队的人特别的多，遂放弃。最终，还是打算先吃点小吃垫一垫，逛完附近的城隍庙再去好好吃一顿。</p>
<p>地图上看城隍庙就在豫园旁边，奈何人太多，饶了一大圈才在不经意间看到了门口。进门后看到了一家面馆，进去稀里糊涂吃了一碗所谓的“迎春面”，顺便给手机充了会电，出来没带充电宝真是个不好的事情。城隍庙入口处有专门的人员为游客赠香，而在我印象中，去过的北方寺庙中可没有这样的待遇，香火都是要花钱买的。不过，话说回来，好像很多城市有“城隍庙”，苏州也有。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="武康路">武康路<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%AD%A6%E5%BA%B7%E8%B7%AF" class="hash-link" aria-label="武康路的直接链接" title="武康路的直接链接">​</a></h3>
<p>下午由于还有好几个小时才能等到看外滩夜景，就坐公交去了武康路，据说整条路上都是名人的故居。</p>
<p>下公交车的路对面似乎是个景点，放眼看去才发现是“宋庆龄故居”。往前走右拐就是著名的“黄公馆”（黄兴故居）了，建筑风格很特别，据说有很多人在这里进行拍照打卡。武康路是个小街道，非常的幽静，从头走到尾距离也比较远，路两旁确是有很多著名人士的故居，当然也有很多便利店、服装店等。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="外滩">外滩<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%A4%96%E6%BB%A9" class="hash-link" aria-label="外滩的直接链接" title="外滩的直接链接">​</a></h3>
<p>从城隍庙出来的时候大概下午两点钟左右，距离外滩也就 1 公里左右，于是在周围的公园休息了一会就步行去了外滩，目睹了一下白天的外滩风采，也看到了著名的东方明珠塔。
日间的外滩观景平台上人并不多，偶尔会有几个人路过。都说看的是外滩夜景，外滩的晚上能挤死人，但这次来上海只是临时的游玩，不一定有时间领略夜间的外滩风景。</p>
<p>不过，在查了一下从上海去苏州的高铁后，远比想象中的要方便的多，几乎每 15 分钟一趟，从早上直至晚上十点钟。这样来看，外滩夜景还是有机会看的，不慌不慢的买了一趟快晚上八点钟出发去苏州的高铁票。无奈只好先找个其它景点打发一下下午的时间，等待夜晚的来临，随便查了查便决定去武康路溜达一圈。</p>
<p>从武康路坐公交车返回到外滩时，已是下午五点多钟，不过此时天色还只是略暗，路上也已开始堵车了，看来晚上的外滩真要挤死人了？随便在周围了溜达了一会就已经六点多了，此时夜色降临，周围高楼的灯光也陆续亮了起来，江对面的也是，只是东方明珠塔还没有亮灯。相比于日间的外滩，夜间的外滩别有一番景致，望着江两岸灯光璀璨的高楼，以及对岸灯光亮起的东方明珠塔，吹着微微晚风，不由思考起来这就是现代人追求的国际化大都市吗？</p>
<p>今天夜晚的外滩观景平台上的似乎并没有想象中的那么多人，停留了半个多小时，拍了照片就准备赶去上海站了。距离上海站比较近，而且时间还有一个多小时，在没有吃晚饭的情况下，恰好看到了路对面的小杨生煎，便想着既然来一趟还是尝一尝吧，夜晚的人比白天排队的人少很多。赶到上海站时，却发现买的高铁列车晚点了，而且晚点时间还不确定，当下便决定改签，尴尬的是下一趟也晚点了 20 分钟，在思考了一番后，便决定先不着急，看看后面的列车临近发车时如何，再决定改签哪一趟能更早到苏州。最终，比预计到苏州的时间晚了半小时，九点钟到达苏州。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="苏州园林的向往">苏州园林的向往<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%8B%8F%E5%B7%9E%E5%9B%AD%E6%9E%97%E7%9A%84%E5%90%91%E5%BE%80" class="hash-link" aria-label="苏州园林的向往的直接链接" title="苏州园林的向往的直接链接">​</a></h2>
<p>计划初五、初六两天时间逛一逛苏州的景点，首先就是要决定住宿的区域，在考虑了一番后，发现苏州的景点聚集在地铁一号、二号和四号沿线上，而苏州站旁边的景区最多，遂决定住在苏州站附近，方便第二天出行。</p>
<p>高铁到达苏州站时九点钟刚过，时间还算早，在预定好酒店后决定可以先去附近的山塘街逛逛，看看夜景。下了高铁后匆忙的进入地铁站，还在思考用什么刷地铁票时，一阵喇叭的声音传入耳中，大致意思是春节假期期间苏州的地铁是免费乘坐的，直接进站即可。这是一个非常意外的惊喜，不得不说苏州市的格局还是很大的，这样便开启了两天不断穿梭在地铁站进进出出的旅程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="山塘街">山塘街<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%B1%B1%E5%A1%98%E8%A1%97" class="hash-link" aria-label="山塘街的直接链接" title="山塘街的直接链接">​</a></h3>
<p>十里山塘街算是苏州一个比较著名的步行街，与全国的景区一样，卖小吃的居多，而且小吃也大多都可以在全国各地买得到，买了一杯竹筒盛的酒酿奶茶觉得也不过如此，才发现买错地方了。晚上九点多，这里的人群已经非常拥挤了，刚开始进入步行街时几乎是前胸贴后背的景象。街两旁店铺的门口都挂着红色灯笼，夜色中的红灯笼也是一道靓丽的风景，与春节的氛围正相适宜。</p>
<p>一切都如预期之内，没有太多惊艳的地方，类似山塘街这样非常现代化、商业化的步行街区在全国各个城市还有很多。唯一有意义的便是在这春节期间能抛开工作在这街道内缓缓散步好好的放松一下，感受一下江南水乡的气氛。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="苏州博物馆">苏州博物馆<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%8B%8F%E5%B7%9E%E5%8D%9A%E7%89%A9%E9%A6%86" class="hash-link" aria-label="苏州博物馆的直接链接" title="苏州博物馆的直接链接">​</a></h3>
<p>来苏州之后，第二个感到意外的便是春节假期期间大部分景区的门票也是免费的，而且需要提前预约，且预约人数有限。看来，苏州市为了吸引游客是做足了功夫，然而这也让人感到措手不及，因为很多著名的景区门票已经预约名额满了，而且也不售卖有价门票。从山塘街回到酒店后，洗漱好在计划两天都去苏州哪些地方游玩的时候，就遇到很多景区已经不能预约了的尴尬情况，那岂不是要白来一趟了？在不断的刷新预约平台捡漏的过程中，还真遇到了苏州博物馆有几张被别人退掉的预约票，那么第二天的第一站就选定了苏州博物馆。</p>
<p>清晨洗漱完简单了吃了早餐后，已经是九点多钟，路程很近，大概两站地铁的样子，目的站点是北寺塔点。出了地铁站后，发现地铁口有一个“报恩寺”，进去烧香祈福之后简单的逛了逛，就出发去苏州博物馆了，还不算远，距离地铁口大概 1 公里的路程。</p>
<p>苏州博物馆的设计风格让人耳目一新，果然来对了地方。馆内并不大，分为三层，对于看惯了北方城市博物馆青铜器的人来说似乎提不起兴趣，不过馆内还有一些字画、玉器挺引人入胜的。苏州博物馆的建筑风格相对于北方很多城市的博物馆来说，给人的感觉确实是不一样的，真正让人感受到了另一种文化的气息。</p>
<p>从博物馆出来后，旁边就是一些其它景区，拙政园、狮子林等等，此时也已到了中午，只好在这片景区的街道逛逛买一些小吃垫一垫肚子，春节出来玩都没有好好吃过一顿饭。拙政园应该是苏州最著名的园林景区，单从门票价格上就可以看出，遗憾的是这次因为不了解苏州的春节政策和没有提前准备，春节特惠票已经预约满了，而且也不售票，就没有机会进去一览园林的风采了，好的是苏州大大小小的园林有很多，也不会说这次是来苏州白跑一趟。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="木渎古镇">木渎古镇<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%9C%A8%E6%B8%8E%E5%8F%A4%E9%95%87" class="hash-link" aria-label="木渎古镇的直接链接" title="木渎古镇的直接链接">​</a></h3>
<p>因为预约的几个城区内的园林景点都在第二天，所以今天下午只能先挑一个人比较少、离得比较近的古镇景区游玩一下，出来玩最烦的就是人群拥挤的景点了。地铁直达的景点还是很方便的，到了景区门口后，肚子实在是太饿了，周围又没有什么好吃的，无奈之下去吃了肯德基还是麦当劳，已经记不太清了。</p>
<p>进入木渎古镇已经是下午三点多钟了，镇内有四个景点，分别是严家花园、虹饮山房、古松园、状元府邸，这些景点下午四点半就已经闭园了，只出不进，只能快快的赶着顺路看哪个能进去逛一逛。由于进入木渎古镇的入口选择问题，第一个沿途遇上的景点是虹饮山房，一进入院内便被这园林风光深深的吸引了，这才是江南和苏州园林的感觉。在其中逗留了相当一段时间，出来已经是接近四点钟了，考虑到来不及逛其它景点了，只能向前赶路，途中碰到了古松园，便入园逛了逛。古松园要比虹饮山房小一些，但也有自己的特色，逗留了十几分钟后出园已经是四点二十左右了，还有十分钟左右其它景点就要关园了，于是着急的寻找网上攻略中说木渎最好的一个景点严家花园。</p>
<p>通过地图导航一查，才发现严家花园在来的路上，于是又着急的返回去，走了一路也没有发现严家花园的景点入口，直至走到来的入口的十字路口发现一个路标，才知道向前再走几十米就是严家花园了，不过了等到了门口也已经赶不上入园了，这也算是这一次来木渎古镇最大的遗憾了。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="金鸡湖">金鸡湖<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E9%87%91%E9%B8%A1%E6%B9%96" class="hash-link" aria-label="金鸡湖的直接链接" title="金鸡湖的直接链接">​</a></h3>
<p>从木渎古镇离开时已经是下午五点多钟了，晚上的计划是去金鸡湖看喷泉灯光秀和夜景，把住宿的酒店也换到了金鸡湖景区附近。计划先回到酒店放下行李，再轻装上阵去金鸡湖好好的放松一下。到酒店已是六点刚过，逗留了十多分钟就乘地铁去金鸡湖月光码头了，倒也不远，两站路。当年去重庆没有坐轮渡，昨天在上海外滩也没有坐轮渡，今天到这里了似乎不坐一次轮渡说不过去，幸运的是抢到了最后的余票。</p>
<p>距离八点钟的轮渡开船时间还有大约不到一个小时，只能在月光码头的岸边随便逛逛，晚上的风特别的大，因为春节的缘故，很多店铺还都没有开张，稍显冷清。由于喷泉灯光秀是在八点开始的二十分钟左右，且今晚是近期的最后一次，还在想是不是又要错过了。不过，经过地图上的分析，由于轮渡是绕着金鸡湖一周，估计八点钟刚出发时刚好能绕到喷泉广场附近看到灯光秀，心里便有一丝期待了。</p>
<p>接近八点钟，码头已经开始检票了，早早的过去排队，刚开始人还很少，直至最后人逐渐多了起来。上船后，挑了个靠窗的方便观景的位置，便静静坐着享受这半个多小时的湖面旅程。正如所料，大约八点零五分的样子，船开到了喷泉广场附近且稍作停留，让船上的游客目睹了灯光秀的表演，同时也近距离欣赏了著名的东方之门的风采。</p>
<p>从金鸡湖回来后，大约九点多钟，在酒店附近广场找了一圈也没有中意的吃饭的餐厅，这大概是春节出游最尴尬的一件事了，无奈只能点外卖。万万没想到的是由于骑手比较少，外卖送达已经是快十一点钟了，草草的填饱了肚子后，洗漱一下，近几天总算是能好好休息一下了。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="虎丘山">虎丘山<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%99%8E%E4%B8%98%E5%B1%B1" class="hash-link" aria-label="虎丘山的直接链接" title="虎丘山的直接链接">​</a></h3>
<p>虎丘山在苏州站附近，属于一个 5A 级景区，没想到还能预约到，等去了之后才发现一般般吧。早上很早的就乘公交去虎丘山景区了，相对来说还是比较方便的，而且又一次发现公交和地铁一样，春节假期内是免费乘坐的。公交上刚开始人还不多，直至最后几站只见上人不见下人，感觉又回到了上班挤公交挤地铁的日子。不仅公交车上很挤，而且路上还异常拥堵，仅仅几公里，大概花费了将近一小时才到达。</p>
<p>进到景区内后，入口处人也很多，寸步难行，稍微往进再走一会，人便少了一些。虎丘山被称为“吴中第一山”，事实上并不高，而且景区内的有效面积也很小，大概半个小时就能逛完，比想象中的 5A 级景区的规模要小很多，心理落差蛮大的。</p>
<p>景区出口处有人在喊可以坐船到山塘街，地图上一查才知道这里离山塘街也就两公里左右，坐船很快，而坐车就要绕一大圈了。想象的来时坐公交车的情景，只好选择坐船回到山塘街了，顺便体验一下“小桥流水人家”的感觉。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="怡园">怡园<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%80%A1%E5%9B%AD" class="hash-link" aria-label="怡园的直接链接" title="怡园的直接链接">​</a></h3>
<p>此时已是中午十二点钟左右，肚子还不饿，遂决定先去附近的怡园逛一逛，然后去平江路吃饭。怡园就在地铁口，去的话很方便，门口还有很多人在排队，园内的人数倒也还好，略显拥挤。</p>
<p>怡园内区域并不小，但也不是特别的大，整体上来看，感觉没有昨天在木渎古镇虹饮山房的景点风景好一些。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="平江路">平江路<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%B9%B3%E6%B1%9F%E8%B7%AF" class="hash-link" aria-label="平江路的直接链接" title="平江路的直接链接">​</a></h3>
<p>从怡园出来后，就直接乘地铁去了平江路，事实证明坐公交下车的地点比地铁要更合适一些。坐地铁后，就打算先去吃个饭，网上查看攻略时找了一家网红菜馆，导航一查大约两公里的距离，中间刚好穿过平江路，于是打算顺道走过去。此时已经是下午三点多钟了，中途路过了耦园景区，打算吃完饭再去，而且还专门从携程上查了一下耦园的入园时间，写的是四点半闭园。</p>
<p>等到了这家网红餐厅后，才发现被坑了，卫生较差，而且饭菜的味道也一般，匆匆填饱肚子后就赶着去耦园了，此时已经是四点钟刚过。赶路的过程中仔细想了一下才意识到可能已经错过入园时间了，苏州的景点应该是统一的，昨天在木渎古镇的景点是四点不再入园，四点半闭园。但是，为了避免留下遗憾，还是气喘吁吁的赶到了耦园门口，才发现确实如此，而和我们一样的人也有很多。</p>
<p>距离晚上八点钟的回杭州高铁还有三四个小时，可以慢悠悠的在平江路上好好溜达一下。不过，平江路也仅有短短的一段路而已，很快便从头走到了尾，一个平常的商业街而已，没有太多的意思。时间也还早，看到观前街就在附近一公里处，便准备去逛逛，也算消磨时间。</p>
<p>观前街的繁华程度还是比预想的要好一些，觉得刚才去平江路的网红餐厅吃饭还不如来这里吃。这里算是一个现代化的商业街广场，人流量也很大，餐饮店铺居多，也有一些卖特产的。在这里吃了一些小吃，随意逛了逛之后，大约七点钟的时候就赶去苏州站了。</p>
<p>两天的苏州行程还算充实，虽然有很多地方还没有去，不过下次还有机会，也总算是领略了苏州园林的风光，不虚此行。</p>
<p>实际上，从苏州回杭州还得先到上海虹桥，再到杭州东站。高铁票是昨天晚上才买的，已经比较迟了，苏州直达杭州的高铁已经售罄了，而且就算有最后一趟的时间也比较早，没有晚上八点以后的列车。相对来说，苏州到上海的高铁每天都非常的方便。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="杭州">杭州<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%9D%AD%E5%B7%9E" class="hash-link" aria-label="杭州的直接链接" title="杭州的直接链接">​</a></h2>
<p>虽然在杭州已经待了一年多的时间，但没有好好的逛过杭州的景区，这次春节出游恰好也是个契机。原本的打算是去绍兴一日游的，结果发现西湖今年一季度景区免门票，那还不如趁这个机会免费逛一逛西湖，何乐而不为呢？</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="西湖飞来峰">西湖飞来峰<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%A5%BF%E6%B9%96%E9%A3%9E%E6%9D%A5%E5%B3%B0" class="hash-link" aria-label="西湖飞来峰的直接�链接" title="西湖飞来峰的直接链接">​</a></h3>
<p>很多人逛西湖，实际上只是西湖边上看了看，湖对面的山上还有很多景点，好好的逛一圈至少也得个几天时间，今天就挑了一个最著名的景点飞来峰，顺便去灵隐寺看一看。</p>
<p>早上出来的时候已经比较晚了，快十一点钟，打算直接乘公交到飞来峰的景点入口，虽然只有区区四站路，但到了西湖跟前时，最后两站路距离很长，而且异常的拥堵。眼看都要快下车了，但奈何堵车过于严重，一个小时过去了还没到达目的地。无奈之下，在最后堵在快到隧道出口时，人们纷纷都下了公交，直接沿路走出了隧道，然后步行到飞来峰景点。</p>
<p>杭州西湖在全国来说应该算是一个热门景点，入口处果然是人挤人。入口进去后不远处便是灵隐寺，按杭州的免票政策是景点内第一道门票是免费的，那么飞来峰免票后，灵隐寺应该是要收费的，结果径直进去后，没有任何检票收费的环节。灵隐寺不愧是西湖的核心景点，内部修缮的很好，在全国的寺庙中应该是排名在前面的。简单的烧香祈福、游览完，出寺后去攀爬了飞来峰。</p>
<p>在我的认知中，飞来峰属于西湖的核心景点，应该是很高的才是，结果不一会就到了飞来峰顶，看来南北方山的特点是不同的，北方的以险峻、高为主，而南方的山大多秀丽为主。</p>
<p>出了飞来峰后，直接去了西湖边的商业街，景区的专线公交非常的方便。在西湖边等待夜色降临，匆匆的欣赏了夜景后在商场吃了东西就结束了这四天的出游。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>四天时间并不算长，三个城市的旅程也让整个过程显得稍显匆忙，没有事先的计划和准备，也引发了一系列小插曲，不过还算顺利，也感受到了苏州市对游客的欢迎，领略了不同的风景和文化。</p>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>生活</category>
            <category>旅游</category>
            <category>上海</category>
            <category>苏州</category>
            <category>杭州</category>
        </item>
        <item>
            <title><![CDATA[解析 ECharts 设计：交互状态系统]]></title>
            <link>https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design</link>
            <guid>https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design</guid>
            <pubDate>Mon, 09 Jan 2023 23:37:00 GMT</pubDate>
            <description><![CDATA[通常，对于 Web 页面的交互处理中，尤其是 DOM 元素样式的变化用 CSS 处理是非常简单的，但如果是普通对象呢？问题似乎变得复杂起来了，这篇文章通过探索 ECharts 与 ZRender 在交互状态设计相关方面的源码实现，讨论一下在复杂场景中处理交互状态的设计方案，如何将命令式编码的复杂性通过声明式编码来降低，该怎样应对复杂场景下的状态叠加问题。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2023-01-09 23:37:00</em></p>
</blockquote>
<p>通常，对于 Web 页面的交互处理中，尤其是 DOM 元素样式的变化用 CSS 处理是非常简单的，但如果是普通对象呢？问题似乎变得复杂起来了，这篇文章通过探索 ECharts 与 ZRender 在交互状态设计相关方面的源码实现，讨论一下在复杂场景中处理交互状态的设计方案，如何将命令式编码的复杂性通过声明式编码来降低，该怎样应对复杂场景下的状态叠加问题。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是交互状态">什么是交互状态<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%A4%E4%BA%92%E7%8A%B6%E6%80%81" class="hash-link" aria-label="什么是交互状态的直接链接" title="什么是交互状态的直接链接">​</a></h2>
<p>在开始讨论之前，有必要清晰的理解即将要讨论的问题的核心：<strong>交互状态</strong>。</p>
<p>对于强交互的应用来说，用户不同的交互行为会导致应用呈现不同的状态。以 Web 场景举一个简单的例子，对于 <code>button</code> 标签来说，用 CSS 可以声明 <code>:hover</code>、<code>:active</code>、<code>:disabled</code> 及默认样式，这里就对应了一个按钮的 4 种样式（状态），它们都是在特定的交互行为下才会触发的样式（状态），这里要讨论的交互状态则就是类似这 4 种样式的概念。如下所示：</p>
<div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token selector" style="color:#00009f">button</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">white</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token selector" style="color:#00009f">button</span><span class="token selector pseudo-class" style="color:#00009f">:hover</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">green</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token selector" style="color:#00009f">button</span><span class="token selector pseudo-class" style="color:#00009f">:active</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">red</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token selector" style="color:#00009f">button</span><span class="token selector pseudo-class" style="color:#00009f">:disabled</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">gray</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要清楚的是，这里的交互指的并不一定是常规的鼠标交互行为，其代表的是我们将一种事物变更为另一种状态的行为，例如一个列表中文本的搜索、筛选高亮，交互则指的是搜索和筛选的这两种用户行为。</p>
<p><img decoding="async" loading="lazy" alt="state" src="https://wang1212.github.io/assets/images/state-1767bd4353accc2f8b49e221b9980c98.jpg" width="777" height="270" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="交互与状态">交互与状态<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E4%BA%A4%E4%BA%92%E4%B8%8E%E7%8A%B6%E6%80%81" class="hash-link" aria-label="交互与状态的直接链接" title="交互与状态的直接链接">​</a></h2>
<p>以上 <code>button</code> 标签的例子中，CSS 声明了 4 种状态，浏览器本身已经实现了 <code>button</code> 标签用户交互行为事件监听，并自动帮助开发者在不同的交互行为下切换相应的状态（样式）。这是处理交互状态中最省心、最简单的场景，只需要声明交互状态即可。</p>
<p>另一方面，熟悉 DOM API 的开发者经常会这样做：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseenter</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'green'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseleave</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'white'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeydown</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'red'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeyup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'white'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token comment" style="color:#999988;font-style:italic">/* disabled */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'gray'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上属于命令式（过程式）的编码风格，对于仅需要改变 <code>button</code> 元素的一个 <code>color</code> 属性来说代码是比较简洁的，但如果需要改变 <code>button</code> 元素的多个属性或者逻辑更复杂时，显然代码就变得更加复杂和不易维护了。</p>
<p>当然，遵循 Web 开发中表现与行为相分离的原则，可以将样式（状态）改为用 CSS 类进行声明，如下所示：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseenter</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hoverClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseleave</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hoverClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeydown</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activeClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeyup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activeClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token comment" style="color:#999988;font-style:italic">/* disabled */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">disabledClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以，将状态和状态变更的逻辑进行拆分，代码会更清晰、易维护一些，状态采用声明式方案预先定义好，在相应的交互行为触发时进行状态的切换即可，而且不同交互行为触发状态变更时可以复用状态定义。</p>
<p><img decoding="async" loading="lazy" alt="interaction-and-state" src="https://wang1212.github.io/assets/images/interaction-and-state-57ec8a1f55fa0a0d7e846a7c8b12e248.jpg" width="1202" height="599" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="echarts-中的交互状态流程设计">ECharts 中的交互状态流程设计<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#echarts-%E4%B8%AD%E7%9A%84%E4%BA%A4%E4%BA%92%E7%8A%B6%E6%80%81%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="ECharts 中的交互状态流程设计的直接链接" title="ECharts 中的交互状态流程设计的直接链接">​</a></h3>
<p>ECharts 是一个提供了丰富图表类型的可交互的声明式图表库，在不同类型的图表（<code>series</code>）中，大部分都可以看到类似高亮（<code>series.emphasis</code>）、弱化（<code>series.blur</code>）、选中（<code>series.select</code>）的图形样式配置项，这些样式配置只有在光标悬浮到图形元素上、点击图形元素或者通过 <code>dispatchAction</code> API 触发生效，同样的由于交互行为的结束又可以恢复到原来的样式配置（normal style）。</p>
<p>接下来，根据源码探索一下 ECharts 是如何完成从图形元素响应交互到更改状态，再到更新图形元素的整个过程。先来看看 ECharts 是如何响应图形元素交互的：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.4.1/src/core/echarts.ts#L2038</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">bindMouseEvent</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zr</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> zrender</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZRenderType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ecIns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECharts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'mouseover'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> el </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> dispatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findEventDispatcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isHighDownDispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">handleGlobalMouseOverForHighDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ecIns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">markStatusToUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecIns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'mouseout'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ECharts 的底层绘制引擎是 ZRender，其提供了画布的事件响应机制，比如 <code>mouseover</code>、<code>mouseout</code>、<code>click</code> 事件。以 <code>mouseover</code> 事件为例，<code>findEventDispatcher()</code> 方法用来寻找当前触发事件元素到根元素上离得最近的<strong>可高亮元素</strong>，查看 <code>isHighDownDispatcher()</code> 方法的源码可以发现是通过判断元素对象的 <code>__highDownDispatcher</code> 标记字段是否为 <em>true</em>。当找到可高亮的元素后，通过 <code>handleGlobalMouseOverForHighDown()</code> 方法对元素的状态逻辑进行处理，当光标悬浮到某个图形元素上时，将其置为 <em>emphasis</em> 状态，同时要将剩余其它的同类型元素置为 <em>blur</em> 状态，需要注意的是该步骤只完成了图形元素的状态更新，但状态的变化还没有应用（更新）到图形元素上。最后，通过 <code>markStatusToUpdate()</code> 方法标记 ECharts 实例需要更新状态，最终在帧循环（<code>_onframe()</code>）中通过调用 <code>applyChangedStates()</code> 方法<strong>批量渲染</strong>所有需要更新状态的图形元素。</p>
<p>这里有一个细节需要注意下，为什么说 <code>applyChangedStates()</code> 是批量渲染？因为其不是同步执行的，在两个帧循环之间可能多次触发 <code>mouseover</code> 事件，这样一个帧循环就会批量处理掉由于多次触发 <code>mouseover</code> 事件累积的需要应用状态更新的图形元素。</p>
<p><img decoding="async" loading="lazy" alt="echarts-interactive-status-process" src="https://wang1212.github.io/assets/images/echarts-interactive-status-process-5438edb7406fe3b774dca9dd2598db41.jpg" width="1542" height="294" class="img_ev3q"></p>
<p>上图就是 ECharts 中交互状态的大致流程设计，在交互响应阶段，关联的对象会被进行标记，此时对象视图并未更新，在帧更新到来前，其它交互行为还会影响已被标记的对象，但对象视图始终在该阶段保持上一次帧更新的结果，待到帧更新阶段到来后，所有被标记的对象会批量进行提交，完成对象视图更新绘制。一句话总结，多次响应交互（对象标记）后统一提交更新。</p>
<p>这里其实应该思考一下为何有这样延迟更新（批量提交）的设计？对于浏览器来说，交互事件的回调在两次帧更新之间（大约 16ms）可能会多次触发，如果每一次触发交互事件回调时都去执行直接更新对象的逻辑不仅耗费性能，而且毫无意义，因为对象没有等待到帧更新时不会重新渲染。另一方面，将交互响应和对象实际更新独立开来，提高性能的同时也降低了代码复杂度和耦合度，对于处理快速且频繁多次不同交互造成的对象状态更新的复杂场景来说会更少出错。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="zrender-中的对象状态管理">ZRender 中的对象状态管理<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#zrender-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86" class="hash-link" aria-label="ZRender 中的对象状态管理的直接链接" title="ZRender 中的对象状态管理的直接链接">​</a></h3>
<p>接下来看看 ECharts 最终是如何完成状态到对象更新的操作的。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.4.1/src/core/echarts.ts#L2259</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">applyChangedStates</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecIns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECharts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ecIns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">STATUS_NEEDS_UPDATE_KEY</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ecIns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getZr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">traverse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Not applied on removed elements, it may still in fading.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">graphic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isElementRemoved</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">applyElementStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ecIns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">STATUS_NEEDS_UPDATE_KEY</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyElementStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newStates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldStates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">currentStates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Keep other states.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> oldStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> stateName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldStates</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stateName </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'emphasis'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stateName </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'blur'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stateName </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'select'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Only use states when it's exists.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">selected </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'select'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hoverState </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOVER_STATE_EMPHASIS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">emphasis</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'emphasis'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hoverState </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOVER_STATE_BLUR</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blur</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'blur'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newStates</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据源码来看，在帧循环（<code>_onframe()</code>）中调用了 <code>applyChangedStates()</code> 方法，对实例中的所有画布元素进行遍历应用状态，也就是更新对象视图。<code>applyElementStates()</code> 方法完成了指定对象的状态应用逻辑，其中最关键的则是对对象的 <code>useStates()</code> 方法的调用。</p>
<p>如果查看 ZRender(V5) 的源码，会发现元素对象实例有很多状态管理相关的 API 方法，如 <code>useStates()</code>、<code>useState()</code>、<code>removeState()</code>、<code>clearStates()</code> 等。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/ecomfe/zrender/blob/5.3.2/src/Element.ts#L939</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Element</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    states</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noAnimation</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forceUseHoverLayer</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stateProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      stateObj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stateProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> states</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">stateObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      stateObj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stateObjects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> animationCfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stateTransition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_applyStateObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据以上 <code>useStates()</code> 方法的源码实现来看，对象状态应用的过程分为两步：首先是获取状态定义，其次是更新对象。这里需要注意的是，对象状态定义的获取又分为通过 <code>stateProxy()</code> 方法动态计算和直接获取 <code>states</code> 字段相应的预定义状态对象；然后，在对象实际更新的过程中还会进行是否需要动画的判断，状态切换的动画配置存储在 <code>stateTransition</code> 字段中。</p>
<p>先来看看状态定义，元素对象 <code>states</code> 字段中存储的预定义状态对象实际上就是前文提到的 ECharts 的 <code>series.emphasis</code>、<code>series.blur</code>、<code>series.select</code> 等配置项解析而来，至于 <code>stateProxy()</code> 后续会提到。</p>
<p>然后，对于状态更新的动画可能很多人都没怎么注意到，实际上对象的 <code>stateTransition</code> 字段中的内容与 ECharts 的 <code>stateAnimation</code> 配置项有关。</p>
<p><img decoding="async" loading="lazy" alt="zrender-object-state-management" src="https://wang1212.github.io/assets/images/zrender-object-state-management-8d2a361c8d91bfdf7fb6a9e82258a93a.jpg" width="985" height="771" class="img_ev3q"></p>
<p>上图大致描述了一个 ZRender 对象从实例化到触发交互行为后状态更新的过程，其中灰色箭头和虚线是可选的流程。</p>
<p>综上所述，以 ECharts 和 ZRender 的实现为例，<strong>对于一个复杂的 Web 应用来说，交互状态的处理总体上抽象为两个过程：一是系统级别的交互响应和对象状态标记及批量对象更新调度，二是局部单个对象的完整状态管理和更新机制。</strong></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="实践案例">实践案例<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B" class="hash-link" aria-label="实践案例的直接链接" title="实践案例的直接链接">​</a></h2>
<p>通过对 ECharts 和 ZRender 源码实现的分析，对于 Web 应用中交互状态的处理有了可参考的解决方案，这里以一个实际案例来说明如何应对此类场景。</p>
<p>在近期一个 3D 关系图的需求中，基于 three.js 来进行开发，而且有很复杂的交互逻辑需要处理，恰好作为尝试对交互状态的处理做了简单的抽象设计。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="整体设计">整体设计<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="整体设计的直接链接" title="整体设计的直接链接">​</a></h3>
<p>在 3D 关系图的场景中，基本元素对象是节点（Node）和边（Edge），参照 ECharts 的设计，将整个交互状态的处理流程划分为全局和局部，全局实现交互事件回调的状态更新业务逻辑，然后在帧渲染中批量应用状态和更新对象（Node 和 Edge）调度，局部对象（Node 和 Edge）要实现自身的状态管理机制（API）。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">全局设计</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// - 交互事件回调</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleClickNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toUpdateNodes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toUpdateEdges </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 处理交互逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 更新状态和标记对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toUpdateNodes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'stateName'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toUpdateEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'stateName'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - 对象批量状态应用和更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 应用对象状态</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyObjectState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 利用 dirty 标记位来触发对象的状态更新</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> pendingUpdateState </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">pendingUpdateState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">OBJECT_STATE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NORMAL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingUpdateState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 程序上下文切换到局部对象</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingUpdateState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">applyObjectState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">applyObjectState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - 帧渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 批量应用状态更新对象</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">updateState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 重新渲染场景</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是系统级别的全局设计伪代码示例，下面来看看对象局部的设计：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">局部设计</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** 标记位 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** 保存对象现有的状态 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  states </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setNormal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setEmphasis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setBlur</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setSelected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 根据指定状态更新对象 setNormal or setEmphasis or setBlur or setSelected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上伪代码对比 ZRender 的对象状态 API，缺少了存储预定义状态对象的 <code>states</code> 字段，反而多了 <code>setEmphasis()</code>、<code>setBlur()</code> 这类方法，也缺少了状态切换动画配置（这次没用到）。为何会有这些差异，后续问题分析时会提到，也是在具体的业务场景中很典型的问题。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="问题分析">问题分析<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90" class="hash-link" aria-label="问题分析的直接链接" title="问题分析的直接链接">​</a></h3>
<p>在 3D 关系图的业务场景中面临多个问题，均会影响交互状态管理的程序设计。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基本元素对象和状态类型的抽象粒度">基本元素对象和状态类型的抽象粒度<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E5%9F%BA%E6%9C%AC%E5%85%83%E7%B4%A0%E5%AF%B9%E8%B1%A1%E5%92%8C%E7%8A%B6%E6%80%81%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%8A%BD%E8%B1%A1%E7%B2%92%E5%BA%A6" class="hash-link" aria-label="基本元素对象和状态类型的抽象粒度的直接链接" title="基本元素对象和状态类型的抽象粒度的直接链接">​</a></h4>
<p>在这里，将 3D 场景中的基本元素抽象为 Node 和 Edge，实际上粒度是很粗的，根据业务数据的特征，Node 也会有子类型，所以状态的抽象很关键。为何没有进一步抽象 Node 的子类？是为了简化设计，避免过度设计，而且业务场景并非特别复杂，可以将一定的业务复杂度放在 Node 类中处理。</p>
<p>根据交互类型进行状态类型的抽象之后（例如光标悬浮、点击选中），由于 Node 实例的数据特征差异，会出现不同 Node 对象同一类型状态拥有不同的状态对象定义。在这里可以选择进一步细化状态类型，但无疑会大大增加代码复杂度，而且代码不可控。另一方面，动态计算状态对象定义是可行的，但也有两个选择，第一是对象实例化时预先计算好存储起来，第二个是运行时动态计算，前者会增加内存消耗量，后者会影响运行时性能，因为考虑到其它问题所以选择了后者。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何用状态表达对象的系统特征">如何用状态表达对象的系统特征<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E5%A6%82%E4%BD%95%E7%94%A8%E7%8A%B6%E6%80%81%E8%A1%A8%E8%BE%BE%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%89%B9%E5%BE%81" class="hash-link" aria-label="如何用状态表达对象的系统特征的直接链接" title="如何用状态表达对象的系统特征的直接链接">​</a></h4>
<p>由于节点（Node）的抽象粒度较粗，而其关联数据的特征信息很多，对于数据分析场景来说，其实有很高的信息表达复杂度。于是出现了这样一个需求：通过一个开关可让用户控制是否需要按节点类型分组着色的效果。说明白一点就是，在按交互行为类型对状态类型进行抽象设计的情况下，一个 Node 实例对象在 <code>normal</code> 状态下可能会因为开关的状态不同而表现不同，该如何应对此类场景？</p>
<p>其实也有两个方案，一是对开关的状态进行状态类型抽象，这样就可以实现 <code>normal</code> 和 <code>switchOpen</code> 两个状态叠加应用并更新对象，但状态的叠加还会产生其它问题，例如状态叠加的顺序。不过，查看 ZRender 的源码，其实可以看到对多状态的叠加是支持的，但在实际使用过程中，叠加的多个状态定义也会产生一些问题。</p>
<p>从按交互行为对状态类型进行抽象的角度来看，这是全部 Node 对象共有的交互特性，也可看作是 Node 个体特征，而要将全部 Node 分组进行着色实际上是 Node 的系统特征的表达。所以，第二种方案就是将交互行为分为两类：用户行为（个体行为）和系统行为。在状态类型抽象设计时，具体的状态类型表达的是用户行为，而对应的状态对象定义可以动态计算，其依赖于系统行为状态。这样，就避免了状态叠加的复杂性和问题，利用命令式编码的灵活性来方便的应对此类复杂场景。实际上，这也是之前为何选择了动态计算状态定义的方案，而 ZRender 中 <code>stateProxy()</code> 的设计应该也是考虑了此类场景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>本文通过引出强交互体验的 Web 应用中交互状态管理的复杂性问题，通过对 ECharts 和 ZRender 在该方面的相关源码实现进行分析，总结了应对此类问题可参考的程序设计思路，并通过一个实际的实践案例应用来分析真实场景中会面临哪些典型问题，如何调整程序设计以解决问题。</p>
<p>总的来说，对于复杂应用的交互状态管理设计首先应该划分为：全局调度和局部对象状态管理机制。在全局将整个流程拆分为交互响应、对象状态更新、对象批量更新等多个阶段以降低代码复杂度和耦合性，在局部对象中提供预先定义状态对象的机制应对简单场景，也可以提供动态计算状态定义的机制来应对复杂场景，并结合动画来进一步提高用户体验。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/2023/01/09/computer-technology/web-frontend/echarts-zrender/interactive-state-design#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://echarts.apache.org/zh/index.html" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/zh/index.html</a></li>
<li><a href="https://ecomfe.github.io/zrender-doc/public/" target="_blank" rel="noopener noreferrer">https://ecomfe.github.io/zrender-doc/public/</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>程序架构设计</category>
            <category>ZRender</category>
            <category>ECharts</category>
            <category>Web 前端</category>
            <category>数据可视化</category>
            <category>实践案例</category>
            <category>源码解析</category>
        </item>
        <item>
            <title><![CDATA[Web 3D 开发实践：计算物体在 2D 平面上的像素尺寸]]></title>
            <link>https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2</link>
            <guid>https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2</guid>
            <pubDate>Tue, 20 Dec 2022 00:09:00 GMT</pubDate>
            <description><![CDATA[这篇文章是基于 3D 地球组件的开发实践，记录了将 3D 空间中的物体投影到 2D 平面中时如何换算像素尺寸的解决方案。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p><em>最后更新于 2022-12-20 00:09:00</em></p>
</blockquote>
<p>这次是基于中秋节活动时开发 3D 月球组件的经验来开发 3D 地球组件，相比于上一次，这一次很多技术难点都有了现成的解决方案，可以说开发成本降低了三分之二之多，而这些额外的开发成本则花费在隐藏在需求细节中的技术难点。这篇文章主要用来记录开发过程中遇到的一个比较有意义的技术难点，即 3D 空间中的物体投影到 2D 平面中时如何换算像素尺寸，在探索解决该难点的过程中，对 3D 与 2D 空间之间的关系有了一个更深刻的认识。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="透视相机与正交相机">透视相机与正交相机<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E9%80%8F%E8%A7%86%E7%9B%B8%E6%9C%BA%E4%B8%8E%E6%AD%A3%E4%BA%A4%E7%9B%B8%E6%9C%BA" class="hash-link" aria-label="透视相机与正交相机的直接链接" title="透视相机与正交相机的直接链接">​</a></h2>
<p>在开始之前，有必要介绍一下相机相关的知识，因为正在讨论的问题是在使用透视相机（<a href="https://threejs.org/docs/#api/en/cameras/PerspectiveCamera" target="_blank" rel="noopener noreferrer"><code>PerspectiveCamera</code></a>）时遇到的。</p>
<p>对于 3D 开发，大部分场景下都会使用透视相机，这是因为透视相机（投影）符合我们人眼观察世界的方式，会产生一种物体“近大远小”的视觉效果。另一方面，正交相机（<a href="https://threejs.org/docs/#api/en/cameras/OrthographicCamera" target="_blank" rel="noopener noreferrer"><code>OrthographicCamera</code></a>）也很常用，绘制 2D 视图就会用到，像我们生活中常见的工程制图一般应用的就是正交投影。</p>
<p><img decoding="async" loading="lazy" alt="perspective-and-orthographic-projection" src="https://wang1212.github.io/assets/images/perspective-and-orthographic-projection-bd14dd87133af90a7875c2e07e043404.webp" width="602" height="290" class="img_ev3q"></p>
<p>以下是 3D 建模过程中透视投影和正交投影的应用，其中 3 张图片是应用正交投影分别产生的车身 3 个不同视角的视图，而右上角则是应用透视投影后和我们人眼所观察到的视觉效果相一致。</p>
<p><img decoding="async" loading="lazy" alt="quad-viewport" src="https://wang1212.github.io/assets/images/quad-viewport-4b3b445fa4d08b90b2baee1dcb234521.jpg" width="1148" height="918" class="img_ev3q"></p>
<p>实际上，这里要讨论的问题即就是在透视相机（投影）所观察到的 3D 空间中某个物体在 2D 平面上的像素尺寸和坐标，是不是又有点像正交投影呢？</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="需求与问题">需求与问题<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E9%9C%80%E6%B1%82%E4%B8%8E%E9%97%AE%E9%A2%98" class="hash-link" aria-label="需求与问题的直接链接" title="需求与问题的直接链接">​</a></h2>
<p>现在来说说具体的问题是什么，如下图所示，地球表面有大量的点标记，点标记又会通过一根竖线和矩形文本框的标签连接起来，也就是说标签的位置取决于点标记在地球表面的经纬度坐标。在转动地球的过程中，如果点标记所在的位置已经被转到当前视角的背面，点标记、竖线、标签作为一个整体都会隐藏掉，这符合我们对三维空间物体的感知。但事情并非想象的这么简单，由于在移动端应用，如果某个标签的文本长度够长会出现标签已出现在屏幕之外而点标记的位置还在当前视角的可视范围内，那么标签就不会隐藏，而产品和交互更倾向于将标签作为参照对象，而不是点标记，<strong>当标签的边缘超出图中红色的矩形框时，标记点、竖线、标签作为一个整体同时隐藏不可见</strong>。</p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="https://wang1212.github.io/assets/images/screenshot-5c01f40559825d465d41c89a8fcdf537.jpg" width="551" height="674" class="img_ev3q"></p>
<p>实际上，点标记、竖线、标签均是用 DOM 绘制的，利用 3D 场景中的点坐标和 2D 平面的像素坐标投影转换即可得到点标记的屏幕坐标。这个应用场景之一是在处理鼠标交互时，可以将鼠标点击的屏幕像素坐标转换为 3D 空间中的坐标。</p>
<p>那么，解决该问题的思路实际上也比较简单，标记点、标签的屏幕像素坐标知道，关键在于图中红色矩形框的位置和大小，其基准是 3D 空间中地球在 2D 平面上投影的矩形包围盒的位置和大小，而根据地球的球心坐标可以很容易换算出屏幕的像素坐标，但难点在于知道 3D 空间中地球的半径却不知如何换算为 2D 平面中的像素尺寸。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3d-空间尺寸与像素尺寸的对应关系">3D 空间尺寸与像素尺寸的对应关系<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#3d-%E7%A9%BA%E9%97%B4%E5%B0%BA%E5%AF%B8%E4%B8%8E%E5%83%8F%E7%B4%A0%E5%B0%BA%E5%AF%B8%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB" class="hash-link" aria-label="3D 空间尺寸与像素尺寸的对应关系的直接链接" title="3D 空间尺寸与像素尺寸的对应关系的直接链接">​</a></h2>
<p>这个问题之所以棘手，就是因为在透视相机（投影）所观察到的 3D 空间中每个物体都会呈现出“近大远小”的视觉效果，所以虽然在同一个 2D 平面（屏幕）上绘制物体，但在 3D 空间中距离相机远近不同，同样的 3D 空间尺寸投影到 2D 平面（屏幕）上时像素尺寸大小是不一样的。</p>
<p>现在，可以进一步将问题具体化为：<strong>在特定的相机距离下，3D 空间中的尺寸与 2D 投影平面的像素尺寸换算关系</strong>。</p>
<p>到了这里，对于 3D 开发经验并不丰富的我来说，技术层面实际上没有太多思路，于是只能搜索是否有解决方案。事实上，查找资料的过程并不顺利，首先是搜索关键字的问题，无法确定有效的关键字，导致一直得不到期望的结果；其次，也是比较耗费时间的一点，有很多不直接相关的问题并有相应的解决方案，但如果不花费时间理解则很容易错过一些很有用的“细节”。最终，从<a href="https://discourse.threejs.org/t/functions-to-calculate-the-visible-width-height-at-a-given-z-depth-from-a-perspective-camera/269" target="_blank" rel="noopener noreferrer">如何计算给定 Z 深度处的可见宽度/高度</a>这个讨论中找到了解决问题的线索，这个讨论中试图实现无论相机如何缩放，都可以让 3D 空间中的某个物体占满全屏。</p>
<p>可以发现，3D 开发中通常都是利用一些数学知识来解决问题的。对于文初的示意图中透视相机（投影）的模型，我们可以画出一个侧视图：</p>
<p><img decoding="async" loading="lazy" alt="example" src="https://wang1212.github.io/assets/images/example-68e1ec4e6b78bae72547a0f2d2dc8a0c.jpg" width="893" height="477" class="img_ev3q"></p>
<p>如上图所示，假设 <code>z0</code> 深度处可见高度（蓝色竖线）为 <code>h</code> 以及距离相机 <code>d</code>，知道相机的 <code>fov</code> 角度，根据三角函数：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tan(fov / 2) = (h / 2) / d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么可见高度 <code>h</code> 就可以得到：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">h = 2 * tan(fov / 2) * d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据相机的视野比例 <code>camera.aspect</code> 很容易就能得到可见宽度：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">w = h * camera.aspect</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里需要注意的是，根据 <code>z0</code> 与相机位置得到的 <code>d</code>，以及计算出的 <code>h</code> 和 <code>w</code> 都是 3D 空间中的尺寸（坐标尺度）。假设 3D 场景中有一个面向相机的矩形平面，在相机不断缩放的过程中，计算出 <code>h</code> 和 <code>w</code> 并设置为该矩形平面的高与宽，就能达到任意缩放比例下，该矩形平面都能占满整个场景的可视范围（即画布整个区域）。</p>
<p>既然如此，那我们很容易就能得到像素尺寸和 3D 尺寸的换算关系（假设物体在 3D 空间中的高度为 <code>H</code>，屏幕投影的像素高度为 <code>pixelH</code>）：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pixelH / canvas.clientHeight = H / h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="计算球体在屏幕上投影的包围盒位置">计算球体在屏幕上投影的包围盒位置<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E8%AE%A1%E7%AE%97%E7%90%83%E4%BD%93%E5%9C%A8%E5%B1%8F%E5%B9%95%E4%B8%8A%E6%8A%95%E5%BD%B1%E7%9A%84%E5%8C%85%E5%9B%B4%E7%9B%92%E4%BD%8D%E7%BD%AE" class="hash-link" aria-label="计算球体在屏幕上投影的包围盒位置的直接链接" title="计算球体在屏幕上投影的包围盒位置的直接链接">​</a></h3>
<p>至此，我们就可以利用以上的结论很方便的计算出：指定位置（<code>z</code> 深度处）和指定球体半径 <code>radius</code> 的地球在屏幕上投影的矩形包围盒像素宽高。</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rectPixelH = (radius / (2 * tan(fov / 2) * d)) * canvas.clientHeight</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样就可以利用程序实现在 canvas 上叠加一个 div 在相机缩放过程中同步 div 的宽高与地球球体投影矩形包围盒的宽高，如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="screenshot1" src="https://wang1212.github.io/assets/images/screenshot1-b2de1048e289e07197b33d68c3fd6413.jpg" width="550" height="551" class="img_ev3q"></p>
<p>知道球体的矩形包围盒的位置和大小后，只需要给四周加上一定的偏移即可动态确定标签显隐检测的矩形范围，就顺利的解决了需求难题。不过，对于球体来说，有其特殊性，我们可以做进一步的优化，让包围盒的范围更精确。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="球体的特点">球体的特点<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E7%90%83%E4%BD%93%E7%9A%84%E7%89%B9%E7%82%B9" class="hash-link" aria-label="球体的特点的直接链接" title="球体的特点的直接链接">​</a></h3>
<p>让我们先来看看 3D 空间中地球的俯视图投影：</p>
<p><img decoding="async" loading="lazy" alt="example1" src="https://wang1212.github.io/assets/images/example1-481eb02dd8cdd5651f67608846d06d61.jpg" width="724" height="714" class="img_ev3q"></p>
<p>如上图所示，从相机位置为起点的两条蓝色直线是球体俯视投影圆的切线（切线与切点到圆心连线形成的夹角为 90° 直角），根据数学知识我们知道，四边形（蓝色实线）内角和为 360°，两条切线的夹角永远大于 0°，对角将永远小于 180°，也就意味着两个切点连线（黄色实线）的长度会无限接近直径（红色实线）长度但永远小于直径长度。</p>
<p>前面我们都是假设相机所能看到的最大范围是直径（图中红色实线）长度，但经过以上分析我们已经知道，对于球体来说，视野的最大范围是两个切点连线（图中黄色实线）的长度。所以，对于球心在 <code>z0</code> 深度处的球体，相机所能观察到的球体投影范围的矩形包围盒的宽高小于半径的两倍（即相当于圆心在 <code>z1</code> 深度处的小圆）。根据示意图所示，运用数学知识就能很快计算出黄色实线对应的 3D 空间中的长度及其和直径长度的比例关系，再将其按照前文所述的换算原理进行计算即可得到对应的像素长度，这里不再赘述。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>在 Web 3D 开发中，很多技术难点实际上都是因为我们对于数学知识的运用和实践经验不足，这篇文章用一个实际案例来说明利用数学知识解决 3D 场景中物体在 2D 平面（屏幕）投影的像素尺寸计算问题，也简单了解了透视相机（投影）和正交相机（投影）的应用场景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://threejs.org/manual/#en/cameras" target="_blank" rel="noopener noreferrer">https://threejs.org/manual/#en/cameras</a></li>
<li><a href="https://en.wikipedia.org/wiki/3D_projection#Perspective_projection" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/3D_projection#Perspective_projection</a></li>
<li><a href="https://en.wikipedia.org/wiki/Orthographic_projection" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Orthographic_projection</a></li>
<li><a href="https://people.computing.clemson.edu/~dhouse/courses/405/notes/projections.pdf" target="_blank" rel="noopener noreferrer">https://people.computing.clemson.edu/~dhouse/courses/405/notes/projections.pdf</a></li>
<li><a href="https://discourse.threejs.org/t/functions-to-calculate-the-visible-width-height-at-a-given-z-depth-from-a-perspective-camera/269/18" target="_blank" rel="noopener noreferrer">https://discourse.threejs.org/t/functions-to-calculate-the-visible-width-height-at-a-given-z-depth-from-a-perspective-camera/269/18</a></li>
<li><a href="https://gist.github.com/ayamflow/462190f13eeef04f01cb" target="_blank" rel="noopener noreferrer">https://gist.github.com/ayamflow/462190f13eeef04f01cb</a></li>
<li><a href="https://stackoverflow.com/questions/13350875/three-js-width-of-view/13351534#13351534" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/13350875/three-js-width-of-view/13351534#13351534</a></li>
</ul>]]></content:encoded>
            <author>mrwang1212@126.com (不如怀念)</author>
            <category>计算机技术</category>
            <category>Web</category>
            <category>Web 前端</category>
            <category>3D</category>
            <category>WebGL</category>
            <category>Three.js</category>
            <category>实践案例</category>
        </item>
    </channel>
</rss>