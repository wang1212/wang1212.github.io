<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://wang1212.github.io/</id>
    <title>不如怀念 Blog</title>
    <updated>2023-12-16T22:10:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://wang1212.github.io/"/>
    <subtitle>不如怀念 Blog</subtitle>
    <icon>https://wang1212.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[绍兴鲁迅故居之行]]></title>
        <id>https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing</id>
        <link href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing"/>
        <updated>2023-12-16T22:10:00.000Z</updated>
        <summary type="html"><![CDATA[杭州待了好几年，早就通了地铁的邻市绍兴是个很好的闲游去处，话虽如此，却也一直缺乏行动，难得在这个冬季的周末完成此行。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-12-16 22:10:00</em></p>
</blockquote>
<p><u>2023-11-25</u>
<br>
<br></p>
<p>杭州待了好几年，早就通了地铁的邻市绍兴是个很好的闲游去处，话虽如此，却也一直缺乏行动，难得在这个冬季的周末完成此行。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="地铁-or-高铁">地铁 or 高铁<a href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing#%E5%9C%B0%E9%93%81-or-%E9%AB%98%E9%93%81" class="hash-link" aria-label="地铁 or 高铁的直接链接" title="地铁 or 高铁的直接链接">​</a></h2>
<p>为什么会产生这个疑问呢？因为计划一日游，所以时间略显紧张，地铁单程大概要两个小时，这样的话早上得起多早啊！</p>
<p>好的是，两市之间也有高铁，耗时仅 19 分钟，这意味着早上可以多睡一会懒觉了。不过，众所周知，高铁站大部分不一定在市中心，所以出发之前还是查了绍兴高铁站距离景点的距离，大约 10 公里的样子，还不算远，怎么算都比地铁耗时短。</p>
<p>绍兴在我的印象中比较吸引人的则是“鲁迅故居”了，看见百草园与三味书屋要感觉亲切很多，另一方面绍兴最有名的则是黄酒了。此外，在旅游 App 上查看，绍兴还有兰亭（可记得《兰亭序》？）、书圣故里（书法名家王羲之）等比较有名的景点，也是此行的计划安排。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="鲁迅故里">鲁迅故里<a href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing#%E9%B2%81%E8%BF%85%E6%95%85%E9%87%8C" class="hash-link" aria-label="鲁迅故里的直接链接" title="鲁迅故里的直接链接">​</a></h2>
<p>当天的天气很好，没想到冬天的游客也很多。到达鲁迅故居已是中午十一点钟了，打算先预约景点然后吃完饭再去逛一逛，不过看了一圈好像也没有特别想吃的，于是找了家人不多的炒年糕店，也是头一次吃到别有一番风味的炒年糕。</p>
<p>绍兴的黄酒很著名，当然也体现在景区的小吃上了，基本都会含黄酒，倒也挺有意思。</p>
<p>鲁迅故居的景点实际上包含了多个小景点（鲁迅故居、鲁迅祖居、百草园、三味书屋等），而且不是连在一起的，要从一个景点进去逛完出来再去另一个景点。</p>
<p>为了节省时间，先从人少的游客中心进到了祖居景点，里面也不算很大，陈列的东西也比较少。下一个则是紧挨着的纪念馆了，里面陈列的东西相当多，不仅有鲁迅相关的，还有一些其它绍兴名人相关的，比较让人印象深刻的则是周恩来总理了，来之前倒还没想到总理原本也是绍兴人啊。一路看着一些我们在课本上学过的鲁迅文集摘选颇有感慨，鲁迅弃医从文等一系列事迹让人深有感触。纪念馆中还有王羲之的《兰亭集序》手稿，看着这些熟悉的字句，不禁能回想起原来全篇背诵的场景。</p>
<p>接下来去了故居景点，里面的人流量有两三千，应该相比长假等热门时间要好一点，这也是核心景点了。从门口的简版地图来看，百草园就在宅子的最后边。故居比祖居看起来要大一些，不过据了解这些都是后来复原的，而且鲁迅可能成年后在绍兴并没有实际的长期生活过，这些都是他们的家族兄弟姐妹及其后人支持修建的。</p>
<p>百草园实际上就是鲁迅家的菜园子，鲁迅给其的称谓让其对别人来说颇感不一样，也许这就是鲁迅幽默的风格吧。</p>
<p>从故居出来之后已经是下午一点多钟了，这里就剩下最后一个三味书屋景点了，这也是在故居的对面，即鲁迅老师的家，看吧，鲁迅总是能把一件事情写出不一样的感觉。排队的人很多，耗时二十分钟才进门，里面的区域实际并不大，有意思的是鲁迅的课桌还在，上面似乎刻了一个“早”字。</p>
<p>来之前本来打算是绕着一圈连续逛好几个景点的，发现这一圈下来有些许的累，于是进行了短暂的歇息。来一次绍兴，当然得带点特产回去吧，黄酒是最好不过了，虽然现在的特产基本上网购都可以买到，但毕竟来一次，尝尝手工的倒也不错。</p>
<p>此刻已是下午两点，打算再去最后一个景点书圣故里，由于距离只有两三公里，所以就步行晃晃悠悠过去了。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="书圣故里">书圣故里<a href="https://wang1212.github.io/2023/12/16/life/tourism/tourism-shaoxing#%E4%B9%A6%E5%9C%A3%E6%95%85%E9%87%8C" class="hash-link" aria-label="书圣故里的直接链接" title="书圣故里的直接链接">​</a></h2>
<p>对于喜欢书法的人来说，有“书圣”之称的王羲之应该是比较熟悉的，其作品天下第一行书《兰亭序》更是为人所熟知。当然，我并不知其为绍兴人。</p>
<p>绍兴有书圣故里和兰亭两个景点，不知其有何不同，由于前者离得较近就选择去这里。</p>
<p>等到了目的地后，才发现这似乎算是一个开放式的小街巷，不算是一个被开发的景点。当然，作为北方人来这街巷走走看看也是不错的，领略一下江南的风土人情。</p>
<p>绍兴此行是比较轻松的，因为离得近，所以觉得以后还可以再来，行程安排就较为随意一些了，逛到哪是哪，走走看看就当散步了。</p>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="生活" term="生活"/>
        <category label="旅游" term="旅游"/>
        <category label="绍兴" term="绍兴"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[解析 ECharts 的 UniversalTransition 动画]]></title>
        <id>https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation</id>
        <link href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation"/>
        <updated>2023-11-10T19:23:00.000Z</updated>
        <summary type="html"><![CDATA[ECharts 的 UniversalTransition 动画提供了一些复杂场景下过渡动画的解决方案，这类场景的难点在于让不规则图形或者不同形状的图形之间如何完成一个比较流畅的过渡动画，在业内比较熟知的类似技术则是 SVG Morph 动画。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-11-11 21:56:00</em></p>
</blockquote>
<p>ECharts 的 <a href="https://echarts.apache.org/zh/option.html#series-line.universalTransition" target="_blank" rel="noopener noreferrer">UniversalTransition 动画</a>提供了一些复杂场景下过渡动画的解决方案，这类场景的难点在于让<strong>不规则图形</strong>或者<strong>不同形状的图形</strong>之间如何完成一个比较流畅的过渡动画，在业内比较熟知的类似技术则是 SVG Morph 动画。</p>
<p>查看以下 ECharts 官方示例：</p>
<blockquote>
<ul>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=scatter-aggregate-bar" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=scatter-aggregate-bar</a></li>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=scatter-symbol-morph" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=scatter-symbol-morph</a></li>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=map-bar-morph" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=map-bar-morph</a></li>
<li><a href="https://echarts.apache.org/examples/zh/editor.html?c=treemap-sunburst-transition" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/examples/zh/editor.html?c=treemap-sunburst-transition</a></li>
</ul>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="svg-morph-动画">SVG Morph 动画<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#svg-morph-%E5%8A%A8%E7%94%BB" class="hash-link" aria-label="SVG Morph 动画的直��接链接" title="SVG Morph 动画的直接链接">​</a></h2>
<p>在探究 ECharts 的 UniversalTransition 动画之前先来看看比较成熟的 SVG Morph 技术。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="css-方案">CSS 方案<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#css-%E6%96%B9%E6%A1%88" class="hash-link" aria-label="CSS 方案的直接链接" title="CSS 方案的直接链接">​</a></h3>
<p>通常，动画会优先采用 CSS 方案，一方面是因为方便，另一方面则是因为会有硬件加速的优势。实际上，SVG 的 Morph 动画也可以使用 CSS 来实现。查看以下示例：</p>
<blockquote>
<p><a href="https://codepen.io/chriscoyier/pen/NRwrNp" target="_blank" rel="noopener noreferrer">https://codepen.io/chriscoyier/pen/NRwrNp</a></p>
</blockquote>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">viewBox</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0 0 10 10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">svg-1</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">d</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">M2,2 L8,8</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token selector class" style="color:#00009f">.svg-1</span><span class="token selector pseudo-class" style="color:#00009f">:hover</span><span class="token selector" style="color:#00009f"> path</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">d</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"M8,2 L2,8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>&lt;path&gt;</code> 标签的 <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d" target="_blank" rel="noopener noreferrer"><code>d</code></a> 属性是一个 Presentation Attributes，所以可被用来作为 CSS 属性使用。不过，目前浏览器的支持度仅有 <a href="https://caniuse.com/mdn-svg_elements_path_d_path" target="_blank" rel="noopener noreferrer">70%</a> 多，兼容性并不高。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="smil-方案">SMIL 方案<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#smil-%E6%96%B9%E6%A1%88" class="hash-link" aria-label="SMIL 方案的直接链接" title="SMIL 方案的直接链接">​</a></h3>
<p>实际上，在 CSS 支持的更早之前，业内采用 <a href="https://www.w3.org/TR/REC-smil/" target="_blank" rel="noopener noreferrer">SMIL 技术</a>来实现 Web 上的矢量图形形变动画。来自 <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animate" target="_blank" rel="noopener noreferrer">MDN 文档</a>的示例如下：</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">viewBox</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0 0 10 10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2000/svg</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">rect</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">width</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">height</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">10</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">animate</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">attributeName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">rx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">values</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">0;5;0</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">dur</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">10s</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">repeatCount</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">indefinite</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">rect</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">svg</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可见，其实际上是类似 HTML 标签的形式，所以在应对一些高度复杂的动画场景时局限性比较大。</p>
<p>给出一个实际案例，状态管理库 jotai 的官方 GitHub 仓库 logo 动画的源文件：</p>
<blockquote>
<p><a href="https://raw.githubusercontent.com/pmndrs/jotai/master/img/title.svg" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/pmndrs/jotai/master/img/title.svg</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gsap-的-morphsvg-插件">GSAP 的 MorphSVG 插件<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#gsap-%E7%9A%84-morphsvg-%E6%8F%92%E4%BB%B6" class="hash-link" aria-label="GSAP 的 MorphSVG 插件的直接链接" title="GSAP 的 MorphSVG 插件的直接链接">​</a></h3>
<p>要实现效果比较好的形变动画并不容易，目前，业内功能比较强大的工具库则是 <a href="https://gsap.com/docs/v3/Plugins/MorphSVGPlugin/" target="_blank" rel="noopener noreferrer">GSAP 的 MorphSVG 插件</a>，我们在其官方文档中可以看到其中的技术难点。</p>
<p><img loading="lazy" alt="gsap-svg-morph-plugin" src="https://wang1212.github.io/assets/images/gsap-svg-morph-plugin-7413a2b75c6b332db8698bbdacde2a58.webp" width="1396" height="437" class="img_ev3q"></p>
<p>在处理两个不同的 SVG 图形之间的形变过渡时，要确保其 <code>d</code> 属性包含的<strong>点数量是一致</strong>的，为了实现这个目标，则需要对其数据进行插值和优化处理，将其转换和细分为多段<strong>贝塞尔曲线</strong>。</p>
<p>为了更好的理解，可以参考以下这篇关于使用 D3.js 实现折线图过渡动画的文章：</p>
<blockquote>
<p><a href="https://bocoup.com/blog/improving-d3-path-animation" target="_blank" rel="noopener noreferrer">https://bocoup.com/blog/improving-d3-path-animation</a></p>
</blockquote>
<p>以上文章中对于不同点数量的折线图过渡动画的数据点插值尝试了多个方案，可以看出不同的插值算法对动画的效果影响是比较明显，这也是 SVG 形变动画中的难点。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="贝塞尔曲线为什么这么重要">贝塞尔曲线为什么这么重要？<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E4%B9%88%E9%87%8D%E8%A6%81" class="hash-link" aria-label="贝塞尔曲线为什么这么重要？的直接链接" title="贝塞尔曲线为什么这么重要？的直接链接">​</a></h2>
<p>查阅不同的资料，发现大家在实现 SVG 形变动画时，数据插值优化过程中都会将其转换为贝塞尔曲线进行处理，遂产生了好奇心，更进一步的探索才发现贝塞尔曲线是非常重要的一个数学函数和曲线，几乎所有的图形引擎都支持绘制贝塞尔曲线。</p>
<p>可参考以下这篇文章来简单的了解贝塞尔曲线在设计领域的重要性：</p>
<blockquote>
<p><a href="https://www.linearity.io/blog/bezier-curves/" target="_blank" rel="noopener noreferrer">https://www.linearity.io/blog/bezier-curves/</a></p>
</blockquote>
<p>根据维基百科：</p>
<blockquote>
<p>由于需要点阵化更精细的分辨率时，重新插值（补点）的计算量较小，<strong>贝塞尔曲线被广泛地在计算机图形中用来为平滑曲线建立模型</strong>。</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="echarts-的动画实现细节">ECharts 的动画实现细节<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#echarts-%E7%9A%84%E5%8A%A8%E7%94%BB%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82" class="hash-link" aria-label="ECharts 的动画实现细节的直接链接" title="ECharts 的动画实现细节的直接链接">​</a></h2>
<p>根据源码，ECharts 的 UniversalTransition 动画被实现为一个插件功能：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.3.3/src/animation/universalTransition.ts#L626</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">installUniversalTransition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">registers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EChartsExtensionInstallRegisters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerUpdateLifecycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'series:beforeupdate'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecMOdel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerUpdateLifecycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'series:transition'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecModel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO api provide an namespace that can save stuff per instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> globalStore </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUniversalTransitionGlobalStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO multiple to multiple series.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oldSeries </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updatedSeries </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optionChanged</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Use give transition config if its' give;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> transitionOpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seriesTransition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transitionOpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">each</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">normalizeToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transitionOpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opt </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">transitionSeriesFromOpt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Else guess from series based on transition series key.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updateBatches </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findTransitionSeriesBatches</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">each</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updateBatches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> updateBatches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">transitionBetween</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oldSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分析一些关键性源码，可以了解到其过渡动画的实现细节，直接来看看两个系列之间的过渡是如何实现的。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.3.3/src/animation/universalTransition.ts#L160</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transitionBetween</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oldList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransitionSeries</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  newList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransitionSeries</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  api</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ExtensionAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateOneToOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldDiffItems</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oldIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newDiffItems</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">newIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newSeries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hostModel </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> SeriesModel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO Mark this elements is morphed and don't morph them anymore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldEl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getItemGraphicEl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newEl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getItemGraphicEl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Can't handle same elements.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      newEl </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animateElementStyles</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newSeries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// We can't use the elements that already being morphed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> isElementStillInChart</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">stopAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">stopAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// If old element is doing leaving animation. stop it and remove it immediately.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">removeEl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hasMorphAnimation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">applyMorphAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">getPathList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">getPathList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          newItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">divide</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          newSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          newIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">          updateMorphingPathProps</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">fadeInElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newSeries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DataDiffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oldDiffItems</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newDiffItems</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">createKeyGetter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">createKeyGetter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'multiple'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updateOneToOne</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateManyToOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateOneToMany</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateManyToMany</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newIndices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldIndices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在应用 Morph 动画之前，对两个图形元素进行了遍历迭代，得到其包含的所有 <code>path</code> 实例。需要注意的是，ECharts 的底层绘图引擎是 ZRender，而其所有图形的基类就是 <code>Path</code>，这只是绘图层的抽象设计，与 svg 的 <code>&lt;path&gt;</code> 标签对象不是同一个概念。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.3.3/src/animation/morphTransitionHelper.ts#L110</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyMorphAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  from</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DescendentPaths </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DescendentPaths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  to</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DescendentPaths </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DescendentPaths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  divideShape</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UniversalTransitionOption</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'divideShape'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  seriesModel</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SeriesModel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dataIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">animateOtherProps</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fromIndividual</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toIndividual</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rawFrom</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rawTo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animationCfg</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ElementAnimateConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">morphOneBatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MorphingBatch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fromIsMany</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateCount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forceManyOne</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchMany </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">many</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchOne </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">one</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchMany</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">forceManyOne</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Is one to one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchFrom</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromIsMany </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> batchMany</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batchOne</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> batchTo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromIsMany </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> batchOne </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batchMany</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isCombineMorphing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchFrom </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Keep doing combine animation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">morphOneBatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          many</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">batchFrom </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          one</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batchTo </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateCount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> individualAnimationCfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> animationDelay </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defaults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            delay</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animationDelay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">animateIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ElementAnimateConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> animationCfg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">morphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchTo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> individualAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">animateOtherProps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchTo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchTo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> individualAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fromIndividuals</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        toIndividuals</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromIsMany</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">combineMorph</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchMany</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchOne</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> separateAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">separateMorph</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batchOne</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batchMany</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> separateAnimationCfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> morphBatches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">morphOneBatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">morphBatches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fromIsMany</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animateCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animateIndex </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> morphBatches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">many</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ECharts 为了使不同的图表元素在动画过渡时更自然一些，提供了多种策略，允许图形分割、合并等。</p>
<p>从源码中可以看到，ECharts 只处理了一些业务逻辑，真正的图形变形逻辑实际上在 ZRender 中实现。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/ecomfe/zrender/blob/5.3.2/src/tool/morphPath.ts#L482</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">morphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fromPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  animationOpts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ElementAnimateConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">fromPath </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldDone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> animationOpts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// const oldAborted = animationOpts.aborted;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldDuring </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> animationOpts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">during</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">prepareMorphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> MorphingPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__morphT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">restoreToPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">restoreMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'buildPath'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">restoreMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'updateTransform'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Mark as not in morphing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> MorphingPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__morphT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Cleanup.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createPathProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dirtyShape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">animateTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    __morphT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defaults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">during</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dirtyShape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      oldDuring </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">oldDuring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">restoreToPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      oldDone </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">oldDone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// NOTE: Don't do restore if aborted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Because all status was just set when animation started.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// aborted() {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//     oldAborted &amp;&amp; oldAborted();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ElementAnimateConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animationOpts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据以上源码来看，ZRender 在对两个 <code>Path</code> 对象实例做 Morph 动画处理时，会先做一部分<strong>准备工作</strong>，然后劫持 <code>buildPath()</code> 和 <code>updateTransform()</code> 两个方法，再利用 <code>__morphT</code> 标记位完成整段动画，最终再将被劫持的方法还原。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/ecomfe/zrender/blob/5.3.2/src/tool/morphPath.ts#L396</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepareMorphPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fromPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fromPathProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUpdatedPathProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toPathProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUpdatedPathProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fromBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toBezierCurves</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">alignBezierCurves</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pathToBezierCurves</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromPathProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pathToBezierCurves</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPathProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fromPathTransform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fromPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getComputedTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toPathTransform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getComputedTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateIdentityTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Transformable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  fromPathTransform </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyTransformOnBeziers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fromPathTransform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  toPathTransform </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyTransformOnBeziers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toPathTransform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Just ignore transform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">saveAndModifyMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'updateTransform'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> replace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> updateIdentityTransform </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> morphingData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findBestMorphingRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fromBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> toBezierCurves</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> tmpArr</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">saveAndModifyMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'buildPath'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PathProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面提到的准备工作是非常关键的，这个阶段 ZRender 会首先获取两个 Path 实例的<strong>绘图代理</strong>（为了同时支持 SVG、Canvas 等环境做的抽象设计），并将其<strong>转换为贝塞尔曲线</strong>的绘图指令组，然后将两段贝塞尔曲线组上的<strong>点数量进行对齐</strong>，然后对贝塞尔曲线应用变换。</p>
<p>以上就是 ECharts 的 UniversalTransition 动画实现细节，总结一下就是其与 SVG 的 Morph 动画实现思路一致，<strong>关键都在于对两个图形的路径点进行插值转换处理，并将点数量对齐</strong>，然后完成动画过渡。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="示例zrender-实现的-svg-morph-动画">示例：ZRender 实现的 SVG Morph 动画<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#%E7%A4%BA%E4%BE%8Bzrender-%E5%AE%9E%E7%8E%B0%E7%9A%84-svg-morph-%E5%8A%A8%E7%94%BB" class="hash-link" aria-label="示例：ZRender 实现的 SVG Morph 动画的直接链接" title="示例：ZRender 实现的 SVG Morph 动画的直接链接">​</a></h3>
<p>GSAP 的 MorphSVG 插件固然强大，但其只有注册为会员才能使用，并不是开源免费的方案，实际上用 ZRender 就可以做出类似的效果，这里给出 GSAP 官网文档示例的 ZRender 实现：</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">style</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css selector" style="color:#00009f">html</span><span class="token style language-css selector punctuation" style="color:#393A34">,</span><span class="token style language-css selector" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css selector" style="color:#00009f">  body</span><span class="token style language-css selector punctuation" style="color:#393A34">,</span><span class="token style language-css selector" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css selector" style="color:#00009f">  </span><span class="token style language-css selector id" style="color:#00009f">#container</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:#393A34">{</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">width</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">100</span><span class="token style language-css unit">%</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">height</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">100</span><span class="token style language-css unit">%</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">display</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> flex</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">flex-direction</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> column</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css punctuation" style="color:#393A34">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css selector class" style="color:#00009f">.nav</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:#393A34">{</span><span class="token style language-css punctuation" style="color:#393A34">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css selector class" style="color:#00009f">.chart</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:#393A34">{</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">flex</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">1</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">    </span><span class="token style language-css property" style="color:#36acaa">height</span><span class="token style language-css punctuation" style="color:#393A34">:</span><span class="token style language-css"> </span><span class="token style language-css number" style="color:#36acaa">0</span><span class="token style language-css punctuation" style="color:#393A34">;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css">  </span><span class="token style language-css punctuation" style="color:#393A34">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token style language-css"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">style</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">container</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">nav</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">nav</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">play</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">play</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">reset</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">reset</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">nav</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">chart</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">chart</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">https://cdn.bootcdn.net/ajax/libs/zrender/5.3.2/zrender.min.js</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> zr </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zrender</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> zrIns </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">init</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">getElementById</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">'chart'</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">path</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createFromString</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">"M490.1,280.649c0,44.459-36.041,80.5-80.5,80.5s-80.5-36.041-80.5-80.5s36.041-80.5,80.5-80.5 S490.1,236.19,490.1,280.649z"</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> to </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">path</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createFromString</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">"M149,245c2.7-36.7,16.11-69.08,40.1-97.06c27.04-31.6,60.92-47.39,101.63-47.39c15.48,0,38.48,2.45,69.02,7.29 c30.54,4.89,53.53,7.28,69.03,7.28c23.69,0,57.87,8.85,102.53,26.48c7.91,3.01,17.47,11.24,28.7,24.59 c6.38,7.89,16.26,19.77,29.62,35.57c3.04,2.14,7,5.32,11.86,9.6c4.86,4.22,8.19,6.06,10,5.46c0.62-1.84,2.15-4.4,4.58-7.74 c1.21-1.23,1.96-1.83,2.26-1.83c0.93,0.61,1.83,1.21,2.75,1.83c0.91,0.62,1.21,2.42,0.91,5.46c-0.62,5.47-0.91,7.14-0.91,5 c-0.33,3.06-0.76,5.01-1.37,5.95c-3.95,6.67-5.48,11.85-4.55,15.47c0.92,3.32,3.77,8.67,8.64,15.96c4.87,7.29,7.59,12.76,8.19,16.4 c-0.3,2.73-0.43,7.12-0.43,13.21l-4.57,11.38c0,8.51,9.86,23.11,29.62,43.78c9.44,4.22,14.12,18.83,14.12,43.71 c0,19.47-16.09,29.17-48.27,29.17c-4.26,0-8.81-0.13-13.68-0.47c-3.34-1.2-8.2-2.56-14.58-4.07c-7.59-0.93-12.76-3.49-15.48-7.77 c-4.88-6.95-12.78-13.51-23.71-19.58c-1.82-0.88-4.48-4.22-7.98-10.02c-3.5-5.77-6.61-9.42-9.33-10.95 c-2.72-1.49-6.68-1.81-11.86-0.88c-8.81,1.49-13.68,2.26-14.57,2.26c-2.14,0-5.25-0.6-9.34-1.83c-4.11-1.21-7.05-1.83-8.89-1.83 c-2.11,9.73-2.59,19.15-1.36,28.25c0.3,2.45,1.83,4.43,4.56,5.92c4.27,3.05,6.53,4.71,6.85,5.05c2.72,2.11,5.61,5.61,8.64,10.45 c0.62,1.85-0.52,4.95-3.42,9.34c-2.89,4.41-5.22,7.01-7.06,7.74c-1.81,0.79-5.77,1.18-11.85,1.18c-8.82,0-29.45-2.45-30.98-2.73 c-7.59-1.53-14.13-3.94-19.58-7.3c-2.76-1.81-5.91-10.33-9.56-25.52c-3.68-16.41-6.72-26.27-9.14-29.64 c-0.6-0.9-1.36-1.33-2.26-1.33c-1.53,0-4.05,1.49-7.53,4.56c-3.49,2.99-5.86,4.65-7.05,5.01c-4.24,17.9-6.4,26.4-6.4,25.47 c0,7.01,1.97,12.89,5.92,17.77c3.94,4.86,8.06,9.57,12.32,14.11c5.16,5.77,7.74,10.78,7.74,15.04c0,2.41-0.75,4.52-2.28,6.37 c-6.38,7.89-17.02,11.85-31.9,11.85c-16.71,0-27.64-2.28-32.79-6.84c-6.7-5.77-10.95-11.86-12.76-18.2 c-0.3-1.53-1.05-6.09-2.28-13.68c-0.61-4.58-1.98-7.29-4.08-8.18c-6.1-0.92-13.69-2.58-22.78-5.01c-1.84-1.21-3.81-4.26-5.94-9.12 c-3.93-9.4-6.83-15.79-8.66-19.13c-9.13-4.56-23.7-9.7-43.76-15.45c-0.92,1.83-1.35,4.37-1.35,7.72c3.34,4.26,8.34,10.8,15.03,19.58 c5.47,7.29,8.2,14.3,8.2,20.96c0,12.78-8.2,19.13-24.61,19.13c-12.45,0-20.96-0.88-25.52-2.71c-6.67-2.73-12.29-9.14-16.85-19.13 c-7.6-16.74-11.85-26.16-12.76-28.27c-4.87-11.23-8.2-21.13-10.01-29.65c-1.23-6.05-3.06-15.35-5.49-27.8 c-2.12-10.3-5.46-18.36-10.01-24.13C155.33,279.36,147.5,260.6,149,245z"</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">style</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">fill</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">stroke</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">x</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">y</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  to</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">style</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">fill</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">stroke</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">'red'</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">x</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">y</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">0</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  zrIns</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">add</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  zrIns</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">add</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">to</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:#36acaa">window</span><span class="token script language-javascript punctuation" style="color:#393A34">[</span><span class="token script language-javascript string" style="color:#e3116c">'play'</span><span class="token script language-javascript punctuation" style="color:#393A34">]</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#d73a49">onclick</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    to</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">false</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">morph</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">morphPath</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> to</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">duration</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">2e3</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:#36acaa">window</span><span class="token script language-javascript punctuation" style="color:#393A34">[</span><span class="token script language-javascript string" style="color:#e3116c">'reset'</span><span class="token script language-javascript punctuation" style="color:#393A34">]</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#d73a49">onclick</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">false</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    to</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">attr</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">ignore</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    zr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">morph</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">morphPath</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">to</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword module" style="color:#00009f">from</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript literal-property property" style="color:#36acaa">duration</span><span class="token script language-javascript operator" style="color:#393A34">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number" style="color:#36acaa">2e3</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/2023/11/10/computer-technology/web-frontend/morph-animation#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://echarts.apache.org/zh/option.html#series-line.universalTransition" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/zh/option.html#series-line.universalTransition</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d</a></li>
<li><a href="https://caniuse.com/" target="_blank" rel="noopener noreferrer">https://caniuse.com/</a></li>
<li><a href="https://www.w3.org/TR/REC-smil/" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/REC-smil/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animate" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animate</a></li>
<li><a href="https://gsap.com/docs/v3/Plugins/MorphSVGPlugin/" target="_blank" rel="noopener noreferrer">https://gsap.com/docs/v3/Plugins/MorphSVGPlugin/</a></li>
<li><a href="https://bocoup.com/blog/improving-d3-path-animation" target="_blank" rel="noopener noreferrer">https://bocoup.com/blog/improving-d3-path-animation</a></li>
<li><a href="https://en.wikipedia.org/wiki/B%C3%A9zier_curve" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/B%C3%A9zier_curve</a></li>
<li><a href="https://www.linearity.io/blog/bezier-curves/" target="_blank" rel="noopener noreferrer">https://www.linearity.io/blog/bezier-curves/</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="动画" term="动画"/>
        <category label="工具" term="工具"/>
        <category label="ECharts" term="ECharts"/>
        <category label="ZRender" term="ZRender"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[此行南京]]></title>
        <id>https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing</id>
        <link href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing"/>
        <updated>2023-08-27T18:30:00.000Z</updated>
        <summary type="html"><![CDATA[夏日的短暂旅行放弃了千岛湖，转而选择了南京，领略了一下古都文化。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-08-27 18:30:00</em></p>
</blockquote>
<p><u>2023-08-25</u>
<br>
<br></p>
<p>夏日的短暂旅行放弃了千岛湖，转而选择了南京，领略了一下古都文化。</p>
<p>忘记什么时候看的新闻了，南京被称为“第一网红城市”，比成都还要厉害，现在还是不是第一倒也不重要了。</p>
<p>不知道是不是因为太热门的原因，临近出行的前几天才开始预定酒店，发现比预期的要贵一些。而且杭州去南京的高铁票几乎售罄，犹豫了几个小时就只能买站票了，要命的是返程也只有站票了，不过还好全程也只有一个半小时左右。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="去程的小插曲">去程的小插曲<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E5%8E%BB%E7%A8%8B%E7%9A%84%E5%B0%8F%E6%8F%92%E6%9B%B2" class="hash-link" aria-label="去程的小插曲的直接链接" title="去程的小插曲的直接链接">​</a></h2>
<p>计划是周五下午过去，周日下午回来，也就是两天两夜的行程。去程还出了一个小插曲，车票是下班后的两小时，去高铁站的时间绰绰有余，但没有预估到夏天是旅游的旺季，即便是提前二十多分钟到的高铁站，但在进站安检的时候排了很长的队，而距离发车已经只有七八分钟了。感觉运气不好的是，过了安检后才发现走错入口了，检票口在另一个入口处，此时距离发车也只有四五分钟了，而我还得从候车大厅的一端狂奔到另一端，中间隔了将近二十个检票口，人群也非常拥挤。等到了检票口是，发现距离发车还有一分钟，但已经显示停止检票了，当时都懵了，重点是今天去南京的票都已经售罄了，这一趟车赶不上就只能等明天早上了。恰好此时检票员还在检票口站着，跑过去立马询问了一下，检票员则迅速帮助我们检票然后放行，悬着的心终于放下了。</p>
<p>犹记得上一次也有类似的经历，还是没有吸取教训啊，以后出行的时间要留的宽裕一些。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="秦淮河夜景">秦淮河夜景<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E7%A7%A6%E6%B7%AE%E6%B2%B3%E5%A4%9C%E6%99%AF" class="hash-link" aria-label="秦淮河夜景的直接链接" title="秦淮河夜景的直接链接">​</a></h2>
<p>到达南京是晚上九点多一些，酒店定在了玄武湖附近，去酒店的途中会路过一些景点，比如夫子庙、秦淮河夜景，便临时改变了注意，原计划在周六晚上的行程改到了今天晚上。不得不说，在城市游玩的话，如果景点有直达的地铁会方便很多，还记得春节时候苏州的地铁不用刷卡直接免费乘坐也为游客省去了不少麻烦。</p>
<p>由于下午没有吃饭，所以选择先去老门东，据说这里的小吃很多。下了地铁后要步行好一会才到了老门东，实际上就是个步行街吧，晚上的人倒是挺多的。进去迅速逛了一圈，本来想找个吃饭的地方，结果发现没有什么好吃的，仅有的几家店人也超级多。随后去了步行街门口的一家店，尝了算是这里的特产的鸭血粉丝汤和一些小吃，其中灌汤包倒是很好吃，整体味道还不错，而且也不算贵。</p>
<p>老门东、夫子庙、秦淮河基本上都在一块，吃过饭后便打算直接步行去秦淮河看夜景了，天气倒也刚刚好，不热不闷，走在大街上还是挺舒服的。</p>
<p>秦淮河的夜景比预期的要差一些，一方面是人比较少，另一方面景区也比较小，也有可能是因为去的太晚了，但整体逛下来比原来想象的那种南京著名景点的感觉还是差不少。夫子庙由于去的太晚了，所以晚上也只能简单的在门口拍个照。不过话说回来，像这种古都文化的城市也许真正有意义的是其历史文化。</p>
<p>夜游行程结束到达酒店已经是晚上十一点多了。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第一天">第一天<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E7%AC%AC%E4%B8%80%E5%A4%A9" class="hash-link" aria-label="第一天的直接链接" title="第一天的直接链接">​</a></h2>
<p>第一天上午的行程计划是玄武湖、鸡鸣寺、总统府，结果因为太劳累，原本打算七点起床的，结果八点才起床，总统府的门票因为提前买的有固定时间，所以吃完早餐后就先去了那里。</p>
<p>打车大概半个多小时的样子到了景点门口，堵车很严重，于是趁停车的时候就赶紧下了车，如果要等到下车点估计至少还得堵个十几分钟。之前看攻略时说总统府的门票一定要提前一天预定，否则当天几乎买不到，果不其然，排队检票的队伍特别长，而且旁边已经提示门票售罄了。</p>
<p>提到“总统”两个字，大家应该很容易想到民国首任“临时大总统”孙中山先生，是的，总统府就是当时孙中山先生及其同事办公的地方，也可以类比为我们当代的国家中央行政单位。</p>
<p>总统府整体还是比较大的，具体的布局已经记不太清了，但是在某处看沙盘时，基本上应有的部门一个都不缺，我们熟知的教育部、工商部等等，这是令我印象比较深刻的。</p>
<p>话说在来之前听说南京博物院很有名，提前七天都约不到的那种，事实也正是如此，不过也有人说当日会放票，可以试试。有意思的是，在总统府内坐着休息的时候突发奇想，想看看能不能预约到南京博物院，没想到点进去后果真下午场有 100 多张票，赶紧下手预约成功。这样，下午的行程也由牛首山更改为南京博物院了。</p>
<p>想到玄武湖和鸡鸣寺时，已经不太想去了，一个是公园，一个就是个简单的寺庙，不同城市类似的地方已经去了很多次了，主要是也是因为时间比较紧张，天气有点炎热，不再想跑来跑去的了，这些景点错过的话倒也不觉得遗憾，如果错过南京博物院那倒是真的一大遗憾。</p>
<p>来之前，因为没有南京博物院的门票，所以计划去完总统府去牛首山的，中山陵预约到了周日早上，所以周六下午倒没有什么事情了，但牛首山据说只有几百米的海拔，山顶只不过有一个很漂亮的建筑，有很多网红来打卡，这倒不是特别令人感兴趣。以前很喜欢爬山，但都是爬那种大山，当然说不定去山顶俯瞰南京倒也是不错的选择。不过，既然预约到了南京博物院，那牛首山则可以不用去啦。</p>
<p>大概中午十二点多的样子，打车来到了南京博物院门口，放眼看去南京博物院的建筑还是挺有文化气息的。此时的天气已经比较热了，走进博物院的那一刻是多么舒服就不用多提了，空调很给力。说到这里，据说陕西省博物馆门票也日常难约，不过两地的文化不同，陕西省博物馆里面大多为青铜器，这里想必也大有不同，但春节时候去苏州博物馆时到挺令人印象深刻的，里面有江南地域的字画、丝绸藏品等等。</p>
<p>南京博物院里面比较大，要真正的看完至少也得一两个小时左右，不过没有预期的惊喜，不像网上说的那么有名，也可能是每个人的见识不同、经历不同，所以感受不一样吧。但是，来过此处此行南京便不再有遗憾了。</p>
<p>没有好好做攻略的后果就是来了南京不知道该吃什么，从博物院出来后肚子已经很饿了，打算吃完饭去看电影，于是找了家电影院附近的饭店，也算是小吃，应该挺有名的。没错，这次也少不了南京特色鸭血粉丝汤，尝起来味道也还不错，食材却没有昨晚的那家分量足，价格却是一样的。</p>
<p>饭后去看了已经上映半个多月，但口碑炸裂的《孤注一掷》，观影下来还不错，是大家关注的话题的诠释，但这个问题一直发生一直解决不了却是最值得令人深思的。</p>
<p>看完电影是旁晚时分，顺便去了不远处的玄武湖。湖上游船的人很多，还在排队，对于做了好几次的船的我来说，提不起游船的兴趣，便在湖边简单的休息了下，旁晚的天气还可以，有些许微风。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="次日">次日<a href="https://wang1212.github.io/2023/08/27/life/tourism/tourism-nanjing#%E6%AC%A1%E6%97%A5" class="hash-link" aria-label="次日的直接链接" title="次日的直接链接">​</a></h2>
<p>在充分休息了一晚之后，也迎来了短暂旅行的最后一天，今天早上起的比较早，为了赶去中山陵，因为据说中山陵耗费的时间比较长，而返程的高铁是下午五点，所以要赶在下午三点之前从中山陵出来。</p>
<p>去中山陵要先坐地铁，下了地铁后需要乘坐小公交专线才能到达中山陵的景点门口。大概早上九点多，开始排队入园。进去之后是一个餐厅，里面有卖喝的、以及糕点，顺路就买了一些糕点，味道确实不错，没有在其它地方尝过，算是一种特产吧。</p>
<p>来的时候还问了当地人，中山陵需要多长时间才能游完，有说慢点需要两个小时左右的，心里便有了数。但实际进去一看，预计一个小时足矣，如果不休息的话。</p>
<p>昨晚看了天气预报，今天似乎有雷阵雨，早晨还专门看了实时天气，显示未来几个小时不会下雨，但出门后看着天色以及吹的微风倒还是挺担心的。幸运的是，直到下午一点钟从中山陵景区往出走时天气依然很好，中途还去了音乐台，但比较令人失望，里面还在维修。</p>
<p>据说中山陵的台阶有 300 多个，象征了当时中国三亿多人民。据介绍，孙中山的遗体便在这后山之中。陵门上写着“天下为公”四个大字，在此处能感受到历史文化及其厚重感。</p>
<p>虽说中山陵里面并不大，但如果要结合导游的解说来真正的理解其包含的历史文化，不是简单的走马观花的话，两个小时倒也不为过。</p>
<p>从音乐台出来后，本打算去美龄宫再看看的，但午饭时间已过，肚子也挺饿的，就直接结束行程了，准备留点时间去商场找个餐厅吃饭顺便好好休息一下。误打误撞去了新街口的商圈，在网上简单的查了一下，发现还有一个美称“中华第一商圈”，开始还不明白，下了地铁就蒙了，地铁出口多达 20 多个，果真中华第一商圈。</p>
<p>找了一家餐厅点完菜等待的时刻，便是南京一行最后的闲暇时光了，两天的时间不长不短，该去的也去了，该看的也看了，最后离开的时候还来了个小小的震撼，倒也不虚此行。</p>
<p>此行南京，又一次说走就走的旅行。</p>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="生活" term="生活"/>
        <category label="旅游" term="旅游"/>
        <category label="南京" term="南京"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[谈谈笔记记录和知识管理工具]]></title>
        <id>https://wang1212.github.io/2023/07/22/tools/notes-app</id>
        <link href="https://wang1212.github.io/2023/07/22/tools/notes-app"/>
        <updated>2023-07-22T23:00:00.000Z</updated>
        <summary type="html"><![CDATA[对于大部分人来说，有一个适合自己需求，同时免费又好用的笔记应用或者知识管理工具是很难得的。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-07-22 23:00:00</em></p>
</blockquote>
<p>不管是在学校还是工作后，记录一直是个很好的习惯，方便积累经验并阶段性进行回顾总结。因此，对于大部分人来说，有一个适合自己需求，同时免费又好用的笔记应用或者知识管理工具是很难得的。</p>
<p>从大学开始就一直在坚持更新博客，期间有相当长一段时间博客几乎没怎么更新过，不过终归还是坚持下来了。随着时间的推移，发现认真写一篇博文耗费的时间成本太高，要么只能在周末抽空，要么就断断续续几天才能写完，这也直接导致坚持更新博客的难度加大。其实这件事情的本质不是对于记录这个行为本身产生了懈怠，而是有很多可以用来记录的小事，但要将其发布成一篇篇博文的代价太大，追求效率就容易在质量上大打折扣，还不如不写。以至于现在每每回过头来看，积攒了大量的待完成的小任务，而整理这些小任务也不是那么容易。</p>
<p>说了这么多，问题的本质在于平时一些小的知识记录缺乏一个比较有效的管理工具应用，因为以前都是直接用 Markdown 编辑器和文件夹进行管理的，为了方便同步，还会用网易有道云笔记这类软件进行记录，但一直觉得不怎么好用。</p>
<p>最开始使用的是 <a href="https://www.typora.io/" target="_blank" rel="noopener noreferrer">typora</a> 的测试版，因为其可以免费使用，后来其正式版发布后收费了就弃用了。有很多人说可以用破解版，我倒觉得没有必要，如此良心的软件，付不起钱就换个免费的吧。后来换了 <a href="https://www.zettlr.com/" target="_blank" rel="noopener noreferrer">Zettlr</a>，用了相当长一段时间，其功能和 UI 交互体验一直觉得很别扭，有时候觉得甚至不如在 VSCode 里面直接写 Markdown 来得方便。后来又改用 <a href="https://github.com/marktext/marktext" target="_blank" rel="noopener noreferrer">MarkText</a>，体验要好很多，不过这个开源项目好像维护的频率很低了。以上都只是 Markdown 文件编辑器，后来就开始慢慢了解一些笔记应用了。</p>
<p>Notable、VNote、Anki 这些简单的笔记应用都了解过，但始终觉得不是自己想要的东西。后来了解到了 <a href="https://joplinapp.org/" target="_blank" rel="noopener noreferrer">Joplin</a>，发现其比较契合自己的需求，简单使用了之后，发现其同步功能使用起来太麻烦，还有一些其它细节上的问题不是很合意，就放弃长期使用了。在这期间，还了解过一个开源的知识管理工具 <a href="https://github.com/zadam/trilium" target="_blank" rel="noopener noreferrer">Trilium Notes</a>，其功能异常强大，但也相当复杂，上手成本太高，一直没怎么有时间去仔细研究，而且也不支持中文，看作者的意思短期内也不打算支持。折腾了一圈后，还是暂时回到 Markdown 编辑器了。</p>
<p>直到近期，在看 ThoughtWorks Technology Radar 时，不经意看到博文里提到了团队知识管理工具，其中简单对比了 <a href="https://obsidian.md/" target="_blank" rel="noopener noreferrer">Obsidian</a> 和 <a href="https://logseq.com/" target="_blank" rel="noopener noreferrer">Logseq</a> 这两个工具，一时间竟引起了我的兴趣。知识图谱这个概念这几年听的比较多，但从没想过个人笔记记录和这个会产生什么关联。在简单的了解了这两款工具应用后，就联想到了 Trilium Notes，不同的是，前两者可能上手成本低一些，用户体验应该也会更好一些。遂打算下载安装试用一下，在简单的试用过后，发现 Logseq 这个应用比较好用，而且也是个开源社区维护的软件，对于一直偏爱于开源软件的我来说最合适不过了。</p>
<p>Obsidian 是一个商业软件，但对个人用户免费，也提供一些收费的增值服务，简单调研过后发现用户群应该也不少，而且口碑也很好，但我倒不怎么喜欢在个人的事情上用一些商业软件。**Obsidian 与 Logseq 有一个很大的不同点在于，前者是以大家熟悉的文件夹形式管理笔记的，但后者却是以块的形式和链接引用的方式来管理笔记，虽然它们都是基于图数据库的。**在一直写博客的过程中遇到过基于文件夹管理的文章，有时候很难做文件夹分类，而 Logseq 这种模式就感觉很适合，尤其是记录平时一些零碎的事情的时候。在使用了一段时间后，也了解了一些其它人使用后的对比体验和总结，<strong>发现像 Logseq 这种基于块的模式，写以前那种具有上下文的完整的一篇文章倒不是那么容易。</strong></p>
<p>最终，在深度使用后，发现 Logseq 可以解决以前零散的知识记录不好管理的问题，博客可以继续坚持更新，博文像是对平时记录的一些知识的一个全方位的总结，更具有意义。另一方面，Logseq 自身的功能以及插件提供的一些功能很方便，例如绘图、任务管理等等，这些都是平时记录东西或者做规划很常用的功能。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考">参考<a href="https://wang1212.github.io/2023/07/22/tools/notes-app#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://www.typora.io/" target="_blank" rel="noopener noreferrer">https://www.typora.io/</a></li>
<li><a href="https://www.zettlr.com/" target="_blank" rel="noopener noreferrer">https://www.zettlr.com/</a></li>
<li><a href="https://github.com/marktext/marktext" target="_blank" rel="noopener noreferrer">https://github.com/marktext/marktext</a></li>
<li><a href="https://joplinapp.org/" target="_blank" rel="noopener noreferrer">https://joplinapp.org/</a></li>
<li><a href="https://obsidian.md/" target="_blank" rel="noopener noreferrer">https://obsidian.md/</a></li>
<li><a href="https://logseq.com/" target="_blank" rel="noopener noreferrer">https://logseq.com/</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="工具" term="工具"/>
        <category label="笔记" term="笔记"/>
        <category label="知识管理" term="知识管理"/>
        <category label="随笔杂谈" term="随笔杂谈"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[通过 Node.js 自定义加载器运行代码]]></title>
        <id>https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader</id>
        <link href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader"/>
        <updated>2023-05-28T23:07:00.000Z</updated>
        <summary type="html"><![CDATA[鉴于 Node.js 的诸多历史遗留原因，目前文件有多种扩展名，在文件引用时很多开发者习惯不写扩展名，这在 ES Modules 代码中需要额外的命令行 flag 才能实现。但在 Node.js v19 的版本发布后，其中 `--experimental-specifier-resolution` 命令行 flag 被删除，为了能继续运行无扩展名的 ES Modules 代码，就需要借助自定义加载器来实现。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-05-28 23:07:00</em></p>
</blockquote>
<p>鉴于 Node.js 的诸多历史遗留原因，目前文件有多种扩展名，在文件引用时很多开发者习惯不写扩展名，这在 ES Modules 代码中需要额外的命令行 flag 才能实现。但在 Node.js v19 的版本发布后，其中 <code>--experimental-specifier-resolution</code> 命令行 flag 被删除，为了能继续运行无扩展名的 ES Modules 代码，就需要借助自定义加载器来实现。</p>
<p>目前，Node.js 文件的扩展名就有数种，比如常见的 <code>.js</code>、<code>.mjs</code>、<code>.cjs</code>、<code>.node</code>，之所以有这些东西存在，是因为了 Node.js 从最初的版本发展到现在，已历经了数个大版本的更新，有很沉重的历史包袱。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="commonjs扩展名不是必须的">CommonJS：扩展名不是必须的<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#commonjs%E6%89%A9%E5%B1%95%E5%90%8D%E4%B8%8D%E6%98%AF%E5%BF%85%E9%A1%BB%E7%9A%84" class="hash-link" aria-label="CommonJS：扩展名不是必须的的直接链接" title="CommonJS：扩展名不是必须的的直接链接">​</a></h3>
<p>相信很多使用 Node.js 的开发者目前熟悉的应该是 CommonJS 风格，其中<strong>不需要强制在代码中写文件的扩展名</strong>，这实际上和其它后端语言体验一致。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./foo.js'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// work!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./foo'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// work too!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="es-modules扩展名是必须的">ES Modules：扩展名是必须的<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#es-modules%E6%89%A9%E5%B1%95%E5%90%8D%E6%98%AF%E5%BF%85%E9%A1%BB%E7%9A%84" class="hash-link" aria-label="ES Modules：扩展名是必须的的直接链接" title="ES Modules：扩展名是必须的的直接链接">​</a></h3>
<p>在现如今 Node.js 已全面支持 ES Modules 的情况下，<strong>使用 ES Modules 编写代码默认必须写文件的扩展名</strong>，据官方文档说明，这与浏览器环境下的 <code>import</code> 行为一致。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#393A34">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#00009f">as</span><span class="token imports"> foo</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./foo.js'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// work!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#393A34">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#00009f">as</span><span class="token imports"> foo</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./foo'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// error, not work!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="--experimental-specifier-resolutionnode"><code>--experimental-specifier-resolution=node</code><a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#--experimental-specifier-resolutionnode" class="hash-link" aria-label="--experimental-specifier-resolutionnode的直接链接" title="--experimental-specifier-resolutionnode的直接链接">​</a></h3>
<p>为了实现用 ES Modules 编写代码，又不需要写文件扩展名，Node.js 在很久以前就给出了一个命令行的 flag 来应对这类问题。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ node --experimental-specifier-resolution=node index.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不过，近期在使用 Node.js v20 版本时，突然发现该 flag 失效了，导致写的没有扩展名的 ES Modules 代码无法运行。遂开始查阅官方文档，发现在 v18 的文档中该 flag 还可以索引，v20 的文档中已经无法索引了，在后续查阅资料的过程中终于从 <a href="https://nodejs.org/en/blog/announcements/v19-release-announce#custom-esm-resolution-adjustments" target="_blank" rel="noopener noreferrer">Node.js 的 v19 发布公告</a>中发现了问题。</p>
<blockquote>
<p>Node.js has removed the --experimental-specifier-resolution flag. Its functionality can now be achieved via custom loaders.</p>
</blockquote>
<p>Node.js v18 将是最后一个可以使用 <code>--experimental-specifier-resolution</code> 命令行 flag 的大版本。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="自定义加载器">自定义加载器<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A0%E8%BD%BD%E5%99%A8" class="hash-link" aria-label="自定义加载器的直接链接" title="自定义加载器的直接链接">​</a></h3>
<p>相信这一变化给很多人造成了困扰，对于我也是。官方给的方案是<strong>自定义加载器</strong>，但没有具体的文档说明，只能在 <a href="https://github.com/nodejs/node/pull/44859" target="_blank" rel="noopener noreferrer">v19 发布公告中提及的 Github Issue</a> 中寻得蛛丝马迹。</p>
<p>最终，为了解决这个问题，需要安装一个官方提供的<a href="https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader" target="_blank" rel="noopener noreferrer">自定义加载器包</a>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ npm i commonjs-extension-resolution-loader</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后改变运行文件的命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 以前</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ node --experimental-specifier-resolution=node index.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 现在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ node --experimental-loader=commonjs-extension-resolution-loader index.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但需要注意的是，使用该自定义加载器运行代码，如果遇到第三方包是 ES Modules，且没有指定 <code>package.json</code> 文件中的 <code>main</code> 字段将会出现找不到模块的错误。这是因为 CommonJS 规范模块解析依赖 <code>main</code> 字段，而 ES Modules 规范则推荐使用 <code>exports</code> 字段指定模块入口文件，详见<a href="https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points" target="_blank" rel="noopener noreferrer">官方文档</a>。</p>
<p>鉴于以上情况，如果是新项目，而且采用 ES Modules 编写代码，那还是带上文件扩展名遵循其规范比较好，放弃采用 flag 以及自定义加载器的方式运行代码，毕竟会带来一些额外的问题。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/2023/05/28/computer-technology/nodejs/nodejs-loader#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h3>
<ul>
<li><a href="https://nodejs.org/en/blog/announcements/v19-release-announce" target="_blank" rel="noopener noreferrer">https://nodejs.org/en/blog/announcements/v19-release-announce</a></li>
<li><a href="https://nodejs.org/docs/latest-v18.x/api/cli.html#--experimental-specifier-resolutionmode" target="_blank" rel="noopener noreferrer">https://nodejs.org/docs/latest-v18.x/api/cli.html#--experimental-specifier-resolutionmode</a></li>
<li><a href="https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader" target="_blank" rel="noopener noreferrer">https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader</a></li>
<li><a href="https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points" target="_blank" rel="noopener noreferrer">https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Node.js" term="Node.js"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[WebGPU – Web 平台的通用计算 API]]></title>
        <id>https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu</id>
        <link href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu"/>
        <updated>2023-05-14T15:42:00.000Z</updated>
        <summary type="html"><![CDATA[随着 Chrome v113 的发布，WebGPU API 已正式可用，预计其它平台也将很快发布正式支持，WebGPU 为 Web 平台现代 3D 图形化开发提供了一流的支持，不过相比于在 3D 图形开发领域的发展，其还有一个更值得关注的目标，即为 Web 平台带来通用计算 API 的一流支持。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-05-14 15:42:00</em></p>
</blockquote>
<p>随着 Chrome v113 的发布，WebGPU API 已正式可用，预计其它平台也将很快发布正式支持，WebGPU 为 Web 平台现代 3D 图形开发提供了一流的支持，不过相比于在 3D 图形开发领域的发展，其还有一个更值得关注的目标，即为 Web 平台带来通用计算 API 的一流支持。</p>
<p><img loading="lazy" alt="chrome113" src="data:image/webp;base64,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" width="750" height="374" class="img_ev3q"></p>
<p>在 <a href="https://developer.chrome.com/blog/new-in-chrome-113/#webgpu" target="_blank" rel="noopener noreferrer">Chrome 113 的发布日志页面</a>，Chrome 团队列举了个几个主流的工具库对 WebGPU 的支持情况，例如 Babylon.js、PlayCanvas、TensorFlow.js、Three.js。其中，有三个是大家比较熟悉的 Web 3D 图形开发绘图引擎/框架工具，而 TensorFlow.js 则与 3D 图形开发无关，是 Google 发布的机器学习框架工具。</p>
<p>很多人认为 WebGPU 将替代 WebGL，长期来看这应该是一个必然的结果，但短期内 WebGL 可能仍将是主流方案，不过这些观点都仅针对 Web 3D 图形开发领域。接下来先来看看官方是如何定义这两者的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="webgl-与-webgpu-的官方定义">WebGL 与 WebGPU 的官方定义<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#webgl-%E4%B8%8E-webgpu-%E7%9A%84%E5%AE%98%E6%96%B9%E5%AE%9A%E4%B9%89" class="hash-link" aria-label="WebGL 与 WebGPU 的官方定义的直接链接" title="WebGL 与 WebGPU 的官方定义的直接链接">​</a></h2>
<p><img loading="lazy" alt="webgl" src="https://wang1212.github.io/assets/images/webgl-15ac431db41a5a81672fdfefe401996c.webp" width="1638" height="395" class="img_ev3q"></p>
<p>以上截图来自于 WebGL 标准的维护组织 <a href="https://www.khronos.org/webgl/" target="_blank" rel="noopener noreferrer">Khronos Group 的官方网站</a>，可以明确的看出 WebGL 标准的制定目标是为 Web 平台提供 3D 图形开发 API 支持。</p>
<p><img loading="lazy" alt="webgpu" src="https://wang1212.github.io/assets/images/webgpu-435b657e52daa6b7ff00b64506ec5e3a.webp" width="1288" height="182" class="img_ev3q"></p>
<p>另外，以上截图来自于 WebGPU 标准的制定组织 <a href="https://www.w3.org/TR/webgpu/" target="_blank" rel="noopener noreferrer">W3C 标准文件</a>，可以从上图的描述看出 WebGPU 的目标至少包含 <strong>3D 图形开发</strong>和<strong>计算</strong>两个领域。所以，WebGPU 的出现并不是纯粹的为了替代 WebGL，还为 Web 平台带来了更多可能性，比如通用计算领域。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="webgl-与-webgpu-的技术架构">WebGL 与 WebGPU 的技术架构<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#webgl-%E4%B8%8E-webgpu-%E7%9A%84%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84" class="hash-link" aria-label="WebGL 与 WebGPU 的技术架构的直接链接" title="WebGL 与 WebGPU 的技术架构的直接链接">​</a></h2>
<p>在讨论 WebGPU 的通用计算 API 之前先来简单了解一下其与 WebGL 的技术架构有何不同。</p>
<p><img loading="lazy" alt="technology-architecture-webgl" src="https://wang1212.github.io/assets/images/technology-architecture-webgl-3fa7e936ec40dddc526b68b9779688c6.webp" width="860" height="485" class="img_ev3q"></p>
<p>WebGL 程序由使用 JavaScript 编写的控制代码和使用 OpenGL ES 着色语言(G​​LSL ES)（一种似于 C 或 C++ 的语言）编写的着色器代码组合，并在计算中机器的图形处理元(GPU)上行。WebGL 是基于 OpenGL ES 标准针对 Web 平台的一个实现，而同时期与 OpenGL（ES）对等的是微软 Win 平台的 DirectX 11。</p>
<p><img loading="lazy" alt="technology-architecture-webgl-1" src="https://wang1212.github.io/assets/images/technology-architecture-webgl-1-ad44ae270abc59d0599ac36e2e814db5.webp" width="1266" height="465" class="img_ev3q"></p>
<p>随着硬件技术的发展，OpenGL 标准也在持续发展，至今最新的版本则是 4.x，而 WebGL 标准的发展则相对缓慢，直至去年（2022）初 Khronos Group 才宣布 WebGL 2.0 在所有的主流 Web 平台得到支持，其基于 OpenGL ES 3.0 标准制定。也就是说，距离 OpenGL ES 4.0 标准的 WebGL 标准还很遥远，可见 Web 平台即便是基于 WebGL 2.0 的实现也无法充分利用现代 GPU 的能力，这也许就是 WebGPU 出现的一个重要因素。</p>
<p><img loading="lazy" alt="technology-architecture-webgpu" src="https://wang1212.github.io/assets/images/technology-architecture-webgpu-699420c9d7c89839beb1eb5c2ce17476.webp" width="1078" height="422" class="img_ev3q"></p>
<p>与 WebGL 不同，WebGPU 不是任何现有的原生 API 的直接接口。它基于 Vulkan、Metal 和 Direct3D 12 提供的 API，旨在跨移动和桌面平台提供高性能。而且，WebGPU 使用 WGSL（一种类 Rust 的语言）着色语言编写着色器代码。</p>
<p>值得一提的是，在过去的一段时间里，随着 Apple 平台发布 Metal，OpenGL ES 在 Apple 平台逐渐被放弃，与此同时 Win 平台的 DirectX 12 发布也预示着 OpenGL 标准已经落后于现代图形开发领域的发展。面对这种情况，Khronos Group 也迅速推出了现代跨平台的图形开发标准 Vulkan。至此，Metal、DirectX 12、Vulkan 成为了更低级的、更接近现代 GPU 架构实现的图形开发标准，而 WebGPU 标准则基于这三者。</p>
<p><img loading="lazy" alt="technology-architecture" src="https://wang1212.github.io/assets/images/technology-architecture-587e6248d241bd7b48a4e3f001eedba9.webp" width="1240" height="635" class="img_ev3q"></p>
<p>下一代图形 API 是对 GPU 更低级别的抽象，也是更接近现在 GPU 架构的实现，对 GPU 有更高的控制权限和灵活性，同样的使用成本变高，但性能收益更高。</p>
<p>此外，通过 WebGL 和 WebGPU 各自所使用的着色器语言代码也可以明显感受到后者更加低级，基本上是对 GPU 内存的直接操作，所以拥有更高的性能符合我们的认知。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="web-平台的通用计算">Web 平台的通用计算<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#web-%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%80%9A%E7%94%A8%E8%AE%A1%E7%AE%97" class="hash-link" aria-label="Web 平台的通用计算的直接链接" title="Web 平台的通用计算的直接链接">​</a></h2>
<p>接下来便是本文关注的核心，即 WebGPU 为 Web 平台带来的通用计算领域的应用场景。通用图形处理单元（GPGPU）在 Web 平台还是一个略微陌生的概念，但在云计算等其它领域已是一个被大家所熟知的概念。</p>
<p>实际上，目前在 Web 平台也有一些大数据计算场景的应用，例如机器学习的离线支持，代表性工具就是文中刚开始提到的 TensorFlow.js。鉴于 Web 平台 JavaScript 单线程模型的限制，在 Web 客户端做大数据计算的性能限制很大，不过如果能利用现代 GPU 的数据计算能力，则可以解决此类问题。</p>
<p><img loading="lazy" alt="gpgpu" src="https://wang1212.github.io/assets/images/gpgpu-1ca12d5db3ed230317199a279c5f83e2.webp" width="1368" height="509" class="img_ev3q"></p>
<p>长期以来 Web 平台利用 GPU 能力的途径只有 WebGL API，也就是 3D 图形开发领域，如上图所示左侧的渲染管道，CPU 承担了相当多的计算任务，而 GPU 则解决的是绘图相关的任务。另一方面，在 GPGPU 技术中，CPU 仅承担一些必要的计算任务，GPU 可以单独完成一些纯计算类的任务，如上图右侧所示。</p>
<p>WebGPU 的出现为 Web 平台 GPGPU 提供了一流的支持，但在这之前，WebGL 时代也有相应的尝试。</p>
<p><img loading="lazy" alt="gpgpu-1" src="https://wang1212.github.io/assets/images/gpgpu-1-2e17ab31626c1c765b10b738d4d902e5.webp" width="1155" height="582" class="img_ev3q"></p>
<p>如上图所示，虽然 WebGL API 是用来绘图的，但可以将数据计算任务转换为绘图指令，得到绘制的结果后，再从像素数据转换为数据结果。通过一种间接的方式，也能基于 WebGL 为 Web 平台提供 GPGPU 技术的支持，但这种方式的问题在于将数据计算任务转换为绘图指令的过程是极其繁琐的。</p>
<p>接下来，来了解一下一个开源工具库 <a href="https://turbo.js.org/" target="_blank" rel="noopener noreferrer">turbo.js</a>，其就是做了上面所描述的事情，针对以上过程进行封装抽象降低了开发者的使用成本。</p>
<p><img loading="lazy" alt="turbojs" src="https://wang1212.github.io/assets/images/turbojs-2089428e42d07e42062677247acc2449.webp" width="1232" height="461" class="img_ev3q"></p>
<p>其官方展示了一个针对访问者机器的性能基准测试的结果，可见利用 GPU 完成计算任务相比于 CPU 的性能高出数倍。来看看如何使用：</p>
<p><img loading="lazy" alt="turbojs-1" src="https://wang1212.github.io/assets/images/turbojs-1-7d80ac1130f5019f711d0c888c78f1e6.webp" width="517" height="563" class="img_ev3q"></p>
<p>从给出的示例代码来看，本质上开发者需要将计算逻辑的代码转换为着色器代码，因为着色器程序是 GPU 硬件的可编程入口。再来看看其源码实现，验证下是否与上述描述一致。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/turbo/js/blob/master/turbo.js#L117</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">ipt</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fragmentShader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FRAGMENT_SHADER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">shaderSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fragmentShader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdlib </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">compileShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fragmentShader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> program </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createProgram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">attachShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vertexShader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">attachShader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fragmentShader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">linkProgram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readPixels</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RGBA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FLOAT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ipt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//                                 ^ 4 x 32 bit ^</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> ipt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">subarray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ipt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是截取的一段 <code>run()</code> 的实现代码，可以比较清晰的看到是先利用数据进行图形绘制，然后再从绘制结果的像素数据中进行结果读取，符合之前所描述的实现思路。该工具库目前已经不再维护，还有另一个工具库 <a href="https://gpu.rocks/" target="_blank" rel="noopener noreferrer">GPU.js</a> 也值得参考。</p>
<p>虽然通过 WebGL API 也能实现 GPGPU 技术，但过程繁琐，还有一定的性能损失，而 WebGPU 为 GPGPU 技术提供了一流的支持。</p>
<div class="language-wgsl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-wgsl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Define global buffer size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const BUFFER_SIZE = 1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const shader = `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@group(0) @binding(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var&lt;storage, read_write&gt; output: array&lt;f32&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@compute @workgroup_size(64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @builtin(global_invocation_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  global_id : vec3u,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @builtin(local_invocation_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  local_id : vec3u,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Avoid accessing the buffer out of bounds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (global_id.x &gt;= ${BUFFER_SIZE}) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output[global_id.x] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f32(global_id.x) * 1000. + f32(local_id.x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码截取自 <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API#basic_compute_pipeline" target="_blank" rel="noopener noreferrer">MDN 文档</a>，可以看到通过 <code>@compute</code> 代码关键字表明了计算任务的处理能力是 WebGPU API 官方支持的，而其对应的绘图相关的代码关键字则为 <code>@vertex</code>、<code>@fragment</code>，这其实对应了不同类型的着色器，也即 GPU 流水线架构设计中的不同阶段。</p>
<p><img loading="lazy" alt="gpgpu-webgl" src="https://wang1212.github.io/assets/images/gpgpu-webgl-9d87296f1ecfcfb4cf93333a323b503c.webp" width="1356" height="637" class="img_ev3q"></p>
<p><img loading="lazy" alt="gpgpu-webgpu" src="https://wang1212.github.io/assets/images/gpgpu-webgpu-a1a9d3c699924991e6bc055e82cceea1.webp" width="1344" height="630" class="img_ev3q"></p>
<p>以上两图来自 Chrome 开发者官方博客，概述了基于 WebGL 和 WebGPU 两种方案实现的 GPGPU 技术在机器学习领域的应用差异，很明显后者灵活性和可控性更高，也具备性能优势。</p>
<p>说句题外话，在 Web 平台上提高数据计算性能的方案不止有 GPGPU，还有 WebAssembly SIMD 技术，但后者对前端开发者的能力要求偏高，上手起来不是很容易，相比较来说，WebGPU API 的方案门槛更低一些。</p>
<p><img loading="lazy" alt="simd" src="https://wang1212.github.io/assets/images/simd-67c78419670f4089c9166c327c80c6d3.webp" width="720" height="499" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/web-frontend/api/webgpu-gpgpu#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://developer.chrome.com/blog/new-in-chrome-113" target="_blank" rel="noopener noreferrer">https://developer.chrome.com/blog/new-in-chrome-113</a></li>
<li><a href="https://en.wikipedia.org/wiki/WebGL" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/WebGL</a></li>
<li><a href="https://www.khronos.org/webgl/" target="_blank" rel="noopener noreferrer">https://www.khronos.org/webgl/</a></li>
<li><a href="https://en.wikipedia.org/wiki/WebGPU" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/WebGPU</a></li>
<li><a href="https://www.w3.org/TR/webgpu/" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/webgpu/</a></li>
<li><a href="https://en.wikipedia.org/wiki/OpenGL_ES" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/OpenGL_ES</a></li>
<li><a href="https://en.wikipedia.org/wiki/WebGL" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/WebGL</a></li>
<li><a href="https://blog.devgenius.io/will-webgpu-be-the-webgl-killer-60a49509b806" target="_blank" rel="noopener noreferrer">https://blog.devgenius.io/will-webgpu-be-the-webgl-killer-60a49509b806</a></li>
<li><a href="https://forum.babylonjs.com/t/i-have-an-important-question-about-webgpu/36896" target="_blank" rel="noopener noreferrer">https://forum.babylonjs.com/t/i-have-an-important-question-about-webgpu/36896</a></li>
<li><a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-from-webgl.html" target="_blank" rel="noopener noreferrer">https://webgpufundamentals.org/webgpu/lessons/webgpu-from-webgl.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units</a></li>
<li><a href="https://turbo.js.org/" target="_blank" rel="noopener noreferrer">https://turbo.js.org/</a></li>
<li><a href="https://gpu.rocks/" target="_blank" rel="noopener noreferrer">https://gpu.rocks/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API#basic_compute_pipeline" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API#basic_compute_pipeline</a></li>
<li><a href="https://developer.chrome.com/blog/webgpu-io2023/" target="_blank" rel="noopener noreferrer">https://developer.chrome.com/blog/webgpu-io2023/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Single_instruction,_multiple_data</a></li>
<li><a href="https://v8.dev/features/simd" target="_blank" rel="noopener noreferrer">https://v8.dev/features/simd</a></li>
<li><a href="https://codelabs.developers.google.com/your-first-webgpu-app" target="_blank" rel="noopener noreferrer">https://codelabs.developers.google.com/your-first-webgpu-app</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Web" term="Web"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="WebGPU" term="WebGPU"/>
        <category label="3D" term="3D"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[3D 开发：正向渲染与延迟渲染]]></title>
        <id>https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering</id>
        <link href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering"/>
        <updated>2023-03-18T14:30:00.000Z</updated>
        <summary type="html"><![CDATA[相对于 2D 开发，3D 开发由于有大量的概念需要进行学习了解因此门槛较高，近期刚好针对 3D 图形渲染技术中的两种常见技术正向渲染和延迟渲染进行了简单的了解，在此做个简单的记录，另外通过了解这些概念的同时也对光照相关的知识有了更深入的了解。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-03-18 14:30:00</em></p>
</blockquote>
<p>相对于 2D 开发，3D 开发由于有大量的概念需要进行学习了解因此门槛较高，近期刚好针对 3D 图形渲染技术中的两种常见技术正向渲染和延迟渲染进行了简单的了解，在此做个简单的记录，另外通过了解这些概念的同时也对光照相关的知识有了更深入的了解。</p>
<p>在此之前，虽然已经进行了相当多的开发实践，但由于场景受限，一直对于 3D 开发中的光照技术应用的偏少，不过恰好近期在学习了解性能相关的知识，在了解到渲染这方面的知识概念时，才意识到光照在 3D 开发中的是一个非常重要的技术。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="渲染管线">渲染管线<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF" class="hash-link" aria-label="渲染管线的直接链接" title="渲染管线的直接链接">​</a></h2>
<p>无论是做普通的前端业务开发，还是数据可视化开发，了解程序性能瓶颈的一个关键方面是知道<strong>程序代码到 UI 视觉效果是如何实现（映射）的</strong>，也即<strong>渲染管线（Rendering Pipeline）</strong>。</p>
<p><img loading="lazy" alt="graphics-pipeline-0" src="data:image/jpeg;base64,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" width="825" height="144" class="img_ev3q"></p>
<p>上图概括了 3D 开发渲染管线的大体流程，即：应用程序、几何图形和光栅化。简单来说，应用程序的代码是一系列绘图逻辑的高度抽象，而这些逻辑代码被编译为底层的几何图元绘制指令，经过一系列运算后交给图形处理器完成光栅化，最终呈现在终端显示器上，具体内容参考<a href="https://en.wikipedia.org/wiki/Graphics_pipeline" target="_blank" rel="noopener noreferrer">维基百科</a>等资料即可，这里不做赘述。</p>
<p>接下来主要是要了解一些常用概念，目的是对后续两种不同渲染技术进行分析说明时更容易理解。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="着色器">着色器<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E7%9D%80%E8%89%B2%E5%99%A8" class="hash-link" aria-label="着色器的直接链接" title="着色器的直接链接">​</a></h3>
<p>这里首先需要了解的便是着色器的概念，在计算机图形学中，<strong>着色器是一种计算机程序</strong>，负责在 3D 场景渲染过程中计算适当的亮度、暗度和颜色级别，这个过程也被称之为着色。</p>
<p>在探讨 3D 开发中的渲染管线时，一定要结合软硬件来思考，换句话说，图形处理器（GPU）被设计为流水线架构，分成多个阶段，其中某些阶段由底层硬件暴露给上层软件可编程接口，着色器则为这些可编程的阶段提供了运行的程序。所以，可灵活编程的着色器程序，为 3D 开发提供了强大的图形处理能力。</p>
<p><img loading="lazy" alt="graphics-pipeline-1" src="https://wang1212.github.io/assets/images/graphics-pipeline-1-0d9bc622037e675f36f6f41cae4320af.webp" width="1500" height="338" class="img_ev3q"></p>
<p>上图是图形处理器的流水线架构设计的一个大体示意图，也可看作是渲染管线的硬件实现，其中绿色部分是可编程的阶段，而各种不同阶段的程序对应不同类型的着色器。</p>
<p>其中，顶点着色器（Vertex shaders）是最成熟和最常见的 3D 着色器类型，并且为提供给图形处理器的每个顶点运行一次。目的是将每个顶点在虚拟空间中的 3D 位置转换为它出现在屏幕上的 2D 坐标（以及 Z 缓冲区的深度值）。顶点着色器可以操纵位置、颜色和纹理坐标等属性，但不能创建新的顶点。</p>
<p>几何着色器（Geometry shaders）程序在顶点着色器之后执行。它们将整个原语作为输入，可能带有邻接信息。例如，在三角形上操作时，三个顶点是几何着色器的输入。然后着色器可以输出零个或多个图元，这些图元被光栅化并且它们的片段最终传递给像素着色器。</p>
<p>来自光栅化阶段的每个片段的数据由片段着色器（像素着色器，Pixel shaders）处理。片段着色器的输出是每个要写入的颜色缓冲区的颜色列表、深度值和模板值。片段着色器无法为片段设置模板数据，但它们可以控制颜色和深度值。</p>
<p>以上三类常见着色器中片段着色器是着色器编程中接触最多的，也算是最核心的。</p>
<p>最后，给出一张 Vulkan （新一代现代图形卡抽象设计 API）文档中对于渲染管线的示意图，相信这幅图能以更直观的方式帮助我们理解渲染管线。</p>
<p><img loading="lazy" alt="graphics-pipeline-2" src="https://wang1212.github.io/assets/images/graphics-pipeline-2-5beeac64796c5b122aed507361479500.webp" width="403" height="643" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="渲染技术">渲染技术<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E6%B8%B2%E6%9F%93%E6%8A%80%E6%9C%AF" class="hash-link" aria-label="渲染技术的直接链接" title="渲染技术的直接链接">​</a></h2>
<p>在对前置概念渲染管线做了简单的了解之后，接下来便是本文的核心内容，两种不同的渲染技术。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="正向渲染">正向渲染<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E6%AD%A3%E5%90%91%E6%B8%B2%E6%9F%93" class="hash-link" aria-label="正向渲染的直接链接" title="正向渲染的直接链接">​</a></h3>
<p>正（前）向渲染（Forward Rendering）又称正向着色，是大多数 3D 渲染引擎的默认渲染技术实现。</p>
<p>**这是一种直接的方式，渲染一个对象并用场景中所有的光源照亮它。如果场景中有大量的对象，则为场景中的每个对象分别执行此操作。**这句话总结了正向渲染技术的实现思路和技术原理，其非常符合我们人类思考的方式。</p>
<p>虽然很容易理解和实现，但它对性能的影响也很大，因为每个渲染对象都必须为每个渲染片段迭代每个光源，由于片段着色器输出被覆盖，正向渲染也往往会在深度复杂度高的场景（多个对象覆盖同一屏幕像素）中浪费大量片段着色器运行结果，导致大量的无效渲染。</p>
<p><img loading="lazy" alt="forward-rendering" src="https://wang1212.github.io/assets/images/forward-rendering-28604d660822eb1b075e009404a38ca7.webp" width="600" height="400" class="img_ev3q"></p>
<p>在上图中，每个几何图形被一次一个传递给渲染管线，经过顶点着色器、几何着色器、片段着色器等多个阶段后最终渲染到渲染目标（显示器），这也正是正向渲染技术处理渲染对象的流程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="延迟渲染">延迟渲染<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93" class="hash-link" aria-label="延迟渲染的直接链接" title="延迟渲染的直接链接">​</a></h3>
<p>延迟渲染（Deferred Rendering）技术似乎并不常见，但被市面上大多数 3D 渲染引擎所支持。</p>
<p><img loading="lazy" alt="deferred-rendering" src="https://wang1212.github.io/assets/images/deferred-rendering-fc3a7552fc4454b0bd5aa8b543313756.webp" width="640" height="353" class="img_ev3q"></p>
<p>上图是一个有大量动态光源的场景，而这也正是延迟渲染技术的典型应用场景。<strong>延迟渲染（着色）基于这样的想法，即我们将大部分繁重的渲染（如照明）推迟或推迟到后期。</strong></p>
<p>延迟着色由两个过程组成：在第一个过程中，称为几何通道，我们渲染一次场景并从我们存储在纹理集合中的对象中检索各种几何信息，称为 G 缓冲区; 考虑位置向量、颜色向量、法线向量和/或镜面反射值。场景的几何信息存储在 G 缓冲区然后用于（更复杂的）光照计算；我们在称为照明通道的第二个通道中使用 G 缓冲区中的纹理，在该通道中我们渲染一个屏幕填充的四边形，并使用存储在 G 缓冲区中的几何信息计算每个片段的场景照明；我们逐个像素地迭代 G 缓冲区。我们不是将每个对象从顶点着色器一直迭代到片段着色器，而是将其高级片段处理分离到后面的阶段。光照计算完全相同，但这次我们从相应的 G 缓冲区纹理中获取所有必需的输入变量，而不是顶点着色器（加上一些统一变量）。</p>
<p><img loading="lazy" alt="deferred-rendering-1" src="https://wang1212.github.io/assets/images/deferred-rendering-1-f33344303d90f0eface11d3ef5838965.webp" width="600" height="400" class="img_ev3q"></p>
<p>所以，延迟渲染很关键的一点是将光照计算这种非常耗性能的流程推迟到后期统一完成，避免了正向渲染技术中产生的大量无效渲染。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="特点对比">特点对比<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E7%89%B9%E7%82%B9%E5%AF%B9%E6%AF%94" class="hash-link" aria-label="特点对比的直接链接" title="特点对比的直接链接">​</a></h3>
<p>目前，大部分的 3D 渲染引擎默认采用就是正向渲染技术，例如 Three.js、Babylon.js、Unity 3D；将延迟渲染技术作为默认方案的很少，例如 Unreal Engine 4。另一方面，Three.js 也<a href="https://threejs.org/docs/#api/en/renderers/WebGLMultipleRenderTargets" target="_blank" rel="noopener noreferrer">支持延迟渲染技术</a>，而 Unity 3D 支持的渲染技术<a href="https://docs.unity3d.com/Manual/RenderingPaths.html" target="_blank" rel="noopener noreferrer">更多</a>，Unreal Engine 4 也提供了<a href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/ForwardRenderer/" target="_blank" rel="noopener noreferrer">正向渲染的支持</a>。</p>
<p>正向渲染容易理解，实现成本低，灵活度高，可以很好的处理透明度、Z 缓冲区、抗锯齿等场景；但在多光源的场景下，光照计算对性能影响很大，会导致大量的无效渲染，在简单场景下可以考虑用光照贴图替代真实光源。用类似大 O 表示法来表示正向渲染技术的渲染复杂度：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">正向渲染复杂度：O(num_geometry_fragments * num_lights)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>相对来说，延迟渲染实现成本较高，对着色器的支持有限，适合应用在大量动态光的场景，会极大的提升渲染性能，但需要支持多个渲染目标的显卡，高带宽以支持大量的缓冲区传输，内存消耗高，默认不支持透明度、抗锯齿等，不过业内有相应的解决方案。那么，延迟渲染技术的渲染复杂度则可表示为：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">延迟渲染复杂度：O(screen_resolution * num_lights)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对比两者的渲染复杂度，具体选用哪种渲染技术，取决于场景中的光源数量以及几何图形的量级等因素。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/3d/forward-rendering-and-deferred-rendering#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Graphics_pipeline" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Graphics_pipeline</a></li>
<li><a href="https://www.khronos.org/opengl/wiki/Shader" target="_blank" rel="noopener noreferrer">https://www.khronos.org/opengl/wiki/Shader</a></li>
<li><a href="https://en.wikipedia.org/wiki/Shader#Pixel_shaders" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Shader#Pixel_shaders</a></li>
<li><a href="https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Introduction" target="_blank" rel="noopener noreferrer">https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Introduction</a></li>
<li><a href="https://gamedevelopment.tutsplus.com/articles/forward-rendering-vs-deferred-rendering--gamedev-12342" target="_blank" rel="noopener noreferrer">https://gamedevelopment.tutsplus.com/articles/forward-rendering-vs-deferred-rendering--gamedev-12342</a></li>
<li><a href="https://learnopengl.com/Advanced-Lighting/Deferred-Shading" target="_blank" rel="noopener noreferrer">https://learnopengl.com/Advanced-Lighting/Deferred-Shading</a></li>
<li><a href="https://www.klab.com/jp/blog/tech/2021/unitydeferredrendering.html" target="_blank" rel="noopener noreferrer">https://www.klab.com/jp/blog/tech/2021/unitydeferredrendering.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/Deferred_shading" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Deferred_shading</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Web" term="Web"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="3D" term="3D"/>
        <category label="WebGL" term="WebGL"/>
        <category label="Three.js" term="Three.js"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[黄山之行]]></title>
        <id>https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan</id>
        <link href="https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan"/>
        <updated>2023-03-12T15:43:00.000Z</updated>
        <summary type="html"><![CDATA[终于有机会一览黄山的风采，也算是疫情三年以来第一次游览一座名山，顺便也去了宏村，领略徽式建筑的风采。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-03-12 15:43:00</em></p>
</blockquote>
<p><u>2023-03-04</u>
<br>
<br></p>
<p>终于有机会一览黄山的风采，也算是疫情三年以来第一次游览一座名山，顺便也去了宏村，领略徽式建筑的风采。</p>
<p>由于这两年工作比较忙，对于旅行来说少了一些提前的准备和计划，最近两次的出游基本都是“说走就走”。自从去年底杭州西站开始运营以来，当时看到的从杭州西直达黄山北的宣传语一直在心中念念不忘，刚好春节后工作还稍微轻松一些，就便有了周末去黄山游玩一番的想法。</p>
<p>提前两三天买了高铁票，订了酒店，便期待着周五的到来。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="看黄山">看黄山<a href="https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan#%E7%9C%8B%E9%BB%84%E5%B1%B1" class="hash-link" aria-label="看黄山的直接链接" title="看黄山的直接链接">​</a></h2>
<p>通过与身边去过黄山的朋友了解，一般黄山一日游建议是前一天的晚上住在山脚下，否则第二天时间不太够，所以我的计划也是如此。周五五点半下了班，回房间收拾好东西，简单吃过晚饭，便直奔杭州西站。</p>
<p>杭州西站由于去年底才开始运营，目前客运量相比于杭州东要少得多，所以对于初次进入杭州西站的我来说，现代化的设计风格与空旷的站内给人也多少有些震撼。</p>
<p>晚上八点多钟的高铁，到达黄山北就已经晚上十点多了，好的是酒店老板提前一天联系了包车，才得以没在黄山北站逗留太长时间，十一点钟多一点就到了酒店，洗漱过后便早早的休息了。酒店大堂还有人在专门讲解黄山的游览路线，并推荐了多条路线还赠送了一张大地图。而且，第二天早上，酒店隔壁就是早餐店，大概七点半的样子酒店还会有车免费送到黄山风景区南大门的换乘中心。</p>
<p>记得上一次周内上完班直接去爬山还是华山，那一次是周五下班直奔华山，傍晚直接开始夜爬，凌晨看了日出，第二天中午就下山了。年轻的时候还是好，不过那个时候工作也没有现在这么忙。</p>
<p>这两天的天气还不错，刚好入春，气温开始上升，黄山也是大晴天，并没有想象中的冷。</p>
<p>第二天匆忙吃了早饭后，坐车到达黄山风景区的南大门换乘点时已经接近八点钟了，排队的人还是挺多的。黄山不愧是一座名山，平时淡季的游客也是相当多，当然也可能是疫情放开后的报复性旅游吧？</p>
<p>选择的路线是从后山的云谷索道上，下午再从前山的玉屏索道下，最后一站便是著名的迎客松。</p>
<p>以前爬山，华山和峨眉山是真的徒步上山再徒步下山，现在基本都是坐索道了，主要还是很多山要徒步上下的太耗费时间了，一天时间可能不太够，而且山顶的住宿条件很差还费用很高。</p>
<p>下了云谷索道后，便是今天开始爬山的旅程了。八点多钟时，计划中午十二点左右到达光明顶，下午的下山索道才赶得上。由于是大晴天，看不到云海，所以对于很多人来说，是略有遗憾的，但这也是没有办法的事情，毕竟雨过天晴的机会难得。如果山爬的多了，会发现景色都差不多，重要的是爬山的这个过程。</p>
<p>从后山上来后的爬山路比较平缓，是一个比较轻松的路线，反而从前山上来的话爬山路都比较陡峭，会比较累一些。当然，后山的风景也没有前山的好。</p>
<p>从八点多钟一直走到十点钟左右，一路的景色是比较平淡无奇的。北海有个著名的景点就是猴子观海，这是在路上走时不经意间看到远处有一个类似石猴的东西，用手机相机的数字变焦才能看清远处却是有一个高峰上有一个石头，形似石猴，向山谷眺望，正如其名猴子观海。这算是第一个小惊喜，不过按照网上查到的攻略，以及地图来看，若是去一趟猴子观海的景点再回来可能会赶不上下午的索道。不过，倒也不遗憾，很多景色是远观才有意思。</p>
<p>上午十点多钟大概也就到了西海区域，这里有一个高峰，即丹霞峰，据说是专门用来看日出和日落的。丹霞峰是个岔路口，需要原路上再原路下，当时想着时间还早就打算去一下，来回大概半个小时足够了。不过，丹霞峰下半段的上山路还是很陡峭的。</p>
<p>西海区域有个著名的西海大峡谷景点，不过最近没有开放，是个适合夏季旅游的人去，而且需要单独花一天时间去，毕竟黄山也是挺大的，一天是不可能游完的。</p>
<p>大概十一点钟，看地图才发现走了还不到一半，距离计划的中午十二点钟到的光明顶还比较远，正好也到了岔路口，不知是直接去光明顶呢，还是去排云亭，再去著名的飞来石，再下到光明顶。这里就要吐槽一下黄山景区了，指示牌上也不标记下一个景点多少距离（公里），路上石阶上也没有距离标记，看地图也看不明白，导致游客无法计划游玩行程，只能从网上去找攻略。鉴于早上两三个小时的经验，发现地图上画的景点虽然很远，但实际走下来都很近，考虑到离下午三四点还早，就决定多绕一圈去排云亭。</p>
<p>要说排云楼和排云亭有啥意思呢？看过了实际也就那么回事，之所以绕到这里来，还是想看看著名的飞来石。其实在丹霞峰顶的时候就能看到飞来石，只不过感觉距离非常的远。</p>
<p>十二点半左右的样子，终于到了飞来石景点，不过飞来石只是上面的一个小区域，而且上去的路只能一个人通过，游客都是排队先下几个人，再上几个人，轮流这样才能上去和下来。飞来石的侧边都是悬崖峭壁，而且只有左侧有护栏，右侧没有，站在上面还是感觉有点心慌的。而且，站在上面拍照发现根本拍不出来效果，还是离远了看才比较好。不过，从飞来石下来之后，往前走个几步路确实有个非常好的拍照点，我也发现黄山景区宣传飞来石景点的照片也是站在这里拍的。</p>
<p>路过飞来石之后，就是光明顶了，也是黄山的正中心位置，一路还算平坦，比较轻松，就是路程比较远。到达光明顶时大约下午一点钟，比预期的时间晚了一个小时，不过在看到指示牌上写着距离迎客松也仅有 5 公里后心里也不再着急了。只能说，到了光明顶才发现今天来黄山的人是真的多，几乎都没地方站人，从后山来的时候一路上都没发现有这么多人。相比于峨眉山的山顶，光明顶好像是一个用于气象研究的地点，倒也没有其它什么让人感觉有意思的景色。在这里逗留了半个多小时，吃了东西补充了体力后准备向最后一站迎客松出发。</p>
<p>如果说 5 公里的路程比较通畅的话，预期两个小时左右，也就是下午三点半左右就能到达迎客松，刚好能赶上四点半的下山索道。不过，去迎客松的路上有几段路还是很陡峭的，并不好走，尤其是百步云梯那块，当时人群已经非常拥挤了，百步云梯应该是人更多，只能走另一条路。其中，有一段几百米的路，人群拥挤到走不动的情况，这几百米几乎是花费了将近一个小时才走完，当时的心情是绝望的，没想到淡季的人都这么多。</p>
<p>到达迎客松时已经是四点半左右了，也就是说 5 公里的路程走了三个小时，好的是下山的玉屏索道也因为人多延长了运营时间，此时倒也不用着急了。迎客松作为一个非常著名的景点，我在小时候家里的挂画上就看到过，相信很多人也是以类似的方式了解到迎客松的。迎客松毕竟是一个有生命的植物，不像石头那样可以多年永存不变，近看时会发现迎客松的树枝已经用了很多钢索在牵引这，而且树上也有很多用来固定的东西，可见迎客松的生命在艰难的维持着。</p>
<p>很多人来黄山，就是为了看一眼迎客松，与其进行合照留念。在这里逗留了半小时后，五点钟的样子索道排队的人已经非常多了，为了早点下山休息也加入了排队的人群中。</p>
<p>下午六点半的时候，到了黄山脚下的汤口镇客运站，准备直接出发去宏村，此时黄山之行便暂告一段落。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="游宏村">游宏村<a href="https://wang1212.github.io/2023/03/12/life/tourism/tourism-huangshan#%E6%B8%B8%E5%AE%8F%E6%9D%91" class="hash-link" aria-label="游宏村的直接链接" title="游宏村的直接链接">​</a></h2>
<p>宏村以徽式建筑而闻名，恰好黄山只游玩了一天时间，既然来一次，就顺便在周日再玩一下周边的宏村。</p>
<p>晚上住的是宏村内的民宿，环境还算不错。放下东西简单的休息过后，便在民俗老板的介绍下去吃了一家徽菜。徽菜和我们北方人吃的菜相差倒不是很大，口味也还可以，不像杭帮菜主要是以甜为主，很多北方人并不太适应。</p>
<p>晚上宏村的夜景也还算可以，主要是今天爬了黄山似乎也有点累了，所以看了一会夜景就回房间休息了。</p>
<p>睡了美美一觉后，早上起来看了宏村白天的景色，白墙灰顶的徽式建筑群倒也别有一番景致，加上南湖与月沼这些水景，增色不少。</p>
<p>宏村并不是很大，游玩的话两三个小时足矣，特产可能就是黄山的茶叶了，其它的倒也没有什么特色。总的来说，宏村适合夏天来休闲一下。</p>
<p>需要吐槽一下的是，宏村的门票偏贵，村内的东西也卖的偏贵，村里部分大院进去还要收费。</p>
<p>中午又挑了一家村里人气很火的徽菜馆，味道也似乎并没有昨晚的好。吃完午饭，在村里到处惬意的散步一个多小时，刚好饭点的人也很少，适合拍照。</p>
<p>下午两点多启程去黄山北站，回家。</p>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="生活" term="生活"/>
        <category label="旅游" term="旅游"/>
        <category label="黄山" term="黄山"/>
        <category label="宏村" term="宏村"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[速读《设计原本》]]></title>
        <id>https://wang1212.github.io/2023/03/05/life/reading/index</id>
        <link href="https://wang1212.github.io/2023/03/05/life/reading/index"/>
        <updated>2023-03-05T16:47:00.000Z</updated>
        <summary type="html"><![CDATA[在日常工作中，经常被糟糕的项目进度控制和需求变更等因素搞得人身心俱疲，为了缓解这类问题，产品设计、程序设计、项目管理等多个环节都需要参考一些优秀的案例，而《设计原本》就针对设计过程进行了较为深入的探讨，在阅读过后发现其中一些概念是日常在用的，但没有意识到的，也有我们一直追求的理想状态被作者认为是非理性的，值得一读。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-05-27 18:35:00</em></p>
</blockquote>
<p>在日常工作中，经常被糟糕的项目进度控制和需求变更等因素搞得人身心俱疲，为了缓解这类问题，产品设计、程序设计、项目管理等多个环节都需要参考一些优秀的案例，而《设计原本》就针对<strong>设计过程</strong>进行了较为深入的探讨，在阅读过后发现其中一些概念是日常在用的，但没有意识到的，也有我们大多数人一直追求的理想状态被作者认为是不合理的，值得一读。</p>
<p>在翻阅博文中读书相关分类的文章时，发现自 2021 年更新后一年多已经没有更新了，倒也不是这一年多没有看书，只是看书是断断续续的，也没有坚持持续性的记录下来。近段时间刚好不是很忙，看到电脑中之前收藏的一本电子书《设计原本》，便饶有兴致的看了起来。鉴于现在工作忙的原因，一般看书的时候都是下班后晚上进行速读，遇到好的内容会花多一些时间深入阅读，这本书是连续几个晚上，总共花费 6 个多小时阅读完的，虽然时间不多，但还是有一些收获的。</p>
<p>这本书总体来说，内容并不是偏向学术理论的，文中有大量的实际案例，更具备实用性。也是在这本书中，又一次见到了“银弹”的说法，对这个说法有了更深入的了解。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="关于理性模型的讨论">关于理性模型的讨论<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E5%85%B3%E4%BA%8E%E7%90%86%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%AE%A8%E8%AE%BA" class="hash-link" aria-label="关于理性模型的讨论的直接链接" title="关于理性模型的讨论的直接链接">​</a></h2>
<p>在阅读这本书的过程中，我被吸引的第一个关注点就是关于“理性模型”的讨论，实际上在这之前我对这个概念没有任何认知。</p>
<blockquote>
<p>将设计过程建模为一种系统化的、按部就班的过程的观念。</p>
</blockquote>
<p>以上是书中对“理性模型”这个概念的概述，这对很多人来说似乎稀松平常，如果进一步了解作者在后续过程中举例的软件开发领域的“瀑布模型”之后更会觉得原来不过如此。</p>
<p><img loading="lazy" alt="waterfall-model" src="data:image/webp;base64,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" width="600" height="401" class="img_ev3q"></p>
<p>如上图所示，这就是软件开发领域的理性模型，即瀑布模型。乍一看这不就是我们每天开发软件的总体流程吗？</p>
<p>但是，本书的作者却不完全认同理性模型，认为这是过于理想化的东西，不符合现实情况。仔细想想也有道理，因为按这样的流程开发软件时，对于一些过程中的细节我们总会因为各种各样的现实情况而妥协或者采取折中方案。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="理性模型的优点">理性模型的优点<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E7%90%86%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BC%98%E7%82%B9" class="hash-link" aria-label="理性模型的优点的直接链接" title="理性模型的优点的直接链接">​</a></h3>
<p>针对理性模型的讨论，作者先叙述了其优点。</p>
<blockquote>
<p>与“先开始编码再说，先开始构建再说”的行为相比，任何将设计过程系统化的工作都可以视为一种长足的进步。它为设计项目的规划提供了清晰的步骤。它为日程规划和进度评估定义了明确的阶段里程碑。它为项目组织和人员配备指明了方向。它改进了设计团队的内部沟通。而在设计团队和其项目经理之间以及项目经理和其他利益攸关者之间而言，它对于沟通的改进尤为显著。新手很容易就可以上手。掌握了它，新手在面对分派给他的第一个设计任务时，就知道从何人手了。</p>
</blockquote>
<p>根据实际来看，以上叙述比较符合我们日常工作的感受。</p>
<blockquote>
<p>理性模型在特定的情形下会体现出更多的长处。在项目早期就给出目标的显式陈述、相关的必要条件以及约束说明，这有助于避免让团队陷于举棋不定的局面，也促使团队形成关于项目宗旨的统一认识。在开始编码或正式的制图工作开始之前做好整体的设计过程规划，就能够规避大量麻烦，也避免让许多努力付之东流。</p>
</blockquote>
<p>以上两部分内容算是对理性模型优点的总体概括，感觉还是比较深刻的，尤其是对于团队协作、设计项目管理等方面的考虑很到位。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="理性模型的缺陷">理性模型的缺陷<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E7%90%86%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%BC%BA%E9%99%B7" class="hash-link" aria-label="理性模型的缺陷的直接链接" title="理性模型的缺陷的直接链接">​</a></h3>
<p>接下来便是探讨了理性模型的缺陷，这部分内容其实也是最值得我们阅读和思考的。</p>
<p>首要的一点便是我们在初始阶段并不真正地知道目标是什么，理性模型最严重的缺陷在于，设计师们往往只有一个模糊不清的、不完整的既定目标，或者说是主要目的。</p>
<blockquote>
<p>设计中最困难的部分在于决定要设计什么。</p>
</blockquote>
<p>在我们日常的软件开发工作中，项目发起时大家都会明确目标，不过这个目标偏向于结果，对于项目或者产品本身没有太多具体的表述，如何具体去落地这个事情便成为了一个最大难题。这就会导致项目过程中出现频繁的需求变更，更甚者还需要进行目标修正，这一般会导致项目周期拉长，多次延期。当然，应对此类问题书中提了一种方案，那就是快速原型设计。</p>
<blockquote>
<p>设计师的主要任务乃是帮助客户发现他们想要的设计。</p>
</blockquote>
<p>快速原型设计采用一种迭代的过程和方式，来帮助客户逐渐明确需求，从而确定设计目标。也就是说，目标的迭代须作为设计过程的固有组成部分加以考虑。</p>
<p>其次，设计不是一蹴而就的，在一些高技术的领域，一个人很难有足够的知识在一开始就确定好设计目标，对于周期长的项目还会出现中途换人的情况，所以这实际是一种探索的过程。那么理性模型在这方面来看就过于理想化。</p>
<p>另一方面，项目进行过程中，很多设计决策并不是最终方案，实际上只能算是一个暂定方案，随着项目的进行，一些未考虑到的因素会被发现并影响既有的设计决策，同时客户的需求发生变化也会产生同样的结果。也就是说，在现实情况中，不可控因素有很多，理性模型注重的是按部就班、持续推进的单向工作流，但这明显不符合现实情况。</p>
<p>还有一种观点认为，设计师通常并不会按理性模型预想的步骤做事，这样只会限制他们的创造力。</p>
<p>最令我印象深刻则是，书中作者大胆指出，很多时候我们自己并不按理性模型设计的那样做事，但又要求别人如此做事，而这样的方式对于我们来说无法给别人提供很好的帮助。</p>
<p>基于以上所有的讨论，书中也做了几点总结，作为参考：</p>
<blockquote>
<p>一个正式的设计过程模型是必需的，目的是帮助组织设计工作、辅助为项目内部以及项目相关的沟通工作，亦有益于教学。</p>
<p>给予设计过程模式以可视化的几何表示至关重要，因为设计师们都擅长空间思维。他们最乐于学习、思考、分享和讨论有着明确儿何图像的模型。</p>
<p>对工程师来说，设计的理性模型是自然而然的。</p>
<p>线性的按部就班的理性模型具有很大的误导性。它并未能反映出设计师的真实工作，或是一流的设计思想家所认定的设计过程的本质。</p>
<p>坏的模型流毒甚广。它会导致需求的过早固定，从而导致过度膨胀的产品，以及日程表、预算和性能的灾难。</p>
<p>理性模型在实践中积重难返，尽管它有种种不足，而且对它早有大量有说服力的批判。这是因为它具有诱人的逻辑简单性，也是因为构建者和客户之间需要“合同”。</p>
</blockquote>
<p>通过阅读这些内容，给人感受最深的有两点：第一，我们预期的过程通常与我们实际做事的过程不相符；第二，理性模型（瀑布模型）是在没有更好的方案之时，为了快速达成某些前置目标而选取的方案。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="螺旋模型">螺旋模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E8%9E%BA%E6%97%8B%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="螺旋模型的直接链接" title="螺旋模型的直接链接">​</a></h3>
<p>在批评了理性模型之后，书中也探讨了一些其它模型的方案，其中螺旋模型作者认为比较合理。</p>
<p><img loading="lazy" alt="spiral-model" src="https://wang1212.github.io/assets/images/spiral-model-4fb901f142b73f7bad0b7a6674ecbcec.webp" width="1920" height="1600" class="img_ev3q"></p>
<blockquote>
<p>螺旋的形状当然表示的是过程。它将同一活动的连续反复彼此关联起来。这种几何形状很容易理解，而且令人印象深刻。该模型强调的是原型方法，它主张远在一个可以跑起来的原型成为可能之前，就从用户界面原型和用户测试起步。</p>
</blockquote>
<p>从瀑布模型和螺旋模型两者可视化表示的层面来看，从前者的线性模型变成了后者的迭代式模型，这意味着设计是一个不断重复的过程，这似乎更符合我们的现实情况。</p>
<p>当然，作者提出螺旋模型并不是目前最优的方案，但基于螺旋模型进行迭代和发展是一个非常有潜力的方向。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="其它设计过程模型">其它设计过程模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E5%85%B6%E5%AE%83%E8%AE%BE%E8%AE%A1%E8%BF%87%E7%A8%8B%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="其它设计过程模型的直接链接" title="其它设计过程模型的直接链接">​</a></h2>
<p>作者在书中探讨比瀑布模型更好的设计过程模型时当然没有武断地直接提出“螺旋模型”就是最好的，还提到了一些其它的模型进行了简单的分析讨论，考虑到其在有我们日常接触的系统的应用，所以提一下。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="共同演化模型">共同演化模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E5%85%B1%E5%90%8C%E6%BC%94%E5%8C%96%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="共同演化模型的直接链接" title="共同演化模型的直接链接">​</a></h3>
<p><img loading="lazy" alt="coevolutionary-model" src="https://wang1212.github.io/assets/images/coevolutionary-model-0ea1239860fa48417f7ccbdb12b94431.webp" width="1202" height="593" class="img_ev3q"></p>
<p>如上图所示，共同演化模型实际上指的是需求问题和解决方案原型不断相互迭代完善的过程。</p>
<blockquote>
<p>共同演化模型当然强调了对于需求的递进式探索和构造。它的视觉表现令人难忘。它并不包罗万象：它没有伪装成将设计一构建一测试一部署一维护一扩展这些过程的所有方面都包含在内的样子。此外，该模型的几何图像也没有示意一个收敛的过程。</p>
</blockquote>
<p>作者认为，在它原始的构造形态中，并没有表示阶段里程碑和合同的节点。虽然该模型有它的闪光点，也比理性模型要好，但并不认为它已经充分完整。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="集市模型">集市模型<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E9%9B%86%E5%B8%82%E6%A8%A1%E5%9E%8B" class="hash-link" aria-label="集市模型的直接链接" title="集市模型的直接链接">​</a></h3>
<p>集市模型没有可参考的图片，但集市的概念对于我们来说是再也熟悉不过了，可以作以类比想象。</p>
<blockquote>
<p>Raymond 在他的集市过程中如是说：在用户与生产者社区中，某个成员发现了一个需要，然后开发出一个模块来满足它，并将该模块作为礼物提供给他的同伴使用。而这个将模块整合的过程，对于 Linux 社区而言，极大地受益于 Linux 的模块化结构，特别是它的管道和过滤器机制。同样的过程也适用于缺陷修复。某个成员在他所使用的模块中检测出一个缺陷，然后把它修复以使自己能完成手头的工作，尔后他就把这个修复成果作为礼物提供给社区。</p>
</blockquote>
<p>当然，对于一些很容易想到的疑问，书中也给出了答案。</p>
<blockquote>
<p>显然，人们编写新的模块，以及修复缺陷是为了使他们可以做到想做的事。但他们又为什么将自己的工作成果分发出来，尤其是这么一来必要的测试、文档撰写以及发布等，都要求人们去做大量的额外工作呢？8Raymond 的答案，我觉得有几分道理，那就是，这样做带来的激励和回报就是在社区中的威望。</p>
</blockquote>
<p>以及市场机制可能发挥的巨大作用。</p>
<blockquote>
<p>经常地，多个模块以及对于同一个缺陷的多个修复会同时提供给社区。Raymond 提出，这时市场机制（即使对于免费商品而言）会发挥作用。更好的工具、修复结果，会赢得更广泛的受众，而它的作者也相应地会赢得更高的威望。</p>
<p>这样，集市就逐渐地被很多电子化提供他们的数字产品的“供应商”填充。许多买家，以投票的方式，通过增加在全球化社区中以电子化形式表现的威望来对他们给予回报。</p>
</blockquote>
<p>现如今活跃在开源社区的大多数开发者都没有相应的收益，但开源社区运动依然进行的如火如荼，这就是威望这种礼物的巨大吸引力。</p>
<p>但是集市模型并不完全适合用来作为设计过程的指导模型，作者由于没有进行过实践，也只是给出了几条评论。简单的来说，集市模型产出的实际上是副产品，工具比产品多，而且没有经过大量测试的不合格产品占比很高；Linux 之所以在开源社区中如此成功，是因为有 Linus Torvalds 始终作为一个保持其概念完整性的关键首脑力量存在，以及 UNIX 已经提供了总体系统设计。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>书中还针对远程协作等内容做了论述，这里不再赘述，因为书中大量的示例结合上下文看会容易理解一些，这里提到的是一些偏概念性的，也是感觉这本书中最核心的内容。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="书">书<a href="https://wang1212.github.io/2023/03/05/life/reading/index#%E4%B9%A6" class="hash-link" aria-label="书的直接链接" title="书的直接链接">​</a></h2>
<ul>
<li>《设计原本》- [美] Jr·Frederick P·Brooks 著，王海鹏、高博 译</li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="生活" term="生活"/>
        <category label="阅读" term="阅读"/>
        <category label="计算机技术" term="计算机技术"/>
        <category label="程序架构设计" term="程序架构设计"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[疫情结束后第一次出游]]></title>
        <id>https://wang1212.github.io/2023/01/25/life/tourism/tourism</id>
        <link href="https://wang1212.github.io/2023/01/25/life/tourism/tourism"/>
        <updated>2023-02-04T21:34:00.000Z</updated>
        <summary type="html"><![CDATA[疫情结束后的第一个春节，也是第一次春节假期出游，四天时间去了上海、苏州、杭州 3 个城市，领略了不同的风景。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-02-04 21:34:00</em></p>
</blockquote>
<p><u>2023-01-25</u>
<br>
<br></p>
<p>疫情结束后的第一个春节，也是第一次春节假期出游，四天时间去了上海、苏州、杭州 3 个城市，领略了不同的风景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="春节出游">春节出游<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%98%A5%E8%8A%82%E5%87%BA%E6%B8%B8" class="hash-link" aria-label="春节出游的直接链接" title="春节出游的直接链接">​</a></h2>
<p>这里说疫情“结束”似乎并不合理，因为用科学的角度来看，疫情是长期化的，总结一下就是“常伴你我身边，如影随形”。但在经历了过去三年防疫混乱的时代，用“结束”这个词语并不为过。</p>
<p>过去的三年，每个人都在断断续续承受着不同程度的精神压力，面对疫情冲击的同时全球经济环境也在恶化，就业环境开始变差，大公司在裁员，小公司可能直接破产，个人每天上班的过程中还可能被防疫政策“误伤”。总之，相信这三年已经成为很多人一生中最灰暗的一段人生经历，面对着身体与精神层面的双重压力。最终，在 2022 年底我们还是等来了曙光和希望，疫情“突然”结束了，这个混乱的时代也跟着结束了，所有的一切都在慢慢恢复，向着 2019 年，我们希望的岁月里变好。</p>
<p>2023 年的春节，年味慢慢也回来了，春运的数据也在恢复和高速增长，没有“核酸”的归途也畅通了不少。还记得四五年前就定了每年爬一座大山的目标，结果就坚持了两三年时间就遭遇了疫情这个黑天鹅事件，三年时间中几乎没有任何可以大胆出游爬山的机会。另一方面，现在工作也比以前要忙不少，很少有比较长的假期能出游。于是，在这样的背景下突发奇想准备在春节假期中挤压出 4 天时间出去游玩一下。</p>
<p>事实上，这是一次没有任何准备的出游，途中也遇到了很多有趣的事情，看新闻才知道今年春节假期的旅游出行数据恢复的很快，多个热门城市的景点都到了限流、甚至临时关停的地步。当然，也是阴差阳错的避开了这些人最多的景区，何其幸运。</p>
<p>对于要去游玩的地方，事先也没有规划和准备，只是大致上想在杭州附近的城市玩一玩，比如苏州、绍兴。预先计划的是初三晚上的飞机（杭州），初四到初七四天的游玩时间。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="出行的小插曲">出行的小插曲<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%87%BA%E8%A1%8C%E7%9A%84%E5%B0%8F%E6%8F%92%E6%9B%B2" class="hash-link" aria-label="出行的小插曲的直接链接" title="出行的小插曲的直接链接">​</a></h3>
<p>机票没有事先购买，只是偶尔会看几眼，直至初二晚上看的时候机票已经涨价很厉害，比几天前翻了一倍还多，于是也不着急买了，就想着反正也比较贵了，不如第二天临上飞机前再买，说不定还会降价，距离返岗还早机票也不会很快售罄。</p>
<p>由于是当天最后一趟飞杭州的航班，为了避免错过，就提前两个多小时赶去机场，不过在去机场的地铁上还在刷购票软件，期望能降价。突然，该航班的机票在各个平台显示已经售罄，这下直接懵了。心想，都已经在去机场的路上了，回去的话第二天早上再飞又得至少耽搁半天时间。于是，临时改变计划，看看杭州或者苏州周边的城市机场有没有票，看来看去只有上海浦东机场的最后一趟航班，价格也不贵，立即就买了。不过，半个小时后，飞杭州的航班机票又显示有了，不过这个时候已经没有什么意义了，不得不说以后还是得提前计划和买票。</p>
<p>原本这四天时间的安排中是没有考虑上海的，想着本身时间就短，主要把时间花在苏州这个城市，以后有时间了再去好好逛逛上海，却不曾想发生这样的小插曲。买了飞上海的航班机票后，还想着落地后直接去苏州，地图上了查了一下才发现浦东机场距离苏州太远，离苏州近的是虹桥机场，这下直接就打乱了之前预想的出行安排。遂决定，落地后先在上海休息一晚上，初四白天和傍晚在上海简单的逛一逛，晚上再乘高铁去苏州。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="上海一日游">上海一日游<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E4%B8%8A%E6%B5%B7%E4%B8%80%E6%97%A5%E6%B8%B8" class="hash-link" aria-label="上海一日游的直接链接" title="上海一日游的直接链接">​</a></h2>
<p>航班落地的时间应该是午夜 12 点左右，对于初次来上海，又没有提前计划的情况下来说，住宿的选择是个问题。刚开始想的是住到机场附近，最后决定先看看白天去哪逛，然后住在玩的区域附近。在上飞机前简单了查了一下旅游攻略，就一天的时间决定去看看上海外滩、豫园以及城隍庙这几个地方，于是下机后刚好还有个机场大巴（守航夜宵线），就选择直接去延安东路浙江中路下车找个地方住宿，旁边几公里内就是豫园、城隍庙以及外滩。</p>
<p>早晨 8 点半起床洗漱一下，还准备吃个上海人都吃的早餐食物，奈何离要去的豫园太近，路上还没怎么走就到了，就随便买了点东西垫了垫肚子。不得不说作为国际化大都市，上海地铁线路的覆盖还是很密集的，城区里地铁出行还是很方便的。而且，上海的很多路上都是带有历史记忆的故居、旧址等等，街道和主干道的命名也很有意思，用的是全国各地的城市名称。</p>
<p>初四的清晨，上海天气还不错，9 点左右路过科技馆，已经有大量的家长带着孩子进馆参观了。到了豫园附近，已经有很多人了，而且有很多维持秩序的执勤人员，找了半天问了好几次执勤人员才找到了豫园园林景区的入口，而且已经排了很长的队了。不过检票还算快，也就几分钟不到便进入了豫园内。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="豫园与城隍庙">豫园与城隍庙<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%B1%AB%E5%9B%AD%E4%B8%8E%E5%9F%8E%E9%9A%8D%E5%BA%99" class="hash-link" aria-label="豫园与城隍庙的直接链接" title="豫园与城隍庙的直接链接">​</a></h3>
<p>豫园内的园林景观是北方人少见的，还是有一定可观赏性的，不过想着还要去苏州园林，心里便觉得也许“不过如此”吧。豫园倒也不是很大，走走停停，拍拍照，大概不到一个小时的样子也就看完了，从后门出来后，向前走一段路就是刚才的入口排队的地方。相较于北方的环境，南方的生活与水相伴，有花有草，景色宜人。</p>
<p>不一会就到了中午，打算去吃一顿大餐来着，网上查了查发现有名的餐厅距离这里有点远，于是看看附近有什么餐厅，找了一家小杨生煎，走过去才发现是个不能堂食的店面，而且排队的人特别的多，遂放弃。最终，还是打算先吃点小吃垫一垫，逛完附近的城隍庙再去好好吃一顿。</p>
<p>地图上看城隍庙就在豫园旁边，奈何人太多，饶了一大圈才在不经意间看到了门口。进门后看到了一家面馆，进去稀里糊涂吃了一碗所谓的“迎春面”，顺便给手机充了会电，出来没带充电宝真是个不好的事情。城隍庙入口处有专门的人员为游客赠香，而在我印象中，去过的北方寺庙中可没有这样的待遇，香火都是要花钱买的。不过，话说回来，好像很多城市有“城隍庙”，苏州也有。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="武康路">武康路<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%AD%A6%E5%BA%B7%E8%B7%AF" class="hash-link" aria-label="武康路的直接链接" title="武康路的直接链接">​</a></h3>
<p>下午由于还有好几个小时才能等到看外滩夜景，就坐公交去了武康路，据说整条路上都是名人的故居。</p>
<p>下公交车的路对面似乎是个景点，放眼看去才发现是“宋庆龄故居”。往前走右拐就是著名的“黄公馆”（黄兴故居）了，建筑风格很特别，据说有很多人在这里进行拍照打卡。武康路是个小街道，非常的幽静，从头走到尾距离也比较远，路两旁确是有很多著名人士的故居，当然也有很多便利店、服装店等。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="外滩">外滩<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%A4%96%E6%BB%A9" class="hash-link" aria-label="外滩的直接链接" title="外滩的直接链接">​</a></h3>
<p>从城隍庙出来的时候大概下午两点钟左右，距离外滩也就 1 公里左右，于是在周围的公园休息了一会就步行去了外滩，目睹了一下白天的外滩风采，也看到了著名的东方明珠塔。
日间的外滩观景平台上人并不多，偶尔会有几个人路过。都说看的是外滩夜景，外滩的晚上能挤死人，但这次来上海只是临时的游玩，不一定有时间领略夜间的外滩风景。</p>
<p>不过，在查了一下从上海去苏州的高铁后，远比想象中的要方便的多，几乎每 15 分钟一趟，从早上直至晚上十点钟。这样来看，外滩夜景还是有机会看的，不慌不慢的买了一趟快晚上八点钟出发去苏州的高铁票。无奈只好先找个其它景点打发一下下午的时间，等待夜晚的来临，随便查了查便决定去武康路溜达一圈。</p>
<p>从武康路坐公交车返回到外滩时，已是下午五点多钟，不过此时天色还只是略暗，路上也已开始堵车了，看来晚上的外滩真要挤死人了？随便在周围了溜达了一会就已经六点多了，此时夜色降临，周围高楼的灯光也陆续亮了起来，江对面的也是，只是东方明珠塔还没有亮灯。相比于日间的外滩，夜间的外滩别有一番景致，望着江两岸灯光璀璨的高楼，以及对岸灯光亮起的东方明珠塔，吹着微微晚风，不由思考起来这就是现代人追求的国际化大都市吗？</p>
<p>今天夜晚的外滩观景平台上的似乎并没有想象中的那么多人，停留了半个多小时，拍了照片就准备赶去上海站了。距离上海站比较近，而且时间还有一个多小时，在没有吃晚饭的情况下，恰好看到了路对面的小杨生煎，便想着既然来一趟还是尝一尝吧，夜晚的人比白天排队的人少很多。赶到上海站时，却发现买的高铁列车晚点了，而且晚点时间还不确定，当下便决定改签，尴尬的是下一趟也晚点了 20 分钟，在思考了一番后，便决定先不着急，看看后面的列车临近发车时如何，再决定改签哪一趟能更早到苏州。最终，比预计到苏州的时间晚了半小时，九点钟到达苏州。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="苏州园林的向往">苏州园林的向往<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%8B%8F%E5%B7%9E%E5%9B%AD%E6%9E%97%E7%9A%84%E5%90%91%E5%BE%80" class="hash-link" aria-label="苏州园林的向往的直接链接" title="苏州园林的向往的直接链接">​</a></h2>
<p>计划初五、初六两天时间逛一逛苏州的景点，首先就是要决定住宿的区域，在考虑了一番后，发现苏州的景点聚集在地铁一号、二号和四号沿线上，而苏州站旁边的景区最多，遂决定住在苏州站附近，方便第二天出行。</p>
<p>高铁到达苏州站时九点钟刚过，时间还算早，在预定好酒店后决定可以先去附近的山塘街逛逛，看看夜景。下了高铁后匆忙的进入地铁站，还在思考用什么刷地铁票时，一阵喇叭的声音传入耳中，大致意思是春节假期期间苏州的地铁是免费乘坐的，直接进站即可。这是一个非常意外的惊喜，不得不说苏州市的格局还是很大的，这样便开启了两天不断穿梭在地铁站进进出出的旅程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="山塘街">山塘街<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%B1%B1%E5%A1%98%E8%A1%97" class="hash-link" aria-label="山塘街的直接链接" title="山塘街的直接链接">​</a></h3>
<p>十里山塘街算是苏州一个比较著名的步行街，与全国的景区一样，卖小吃的居多，而且小吃也大多都可以在全国各地买得到，买了一杯竹筒盛的酒酿奶茶觉得也不过如此，才发现买错地方了。晚上九点多，这里的人群已经非常拥挤了，刚开始进入步行街时几乎是前胸贴后背的景象。街两旁店铺的门口都挂着红色灯笼，夜色中的红灯笼也是一道靓丽的风景，与春节的氛围正相适宜。</p>
<p>一切都如预期之内，没有太多惊艳的地方，类似山塘街这样非常现代化、商业化的步行街区在全国各个城市还有很多。唯一有意义的便是在这春节期间能抛开工作在这街道内缓缓散步好好的放松一下，感受一下江南水乡的气氛。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="苏州博物馆">苏州博物馆<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%8B%8F%E5%B7%9E%E5%8D%9A%E7%89%A9%E9%A6%86" class="hash-link" aria-label="苏州博物馆的直接链接" title="苏州博物馆的直接链接">​</a></h3>
<p>来苏州之后，第二个感到意外的便是春节假期期间大部分景区的门票也是免费的，而且需要提前预约，且预约人数有限。看来，苏州市为了吸引游客是做足了功夫，然而这也让人感到措手不及，因为很多著名的景区门票已经预约名额满了，而且也不售卖有价门票。从山塘街回到酒店后，洗漱好在计划两天都去苏州哪些地方游玩的时候，就遇到很多景区已经不能预约了的尴尬情况，那岂不是要白来一趟了？在不断的刷新预约平台捡漏的过程中，还真遇到了苏州博物馆有几张被别人退掉的预约票，那么第二天的第一站就选定了苏州博物馆。</p>
<p>清晨洗漱完简单了吃了早餐后，已经是九点多钟，路程很近，大概两站地铁的样子，目的站点是北寺塔点。出了地铁站后，发现地铁口有一个“报恩寺”，进去烧香祈福之后简单的逛了逛，就出发去苏州博物馆了，还不算远，距离地铁口大概 1 公里的路程。</p>
<p>苏州博物馆的设计风格让人耳目一新，果然来对了地方。馆内并不大，分为三层，对于看惯了北方城市博物馆青铜器的人来说似乎提不起兴趣，不过馆内还有一些字画、玉器挺引人入胜的。苏州博物馆的建筑风格相对于北方很多城市的博物馆来说，给人的感觉确实是不一样的，真正让人感受到了另一种文化的气息。</p>
<p>从博物馆出来后，旁边就是一些其它景区，拙政园、狮子林等等，此时也已到了中午，只好在这片景区的街道逛逛买一些小吃垫一垫肚子，春节出来玩都没有好好吃过一顿饭。拙政园应该是苏州最著名的园林景区，单从门票价格上就可以看出，遗憾的是这次因为不了解苏州的春节政策和没有提前准备，春节特惠票已经预约满了，而且也不售票，就没有机会进去一览园林的风采了，好的是苏州大大小小的园林有很多，也不会说这次是来苏州白跑一趟。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="木渎古镇">木渎古镇<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%9C%A8%E6%B8%8E%E5%8F%A4%E9%95%87" class="hash-link" aria-label="木渎古镇的直接链接" title="木渎古镇的直接链接">​</a></h3>
<p>因为预约的几个城区内的园林景点都在第二天，所以今天下午只能先挑一个人比较少、离得比较近的古镇景区游玩一下，出来玩最烦的就是人群拥挤的景点了。地铁直达的景点还是很方便的，到了景区门口后，肚子实在是太饿了，周围又没有什么好吃的，无奈之下去吃了肯德基还是麦当劳，已经记不太清了。</p>
<p>进入木渎古镇已经是下午三点多钟了，镇内有四个景点，分别是严家花园、虹饮山房、古松园、状元府邸，这些景点下午四点半就已经闭园了，只出不进，只能快快的赶着顺路看哪个能进去逛一逛。由于进入木渎古镇的入口选择问题，第一个沿途遇上的景点是虹饮山房，一进入院内便被这园林风光深深的吸引了，这才是江南和苏州园林的感觉。在其中逗留了相当一段时间，出来已经是接近四点钟了，考虑到来不及逛其它景点了，只能向前赶路，途中碰到了古松园，便入园逛了逛。古松园要比虹饮山房小一些，但也有自己的特色，逗留了十几分钟后出园已经是四点二十左右了，还有十分钟左右其它景点就要关园了，于是着急的寻找网上攻略中说木渎最好的一个景点严家花园。</p>
<p>通过地图导航一查，才发现严家花园在来的路上，于是又着急的返回去，走了一路也没有发现严家花园的景点入口，直至走到来的入口的十字路口发现一个路标，才知道向前再走几十米就是严家花园了，不过了等到了门口也已经赶不上入园了，这也算是这一次来木渎古镇最大的遗憾了。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="金鸡湖">金鸡湖<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E9%87%91%E9%B8%A1%E6%B9%96" class="hash-link" aria-label="金鸡湖的直接链接" title="金鸡湖的直接链接">​</a></h3>
<p>从木渎古镇离开时已经是下午五点多钟了，晚上的计划是去金鸡湖看喷泉灯光秀和夜景，把住宿的酒店也换到了金鸡湖景区附近。计划先回到酒店放下行李，再轻装上阵去金鸡湖好好的放松一下。到酒店已是六点刚过，逗留了十多分钟就乘地铁去金鸡湖月光码头了，倒也不远，两站路。当年去重庆没有坐轮渡，昨天在上海外滩也没有坐轮渡，今天到这里了似乎不坐一次轮渡说不过去，幸运的是抢到了最后的余票。</p>
<p>距离八点钟的轮渡开船时间还有大约不到一个小时，只能在月光码头的岸边随便逛逛，晚上的风特别的大，因为春节的缘故，很多店铺还都没有开张，稍显冷清。由于喷泉灯光秀是在八点开始的二十分钟左右，且今晚是近期的最后一次，还在想是不是又要错过了。不过，经过地图上的分析，由于轮渡是绕着金鸡湖一周，估计八点钟刚出发时刚好能绕到喷泉广场附近看到灯光秀，心里便有一丝期待了。</p>
<p>接近八点钟，码头已经开始检票了，早早的过去排队，刚开始人还很少，直至最后人逐渐多了起来。上船后，挑了个靠窗的方便观景的位置，便静静坐着享受这半个多小时的湖面旅程。正如所料，大约八点零五分的样子，船开到了喷泉广场附近且稍作停留，让船上的游客目睹了灯光秀的表演，同时也近距离欣赏了著名的东方之门的风采。</p>
<p>从金鸡湖回来后，大约九点多钟，在酒店附近广场找了一圈也没有中意的吃饭的餐厅，这大概是春节出游最尴尬的一件事了，无奈只能点外卖。万万没想到的是由于骑手比较少，外卖送达已经是快十一点钟了，草草的填饱了肚子后，洗漱一下，近几天总算是能好好休息一下了。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="虎丘山">虎丘山<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%99%8E%E4%B8%98%E5%B1%B1" class="hash-link" aria-label="虎丘山的直接链接" title="虎丘山的直接链接">​</a></h3>
<p>虎丘山在苏州站附近，属于一个 5A 级景区，没想到还能预约到，等去了之后才发现一般般吧。早上很早的就乘公交去虎丘山景区了，相对来说还是比较方便的，而且又一次发现公交和地铁一样，春节假期内是免费乘坐的。公交上刚开始人还不多，直至最后几站只见上人不见下人，感觉又回到了上班挤公交挤地铁的日子。不仅公交车上很挤，而且路上还异常拥堵，仅仅几公里，大概花费了将近一小时才到达。</p>
<p>进到景区内后，入口处人也很多，寸步难行，稍微往进再走一会，人便少了一些。虎丘山被称为“吴中第一山”，事实上并不高，而且景区内的有效面积也很小，大概半个小时就能逛完，比想象中的 5A 级景区的规模要小很多，心理落差蛮大的。</p>
<p>景区出口处有人在喊可以坐船到山塘街，地图上一查才知道这里离山塘街也就两公里左右，坐船很快，而坐车就要绕一大圈了。想象的来时坐公交车的情景，只好选择坐船回到山塘街了，顺便体验一下“小桥流水人家”的感觉。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="怡园">怡园<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%80%A1%E5%9B%AD" class="hash-link" aria-label="怡园的直接链接" title="怡园的直接链接">​</a></h3>
<p>此时已是中午十二点钟左右，肚子还不饿，遂决定先去附近的怡园逛一逛，然后去平江路吃饭。怡园就在地铁口，去的话很方便，门口还有很多人在排队，园内的人数倒也还好，略显拥挤。</p>
<p>怡园内区域并不小，但也不是特别的大，整体上来看，感觉没有昨天在木渎古镇虹饮山房的景点风景好一些。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="平江路">平江路<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E5%B9%B3%E6%B1%9F%E8%B7%AF" class="hash-link" aria-label="平江路的直接链接" title="平江路的直接链接">​</a></h3>
<p>从怡园出来后，就直接乘地铁去了平江路，事实证明坐公交下车的地点比地铁要更合适一些。坐地铁后，就打算先去吃个饭，网上查看攻略时找了一家网红菜馆，导航一查大约两公里的距离，中间刚好穿过平江路，于是打算顺道走过去。此时已经是下午三点多钟了，中途路过了耦园景区，打算吃完饭再去，而且还专门从携程上查了一下耦园的入园时间，写的是四点半闭园。</p>
<p>等到了这家网红餐厅后，才发现被坑了，卫生较差，而且饭菜的味道也一般，匆匆填饱肚子后就赶着去耦园了，此时已经是四点钟刚过。赶路的过程中仔细想了一下才意识到可能已经错过入园时间了，苏州的景点应该是统一的，昨天在木渎古镇的景点是四点不再入园，四点半闭园。但是，为了避免留下遗憾，还是气喘吁吁的赶到了耦园门口，才发现确实如此，而和我们一样的人也有很多。</p>
<p>距离晚上八点钟的回杭州高铁还有三四个小时，可以慢悠悠的在平江路上好好溜达一下。不过，平江路也仅有短短的一段路而已，很快便从头走到了尾，一个平常的商业街而已，没有太多的意思。时间也还早，看到观前街就在附近一公里处，便准备去逛逛，也算消磨时间。</p>
<p>观前街的繁华程度还是比预想的要好一些，觉得刚才去平江路的网红餐厅吃饭还不如来这里吃。这里算是一个现代化的商业街广场，人流量也很大，餐饮店铺居多，也有一些卖特产的。在这里吃了一些小吃，随意逛了逛之后，大约七点钟的时候就赶去苏州站了。</p>
<p>两天的苏州行程还算充实，虽然有很多地方还没有去，不过下次还有机会，也总算是领略了苏州园林的风光，不虚此行。</p>
<p>实际上，从苏州回杭州还得先到上海虹桥，再到杭州东站。高铁票是昨天晚上才买的，已经比较迟了，苏州直达杭州的高铁已经售罄了，而且就算有最后一趟的时间也比较早，没有晚上八点以后的列车。相对来说，苏州到上海的高铁每天都非常的方便。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="杭州">杭州<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E6%9D%AD%E5%B7%9E" class="hash-link" aria-label="杭州的直接链接" title="杭州的直接链接">​</a></h2>
<p>虽然在杭州已经待了一年多的时间，但没有好好的逛过杭州的景区，这次春节出游恰好也是个契机。原本的打算是去绍兴一日游的，结果发现西湖今年一季度景区免门票，那还不如趁这个机会免费逛一逛西湖，何乐而不为呢？</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="西湖飞来峰">西湖飞来峰<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E8%A5%BF%E6%B9%96%E9%A3%9E%E6%9D%A5%E5%B3%B0" class="hash-link" aria-label="西湖飞来峰的直接链接" title="西湖飞来峰的直接链接">​</a></h3>
<p>很多人逛西湖，实际上只是西湖边上看了看，湖对面的山上还有很多景点，好好的逛一圈至少也得个几天时间，今天就挑了一个最著名的景点飞来峰，顺便去灵隐寺看一看。</p>
<p>早上出来的时候已经比较晚了，快十一点钟，打算直接乘公交到飞来峰的景点入口，虽然只有区区四站路，但到了西湖跟前时，最后两站路距离很长，而且异常的拥堵。眼看都要快下车了，但奈何堵车过于严重，一个小时过去了还没到达目的地。无奈之下，在最后堵在快到隧道出口时，人们纷纷都下了公交，直接沿路走出了隧道，然后步行到飞来峰景点。</p>
<p>杭州西湖在全国来说应该算是一个热门景点，入口处果然是人挤人。入口进去后不远处便是灵隐寺，按杭州的免票政策是景点内第一道门票是免费的，那么飞来峰免票后，灵隐寺应该是要收费的，结果径直进去后，没有任何检票收费的环节。灵隐寺不愧是西湖的核心景点，内部修缮的很好，在全国的寺庙中应该是排名在前面的。简单的烧香祈福、游览完，出寺后去攀爬了飞来峰。</p>
<p>在我的认知中，飞来峰属于西湖的核心景点，应该是很高的才是，结果不一会就到了飞来峰顶，看来南北方山的特点是不同的，北方的以险峻、高为主，而南方的山大多秀丽为主。</p>
<p>出了飞来峰后，直接去了西湖边的商业街，景区的专线公交非常的方便。在西湖边等待夜色降临，匆匆的欣赏了夜景后在商场吃了东西就结束了这四天的出游。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/2023/01/25/life/tourism/tourism#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>四天时间并不算长，三个城市的旅程也让整个过程显得稍显匆忙，没有事先的计划和准备，也引发了一系列小插曲，不过还算顺利，也感受到了苏州市对游客的欢迎，领略了不同的风景和文化。</p>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="生活" term="生活"/>
        <category label="旅游" term="旅游"/>
        <category label="上海" term="上海"/>
        <category label="苏州" term="苏州"/>
        <category label="杭州" term="杭州"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[交互状态设计：探索 ECharts 与 ZRender 的设计模式]]></title>
        <id>https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design</id>
        <link href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design"/>
        <updated>2023-01-09T23:37:00.000Z</updated>
        <summary type="html"><![CDATA[通常，对于 Web 页面的交互处理中，尤其是 DOM 元素样式的变化用 CSS 处理是非常简单的，但如果是普通对象呢？问题似乎变得复杂起来了，这篇文章通过探索 ECharts 与 ZRender 在交互状态设计相关方面的源码实现，讨论一下在复杂场景中处理交互状态的设计方案，如何将命令式编码的复杂性通过声明式编码来降低，该怎样应对复杂场景下的状态叠加问题。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-01-09 23:37:00</em></p>
</blockquote>
<p>通常，对于 Web 页面的交互处理中，尤其是 DOM 元素样式的变化用 CSS 处理是非常简单的，但如果是普通对象呢？问题似乎变得复杂起来了，这篇文章通过探索 ECharts 与 ZRender 在交互状态设计相关方面的源码实现，讨论一下在复杂场景中处理交互状态的设计方案，如何将命令式编码的复杂性通过声明式编码来降低，该怎样应对复杂场景下的状态叠加问题。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是交互状态">什么是交互状态<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%A4%E4%BA%92%E7%8A%B6%E6%80%81" class="hash-link" aria-label="什么是交互状态的直接链接" title="什么是交互状态的直接链接">​</a></h2>
<p>在开始讨论之前，有必要清晰的理解即将要讨论的问题的核心：<strong>交互状态</strong>。</p>
<p>对于强交互的应用来说，用户不同的交互行为会导致应用呈现不同的状态。以 Web 场景举一个简单的例子，对于 <code>button</code> 标签来说，用 CSS 可以声明 <code>:hover</code>、<code>:active</code>、<code>:disabled</code> 及默认样式，这里就对应了一个按钮的 4 种样式（状态），它们都是在特定的交互行为下才会触发的样式（状态），这里要讨论的交互状态则就是类似这 4 种样式的概念。如下所示：</p>
<div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token selector" style="color:#00009f">button</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">white</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token selector" style="color:#00009f">button</span><span class="token selector pseudo-class" style="color:#00009f">:hover</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">green</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token selector" style="color:#00009f">button</span><span class="token selector pseudo-class" style="color:#00009f">:active</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">red</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token selector" style="color:#00009f">button</span><span class="token selector pseudo-class" style="color:#00009f">:disabled</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">color</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token color">gray</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要清楚的是，这里的交互指的并不一定是常规的鼠标交互行为，其代表的是我们将一种事物变更为另一种状态的行为，例如一个列表中文本的搜索、筛选高亮，交互则指的是搜索和筛选的这两种用户行为。</p>
<p><img loading="lazy" alt="state" src="https://wang1212.github.io/assets/images/state-1767bd4353accc2f8b49e221b9980c98.jpg" width="777" height="270" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="交互与状态">交互与状态<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E4%BA%A4%E4%BA%92%E4%B8%8E%E7%8A%B6%E6%80%81" class="hash-link" aria-label="交互与状态的直接链接" title="交互与状态的直接链接">​</a></h2>
<p>以上 <code>button</code> 标签的例子中，CSS 声明了 4 种状态，浏览器本身已经实现了 <code>button</code> 标签用户交互行为事件监听，并自动帮助开发者在不同的交互行为下切换相应的状态（样式）。这是处理交互状态中最省心、最简单的场景，只需要声明交互状态即可。</p>
<p>另一方面，熟悉 DOM API 的开发者经常会这样做：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseenter</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'green'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseleave</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'white'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeydown</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'red'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeyup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'white'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token comment" style="color:#999988;font-style:italic">/* disabled */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'gray'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上属于命令式（过程式）的编码风格，对于仅需要改变 <code>button</code> 元素的一个 <code>color</code> 属性来说代码是比较简洁的，但如果需要改变 <code>button</code> 元素的多个属性或者逻辑更复杂时，显然代码就变得更加复杂和不易维护了。</p>
<p>当然，遵循 Web 开发中表现与行为相分离的原则，可以将样式（状态）改为用 CSS 类进行声明，如下所示：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseenter</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hoverClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmouseleave</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hoverClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeydown</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activeClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onkeyup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activeClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token comment" style="color:#999988;font-style:italic">/* disabled */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  button</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">classList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">disabledClassName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以，将状态和状态变更的逻辑进行拆分，代码会更清晰、易维护一些，状态采用声明式方案预先定义好，在相应的交互行为触发时进行状态的切换即可，而且不同交互行为触发状态变更时可以复用状态定义。</p>
<p><img loading="lazy" alt="interaction-and-state" src="https://wang1212.github.io/assets/images/interaction-and-state-57ec8a1f55fa0a0d7e846a7c8b12e248.jpg" width="1202" height="599" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="echarts-中的交互状态流程设计">ECharts 中的交互状态流程设计<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#echarts-%E4%B8%AD%E7%9A%84%E4%BA%A4%E4%BA%92%E7%8A%B6%E6%80%81%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="ECharts 中的交互状态流程设计的直接链接" title="ECharts 中的交互状态流程设计的直接链接">​</a></h3>
<p>ECharts 是一个提供了丰富图表类型的可交互的声明式图表库，在不同类型的图表（<code>series</code>）中，大部分都可以看到类似高亮（<code>series.emphasis</code>）、弱化（<code>series.blur</code>）、选中（<code>series.select</code>）的图形样式配置项，这些样式配置只有在光标悬浮到图形元素上、点击图形元素或者通过 <code>dispatchAction</code> API 触发生效，同样的由于交互行为的结束又可以恢复到原来的样式配置（normal style）。</p>
<p>接下来，根据源码探索一下 ECharts 是如何完成从图形元素响应交互到更改状态，再到更新图形元素的整个过程。先来看看 ECharts 是如何响应图形元素交互的：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.4.1/src/core/echarts.ts#L2038</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">bindMouseEvent</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zr</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> zrender</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZRenderType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ecIns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECharts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'mouseover'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> el </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> dispatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findEventDispatcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isHighDownDispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">handleGlobalMouseOverForHighDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ecIns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">markStatusToUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecIns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'mouseout'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ECharts 的底层绘制引擎是 ZRender，其提供了画布的事件响应机制，比如 <code>mouseover</code>、<code>mouseout</code>、<code>click</code> 事件。以 <code>mouseover</code> 事件为例，<code>findEventDispatcher()</code> 方法用来寻找当前触发事件元素到根元素上离得最近的<strong>可高亮元素</strong>，查看 <code>isHighDownDispatcher()</code> 方法的源码可以发现是通过判断元素对象的 <code>__highDownDispatcher</code> 标记字段是否为 <em>true</em>。当找到可高亮的元素后，通过 <code>handleGlobalMouseOverForHighDown()</code> 方法对元素的状态逻辑进行处理，当光标悬浮到某个图形元素上时，将其置为 <em>emphasis</em> 状态，同时要将剩余其它的同类型元素置为 <em>blur</em> 状态，需要注意的是该步骤只完成了图形元素的状态更新，但状态的变化还没有应用（更新）到图形元素上。最后，通过 <code>markStatusToUpdate()</code> 方法标记 ECharts 实例需要更新状态，最终在帧循环（<code>_onframe()</code>）中通过调用 <code>applyChangedStates()</code> 方法<strong>批量渲染</strong>所有需要更新状态的图形元素。</p>
<p>这里有一个细节需要注意下，为什么说 <code>applyChangedStates()</code> 是批量渲染？因为其不是同步执行的，在两个帧循环之间可能多次触发 <code>mouseover</code> 事件，这样一个帧循环就会批量处理掉由于多次触发 <code>mouseover</code> 事件累积的需要应用状态更新的图形元素。</p>
<p><img loading="lazy" alt="echarts-interactive-status-process" src="https://wang1212.github.io/assets/images/echarts-interactive-status-process-5438edb7406fe3b774dca9dd2598db41.jpg" width="1542" height="294" class="img_ev3q"></p>
<p>上图就是 ECharts 中交互状态的大致流程设计，在交互响应阶段，关联的对象会被进行标记，此时对象视图并未更新，在帧更新到来前，其它交互行为还会影响已被标记的对象，但对象视图始终在该阶段保持上一次帧更新的结果，待到帧更新阶段到来后，所有被标记的对象会批量进行提交，完成对象视图更新绘制。一句话总结，多次响应交互（对象标记）后统一提交更新。</p>
<p>这里其实应该思考一下为何有这样延迟更新（批量提交）的设计？对于浏览器来说，交互事件的回调在两次帧更新之间（大约 16ms）可能会多次触发，如果每一次触发交互事件回调时都去执行直接更新对象的逻辑不仅耗费性能，而且毫无意义，因为对象没有等待到帧更新时不会重新渲染。另一方面，将交互响应和对象实际更新独立开来，提高性能的同时也降低了代码复杂度和耦合度，对于处理快速且频繁多次不同交互造成的对象状态更新的复杂场景来说会更少出错。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="zrender-中的对象状态管理">ZRender 中的对象状态管理<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#zrender-%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86" class="hash-link" aria-label="ZRender 中的对象状态管理的直接链接" title="ZRender 中的对象状态管理的直接链接">​</a></h3>
<p>接下来看看 ECharts 最终是如何完成状态到对象更新的操作的。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/apache/echarts/blob/5.4.1/src/core/echarts.ts#L2259</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">applyChangedStates</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ecIns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECharts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ecIns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">STATUS_NEEDS_UPDATE_KEY</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ecIns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getZr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">traverse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Not applied on removed elements, it may still in fading.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">graphic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isElementRemoved</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">applyElementStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ecIns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">STATUS_NEEDS_UPDATE_KEY</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyElementStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ECElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newStates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> oldStates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">currentStates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Keep other states.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> oldStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> stateName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldStates</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stateName </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'emphasis'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stateName </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'blur'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stateName </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'select'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Only use states when it's exists.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">selected </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'select'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hoverState </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOVER_STATE_EMPHASIS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">emphasis</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'emphasis'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hoverState </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOVER_STATE_BLUR</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blur</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'blur'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  el</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newStates</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据源码来看，在帧循环（<code>_onframe()</code>）中调用了 <code>applyChangedStates()</code> 方法，对实例中的所有画布元素进行遍历应用状态，也就是更新对象视图。<code>applyElementStates()</code> 方法完成了指定对象的状态应用逻辑，其中最关键的则是对对象的 <code>useStates()</code> 方法的调用。</p>
<p>如果查看 ZRender(V5) 的源码，会发现元素对象实例有很多状态管理相关的 API 方法，如 <code>useStates()</code>、<code>useState()</code>、<code>removeState()</code>、<code>clearStates()</code> 等。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/ecomfe/zrender/blob/5.3.2/src/Element.ts#L939</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Element</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    states</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noAnimation</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forceUseHoverLayer</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stateProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      stateObj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stateProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> states</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">stateObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      stateObj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stateObjects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> animationCfg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stateTransition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">_applyStateObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据以上 <code>useStates()</code> 方法的源码实现来看，对象状态应用的过程分为两步：首先是获取状态定义，其次是更新对象。这里需要注意的是，对象状态定义的获取又分为通过 <code>stateProxy()</code> 方法动态计算和直接获取 <code>states</code> 字段相应的预定义状态对象；然后，在对象实际更新的过程中还会进行是否需要动画的判断，状态切换的动画配置存储在 <code>stateTransition</code> 字段中。</p>
<p>先来看看状态定义，元素对象 <code>states</code> 字段中存储的预定义状态对象实际上就是前文提到的 ECharts 的 <code>series.emphasis</code>、<code>series.blur</code>、<code>series.select</code> 等配置项解析而来，至于 <code>stateProxy()</code> 后续会提到。</p>
<p>然后，对于状态更新的动画可能很多人都没怎么注意到，实际上对象的 <code>stateTransition</code> 字段中的内容与 ECharts 的 <code>stateAnimation</code> 配置项有关。</p>
<p><img loading="lazy" alt="zrender-object-state-management" src="https://wang1212.github.io/assets/images/zrender-object-state-management-8d2a361c8d91bfdf7fb6a9e82258a93a.jpg" width="985" height="771" class="img_ev3q"></p>
<p>上图大致描述了一个 ZRender 对象从实例化到触发交互行为后状态更新的过程，其中灰色箭头和虚线是可选的流程。</p>
<p>综上所述，以 ECharts 和 ZRender 的实现为例，<strong>对于一个复杂的 Web 应用来说，交互状态的处理总体上抽象为两个过程：一是系统级别的交互响应和对象状态标记及批量对象更新调度，二是局部单个对象的完整状态管理和更新机制。</strong></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="实践案例">实践案例<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B" class="hash-link" aria-label="实践案例的直接链接" title="实践案例的直接链接">​</a></h2>
<p>通过对 ECharts 和 ZRender 源码实现的分析，对于 Web 应用中交互状态的处理有了可参考的解决方案，这里以一个实际案例来说明如何应对此类场景。</p>
<p>在近期一个 3D 关系图的需求中，基于 three.js 来进行开发，而且有很复杂的交互逻辑需要处理，恰好作为尝试对交互状态的处理做了简单的抽象设计。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="整体设计">整体设计<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="整体设计的直接链接" title="整体设计的直接链接">​</a></h3>
<p>在 3D 关系图的场景中，基本元素对象是节点（Node）和边（Edge），参照 ECharts 的设计，将整个交互状态的处理流程划分为全局和局部，全局实现交互事件回调的状态更新业务逻辑，然后在帧渲染中批量应用状态和更新对象（Node 和 Edge）调度，局部对象（Node 和 Edge）要实现自身的状态管理机制（API）。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">全局设计</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// - 交互事件回调</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleClickNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toUpdateNodes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toUpdateEdges </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 处理交互逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 更新状态和标记对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toUpdateNodes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'stateName'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toUpdateEdges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'stateName'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    edge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - 对象批量状态应用和更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 应用对象状态</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyObjectState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 利用 dirty 标记位来触发对象的状态更新</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> pendingUpdateState </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">pendingUpdateState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pendingUpdateState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">OBJECT_STATE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NORMAL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingUpdateState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 程序上下文切换到局部对象</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingUpdateState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">applyObjectState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  edges</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">applyObjectState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - 帧渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 批量应用状态更新对象</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">updateState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 重新渲染场景</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是系统级别的全局设计伪代码示例，下面来看看对象局部的设计：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">局部设计</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** 标记位 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dirty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** 保存对象现有的状态 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  states </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setNormal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setEmphasis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setBlur</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setSelected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stateName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO 根据指定状态更新对象 setNormal or setEmphasis or setBlur or setSelected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上伪代码对比 ZRender 的对象状态 API，缺少了存储预定义状态对象的 <code>states</code> 字段，反而多了 <code>setEmphasis()</code>、<code>setBlur()</code> 这类方法，也缺少了状态切换动画配置（这次没用到）。为何会有这些差异，后续问题分析时会提到，也是在具体的业务场景中很典型的问题。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="问题分析">问题分析<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90" class="hash-link" aria-label="问题分析的直接链接" title="问题分析的直接链接">​</a></h3>
<p>在 3D 关系图的业务场景中面临多个问题，均会影响交互状态管理的程序设计。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基本元素对象和状态类型的抽象粒度">基本元素对象和状态类型的抽象粒度<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E5%9F%BA%E6%9C%AC%E5%85%83%E7%B4%A0%E5%AF%B9%E8%B1%A1%E5%92%8C%E7%8A%B6%E6%80%81%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%8A%BD%E8%B1%A1%E7%B2%92%E5%BA%A6" class="hash-link" aria-label="基本元素对象和状态类型的抽象粒度��的直接链接" title="基本元素对象和状态类型的抽象粒度的直接链接">​</a></h4>
<p>在这里，将 3D 场景中的基本元素抽象为 Node 和 Edge，实际上粒度是很粗的，根据业务数据的特征，Node 也会有子类型，所以状态的抽象很关键。为何没有进一步抽象 Node 的子类？是为了简化设计，避免过度设计，而且业务场景并非特别复杂，可以将一定的业务复杂度放在 Node 类中处理。</p>
<p>根据交互类型进行状态类型的抽象之后（例如光标悬浮、点击选中），由于 Node 实例的数据特征差异，会出现不同 Node 对象同一类型状态拥有不同的状态对象定义。在这里可以选择进一步细化状态类型，但无疑会大大增加代码复杂度，而且代码不可控。另一方面，动态计算状态对象定义是可行的，但也有两个选择，第一是对象实例化时预先计算好存储起来，第二个是运行时动态计算，前者会增加内存消耗量，后者会影响运行时性能，因为考虑到其它问题所以选择了后者。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何用状态表达对象的系统特征">如何用状态表达对象的系统特征<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E5%A6%82%E4%BD%95%E7%94%A8%E7%8A%B6%E6%80%81%E8%A1%A8%E8%BE%BE%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%89%B9%E5%BE%81" class="hash-link" aria-label="如何用状态表达对象的系统特征的直接链接" title="如何用状态表达对象的系统特征的直接链接">​</a></h4>
<p>由于节点（Node）的抽象粒度较粗，而其关联数据的特征信息很多，对于数据分析场景来说，其实有很高的信息表达复杂度。于是出现了这样一个需求：通过一个开关可让用户控制是否需要按节点类型分组着色的效果。说明白一点就是，在按交互行为类型对状态类型进行抽象设计的情况下，一个 Node 实例对象在 <code>normal</code> 状态下可能会因为开关的状态不同而表现不同，该如何应对此类场景？</p>
<p>其实也有两个方案，一是对开关的状态进行状态类型抽象，这样就可以实现 <code>normal</code> 和 <code>switchOpen</code> 两个状态叠加应用并更新对象，但状态的叠加还会产生其它问题，例如状态叠加的顺序。不过，查看 ZRender 的源码，其实可以看到对多状态的叠加是支持的，但在实际使用过程中，叠加的多个状态定义也会产生一些问题。</p>
<p>从按交互行为对状态类型进行抽象的角度来看，这是全部 Node 对象共有的交互特性，也可看作是 Node 个体特征，而要将全部 Node 分组进行着色实际上是 Node 的系统特征的表达。所以，第二种方案就是将交互行为分为两类：用户行为（个体行为）和系统行为。在状态类型抽象设计时，具体的状态类型表达的是用户行为，而对应的状态对象定义可以动态计算，其依赖于系统行为状态。这样，就避免了状态叠加的复杂性和问题，利用命令式编码的灵活性来方便的应对此类复杂场景。实际上，这也是之前为何选择了动态计算状态定义的方案，而 ZRender 中 <code>stateProxy()</code> 的设计应该也是考虑了此类场景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>本文通过引出强交互体验的 Web 应用中交互状态管理的复杂性问题，通过对 ECharts 和 ZRender 在该方面的相关源码实现进行分析，总结了应对此类问题可参考的程序设计思路，并通过一个实际的实践案例应用来分析真实场景中会面临哪些典型问题，如何调整程序设计以解决问题。</p>
<p>总的来说，对于复杂应用的交互状态管理设计首先应该划分为：全局调度和局部对象状态管理机制。在全局将整个流程拆分为交互响应、对象状态更新、对象批量更新等多个阶段以降低代码复杂度和耦合性，在局部对象中提供预先定义状态对象的机制应对简单场景，也可以提供动态计算状态定义的机制来应对复杂场景，并结合动画来进一步提高用户体验。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/computer-technology/program-architecture-design/interactive-state-design#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://echarts.apache.org/zh/index.html" target="_blank" rel="noopener noreferrer">https://echarts.apache.org/zh/index.html</a></li>
<li><a href="https://ecomfe.github.io/zrender-doc/public/" target="_blank" rel="noopener noreferrer">https://ecomfe.github.io/zrender-doc/public/</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="程序架构设计" term="程序架构设计"/>
        <category label="ZRender" term="ZRender"/>
        <category label="ECharts" term="ECharts"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="数据可视化" term="数据可视化"/>
        <category label="实践案例" term="实践案例"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Web 3D 开发实践：计算物体在 2D 平面上的像素尺寸]]></title>
        <id>https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2</id>
        <link href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2"/>
        <updated>2022-12-20T00:09:00.000Z</updated>
        <summary type="html"><![CDATA[这篇文章是基于 3D 地球组件的开发实践，记录了将 3D 空间中的物体投影到 2D 平面中时如何换算像素尺寸的解决方案。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-12-20 00:09:00</em></p>
</blockquote>
<p>这次是基于中秋节活动时开发 3D 月球组件的经验来开发 3D 地球组件，相比于上一次，这一次很多技术难点都有了现成的解决方案，可以说开发成本降低了三分之二之多，而这些额外的开发成本则花费在隐藏在需求细节中的技术难点。这篇文章主要用来记录开发过程中遇到的一个比较有意义的技术难点，即 3D 空间中的物体投影到 2D 平面中时如何换算像素尺寸，在探索解决该难点的过程中，对 3D 与 2D 空间之间的关系有了一个更深刻的认识。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="透视相机与正交相机">透视相机与正交相机<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E9%80%8F%E8%A7%86%E7%9B%B8%E6%9C%BA%E4%B8%8E%E6%AD%A3%E4%BA%A4%E7%9B%B8%E6%9C%BA" class="hash-link" aria-label="透视相机与正交相机的直接链接" title="透视相机与正交相机的直接链接">​</a></h2>
<p>在开始之前，有必要介绍一下相机相关的知识，因为正在讨论的问题是在使用透视相机（<a href="https://threejs.org/docs/#api/en/cameras/PerspectiveCamera" target="_blank" rel="noopener noreferrer"><code>PerspectiveCamera</code></a>）时遇到的。</p>
<p>对于 3D 开发，大部分场景下都会使用透视相机，这是因为透视相机（投影）符合我们人眼观察世界的方式，会产生一种物体“近大远小”的视觉效果。另一方面，正交相机（<a href="https://threejs.org/docs/#api/en/cameras/OrthographicCamera" target="_blank" rel="noopener noreferrer"><code>OrthographicCamera</code></a>）也很常用，绘制 2D 视图就会用到，像我们生活中常见的工程制图一般应用的就是正交投影。</p>
<p><img loading="lazy" alt="perspective-and-orthographic-projection" src="https://wang1212.github.io/assets/images/perspective-and-orthographic-projection-bd14dd87133af90a7875c2e07e043404.webp" width="602" height="290" class="img_ev3q"></p>
<p>以下是 3D 建模过程中透视投影和正交投影的应用，其中 3 张图片是应用正交投影分别产生的车身 3 个不同视角的视图，而右上角则是应用透视投影后和我们人眼所观察到的视觉效果相一致。</p>
<p><img loading="lazy" alt="quad-viewport" src="https://wang1212.github.io/assets/images/quad-viewport-4b3b445fa4d08b90b2baee1dcb234521.jpg" width="1148" height="918" class="img_ev3q"></p>
<p>实际上，这里要讨论的问题即就是在透视相机（投影）所观察到的 3D 空间中某个物体在 2D 平面上的像素尺寸和坐标，是不是又有点像正交投影呢？</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="需求与问题">需求与问题<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E9%9C%80%E6%B1%82%E4%B8%8E%E9%97%AE%E9%A2%98" class="hash-link" aria-label="需求与问题的直接链接" title="需求与问题的直接链接">​</a></h2>
<p>现在来说说具体的问题是什么，如下图所示，地球表面有大量的点标记，点标记又会通过一根竖线和矩形文本框的标签连接起来，也就是说标签的位置取决于点标记在地球表面的经纬度坐标。在转动地球的过程中，如果点标记所在的位置已经被转到当前视角的背面，点标记、竖线、标签作为一个整体都会隐藏掉，这符合我们对三维空间物体的感知。但事情并非想象的这么简单，由于在移动端应用，如果某个标签的文本长度够长会出现标签已出现在屏幕之外而点标记的位置还在当前视角的可视范围内，那么标签就不会隐藏，而产品和交互更倾向于将标签作为参照对象，而不是点标记，<strong>当标签的边缘超出图中红色的矩形框时，标记点、竖线、标签作为一个整体同时隐藏不可见</strong>。</p>
<p><img loading="lazy" alt="screenshot" src="https://wang1212.github.io/assets/images/screenshot-5c01f40559825d465d41c89a8fcdf537.jpg" width="551" height="674" class="img_ev3q"></p>
<p>实际上，点标记、竖线、标签均是用 DOM 绘制的，利用 3D 场景中的点坐标和 2D 平面的像素坐标投影转换即可得到点标记的屏幕坐标。这个应用场景之一是在处理鼠标交互时，可以将鼠标点击的屏幕像素坐标转换为 3D 空间中的坐标。</p>
<p>那么，解决该问题的思路实际上也比较简单，标记点、标签的屏幕像素坐标知道，关键在于图中红色矩形框的位置和大小，其基准是 3D 空间中地球在 2D 平面上投影的矩形包围盒的位置和大小，而根据地球的球心坐标可以很容易换算出屏幕的像素坐标，但难点在于知道 3D 空间中地球的半径却不知如何换算为 2D 平面中的像素尺寸。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3d-空间尺寸与像素尺寸的对应关系">3D 空间尺寸与像素尺寸的对应关系<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#3d-%E7%A9%BA%E9%97%B4%E5%B0%BA%E5%AF%B8%E4%B8%8E%E5%83%8F%E7%B4%A0%E5%B0%BA%E5%AF%B8%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB" class="hash-link" aria-label="3D 空间尺寸与像素尺寸的对应关系的直接链接" title="3D 空间尺寸与像素尺寸的对应关系的直接链接">​</a></h2>
<p>这个问题之所以棘手，就是因为在透视相机（投影）所观察到的 3D 空间中每个物体都会呈现出“近大远小”的视觉效果，所以虽然在同一个 2D 平面（屏幕）上绘制物体，但在 3D 空间中距离相机远近不同，同样的 3D 空间尺寸投影到 2D 平面（屏幕）上时像素尺寸大小是不一样的。</p>
<p>现在，可以进一步将问题具体化为：<strong>在特定的相机距离下，3D 空间中的尺寸与 2D 投影平面的像素尺寸换算关系</strong>。</p>
<p>到了这里，对于 3D 开发经验并不丰富的我来说，技术层面实际上没有太多思路，于是只能搜索是否有解决方案。事实上，查找资料的过程并不顺利，首先是搜索关键字的问题，无法确定有效的关键字，导致一直得不到期望的结果；其次，也是比较耗费时间的一点，有很多不直接相关的问题并有相应的解决方案，但如果不花费时间理解则很容易错过一些很有用的“细节”。最终，从<a href="https://discourse.threejs.org/t/functions-to-calculate-the-visible-width-height-at-a-given-z-depth-from-a-perspective-camera/269" target="_blank" rel="noopener noreferrer">如何计算给定 Z 深度处的可见宽度/高度</a>这个讨论中找到了解决问题的线索，这个讨论中试图实现无论相机如何缩放，都可以让 3D 空间中的某个物体占满全屏。</p>
<p>可以发现，3D 开发中通常都是利用一些数学知识来解决问题的。对于文初的示意图中透视相机（投影）的模型，我们可以画出一个侧视图：</p>
<p><img loading="lazy" alt="example" src="https://wang1212.github.io/assets/images/example-68e1ec4e6b78bae72547a0f2d2dc8a0c.jpg" width="893" height="477" class="img_ev3q"></p>
<p>如上图所示，假设 <code>z0</code> 深度处可见高度（蓝色竖线）为 <code>h</code> 以及距离相机 <code>d</code>，知道相机的 <code>fov</code> 角度，根据三角函数：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tan(fov / 2) = (h / 2) / d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么可见高度 <code>h</code> 就可以得到：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">h = 2 * tan(fov / 2) * d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据相机的视野比例 <code>camera.aspect</code> 很容易就能得到可见宽度：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">w = h * camera.aspect</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里需要注意的是，根据 <code>z0</code> 与相机位置得到的 <code>d</code>，以及计算出的 <code>h</code> 和 <code>w</code> 都是 3D 空间中的尺寸（坐标尺度）。假设 3D 场景中有一个面向相机的矩形平面，在相机不断缩放的过程中，计算出 <code>h</code> 和 <code>w</code> 并设置为该矩形平面的高与宽，就能达到任意缩放比例下，该矩形平面都能占满整个场景的可视范围（即画布整个区域）。</p>
<p>既然如此，那我们很容易就能得到像素尺寸和 3D 尺寸的换算关系（假设物体在 3D 空间中的高度为 <code>H</code>，屏幕投影的像素高度为 <code>pixelH</code>）：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pixelH / canvas.clientHeight = H / h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="计算球体在屏幕上投影的包围盒位置">计算球体在屏幕上投影的包围盒位置<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E8%AE%A1%E7%AE%97%E7%90%83%E4%BD%93%E5%9C%A8%E5%B1%8F%E5%B9%95%E4%B8%8A%E6%8A%95%E5%BD%B1%E7%9A%84%E5%8C%85%E5%9B%B4%E7%9B%92%E4%BD%8D%E7%BD%AE" class="hash-link" aria-label="计算球体在屏幕上投影的包围盒位置的直接链接" title="计算球体在屏幕上投影的包围盒位置的直接链接">​</a></h3>
<p>至此，我们就可以利用以上的结论很方便的计算出：指定位置（<code>z</code> 深度处）和指定球体半径 <code>radius</code> 的地球在屏幕上投影的矩形包围盒像素宽高。</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rectPixelH = (radius / (2 * tan(fov / 2) * d)) * canvas.clientHeight</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样就可以利用程序实现在 canvas 上叠加一个 div 在相机缩放过程中同步 div 的宽高与地球球体投影矩形包围盒的宽高，如下图所示：</p>
<p><img loading="lazy" alt="screenshot1" src="https://wang1212.github.io/assets/images/screenshot1-b2de1048e289e07197b33d68c3fd6413.jpg" width="550" height="551" class="img_ev3q"></p>
<p>知道球体的矩形包围盒的位置和大小后，只需要给四周加上一定的偏移即可动态确定标签显隐检测的矩形范围，就顺利的解决了需求难题。不过，对于球体来说，有其特殊性，我们可以做进一步的优化，让包围盒的范围更精确。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="球体的特点">球体的特点<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E7%90%83%E4%BD%93%E7%9A%84%E7%89%B9%E7%82%B9" class="hash-link" aria-label="球体的特点的直接链接" title="球体的特点的直接链接">​</a></h3>
<p>让我们先来看看 3D 空间中地球的俯视图投影：</p>
<p><img loading="lazy" alt="example1" src="https://wang1212.github.io/assets/images/example1-481eb02dd8cdd5651f67608846d06d61.jpg" width="724" height="714" class="img_ev3q"></p>
<p>如上图所示，从相机位置为起点的两条蓝色直线是球体俯视投影圆的切线（切线与切点到圆心连线形成的夹角为 90° 直角），根据数学知识我们知道，四边形（蓝色实线）内角和为 360°，两条切线的夹角永远大于 0°，对角将永远小于 180°，也就意味着两个切点连线（黄色实线）的长度会无限接近直径（红色实线）长度但永远小于直径长度。</p>
<p>前面我们都是假设相机所能看到的最大范围是直径（图中红色实线）长度，但经过以上分析我们已经知道，对于球体来说，视野的最大范围是两个切点连线（图中黄色实线）的长度。所以，对于球心在 <code>z0</code> 深度处的球体，相机所能观察到的球体投影范围的矩形包围盒的宽高小于半径的两倍（即相当于圆心在 <code>z1</code> 深度处的小圆）。根据示意图所示，运用数学知识就能很快计算出黄色实线对应的 3D 空间中的长度及其和直径长度的比例关系，再将其按照前文所述的换算原理进行计算即可得到对应的像素长度，这里不再赘述。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>在 Web 3D 开发中，很多技术难点实际上都是因为我们对于数学知识的运用和实践经验不足，这篇文章用一个实际案例来说明利用数学知识解决 3D 场景中物体在 2D 平面（屏幕）投影的像素尺寸计算问题，也简单了解了透视相机（投影）和正交相机（投影）的应用场景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-2#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://threejs.org/manual/#en/cameras" target="_blank" rel="noopener noreferrer">https://threejs.org/manual/#en/cameras</a></li>
<li><a href="https://en.wikipedia.org/wiki/3D_projection#Perspective_projection" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/3D_projection#Perspective_projection</a></li>
<li><a href="https://en.wikipedia.org/wiki/Orthographic_projection" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Orthographic_projection</a></li>
<li><a href="https://people.computing.clemson.edu/~dhouse/courses/405/notes/projections.pdf" target="_blank" rel="noopener noreferrer">https://people.computing.clemson.edu/~dhouse/courses/405/notes/projections.pdf</a></li>
<li><a href="https://discourse.threejs.org/t/functions-to-calculate-the-visible-width-height-at-a-given-z-depth-from-a-perspective-camera/269/18" target="_blank" rel="noopener noreferrer">https://discourse.threejs.org/t/functions-to-calculate-the-visible-width-height-at-a-given-z-depth-from-a-perspective-camera/269/18</a></li>
<li><a href="https://gist.github.com/ayamflow/462190f13eeef04f01cb" target="_blank" rel="noopener noreferrer">https://gist.github.com/ayamflow/462190f13eeef04f01cb</a></li>
<li><a href="https://stackoverflow.com/questions/13350875/three-js-width-of-view/13351534#13351534" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/13350875/three-js-width-of-view/13351534#13351534</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Web" term="Web"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="3D" term="3D"/>
        <category label="WebGL" term="WebGL"/>
        <category label="Three.js" term="Three.js"/>
        <category label="实践案例" term="实践案例"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[探索 Docusaurus 的路由实现]]></title>
        <id>https://wang1212.github.io/computer-technology/tools/tools-docusaurus</id>
        <link href="https://wang1212.github.io/computer-technology/tools/tools-docusaurus"/>
        <updated>2022-11-15T00:47:00.000Z</updated>
        <summary type="html"><![CDATA[Docusaurus 是由 Meta 公司发布的一款专门用来构建文档站点的工具库，当然也对博客网站提供支持，为了实现自定义博客的页面，遂对其路由机制做了简单的了解。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-11-15 00:47:00</em></p>
</blockquote>
<p>大概早在一年前就了解到 Meta(Facebook) 发布的一款专门用来构建文档站点的 <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a> 工具库，那时候 Docusaurus 就已在社区中受欢迎起来，随着这一年多来看到很多开源项目的文档站点都基于 Docusaurus 构建，便下定决定要找机会尝试一下。于是，前不久在团队内对基建做改进时，对于文档这一块的迭代了解了很多热门的社区方案，一直举棋不定，在某天闲下来时就准备基于 Docusaurus 做一个尝试，最终发现效果还不错，而且迁移起来也几乎没有什么成本。</p>
<p>基于对 Docusaurus 这次尝试留下的好印象，便顺带深入了解了一下，发现还支持博客站点，而且功能很丰富，最吸引人的便是可以借助插件构建本地的离线全站搜索功能。说干就干，找了个周末就把自己的博客站点完全迁移到基于 Docusaurus 构建的站点了。当然，迁移过程是挺顺利的，而且也并没有想象中的麻烦，只是以前的博客页面都是自己写的，而现在基于 Docusaurus 的博客页面是开箱即用的主题，尤其是归档页面并不太符合期望，准备自己重新实现归档页面。经过<a href="https://docusaurus.io/docs/swizzling" target="_blank" rel="noopener noreferrer">查看文档</a>，发现 Docusaurus 确实提供了重写归档页面的机制。不过，在重写之前，我心里突然发出一个疑问：我只能在已有的路由下（<code>/archive</code>）重写页面吗？博客的数据解析后是如何存储并传递给页面组件的呢？为了一探究竟，我便带着这些问题对 Docusaurus 的路由机制做了简单的探索，总算是了解了 Docusaurus 是如何以巧妙的方式做到这些事情的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何重写页面">如何重写页面<a href="https://wang1212.github.io/computer-technology/tools/tools-docusaurus#%E5%A6%82%E4%BD%95%E9%87%8D%E5%86%99%E9%A1%B5%E9%9D%A2" class="hash-link" aria-label="如何重写页面的直接链接" title="如何重写页面的直接链接">​</a></h2>
<p>根据 Docusaurus 官方的文档描述，首先对于重写页面的场景做了简单的分类，第一类便是<a href="https://docusaurus.io/docs/styling-layout" target="_blank" rel="noopener noreferrer">样式重写</a>，此类场景只需要覆盖 CSS 样式即可；而另一类场景，以更细粒度的方式调整页面结构，也就是 Docusaurus 提供的 <a href="https://docusaurus.io/docs/swizzling" target="_blank" rel="noopener noreferrer"><strong>Swizzling</strong></a> 机制。对于调整页面结构，Docusaurus 又提供了两套方案 <a href="https://docusaurus.io/docs/swizzling#ejecting" target="_blank" rel="noopener noreferrer"><strong>Ejecting</strong></a> 和 <a href="https://docusaurus.io/docs/swizzling#wrapping" target="_blank" rel="noopener noreferrer"><strong>Wrapping</strong></a>，根据官方推荐来看，后者要比前者更安全一些，随即选了后者，但后面因为完全重写了整个博客的归档页面，所以实际上干了前者所对应的事情。</p>
<p><strong>Wrapping</strong> 方案简单的来说就是对原有的 <code>BlogArchivePage</code> 组件做一层包装，即实现 <code>BlogArchivePageWrapper</code> 组件，用代码来表达的话如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BlogArchivePageWrapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** TODO something */</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">BlogArchivePage </span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了重写博客的归档页面，必然得了解 <code>props</code> 的数据结构。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="页面的数据从何而来">页面的数据从何而来<a href="https://wang1212.github.io/computer-technology/tools/tools-docusaurus#%E9%A1%B5%E9%9D%A2%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BB%8E%E4%BD%95%E8%80%8C%E6%9D%A5" class="hash-link" aria-label="页面的数据从何而来的直接链接" title="页面的数据从何而来的直接链接">​</a></h2>
<p>随即打开 Chrome 的开发工具，利用 React 的调试插件查看了页面组件树，了解了 <code>BlogArchivePageWrapper</code> 组件所接收的 <code>props</code> 数据结构。如下图所示：</p>
<p><img loading="lazy" alt="Snipaste_2022-11-15_01-29-33.png" src="https://wang1212.github.io/assets/images/Snipaste_2022-11-15_01-29-33-5440fb0d000703c5cad37a93d13d9d74.png" width="1069" height="390" class="img_ev3q"></p>
<p>此时，我便产生了刚开始提到的一些疑问：页面的数据从何而来？是否有 API 可以获取？如果我想利用博客的数据构建一个自定义路由下的页面是否有可能呢？</p>
<p>带着这些问题我仔细查看了官方的文档，然而一无所获。当然，这便引起了我的兴趣，我决定通过探索 Docusaurus 源码的方式搞清楚这些问题。通过快速的阅读源码，大致了解了其机制和原理，觉得非常有意思和有技巧性，决定记录下来。（事实证明，由于没有仔细看官方的架构设计文档，花费了很多不必要的时间。）</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="创建路由">创建路由<a href="https://wang1212.github.io/computer-technology/tools/tools-docusaurus#%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1" class="hash-link" aria-label="创建路由的直接链接" title="创建路由的直接链接">​</a></h3>
<p>第一步，便是通过分析得到的数据结构关键字 <code>archive</code> 做一个源码的全局搜索，便找到了 <strong>@docusaurus/plugin-content-blog</strong> 包的源码实现部分。其关键代码如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/facebook/docusaurus/blob/v2.2.0/packages/docusaurus-plugin-content-blog/src/index.ts#L229</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">contentLoaded</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blogContents</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> actions</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> archiveUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    component</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blogArchiveComponent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exact</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modules</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">      archive</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">aliasedSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">archiveProp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据源码可以看出，通过 <code>addRoute()</code> API 创建了一个路由（即默认的 <code>/archive</code>），并将解析好的博客归档数据 <code>archive</code> 作为参数传入。这个时候，如果及时查看一下<a href="https://docusaurus.io/docs/api/plugin-methods/lifecycle-apis#addRoute" target="_blank" rel="noopener noreferrer">官方插件文档</a> 理解起来要容易很多，当然跟踪上游的代码实现也是可以的，毕竟源码是绝对可信的。</p>
<p>在看源码之前，仔细看看官方的<a href="https://docusaurus.io/docs/advanced/architecture" target="_blank" rel="noopener noreferrer">架构文档</a>和<a href="https://docusaurus.io/docs/advanced/routing" target="_blank" rel="noopener noreferrer">路由文档</a>对于源码的理解要更深一些。关键源码如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/facebook/docusaurus/blob/v2.2.0/packages/docusaurus/src/server/plugins/index.ts#L119</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initialRouteConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Trailing slash behavior is handled generically for all plugins</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> finalRouteConfig </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">applyRouteTrailingSlash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initialRouteConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">siteConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pluginsRouteConfigs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">finalRouteConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finalRouteConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> finalRouteConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      plugin</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pluginRouteContextModulePath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>单纯看这段源码的话，并不能明白 <code>addRoute()</code> API 具体做了什么事情，不过架构文档中对于该 API 有一段描述，一个重点则是 <strong>“插件代码和主题代码不直接相互导入，而是通过 JSON 临时文件和调用 <code>addRoute</code>”</strong>。另一方面，可以注意到以上关键代码位于 <em>server/</em> 目录下，而 Docusaurus 是 Server-Client 架构。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="页面是如何加载数据的">页面是如何加载数据的<a href="https://wang1212.github.io/computer-technology/tools/tools-docusaurus#%E9%A1%B5%E9%9D%A2%E6%98%AF%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E7%9A%84" class="hash-link" aria-label="页面是如何加载数据的的直接链接" title="页面是如何加载数据的的直接链接">​</a></h3>
<p>经过以上分析，我们知道博客插件将解析好的博客归档数据 <code>archive</code> 通过 <code>addRoute()</code> API 注册路由时绑定了起来，那么页面加载 <code>/archive</code> 路由时如何获取这份数据是非常关键的。最简单的方式就是查看开发工具的请求信息，当然确实发出了一个<strong>js 文件</strong>请求，如下图所示：</p>
<p><img loading="lazy" alt="Snipaste_2022-11-15_02-14-57.png" src="https://wang1212.github.io/assets/images/Snipaste_2022-11-15_02-14-57-0902059e4a4b8d9b4b20473aa2508f50.png" width="968" height="468" class="img_ev3q"></p>
<p>根据该 JS 文件的源码来看，实际上是一个包含了博客归档 JSON 数据的 webpack 构建的模块。联想到之前架构文档中提到的 JSON 数据通信，再去看一下官方的<a href="https://docusaurus.io/docs/advanced/plugins" target="_blank" rel="noopener noreferrer">插件文档</a> 发现提供了一个很有用的 <strong>debug plugin's metadata panel</strong> 调试面板，然后再看看项目根目录的 <em>.docusaurus</em> 文件夹，很容易就找到了 <em>.docusaurus/docusaurus-plugin-content-blog/default/archive-3ef.json</em> 文件，而这正是博客归档数据，也是以上 JS 模块所包含的 JSON 数据。而该 JSON 文件又是何时生成的呢？</p>
<p>回过头来看，在分析 <code>addRoute()</code> 源码的时候忽略了其上几行的 <code>createData()</code> API 的关键代码：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/facebook/docusaurus/blob/v2.2.0/packages/docusaurus-plugin-content-blog/src/index.ts#L220</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Create a blog archive route</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> archiveProp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation function" style="color:#d73a49">docuHash</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">archiveUrl</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">.json</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> blogPosts </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此，已经清楚的知道插件在通过 <code>addRoute()</code> 添加路由时，就调用 <code>createData()</code> API 生成了相关的 JSON 数据临时文件，以备后续客户端代码通信。</p>
<p>根据之前留意的一个细节，<code>addRoute</code> 的源码在 <em>server/</em>，现在来看看 <em>client/</em> 目录便可知晓客户端页面是如何加载数据的。在此之前，先通过开发工具的 React 调试插件看看该数据到底是从哪个父组件获取并注入 <code>BlogArchivePageWrapper</code> 组件的。结果如下：</p>
<p><img loading="lazy" alt="Snipaste_2022-11-15_02-37-14.png" src="https://wang1212.github.io/assets/images/Snipaste_2022-11-15_02-37-14-4fd02c4b397413c9764dd4d18743cb40.png" width="760" height="512" class="img_ev3q"></p>
<p>如图中所示，实际上是 <code>LoadableComponent</code> 完成了数据获取，并将其注入到子组件中。这一看似乎是 <a href="https://github.com/jamiebuilds/react-loadable" target="_blank" rel="noopener noreferrer">react-loadable</a> 的代码，经过查看源码确实如此，不过让我感到疑惑的是，曾经用过 react-loadable 却不知道其还有加载（请求）数据的功能？实际上，Docusaurus 利用了其<a href="https://github.com/jamiebuilds/react-loadable#optsrender" target="_blank" rel="noopener noreferrer">自定义渲染的 API</a> 来巧妙的完成了页面加载时数据请求的任务。关键代码如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/facebook/docusaurus/blob/v2.2.0/packages/docusaurus/src/client/exports/ComponentCreator.tsx#L75</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loaded</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">keyPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">exportedName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  props</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// `loaded` will be a map from key path (as returned from the flattened</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// chunk names) to the modules loaded from the loaders. We now have to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// restore the chunk names' previous shape from this flat record.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// We do so by taking advantage of the existing `chunkNames` and replacing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// each chunk name with its loaded module, so we don't create another</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// object from scratch.</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loadedModules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chunkNames</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __comp</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ComponentType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">object</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __context</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RouteContext</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">propName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段代码中，<code>chunkNames</code> 实际上就是请求的 JS 模块加载后注入到全局的数据信息（参考 Webpack 模块机制）。现在，我们明白了客户端页面是如何完成数据加载工作的，但还有一个问题还未解决，我们了解了 JSON 数据临时文件何时生成的，JS 模块是何时加载数据的，但唯独中间过程，即是如何利用 JSON 数据临时文件生成该 JS 模块文件的目前还不得而知？</p>
<p>实际上，这个问题随着追溯上面代码的上下文 <code>ComponentCreator</code> 方法的引用就立刻明白了。于是，又回到了服务端代码 <em>server/routes.ts</em> 中，这是路由的核心实现。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">https://github.com/facebook/docusaurus/blob/v2.2.0/packages/docusaurus/src/server/routes.ts#L246</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * This is the higher level overview of route code generation. For each route</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * config node, it returns the node's serialized form, and mutates `registry`,</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * `routesPaths`, and `routesChunkNames` accordingly.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">genRouteCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">routeConfig</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RouteConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LoadedRoutes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * Routes are prepared into three temp files:</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * - `routesConfig`, the route config passed to react-router. This file is kept</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * minimal, because it can't be code-splitted.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * - `routesChunkNames`, a mapping from route paths (hashed) to code-splitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * chunk names.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * - `registry`, a mapping from chunk names to options for react-loadable.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadRoutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  routeConfigs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RouteConfig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  baseUrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onDuplicateRoutes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReportingSeverity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上不再细说，代码和注释已经非常的清晰了。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/tools/tools-docusaurus#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>最终，由于在重写博客归档页面中引起的一些疑问简单探索了 Docusaurus 路由机制的实现原理，了解了从数据解析到路由创建，再到页面加载完成数据请求并渲染页面内容的整个过程。从这个分析过程中，可以看到 Docusaurus 实现静态文档站点工具库所使用的一些技术和技巧，也许可以在解决某些问题时受到启发。</p>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="工具" term="工具"/>
        <category label="Docusaurus" term="Docusaurus"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Web 字体加载对页面产生的影响]]></title>
        <id>https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts</id>
        <link href="https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts"/>
        <updated>2022-10-16T23:49:00.000Z</updated>
        <summary type="html"><![CDATA[由于使用了第三方 Web 字体，产生了一个潜在的线上问题，苦于调试过程中一直没有考虑字体加载会对页面产生一定影响，浪费了大量时间和精力。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2023-12-16 21:32:00</em></p>
</blockquote>
<p>通常，在 Web UI 设计过程中会用到定制字体，页面开发过程中会使用 CSS 引用（<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face" target="_blank" rel="noopener noreferrer">@font-face</a>）该字体资源，不过<strong>由于字体资源较大，通常会对页面性能造成一些不利影响。</strong></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="案例">案例<a href="https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts#%E6%A1%88%E4%BE%8B" class="hash-link" aria-label="案例的直接链接" title="案例的直接链接">​</a></h2>
<p>由于公司的业务会用到设计师定制的 Web 字体，前段时间发现一个线上问题：在部分 iOS 机型上，DOM 元素的位置发生了错位。</p>
<p>首先，对于问题复现的必要条件做了分析，为以下几个方面：</p>
<ul>
<li>部分 iOS 机型（新旧机型均有）</li>
<li>问题发生在首次页面加载时（即后续加载问题不再复现）</li>
</ul>
<p>根据以往的经验和代码实现来看，可能是 DOM 测量的尺寸数据不准确导致的，于是首先尝试加了延迟的方案看看效果，发现问题依然存在，然后尝试线上调试看看具体测量到的 DOM 尺寸数据是否准确。由于线上调试比较麻烦，所以也更进一步分析为何问题出现在清除缓存后的首次加载，推测是什么资源加载太慢导致的？但当时由于着急，主要考虑的都是显式引入的资源（例如 js、css 文件等，忽略了一些细节），在这方面也没有什么进展。于是，继续尝试线上调试，结果发现首次加载和二次加载得到的 DOM 测量数据完全一致，此时这个问题就有点“邪门”了，难道是浏览器内核渲染的问题？调试了很久，也没有什么收获，但考虑到对线上用户影响不是很大，就暂时搁置了这个问题，暂且认为是浏览器内核的一个什么 bug（虽然说这个确实没有什么说服力，但苦于花了很多精力和时间依然找不到原因，考虑到解决这个问题的性价比不高就先放弃了）。</p>
<p>后来，有个同事提到之前的文档有记录过类似因为公司定制字体加载导致的页面问题，简单看了下文档后，发现之前确实忽略了这个细节（字体文件通常比较大，加载比较慢，但由于是放在 CDN 上的所以一直没太在意）。经过和业务侧的前端沟通后，一天下午抽空尝试了下，发现确实是由于 Web 字体资源太大（CDN 不太稳定）加载较慢导致的 DOM 位置渲染错位（需要注意的是，该原因并没有导致 DOM 测量出现错误）。这里贴一下解决该问题的示例代码：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fonts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ready</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解决方案">解决方案<a href="https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2>
<p>近期，看到了 Google Chrome 团队构建的 <a href="https://web.dev/" target="_blank" rel="noopener noreferrer">web.dev</a> 站点进行了大改版，其中有一篇专门针对<a href="https://web.dev/articles/avoid-invisible-text?hl=en" target="_blank" rel="noopener noreferrer">字体加载对页面性能影响的文章</a>感觉很有价值，所以更新一下这篇文章。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="方案一在字体加载后再使用">方案一：在字体加载后再使用<a href="https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts#%E6%96%B9%E6%A1%88%E4%B8%80%E5%9C%A8%E5%AD%97%E4%BD%93%E5%8A%A0%E8%BD%BD%E5%90%8E%E5%86%8D%E4%BD%BF%E7%94%A8" class="hash-link" aria-label="方案一：在字体加载后再使用的直接链接" title="方案一：在字体加载后再使用的直接链接">​</a></h3>
<p>要做到这一点，需要了解字体资源何时会加载成功，实际上在前面的案例中已经看到有现成的 Web API 可以支持：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">fonts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ready</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">fontFaceSet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Any operation that needs to be done only after all used fonts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// have finished loading can go here.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fontFaces </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">fontFaceSet</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fontFaces</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// some fonts may still be unloaded if they aren't used on the site</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fontFaces</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当前，除过使用 CSS（<code>@font-face</code>）方式加载第三方字体资源，还可以通过 JavaScript 方式来加载，和以上 API 结合使用：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Define a FontFace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> font </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FontFace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"myfont"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"url(myfont.woff)"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Add to the document.fonts (FontFaceSet)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">fonts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Load the font</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Wait until the fonts are all loaded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">fonts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ready</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Use the font to render text (for example, in a canvas)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>web.dev 文中也提到一个第三方工具库 <a href="https://github.com/bramstein/fontfaceobserver" target="_blank" rel="noopener noreferrer"><code>Font Face Observer</code></a>，其提供了更容易的使用方式：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> font </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FontFaceObserver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'My Family'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">weight</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Font is available'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Font is not available'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="方案二font-display-属性">方案二：<code>font-display</code> 属性<a href="https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts#%E6%96%B9%E6%A1%88%E4%BA%8Cfont-display-%E5%B1%9E%E6%80%A7" class="hash-link" aria-label="方案二font-display-属性的直接链接" title="方案二font-display-属性的直接链接">​</a></h3>
<p>该方案是 web.dev 文中提到的首个方案，因为它足够简单：</p>
<div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Before */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token atrule rule" style="color:#00a4db">@font-face</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">font-family</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Helvetica</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* After */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token atrule rule" style="color:#00a4db">@font-face</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">font-family</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Helvetica</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">font-display</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> swap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>随着技术的发展，很多以前很难办到的事情，也许使用一个新的特性就能解决，不过这也需要我们持续学习。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/2022/10/16/computer-technology/web-frontend/web-tips-fonts#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/fonts" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/Document/fonts</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/CSS_Font_Loading_API" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/CSS_Font_Loading_API</a></li>
<li><a href="https://web.dev/articles/avoid-invisible-text?hl=en" target="_blank" rel="noopener noreferrer">https://web.dev/articles/avoid-invisible-text?hl=en</a></li>
<li><a href="https://github.com/bramstein/fontfaceobserver" target="_blank" rel="noopener noreferrer">https://github.com/bramstein/fontfaceobserver</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Web" term="Web"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="实践案例" term="实践案例"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Web 3D 开发实践：3D 月球组件]]></title>
        <id>https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1</id>
        <link href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1"/>
        <updated>2022-09-17T17:23:01.000Z</updated>
        <summary type="html"><![CDATA[这篇文章是基于 3D 月球组件的开发实践，记录 3D 开发实践中了解的一些 Web 3D 技术知识和一些典型问题场景的解决方案。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-09-17 17:23:01</em></p>
</blockquote>
<p>恰逢中秋节，有机会参与到一项中秋运营活动的项目中，负责为业务方提供一个移动端场景投放的 3D 月球组件。由于一直接触的是 2D 可视化开发，对于 3D 开发（WebGL）的技术未有深入了解和实践经验，基于对现有社区主流技术的简单了解和团队成员的技术背景，遂选定基于 Three.js 进行开发以降低风险。</p>
<p>这篇文章是基于 3D 月球组件的开发实践，记录 3D 开发实践中了解的一些 Web 3D 技术知识和一些典型问题场景的解决方案。</p>
<p>先看看最终线上效果：</p>
<video src="/video/web-3d-practical-case-1_screenshot.mp4" width="280" controls="" autoplay="" loop="">
<blockquote>
<p><a href="https://eq.10jqka.com.cn/activepage/activeMidAutumn/#/home" target="_blank" rel="noopener noreferrer">线上活动链接</a></p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="为什么选择-threejs">为什么选择 three.js？<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-threejs" class="hash-link" aria-label="为什么选择 three.js？的直接链接" title="为什么选择 three.js？的直接链接">​</a></h2>
<p>这里，先简单的聊一聊为什么会选择 <a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">three.js</a>？</p>
<p>鉴于对 3D 开发技术不够了解和时间紧迫等原因，优先考虑借助工具库完成组件开发。开源社区主流的 3D 开发工具库可以根据 <a href="https://npmtrends.com/aframe-vs-babylonjs-vs-phaser-vs-react-three-fiber-vs-three" target="_blank" rel="noopener noreferrer">npm trends</a> 提供的信息做个参考，其中 three.js 的下载量遥遥领先，可见 three.js 已经被应用的很广泛了，是一个足够成熟的工具库。另一方面，Web 3D 技术的应用场景大多还是集中在游戏领域，例如 <a href="https://www.babylonjs.com/" target="_blank" rel="noopener noreferrer">Babylon.js</a> 这个游戏开发框架，以及用来构建 AR 应用的 <a href="https://aframe.io/" target="_blank" rel="noopener noreferrer">A-Frame</a>，所以可选择的成熟方案并不多。</p>
<p>综合考虑，three.js 在社区应用广泛，并且资料丰富、官方文档也较为友好，是一个比较合适的方案，另一方面，three.js 属于是对底层进行封装抽象的 API 集合，轻量也不复杂，而对于一个偏向于框架的工具来说就引入了不必要的复杂度。与此同时，考虑到团队内成员的技术背景（部分人基于 three.js 实践过 3D 开发），基于 three.js 来开发组件技术风险也能低一些。顺带提及一下 <a href="https://github.com/vasturiano/three-globe" target="_blank" rel="noopener noreferrer">three-globe</a> 这个工具库，是用来专门构建 3D 地球可视化场景的开箱即用工具箱，也是后来开发过程中才了解到的，值得探究。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="threejs-的应用程序结构">three.js 的应用程序结构<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#threejs-%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84" class="hash-link" aria-label="three.js 的应用程序结构的直接链接" title="three.js 的应用程序结构的直接链接">​</a></h3>
<p>选定技术方案后，需要对此次的 3D 月球组件需求任务要进行一个分析和拆解，做一个简化的应用架构设计，方便后续编码实现和快速迭代。在设计 3D 月球组件之前，有必要了解一下 three.js 的应用程序结构，便于完成后续工作。</p>
<p><img loading="lazy" alt="threejs-application-structure.jpg" src="https://wang1212.github.io/assets/images/threejs-application-structure-fa9520b43ae06e7ed4b755a326c266bb.jpg" width="1181" height="747" class="img_ev3q"></p>
<p>如上图所示，典型的 three.js 应用程序结构包含渲染器（Renderer）、场景（Scene）、相机（Camera）三大部分。相对于 2D 可视化开发来说，多了场景和相机这两个概念，前者要容易理解一些，可以简单的认为是绘图空间；而后者相机是一个新的东西，对于屏幕来说永远都是一个二维平面，三维物体的展现也是在特定的距离、方位和视角下，可以等同于人眼来理解相机。</p>
<p>场景图是 three.js 的核心，用来组织所有的可视元素节点，与 2D 开发类似，都有一个<strong>组（Group）</strong> 的概念，其可以很方便将大型场景进行分组设计、布局计算。对于 3D 月球组件的场景图结构设计也是基于组的概念来完成。</p>
<p>下面以一个现实中的场景来举例说明组（Group）的概念重要性。如下图所示，太阳（黄色）、地球（蓝色）、月球（灰色）的分布，我们都知道地球绕着太阳转，月球绕着地球转，在全局空间中月球的位置将会变得难以计算（因为月球参照的中心点地球位置在移动，而月球还绕着地球在旋转）。此时，可以考虑将月球放在地球形成的组（Group）中，在这个组中的任何物体的布局计算都不再是基于全局空间的坐标原点，而是基于该组所在的坐标点，在这个“局部空间”中月球的坐标计算只需要考虑自身旋转运动即可，组的坐标点更新会自动同步到组中月球节点上。</p>
<p><img loading="lazy" alt="example1.png" src="data:image/png;base64,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" title="example1.png" width="400" height="300" class="img_ev3q"></p>
<p>对于此次要开发的 3D 月球组件来说，场景图结构设计要简单得多，如下所示：</p>
<p><img loading="lazy" alt="scene-graph.png" src="https://wang1212.github.io/assets/images/scene-graph-5aff36f2eb25778582d6d26ec5bb5b99.png" width="639" height="353" class="img_ev3q"></p>
<p>3D 月球组件中的 3 大元素就是月球（Moon）、标签（Word）、飞线（FlyLine），其中标签通过一个组（Group）来实现，因其包含一个圆形节点和文本节点，可以统一位置布局；事实上飞线也是会存在多个的，也可将其放入一个组（Group）内，只不过这里仅仅是用来便于统一管理。按理来说，标签位于月球表面，而月球会自转，标签和月球放入一个组（Group）内不是更好？但由于这里的月球中心位于坐标原点处，球面标签的位置非常好计算，而且月球的自转动画的实现也借助了轨道控制器（后续会提到），所以不放在一个组内也是可以的。</p>
<p>参考<a href="https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene" target="_blank" rel="noopener noreferrer">官方文档</a>，很快就能启动一个 3D 可视化项目，具体的代码不在这里举例说明。需要特别说明的是，对于三维场景中的坐标计算，通常利用一些简单的数学知识就能完成，而 three.js 提供了非常多的开箱即用的数学工具，例如线、球体、椭圆几何体的计算、向量的叉积与点积运算等、线之间的夹角计算等等，需要用到的时候先仔细翻翻官方文档，大概率是可以找到 api 的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="开始构建-3d-月球组件">开始构建 3D 月球组件<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA-3d-%E6%9C%88%E7%90%83%E7%BB%84%E4%BB%B6" class="hash-link" aria-label="开始构建 3D 月球组件的直接链接" title="开始构建 3D 月球组件的直接链接">​</a></h2>
<p>现在，基于上文提到的场景图结构设计的参考图，再结合 2D 可视化开发中的组件化（模块化）思路，最终的项目结构呈现为：</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── assets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── FlyLine.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Moon.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── Word.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Component.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── Controller.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── util</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── common.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── math.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── index.ts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如上所示，<strong>Controller.ts</strong> 文件是整个组件程序控制流的实现，而 <strong>component/</strong> 文件夹中的几个文件是业务组件的实现。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// src/core/Controller.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Controller</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__initRenderer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__initScene</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__initCamera</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__initLights</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__initControls</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__initInteractionManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">___bindEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__initialized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__getAllComponents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">comm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">controls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_renderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camera</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__initialized</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__animationLoop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">requestAnimationFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是 <strong>Controller.ts</strong> 文件的部分代码，展示了 3D 组件的程序主流程的核心实现，大致上遵循先初始化各个子组件实例，绑定事件，启动动画循环，然后在动画循环中更新组件、相机轨道控制器、渲染器重渲染等等这个模式。</p>
<p>基本上，组件的开发流程可以拆解为各个业务组件的逐步实现。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="月球">月球<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E6%9C%88%E7%90%83" class="hash-link" aria-label="月球的直接链接" title="月球的直接链接">​</a></h3>
<p>首先要实现的便是月球组件，通过分析，其实现起来比较简单，本质上是一个球体在加一个月球表面的贴图即可。代码示例：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Moon</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__createSphere</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> geometry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SphereGeometry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">radius</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> texture </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textureLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moonImage </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> material </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MeshBasicMaterial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// color: 0x00ff00,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> texture</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Mesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">geometry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> material</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果月球组件这么简单的话，就没有必要写这篇文章了。事实上，设计师对于细节是有要求的，比如接下来遇到的这个问题。</p>
<p>为了让月球看起来更真实一些，需要做一个月球的外发光效果。在力争实现设计师预期的视觉效果的过程中，查阅了很多资料，发现 3D 场景中的物体发光并不是一个 three.js 默认支持的功能，有一定的技术成本。另一方面，发现有很多人在应对 3D 地球的发光效果时采用了一种折衷方案，该方案的具体做法就是让设计师提前准备好一张正方形的中心透明四周泛光的光圈贴图，然后将这个贴图和场景中的月球叠在一块，经过调整位置和大小就可以达到以假乱真的效果。贴图效果如下：</p>
<p><img loading="lazy" alt="月球光晕1.png" src="https://wang1212.github.io/assets/images/%E6%9C%88%E7%90%83%E5%85%89%E6%99%951-eafe4ea7c603f94003fdfcc624053238.png" width="278" height="278" class="img_ev3q"></p>
<p>相信看到贴图的你已经知道我们要玩一种“以假乱真”的把戏，利用简单的贴图叠加实现月球的外发光效果。实现效果如下：</p>
<p><img loading="lazy" alt="screenshot1.jpg" src="https://wang1212.github.io/assets/images/screenshot1-1a344a7f62cb5023bb5ca5a317ffb660.jpg" width="415" height="379" class="img_ev3q"></p>
<p>从最终的效果上看，设计师是比较满意的，从技术上讲这也是成本最低的方案。代码如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Moon</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> moon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__createSphere</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    moon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Moon'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    moon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rotation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PI</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">180</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">86</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 将外发光的阴影贴图和月球节点放在同一个 Group 内叠加</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shadow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">__createShadow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    moon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shadow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> moon</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__createShadow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> texture </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textureLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moonShadowImage </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> material </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpriteMaterial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> texture</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      transparent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      depthWrite</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      opacity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.75</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">material</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 调整大小和月球节点完美的叠加起来</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">radius </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.875</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">radius </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.875</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此，月球的外发光效果就基于贴图方案完美的解决掉了。当然，我们的产品是追求完美的，3D 场景下的物体务必要真实一些，而这个真实感就体现在月球表面的纹理（类似陨石坑一样的起伏）是否有立体感。</p>
<p>一般来说，3D 地球在 GIS 场景中应用时，会附加地形（DEM）数据，所以会看到地球表面明显的地形起伏，颇有真实感；但是，对于月球来说，真实的高程（DEM）数据是很难获得的，实现成本会很高，况且也毫无头绪。当然，问题还是得解决的，经过查阅资料发现有一种 <a href="https://en.wikipedia.org/wiki/Bump_mapping" target="_blank" rel="noopener noreferrer">Bump mapping（凹凸贴图）</a>的技术可以用来解决该问题，而 three.js 也支持。</p>
<blockquote>
<p>凹凸映射是计算机图形学中的一种纹理映射技术，用于模拟物体表面的凹凸和皱纹。这是通过扰动对象的表面法线并在光照计算期间使用扰动的法线来实现的。结果是一个明显凹凸不平的表面，而不是一个光滑的表面，尽管底层对象的表面没有改变。</p>
</blockquote>
<p><img loading="lazy" alt="600px-Bump-map-demo-full.jpg" src="https://wang1212.github.io/assets/images/600px-Bump-map-demo-full-7ba08f592fdb80b4a410f3d690542799.jpg" width="600" height="202" class="img_ev3q"></p>
<p>如上图所示，凹凸贴图可以实现让一个光滑的物体表面看起来凹凸不平的视觉效果，这也契合我们的需求。实现的效果不在这里给出截图，因为细节只有在真机设备上看起来才明显。代码比较简单：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Moon</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__createSphere</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> geometry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SphereGeometry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">radius</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> texture </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textureLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moonImage </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 更换为 MeshPhongMaterial 材质</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> material </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MeshPhongMaterial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> texture</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 添加 Bump 贴图</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> textureBump </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textureLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moonImageBump </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    material</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bumpMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textureBump</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    material</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bumpScale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Mesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">geometry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> material</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如代码所示，需要注意的是，要先将月球表面的材质替换为 <a href="https://threejs.org/docs/index.html?q=MeshPhongMaterial#api/en/materials/MeshPhongMaterial" target="_blank" rel="noopener noreferrer">MeshPhongMaterial</a> 类型，然后利用 <a href="https://threejs.org/docs/index.html?q=MeshPhongMaterial#api/en/materials/MeshPhongMaterial.bumpMap" target="_blank" rel="noopener noreferrer"><code>bumpMap</code></a> 配置再叠加一张 bump 贴图即可。通过解决这个问题可以发现，在 3D 场景中一般可以通过不同类型的材质和相应配置项就可以极低的成本实现“以假乱真”的效果，这也正是 three.js 提供的一项强大的能力。下面的材质特性表格值得作为参考：</p>
<blockquote>
<p><a href="https://threejs.org/manual/#en/material-table" target="_blank" rel="noopener noreferrer">Material Feature Table</a></p>
</blockquote>
<p>到了这里，三大业务组件中的月球组件已经实现了所有的功能，接下来看看月球表面的标签节点如何实现。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="月球表面的标签">月球表面的标签<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E6%9C%88%E7%90%83%E8%A1%A8%E9%9D%A2%E7%9A%84%E6%A0%87%E7%AD%BE" class="hash-link" aria-label="月球表面的标签的直接链接" title="月球表面的标签的直接链接">​</a></h3>
<p>月球表面的标签是由两部分组成的，点节点和文本节点，它们作为一个整体（组）存在。首先，对于文本标签的应用场景，希望文本的视觉效果以通常的 2D 文本展示即可，不需要 3D 立体效果；同时，又希望能拥有 3D 场景中的真实感，即“近大远小”的效果。</p>
<p>对于文本（Text） 的创建，<a href="https://threejs.org/docs/index.html#manual/en/introduction/Creating-text" target="_blank" rel="noopener noreferrer">three.js 的文档</a>有提到多种方案，大致可分类为 DOM 实现、纹理（Texture）、模型、文本几何体（Geometry）、位图字体（Bitmap Fonts），根据示例来看，DOM 实现和位图字体符合需求并且更灵活。综合考虑下来，DOM 实现要更简单方便一些，借助 <a href="https://threejs.org/docs/index.html#examples/en/renderers/CSS3DRenderer" target="_blank" rel="noopener noreferrer">CSS3DRenderer</a> 不仅可以自动将 DOM 元素和 3D 场景中的节点绑定还可以实现“近大远小”的三维场景效果。示例代码：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> CSS3DRenderer </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'three/examples/jsm/renderers/CSS3DRenderer.js'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> CSS3DSprite </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'three/examples/jsm/renderers/CSS3DRenderer.js'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// create</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CSS3DRenderer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bBox </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_dom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBoundingClientRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bBox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bBox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">position </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'absolute'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">top </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pointerEvents </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'none'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_dom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">appendChild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_labelRenderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camera</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// create label node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> geometry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SphereGeometry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> material </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MeshBasicMaterial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  color</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NORMAL_COLOR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  transparent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mesh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Mesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">geometry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> material</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// create label text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> $label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'div'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cssText </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  position</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'relative'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  left</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0px'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  top</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'4px'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'none'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  padding</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0 0 10px 0'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">'-webkit-tap-highlight-color'</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'transparent'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">'user-select'</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'none'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innerHTML </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string html language-html"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string html language-html">  </span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&lt;</span><span class="token template-string html language-html tag" style="color:#00009f">div</span><span class="token template-string html language-html tag" style="color:#00009f"> </span><span class="token template-string html language-html tag attr-name" style="color:#00a4db">class</span><span class="token template-string html language-html tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token template-string html language-html tag attr-value punctuation" style="color:#393A34">"</span><span class="token template-string html language-html tag attr-value" style="color:#e3116c">js-wrapper</span><span class="token template-string html language-html tag attr-value punctuation" style="color:#393A34">"</span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&gt;</span><span class="token template-string html language-html"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string html language-html">    </span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&lt;</span><span class="token template-string html language-html tag" style="color:#00009f">span</span><span class="token template-string html language-html tag" style="color:#00009f"> </span><span class="token template-string html language-html tag attr-name" style="color:#00a4db">class</span><span class="token template-string html language-html tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token template-string html language-html tag attr-value punctuation" style="color:#393A34">"</span><span class="token template-string html language-html tag attr-value" style="color:#e3116c">js-label-content</span><span class="token template-string html language-html tag attr-value punctuation" style="color:#393A34">"</span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&gt;</span><span class="token template-string html language-html"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string html language-html">      标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string html language-html">    </span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&lt;/</span><span class="token template-string html language-html tag" style="color:#00009f">span</span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&gt;</span><span class="token template-string html language-html"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string html language-html">  </span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&lt;/</span><span class="token template-string html language-html tag" style="color:#00009f">div</span><span class="token template-string html language-html tag punctuation" style="color:#393A34">&gt;</span><span class="token template-string html language-html"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string html language-html"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> css3dText </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CSS3DSprite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$label</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mesh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mesh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>额外补充一点，虽然 CSS3DRenderer 渲染器是开箱即用的，但是我们也可以自己完成将 DOM 元素的位置与场景图中 3D 元素节点位置同步的逻辑，参考<a href="https://threejs.org/manual/#en/align-html-elements-to-3d" target="_blank" rel="noopener noreferrer">这篇文档</a>即可。</p>
<p>使用 DOM 实现标签很方便，但有一个本质上的缺陷就是它不属于三维场景的一部分，所以在三维场景中来看，月球表面我们始终只能看到一半，对于另一半的月球表面可认为是在视区外，在这种情况下当标签存在于月球背面时，DOM 节点是不会自动隐藏的，但预期的效果应该是标签不可见的。所以，为了实现预期的效果，需要判断哪些标签是位于月球背面的。尝试了很多的方案后，在 <a href="https://stackoverflow.com/questions/29316832/three-js-how-to-check-if-object-is-behind-a-sphere-not-visible" target="_blank" rel="noopener noreferrer">stackoverflow</a> 看到一个答案，深受启发，才发觉原来利用数学物理知识可以很简单的解决该问题。用一副图来解释该方案：</p>
<p><img loading="lazy" alt="image.png" src="https://wang1212.github.io/assets/images/image-c79f94e16ff1ffae24720e7a47ebabc6.png" width="388" height="436" class="img_ev3q"></p>
<p>如图所示，假设一个人正视前方看向月球表面，那么月球表面距离这个人最近的点必然就是这个人所在位置与月球中心连线与球面的交点（近月点），而可见范围内月球表面距离这个人最远的点则是这个人所在位置与月球表明切线的切点（远月点）的距离。那么，既然知道这个人能看到月球表面的最远距离和每个标签节点距离这个人的距离，经过比较就可以知道标签是在月球正面还是背面，在每一帧刷新的时候进行判断控制标签节点的隐藏显示即可实现预期的效果。</p>
<p>完成标签的绘制后，如何把数十个标签均匀分布在月球表面又是一个难题，当然这个实际上是个很常见的分布规则，经过查阅文档，最终利用<a href="https://stackoverflow.com/questions/60578028/how-can-i-achieve-an-even-distribution-of-sprites-across-the-surface-of-a-sphere" target="_blank" rel="noopener noreferrer">斐波那契球算法</a>比较理想的解决了这个问题。</p>
<p>下面这个是利用该算法实现的一个非常漂亮的示例：</p>
<blockquote>
<p><a href="https://openprocessing.org/sketch/41142" target="_blank" rel="noopener noreferrer">https://openprocessing.org/sketch/41142</a></p>
</blockquote>
<p>算法的 JS 实现：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fibonacciSphere</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  numPoints</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pointIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rnd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> numPoints</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> increment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PI</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pointIndex </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">**</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> phi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pointIndex </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rnd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> numPoints</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> increment</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终，标签的实现效果如下图所示：</p>
<p><img loading="lazy" alt="screenshot2.jpg" src="https://wang1212.github.io/assets/images/screenshot2-08aa4a4405afd5bc270ef0c2d2ce43ec.jpg" width="437" height="395" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="标签节点之间的飞线">标签节点之间的飞线<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E9%A3%9E%E7%BA%BF" class="hash-link" aria-label="标签节点之间的飞线的直接链接" title="标签节点之间的飞线的直接链接">​</a></h3>
<p>可交互的应用总是能给用户带来更好的使用体验，因此标签节点被设计为是可以点击交互的，当点击标签时则选中该标签，多个选中的标签根据顺序将两两之间出现一条飞线。总的来说，飞线的需求其实很简单，两个标签点连成一条曲线，当然也有一些细节上的要求，飞线不能穿过球体以及飞线要看起来有流动的效果。</p>
<p>将问题拆解开来看，首先是曲线的绘制，three.js 提供了诸如 <a href="https://threejs.org/docs/index.html#api/en/extras/curves/CatmullRomCurve3" target="_blank" rel="noopener noreferrer">CatmullRomCurve3</a>、<a href="https://threejs.org/docs/index.html#api/en/extras/curves/CubicBezierCurve3" target="_blank" rel="noopener noreferrer">CubicBezierCurve3</a> 等几类三维曲线的实现，为了满足飞线不穿过球体，用 CatmullRomCurve3 实现要简单很多，在两点之间给一些插值的点即可，具体实现参考了<a href="https://github.com/RainManGO/3d-earth/blob/main/lib/src/earth/flyLine.ts#L60" target="_blank" rel="noopener noreferrer">一个 3D 地球的开源项目</a>代码。但是，在尝试实现后，发现没有预期的效果好，而且点的插值策略并不好掌握，尤其是当两个标签位于两极时，曲线的弯曲夹角非常明显，并不像一个平滑的曲线一样。如下图所示：</p>
<p><img loading="lazy" alt="screenshot3.png" src="https://wang1212.github.io/assets/images/screenshot3-c18df9b7cadc49b8533d3ad329e2b6f3.png" width="513" height="164" class="img_ev3q"></p>
<p>那么换一种方案的话，其实贝塞尔曲线在线型上是非常理想的效果，一开始也是简单做了尝试，发现一方面控制点很不好找，另一方面也是标签在两极时线会出现穿过球体的现象。在查阅资料的过程中，发现 3D 地球是一个很经典的 Web 3D 应用场景，而 GitHub 新首页的 3D 地球也是基于 three.js 做的，而且其官方还发布了如何构建该组件的<a href="https://github.blog/2020-12-21-how-we-built-the-github-globe/" target="_blank" rel="noopener noreferrer">博客文章</a>。</p>
<p>由博文来看，GitHub 官方做了大量的细节优化，而其飞线这是用三次贝塞尔曲线实现的。当年 GitHub 发布新首页上的这个 3D 地球组件时，也风靡一时，引起了大量的开发者去复刻它。所以，开头提到的专门用来开发 3D 球应用的工具库 <a href="https://github.com/vasturiano/three-globe" target="_blank" rel="noopener noreferrer">three-globe</a> 就被我找到了。在简略的查看了其源码后，专门仔细研究了一下其<a href="https://github.com/vasturiano/three-globe/blob/master/src/layers/arcs.js#L286" target="_blank" rel="noopener noreferrer">飞线的实现代码</a>，也是参考这个实现最终完成了 3D 月球组件的飞线效果。效果如下：</p>
<p><img loading="lazy" alt="screenshot4.jpg" src="https://wang1212.github.io/assets/images/screenshot4-e274101b3ba7dec50caa2f620e567b51.jpg" width="482" height="451" class="img_ev3q"></p>
<p>其中，比较关键的一段代码是先计算出贴着球面的曲线，然后根据该曲线上特殊的两个点坐标进行向量缩放得到贝塞尔曲线的控制点，参考代码如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// * 贴着球面的曲线</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// see https://github.com/vasturiano/three-globe/blob/master/src/layers/arcs.js#L286</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calcSphereArc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">startVec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endVec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> angle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startVec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">angleTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endVec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getGreatCirclePoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    angle </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> startVec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// points exactly overlap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Vector3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addVectors</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              startVec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiplyScalar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              endVec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiplyScalar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">divideScalar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">angle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sphereArc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Curve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sphereArc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getPoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> getGreatCirclePoint</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sphereArc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sphereArc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calcSphereArc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 这里根据两个标签节点位置之间的夹角大小来优化控制点的位置，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 避免在两个标签点距离很近时，飞线弧度过大，且离月球表面很远</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.25</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.75</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">distanceDivRadius </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.15</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">distanceDivRadius </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.25</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">distanceDivRadius </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.25</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.35</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">distanceDivRadius </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">distanceDivRadius </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.75</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.75</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 得到三次贝塞尔曲线</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// see https://github.com/vasturiano/three-globe/blob/master/src/layers/arcs.js#L271</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> curve </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CubicBezierCurve3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sphereArc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Vector3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiplyScalar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sphereArc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Vector3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiplyScalar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>第二个方面则是实现飞线的流动效果，如果用单纯的曲线几何体，必然是不可能实现流动效果的，此时需要借助 <a href="https://threejs.org/docs/index.html?q=TubeGeometry#api/en/geometries/TubeGeometry" target="_blank" rel="noopener noreferrer">TubeGeometry</a> 和材质更新来实现。具体实现的思路是参考了<a href="http://www.xiaobaigis.com/Home/WebArticle?ID=89" target="_blank" rel="noopener noreferrer">这篇文章</a>。</p>
<p>在初版完成后，针对飞线又提了一个经典的效果需求，即从无到有的生长动画。这个在一些人口迁徙、航线分布等 3D 可视化场景中是非常常见的，GitHub 首页的 3D 地球实际上就有这个动画效果。正因为应用广泛，所在有很多可<a href="https://stackoverflow.com/questions/36426139/incrementally-display-three-js-tubegeometry" target="_blank" rel="noopener noreferrer">参考的资料</a>。这里提到了一个 three.js 非常重要的 <a href="https://threejs.org/docs/index.html#api/en/core/BufferGeometry.setDrawRange" target="_blank" rel="noopener noreferrer">setDrawRange()</a> API，其原理也很简单，因为 3D 场景中的任何几何体表面都是由三角格网组成的，所以一个几何体表面有大量的顶点数据，该 API 就是用来控制实际要渲染几何体表面的哪些顶点数据。换句话说，可以多次调用 setDrawRange 让飞线从一端开始慢慢的增加渲染范围从而实现生长动画。这也是最终选定的方案，因为飞线的生长动画效果的应用场景很简单，采用该方案实现起来成本很低，但是也正因为实现简单，其也有无法精确控制几何体渲染的缺点。对于几何体的部分渲染，实际上还有另一个方案，由于依赖于着色器代码，所以实现成本略高，可参考<a href="https://stackoverflow.com/questions/37090564/how-to-animate-the-drawing-of-a-mesh-in-three-js/37091797#37091797" target="_blank" rel="noopener noreferrer">这篇文章</a>。</p>
<p><img loading="lazy" alt="example2.jpg" src="https://wang1212.github.io/assets/images/example2-f8c1cf7d6404bee03c3018ffad5f733a.jpg" width="472" height="223" class="img_ev3q"></p>
<p>飞线生长动画最终的实现效果可参考文章开头放的动图。</p>
<p>对于飞线来说，还有一个比较棘手的问题需要解决，那就是飞线的发光效果，类似于刚开始提到的月球外发光效果。但是，飞线是没有办法采用之前的方案来实现发光效果的，因为飞线是动态变化的，位置具有不确定性，而且不是规则的曲线。不过不用担心，物体的发光效果是个比较常见的需求，three.js 虽然没有默认支持，但还是提供了一种<a href="https://threejs.org/docs/index.html#examples/en/postprocessing/EffectComposer" target="_blank" rel="noopener noreferrer">后处理的机制</a>来实现此类效果，并且有完整的<a href="https://threejs.org/examples/#webgl_postprocessing_unreal_bloom_selective" target="_blank" rel="noopener noreferrer">示例代码</a>。</p>
<p>采用该方案来实现飞线的发光效果是很容易的，具体的代码基本上将官方示例的源码复制过来就能用。从官方示例的源码中可以看到其实现采用了着色器代码。不过，官方示例源码中的着色器代码会导致一个问题，在设置了场景的透明色背景后会失效，场景的背景会变成黑色，当然社区中也早已有成熟的<a href="https://discourse.threejs.org/t/shader-to-turns-black-into-transparency-bloompass/22351" target="_blank" rel="noopener noreferrer">解决方案</a>可供参考。利用该文章中提到的着色器代码替换掉 <code>UnrealBloomPass.prototype.getSeperableBlurMaterial</code> 函数中的实现即可。至此，飞线发光效果也算是比较圆满的解决了。效果如下图所示：</p>
<p><img loading="lazy" alt="screenshot5.jpg" src="https://wang1212.github.io/assets/images/screenshot5-99aef1b1b35b9f44864a0940d92f33c5.jpg" width="563" height="598" class="img_ev3q"></p>
<p>到了这里，3D 月球组件的大部分功能已经实现了。当然，从文章开头的动图里面看到月球组件会自转，而且有一些额外的元素，比如灯光等。对于这部分东西，是为了后续结合 3D 场景中的交互处理统一讲一下的，因为交互处理是个比较典型的应用场景。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3d-场景下的交互处理">3D 场景下的交互处理<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#3d-%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E4%BA%A4%E4%BA%92%E5%A4%84%E7%90%86" class="hash-link" aria-label="3D 场景下的交互处理的直接链接" title="3D 场景下的交互处理的直接链接">​</a></h2>
<p>对于 Web 3D 应用来说，提供丰富的鼠标和触摸交互能大大提高用户体验，而这些交互并不是 three.js 默认提供的，需要自己编码实现。当然，three.js 官方还是很贴心的提供了一种<a href="https://threejs.org/docs/index.html#api/en/core/Raycaster" target="_blank" rel="noopener noreferrer">光线投射方案（物理拾取）的代码实现</a>，代码非常简洁，可以快速上手。</p>
<p>三维空间中的物体拾取要比二维空间难度大很多，一般来说有两种实现方案：</p>
<ul>
<li>物理拾取</li>
<li>GPU 拾取</li>
</ul>
<p>其中，物理拾取也是 three.js 官方示例代码所采用的方案，其本质是利用交互点和相机形成的射线与场景中的物体逐一进行相交检测来实现物体的拾取。而 GPU 拾取是一种更精准、高效的方案，但代码实现略有难度，通俗一点解释就是将屏幕上每一像素都和在这个像素上渲染的物体对应起来，当鼠标点击到任一像素时，搜索与该像素对应的渲染物体即可拾取到物体。与 GPU 拾取相关的两篇资料（<a href="https://sites.google.com/site/csc8820/educational/picking" target="_blank" rel="noopener noreferrer">How to pick a 3D object?</a> 和 <a href="https://ogldev.org/www/tutorial29/tutorial29.html" target="_blank" rel="noopener noreferrer">3D Picking</a>）值得一读。</p>
<p>所以，最终对比来看，3D 月球组件这种简单场景采用光线投射（物理拾取）方案即可，但官方提供的示例代码未免太过简陋，更进一步来看的话并不属于生产就绪的代码。查看官方文档，会发现每一个对象都继承自 <a href="https://threejs.org/docs/index.html#api/en/core/EventDispatcher" target="_blank" rel="noopener noreferrer">EventDispatcher</a> 类，其提供了标准的事件 API，但没有具体的交互事件实现，为了能在应用层面更好的管理元素节点的事件，需要设计一个事件交互管理类。在思考的同时，发现社区提供了一个不错的工具库 <a href="https://github.com/markuslerner/THREE.Interactive#readme" target="_blank" rel="noopener noreferrer">THREE.Interactive</a>，可以直接拿来用。其 API 设计和使用方式也较为简单，这里举例说明：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> InteractionManager </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'three.interactive'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> interactionManager </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">InteractionManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  camera</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domElement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interactionManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 将需要交互的元素节点添加到交互管理器中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interactionManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cube</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 注册事件处理函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里有一个小细节需要注意一下，为何没有默认开启对场景中所有元素节点的交互支持呢？主要目的还是基于性能优化考虑，射线相交检测的计算也需要耗费一定的性能。</p>
<p>接下来，会介绍一下 3D 月球组件实现过程中交互处理方面的一些核心要点。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="月球自转运动">月球自转运动<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E6%9C%88%E7%90%83%E8%87%AA%E8%BD%AC%E8%BF%90%E5%8A%A8" class="hash-link" aria-label="月球自转运动的直接链接" title="月球自转运动的直接链接">​</a></h3>
<p>根据需求，月球默认状态下是要有自转运动的，同时，一旦用户手指发生交互，自转运动要停止下来，用户手指离开屏幕恢复自转运动。</p>
<p>一般来说，首先考虑的是给月球节点加动画，但交互互斥的逻辑处理并不简单。因为要支持用户的手指触摸交互，以便于用户调整相机视角，应用了官方提供的 <a href="https://threejs.org/docs/index.html?q=OrbitControls#examples/en/controls/OrbitControls" target="_blank" rel="noopener noreferrer">OrbitControls</a>，偶然发现该轨道控制器有一个 <code>autoRotate</code> 配置项可以开启自动旋转，同时还能配置旋转速度，很完美的解决了该问题。</p>
<p>通过这一点可以看出来，为了解决一个旋转动画问题，直接采用节点动画方案的话，实现起来并不简单；反过来利用开箱即用的轨道控制器不断的改变相机视角，也可以实现类似的旋转动画，要简单得多，这是一个特定场景下的完美解决方案（运动是相对的）。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="相机和光源的同步">相机和光源的同步<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E7%9B%B8%E6%9C%BA%E5%92%8C%E5%85%89%E6%BA%90%E7%9A%84%E5%90%8C%E6%AD%A5" class="hash-link" aria-label="相机和光源的同步的直接链接" title="相机和光源的同步的直接链接">​</a></h3>
<p>前面已经提到组（Group）无论在 2D 还是 3D 可视化开发中都是一个重要的概念，也介绍了一些应用场景，同样的在 3D 月球组件开发过程中，利用组非常巧妙的解决了一个难题。</p>
<p>具体问题是，为了使月球表明看起来更真实一些，在可视范围的一个球面定点位置加了一个光源（SpotLight），由于月球是不断的旋转的，光源如果要照射到视区范围的定点位置就得抵消月球的转动量以达到预期效果（即看起来光源不动）。想到这里，似乎要眉头紧锁了，有限的时间内实现该效果还是得费一番功夫。</p>
<p>在经过翻阅文档和网络资料后，发现 three.js 中几乎所有的对象都继承自 object3d 对象（即 Group），那问题瞬间就简化了，我们预期光源和相机的相对位置保持不变，将光源放在相机所属的组中即可。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> spotLight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name constant" style="color:#36acaa">THREE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpotLight</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'#FFFB64'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spotLight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camera</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spotLight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camera</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="screenshot6.jpg" src="https://wang1212.github.io/assets/images/screenshot6-3060c1dc34825e36ac81a4223b88c3f3.jpg" width="439" height="380" class="img_ev3q"></p>
<p>如上图所示，红框中的位置就是光源的照射位置，随着月球的自转运动，光源将一直保持在月球表面的红框位置不移动。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="性能优化">性能优化<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" class="hash-link" aria-label="性能优化的直接链接" title="性能优化的直接链接">​</a></h2>
<p>Web 3D 应用的良好性能体验取决于设备的硬件性能和程序优化能力，尤其对于移动端设备的用户来说，性能的影响因素一般在于开发过程中的所做的优化措施，所以掌握一些比较典型的性能优化方案可以极大的提升用户体验。在开发 3D 月球组件的时候，线上真机测试期间确实发现了性能问题，在采取了一些降级措施后较好的解决了性能问题，在这里简单的列举一下。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="由于-vue-引起的一个插曲">由于 Vue 引起的一个插曲<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E7%94%B1%E4%BA%8E-vue-%E5%BC%95%E8%B5%B7%E7%9A%84%E4%B8%80%E4%B8%AA%E6%8F%92%E6%9B%B2" class="hash-link" aria-label="由于 Vue 引起的一个插曲的直接链接" title="由于 Vue 引起的一个插曲的直接链接">​</a></h3>
<p>首先遇到了一个小插曲，将组件交付给业务前端接入时，本地开发过程中就遇到了很严重的性能问题，但自己在本地却无法复现，经过努力的调试和查阅资料后，才发现是一个较为尴尬的原因。</p>
<p>业务方基于 Vue 框架进行页面开发，在接入组件过程中将实例化后的组件实例变量赋值在了 vue 组件实例的 data 上，鉴于 Vue 是基于类似“脏检查”的机制监听挂载的对象变化，所以组件实例上存在一些频繁变化的对象时（例如相机实例，相机自动的变换视角），页面会产生严重的卡顿问题。</p>
<p>解决方案也非常简单，将组件实例变量不要绑定在 vue 的组件实例上即可。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="渲染策略">渲染策略<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E6%B8%B2%E6%9F%93%E7%AD%96%E7%95%A5" class="hash-link" aria-label="渲染策略的直接链接" title="渲染策略的直接链接">​</a></h3>
<p>如果是静态场景，只需要渲染一次即可，对于可交互和支持动画效果的动态场景，需要多次渲染。官方文档和一些主流动画工具库的教程中，一般都会提到利用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" target="_blank" rel="noopener noreferrer">requestAnimationFrame() API</a> 实现动画循环的代码，如下所示：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">animate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">requestAnimationFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">animate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rotation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rotation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> camera</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">animate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>动画循环是一种非常常见和实现起来很简单的渲染策略，还可以根据需要优化渲染的帧速率（一般 30 帧/s 即可）。但是，这种方案有性能上的劣势，周期性的渲染会导致一些不会频繁更新的元素节点重复渲染（或者执行不必要的代码逻辑），对于复杂的三维场景应用很有可能造成严重的性能问题。</p>
<p>因此，为了解决这个问题，还有一种策略就是按需渲染，那就是在需要重新渲染的时候调用更新逻辑。举例来说，如果是因为某些交互行为触发后才有的动画效果更适合采用按需渲染策略。</p>
<p>事实上，可以很好的将这两种渲染策略结合起来使用，为每一个元素实例暴露一个 <code>update()</code> 方法在动画循环中调用，但在该函数的代码实现中我们可以使用标记位来判断要不要具体执行更新逻辑，而标记位则由相应的一些交互行为触发后改变。这样，就可以很好的将交互处理和元素更新完全解耦，这也是很多绘图工具库（例如 zrender）所采用的方案。</p>
<p>在开发 3D 月球组件的过程中，第一个版本线上真机测试就遇到了性能问题，在一些低端机型上月球卡着无法旋转，组件初始化也很缓慢，将动画循环的帧速率降到 30，并且调整了一些性能参数后，即便是 5 年前发布的中低端机型也能流畅的进行交互。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="贴图资源的内存占用">贴图资源的内存占用<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E8%B4%B4%E5%9B%BE%E8%B5%84%E6%BA%90%E7%9A%84%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8" class="hash-link" aria-label="贴图资源的内存占用的直接链接" title="贴图资源的内存占用的直接链接">​</a></h3>
<p>对于 Web 3D 应用来说，性能是比较敏感的，尤其是内存占用。当使用到纹理（Textures）贴图的时候，需要明确知道加载一张贴图时，对内存的影响程序是怎样的。通过<a href="https://threejs.org/manual/#en/textures" target="_blank" rel="noopener noreferrer">这篇文档</a>，可以了解到一个用来计算图像加载的内存占用量的公式：</p>
<blockquote>
<p>width * height * 4 * 1.33 = bytes</p>
</blockquote>
<p>看到这里，似乎与我们通常的认知不太一样？实际上，图像的物理大小只是影响从网络获取该资源的加载性能，对于内存占用的影响在于其宽高。一般设计师追求高质量的视觉效果，会提供高清二倍图、三倍图，如果不经过二次处理，就会发生加载一个仅 157kb 大小，但宽高为 3024 * 3761 的图片会消耗 60mb 左右的内存，这显然会对运行时性能产生不利影响。</p>
<p>如何既保证内存占用小的同时视觉效果好？目前并没有太好的方法，只能通过肉眼判断是否达到了预期的视觉效果，加载尽可能小的贴图。</p>
<p>除此之外，在 3D 应用中最常见的一个优化措施就是重用纹理（Texture）、材质（Material）、几何（Geometry）资源。在这里的一个应用场景就是，多条飞线节点实例都使用了同一个材质资源。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>3D 月球组件在预期的时间内开发完成并顺利交付并上线发布，值得庆幸。这是首次尝试 3D 组件在简单场景下的应用开发，遇到了一些 Web 3D 开发过程中典型的问题，通过解决这些问题对 Web 3D 开发技术有了更深入的了解，也为后续接触更复杂场景下的开发积累了实践经验。相对于 2D 可视化开发来说，3D 可视化开发的难点在于 3D 场景下有很多新的概念需要去了解和学习，另一方面 three.js 发展了这么多年，已成为一个学习 3D 开发很好的工具库，值得一试。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/3d/web-3d-practical-case-1#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">https://threejs.org/</a></li>
<li><a href="https://threejs.org/manual/#en/fundamentals" target="_blank" rel="noopener noreferrer">https://threejs.org/manual/#en/fundamentals</a></li>
<li><a href="https://threejs.org/docs/index.html?q=OrbitControls#examples/en/controls/OrbitControls" target="_blank" rel="noopener noreferrer">https://threejs.org/docs/index.html?q=OrbitControls#examples/en/controls/OrbitControls</a></li>
<li><a href="https://stackoverflow.com/questions/29316832/three-js-how-to-check-if-object-is-behind-a-sphere-not-visible" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/29316832/three-js-how-to-check-if-object-is-behind-a-sphere-not-visible</a></li>
<li><a href="https://sites.google.com/site/csc8820/educational/picking" target="_blank" rel="noopener noreferrer">https://sites.google.com/site/csc8820/educational/picking</a></li>
<li><a href="https://ogldev.org/www/tutorial29/tutorial29.html" target="_blank" rel="noopener noreferrer">https://ogldev.org/www/tutorial29/tutorial29.html</a></li>
<li><a href="https://github.com/markuslerner/THREE.Interactive#readme" target="_blank" rel="noopener noreferrer">https://github.com/markuslerner/THREE.Interactive#readme</a></li>
<li><a href="https://github.com/vasturiano/three-globe" target="_blank" rel="noopener noreferrer">https://github.com/vasturiano/three-globe</a></li>
<li><a href="https://github.blog/2020-12-21-how-we-built-the-github-globe/" target="_blank" rel="noopener noreferrer">https://github.blog/2020-12-21-how-we-built-the-github-globe/</a></li>
<li><a href="https://stripe.com/blog/globe" target="_blank" rel="noopener noreferrer">https://stripe.com/blog/globe</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/473982513" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/473982513</a></li>
</ul></video>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="Web" term="Web"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="3D" term="3D"/>
        <category label="WebGL" term="WebGL"/>
        <category label="Three.js" term="Three.js"/>
        <category label="实践案例" term="实践案例"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[利用脚本执行 `tsc` 忽略类型检查错误]]></title>
        <id>https://wang1212.github.io/computer-technology/typescript/tools-typescript-use-script-to-ts-types</id>
        <link href="https://wang1212.github.io/computer-technology/typescript/tools-typescript-use-script-to-ts-types"/>
        <updated>2022-08-06T17:33:00.000Z</updated>
        <summary type="html"><![CDATA[TypeScript 作为一个强类型的语言，增强了 JavaScript 编程开发体验，类型定义文件为一个第三方模块的使用体验增色不少，现如今很多 npm 包的发布都内置了对类型定义文件的支持。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-08-13 02:46:00</em></p>
</blockquote>
<p>在发布 npm 包时添加对 TypeScript 类型定义文件的支持会让用户的使用体验增色不少，TypeScript 官方提供了 <code>tsc --emitDeclarationOnly</code> 命令用来生成类型定义文件（<code>.d.ts</code>）。但是，该命令会同时执行类型检查，遇到错误时会报错中断命令行进程，这就使其无法直接集成在 CI 环节在发布 npm 包时自动执行生成类型定义文件的操作。当然，一个解决办法就是解决掉代码中所有的类型检查错误即可，既然讨论到这个问题，必然不会花费额外精力去解决一些历史遗留问题。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tsc --emitDeclarationOnly</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>怎么能让以上脚本在执行时不做类型检查（或者说忽略错误，例如类似 <code>silent</code> 标志位），在查阅了很多资料之后，显然 TypeScript 官方没有对其支持（因为他们认为忽略类型检查错误就失去了使用 TypeScript 的意义），但另一方面前端生态的很多工具链却都一致的推荐使用类 Babel 这种编译方案（不做类型检查），而且有很多开发者是有这样的需求的。在查阅很多资料无果后，突然想到前段时间学习了 Nodejs 的 <code>child_process</code> API，可以用其来写一些工具脚本，最终有了一个待实践的方案：利用 JS 脚本执行该命令，但忽略类型检查错误不让进程中断，这样就可以安全的集成到 CI 环节中。经过实践，确实能达到预期效果，贴出代码：</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> execSync </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'node:child_process'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">argv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> isSilent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'--silent'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isSilent </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">splice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isSilent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isSilent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isSilent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isSilent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'[generate-types] silent mode'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// see https://nodejs.org/dist/latest-v16.x/docs/api/child_process.html#optionsstdio</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">execSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">npx tsc --emitDeclarationOnly </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">args</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation method function property-access" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">' '</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">cwd</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WORKING_DIRECTORY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">encoding</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'utf8'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">stdio</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> isSilent </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ignore'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'inherit'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'inherit'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ignore'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// console.error(error.message);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里实际上是利用 <code>try ... catch</code> 将错误捕获，防止其导致进程异常中断；另外，使用了 <code>stdio</code> 配置项去控制子进程的执行结果信息怎么交由父进程来处理，利用 <code>silent</code> 标志位将所有的输出信息忽略，或者仅忽略掉错误信息，类型检查的结果信息依然可以打印到控制台以做参考。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">node generate-types.cjs --silent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node generate-types.cjs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node generate-types.cjs --watch # 等同于 tsc --emitDeclarationOnly --watch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在实际使用的过程中，发现 CI 环节的 Node 环境中会报错（<code>npx</code> 不存在），解决方案就是将要执行的命令写成 npm 脚本，在 js 脚本中运行 npm 脚本即可，例如：</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// npm 脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">"tsc:types"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"tsc --emitDeclarationOnly"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// js 脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">execSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">npm run tsc:types</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此，利用脚本执行命令可以轻松解决无法控制程序命令行为的问题。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/computer-technology/typescript/tools-typescript-use-script-to-ts-types#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://www.typescriptlang.org/docs/handbook/declaration-files/dts-from-js.html" target="_blank" rel="noopener noreferrer">https://www.typescriptlang.org/docs/handbook/declaration-files/dts-from-js.html</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="工具" term="工具"/>
        <category label="TypeScript" term="TypeScript"/>
        <category label="类型定义" term="类型定义"/>
        <category label="实践案例" term="实践案例"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[前端工程化：对于构建工具链的简单思考]]></title>
        <id>https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain</id>
        <link href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain"/>
        <updated>2022-08-01T21:07:00.000Z</updated>
        <summary type="html"><![CDATA[前端工程化是一个值得了解的方向，从软件开发、测试到部署上线整个环节的深入，可以对软件工程有一个更深刻的理解，对于前端来说，构建工具链是工程化中重要的一环，这里对这么多年接触过得工具做一个简单的总结思考。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-08-06 00:21:00</em></p>
</blockquote>
<p>前端工程化是在做与业务开发完全不同的事情，旨在解决软件工程领域与开发者密切相关的问题，通常会将其与基建开发、DevOps 放在一起讨论。前端开发是复杂的，其结合了 HTML/CSS/JavaScript 3 种语言，甚至还有很多其超集，没有开箱即用的工具链，不像 Java Web 开发、Android 开发等等有官方或者商业领域非常成熟的工具可以利用，一切都源于开源社区的从 0 开始构建。正因如此，前端工程化领域百花齐放，开放与创新展现的淋漓尽致，这也是前端开发者了解学习软件工程的机会。</p>
<p>这里对于前端开发中比较重要的一个环节，即构建工具链，谈谈这么多年来了解与使用了多种工具后的简单思考。怎么理解构建工具链？也许可以想想前端开发中编译、打包、静态资源压缩、静态语法检查、热更新、代码 Lint、测试、类型文件生成……</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="任务运行器与打包工具">任务运行器与打包工具<a href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain#%E4%BB%BB%E5%8A%A1%E8%BF%90%E8%A1%8C%E5%99%A8%E4%B8%8E%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7" class="hash-link" aria-label="任务运行器与打包工具的直接链接" title="任务运行器与打包工具的直接链接">​</a></h2>
<p>在 16、17 年刚开始接触前端构建工具时，最先尝试的则是 gulp.js，当时也了解到 grunt.js 但没有真正的使用过，主要是它们是同类东西，具有可替代性；后来，将 gulp.js 与 webpack(v3) 配合起来用，主要原因还是前者只能处理单个文件，后者可以将多个文件合并（bundle）；再后来，迁移到 webpack(v4) 后替代了 gulp.js 这部分的任务，直接将 gulp.js 移出工具链。</p>
<blockquote>
<p>gulp.js(grunt.js) -&gt; gulp.js + webpack(v3) -&gt; webpack(v4)</p>
</blockquote>
<p>以上是<strong>针对 Web 应用开发</strong>的构建工具的选择变化，即由任务运行器（Task Runner）向打包工具（Bundler）的转变，这些工具的目标是一致的：为 Web 开发建立一个完整的自动化工作流（automate workflow）。那么，为何会发生这样的转变呢？工具是为开发者服务的，Web 前端开发者对于 Web 应用的优化着力点则在于将多个分散的小文件合并为一个大文件，较少 HTTP 请求次数从而提高加载性能以改善用户体验。换句话说，像 gulp.js 这样的任务运行器更大程度上解决的是开发体验问题，可以自动将 JS/CSS 的超集语言（例如 Less/Sass/CoffeeScript）进行编译，对静态资源进行压缩等等；而打包工具在此基础之上，更加契合了前端领域的 Web 应用优化法则，帮开发者包办一切，只需编码即可交付上线。孰好孰坏？孰优孰劣？这不是一个绝对的问题，特定场景下用更适合的工具解决问题即可，但显然，当下 webpack 是可以解决大多数问题的最佳选择。</p>
<p>当然，同一时代下，打包工具不仅只有 webpack，还有 rollup（后续会提到）、Parcel 诸如此类的工具，所以前面说这个领域是百花齐放，开放与创新并存。每个工具都有自己的特点和优势，这里我重点讲讲我自己实际用过的一些工具。</p>
<p>后来，开发一些工具库的时候，尝试了 rollup 这个打包工具。先说一个比较有趣的观点：</p>
<ul>
<li>Web App -&gt; webpack</li>
<li>JS Lib -&gt; rollup</li>
</ul>
<p>这个意思就是打包 Web 应用选 webpack，打包工具库用 rollup。无论这个观点合不合理，但这是一个值得我去尝试 rollup 的理由。鉴于历史原因，一般工具库的构建产物需要包含多种格式（UMD/CJS/ESM），一番体验过后，rollup 可以轻松完成这个任务，反观 webpack 就不是很好处理了。另一方面，rollup 的生态中似乎处理 JS 的工具要多一些，反而处理静态资源，尤其是 CSS、HTML 的优秀工具就很匮乏了，而 webpack 的生态足够繁荣，针对 JS/CSS/HTML 都有相关的优秀工具。说到这里，实际上刚开始提到的观点多少还是有点道理的，两个工具的生态解决问题的侧重点不同。</p>
<p>任务运行器和打包工具的区别是前者处理单个文件，后者处理并合并所有文件，而真正完成编译、压缩、语法检查等等核心任务的则是其它工具（比如 Babel/ESLint/Prettier/TypeScript），通常会以相应的打包工具的插件方式来使用。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="插件">插件<a href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain#%E6%8F%92%E4%BB%B6" class="hash-link" aria-label="插件的直接链接" title="插件的直接链接">​</a></h3>
<p>插件机制是一个程序具备可扩展性和灵活性的关键，各种任务运行器和打包工具均依赖于插件增强自身的能力，所以一个工具的社区生态中优秀插件足够多是非常重要的。这里秉承一个理念：一个工具只解决最关键的一个问题，多个工具组合起来就可以解决特定领域的一类问题，而像 webpack 和 rollup 这样的工具就是用来组合各种各样工具的容器。</p>
<p>以插件的方式解决问题很好，不同的工具解决同样的问题不用重复实现，避免造轮子，减轻了工具维护者的负担，也促进了前端工具生态的繁荣，可以有很多人以不同的方式解决同样的问题（例如 Terser 与 UglifyJS 都可以用来压缩和混淆 JS 代码）。</p>
<p>有人曾想过从 webpack 迁移到 rollup，但以我自身的体验为例，举个例子可以说明，插件有好处亦有坏处。webpack 的生态非常繁荣，当你尝试迁移到 rollup 时想找到对应的替代品，这个过程可能会让你非常沮丧，ESLint 工具可以帮助我们做代码 Lint，webpack 社区中有一个非常优秀的插件（<code>fork-ts-checker-webpack-plugin</code>(v6)）可以将 ESLint 集成到 webpack 工作流中，但 rollup 中似乎找不到一个满意的插件（<code>@rollup/plugin-eslint</code> 已经很久没有维护，且不支持 ESLint 8.x）。这个时候，你是不是会抛出一个疑问：一个工具（比如 ESLint）作为独立的工具库避免了造轮子，但为了适配 webpack、rollup 等众多的打包工具，都需要一一编写插件并持续维护，反而又造了一批轮子？</p>
<p>的确，插件是一个解决问题的好方式，但也有其劣势，每当出现一个新的打包工具，那么就需要复制实现一遍现有打包工具的插件。另一方面，我们也可以思考，将所有的工具集成到打包工具中是否有必要？实际上我最近就面临这个问题。</p>
<p>当我基于 rollup 工具链构建一个用来开发 UI 组件库的工作流时，庞大的第三方依赖让 rollup 在开发模式（watch）下增量编译非常缓慢（4s 以上），经过调试发现是 <code>@rollup/plugin-node-resolve</code> 插件耗费了大量的时间，这也是 rollup 与 webpakc 对待第三方模块实现有所不同的显著差异，基本上无解；另一方面，为了做 TypeScript 的类型检查，这又进一步减缓了增量编译的速度。为了解决庞大依赖项对增量编译的速度巨大影响，尝试换用用 Go 编写的 esbuild 打包工具，在这个迁移过程中对于 CSS 的处理则耗费了很多时间（因为 esbuild 主要还是专注于处理 JS 代码），对于 TypeScript 也不做类型检查。那么，当我们为了解决一个收益很高的问题而迁移到另一个打包工具时，一些收益较低的特性面临不被支持的问题（比如 TypeScript 类型检查），实际上我们可以将辅助性的工具与打包工具解耦，用任务运行器来与打包工具的工作流并行运行即可解决，这也是我所采用的方案。</p>
<blockquote>
<p>rollup + Core(plugin) + Util(plugin) -&gt; rollup + Core(plugin) + Util(task)</p>
</blockquote>
<p>借助 <code>concurrently</code> 这个命令行工具，我们可以将一些辅助性的工具与打包工具并行运行，这样就可以实现开发模式下用 esbuild，生产模式下用 rollup，还能具备 TypeScript 类型检查的能力：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">concurrently --kill-others "node esbuild-watch.cjs" "tsc --noEmit --watch"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">concurrently --kill-others "rollup --config" "tsc --noEmit --watch"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实际上，开发模式使用 esbuild，生产模式使用 rollup 正是打包工具 vite 的底层架构设计。当然，这种方案有其性能劣势，本应该开启一个文件系统的 watch 服务即可，但这里可能会利用诸如 <code>chokidar</code> 这样的 npm 包开启多个 watch 服务，也许操作系统底层对该场景做了优化，但没有深究也就不得而知了。</p>
<p>所以说，当我们使用打包工具替代任务运行器时，刚开始是方便了，但也加强你对该工具的依赖性，后续很难迁移到其它工具链。没有最好的工具，只有更优的方案，满足自己的需求即可。</p>
<p>当然，对于利用插件来组合各种工具解决各类问题的方案，显然有部分人觉得是不满意的，每种工具都有特定的配置项，组合的工具越多，配置起来就越复杂。Rome 试图用一套工具来解决目前前端构建工具领域典型的几个环节的问题，替代 Babel/ESLint/webpack/Prettier/Jest 等等，值得关注。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="用高性能语言解决性能问题">用高性能语言解决性能问题<a href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain#%E7%94%A8%E9%AB%98%E6%80%A7%E8%83%BD%E8%AF%AD%E8%A8%80%E8%A7%A3%E5%86%B3%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98" class="hash-link" aria-label="用高性能语言解决性能问题的直接链接" title="用高性能语言解决性能问题的直接链接">​</a></h2>
<p>当前端的项目日益复杂，庞大的代码库使用 JS 编写的构建工具处理起来显得有些力不从心，毕竟 JS 是一个脚本语言，有性能上的劣势。这个时候用一些高性能语言编写构建工具来解决前端工具链中存在的性能问题成为了一个有趣的方案，当前的代表作是 esbuild（用 Go 编写） 和 swc（用 Rust 编写）。为什么说它有趣呢？作为 Web 开发者，应该很少会有人想到利用一些比 JS 较为低级的高性能语言去编写工具，这个有很高的学习成本；另一方面，这些工具也确实以非常强的性能优势很好的解决了前端工具链中的性能问题，值得尝试。</p>
<p>以第三方语言编写的工具，目前有一个劣势就是能参与到社区生态中贡献的开发者群体将占比很小，对比 esbuild 和 rollup、webpack 这些用 JS 编写的工具的代码库贡献者数量就有一个非常直观的感受。其次，这些工具利用性能优势解决了核心性能问题，其它问题还依赖于前端社区中现有的工具来完成，而不是重复造轮子（实际上也不现实），而 esbuild 的插件机制实际上还处于实验阶段，而正如官方文档中所说的，用 JS 编写的插件将不具备 Go 的性能优势，esbuild 的方案就是暴露一些耗费性能的程序 API（用 Go 实现）供 JS 代码调用，以达到一个折衷的效果，既支持引入前端生态的现有工具，也不太会降低性能。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何定义工具">如何定义工具<a href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7" class="hash-link" aria-label="如何定义工具的直接链接" title="如何定义工具的直接链接">​</a></h2>
<p>另一方面，前端工程化所做的一切应该是致力于提高开发者体验、让流程标准化、自动化，从而提高开发效率和保证质量。那么，在这个过程中，所引入的一些工具链不应该成为开发者的“绊脚石”，应该结合团队实际情况选择合适的工具和方案，当团队成员都在迎合工具时，实际上已经违背了前端工程化的初衷了。</p>
<p>这里其实可以以前端一个比较有争论的工具来举例，即 TypeScript。首先，TypeScript 在前端领域的应用是越来越广泛了，这是一个趋势，说明其在前端生态中有一定的重要性和作用。一般来说，有一部分人认为应该用 TypeScript，可以提高代码质量，而另一部分人则认为不应该用 TypeScript，因为会降低编码效率。当把 TypeScript 引入编译工具链时，一般来说有两种选择，一种是类 Babel 方案（不做类型检查），而另一种就是官方 <code>tsc</code> 方案，出于简单性后者会更方便一些，但后者会做类型检查更加严格，这就意味着开发过程中你要解决所有的错误才能让代码编译通过（这在一些场景下实际上是开发者的噩梦，至少我是这样觉得的并有所体会）。简单来说，引入 TypeScript 的目的是提高代码质量，但以什么样的方式和程度去实践这个事情其实是有争议的。对于体验过早期前端开发的人来说，我觉得 TypeScript 主要是解决了两个问题，第一个就是类型定义所带来的代码智能提示功能（以前是需要边写边查文档的），第二个就是类型检查可以帮助我们提前发现问题并修复（但这里并不代表开发者需要迎合严格的类型检查，应该更多的是作为一种参考信息）。由于前端开发（尤其是业务开发）有其复杂性，不适合生搬硬套类 Java 这种严格的静态类型语言标准，将 TypeScript 作为工具引入，而不是为了迎合 TypeScript 的标准花费精力解决额外的事情（或者说历史遗留问题）。对于 TypeScript 来说，更大的一个作用就是可以用来生成类型定义文件（<code>.d.ts</code>），官方提供的命令行工具（<code>tsc --emitDeclarationOnly</code>）会在发生类型检查错误时报错中断，这就使其很难集成在 CI 中（例如 npm 包发布前自动生成类型定义文件），期望官方能提供一个忽略类型检查错误的命令行标志位，但奈何没有（在查找资料的过程中发现有很多开发者有类似的需求），无奈之下只能以 JS 脚本的方式去运行该命令同时忽略掉类型检查错误以集成在 CI 中。</p>
<p>所以说，前端生态中，很多优秀的工具官方推荐或者默认是选择不做类型检查的编译方案的（类 Babel），我想这也是有原因的，且是被大多数人所认同的。工程化实施的过程中，引入任何工具链的最终效果应该是“帮助”开发者，而不是带来“绊脚石”的副作用，完美的类型检查是我们所追求的，但投入产出比是需要重点考虑的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>随着 <code>wasm</code>、ES Module、HTTP2/HTTP3 等的推广与普及，前端工程化领域还在不断演进，Bundle 与 Bundle less 将如何发展值得期待。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="https://wang1212.github.io/computer-technology/web-frontend/tools-web-fee-toolchain#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://gulpjs.com/" target="_blank" rel="noopener noreferrer">https://gulpjs.com/</a></li>
<li><a href="https://gruntjs.com/" target="_blank" rel="noopener noreferrer">https://gruntjs.com/</a></li>
<li><a href="https://webpack.js.org/" target="_blank" rel="noopener noreferrer">https://webpack.js.org/</a></li>
<li><a href="https://rollupjs.org/" target="_blank" rel="noopener noreferrer">https://rollupjs.org/</a></li>
<li><a href="https://esbuild.github.io/" target="_blank" rel="noopener noreferrer">https://esbuild.github.io/</a></li>
<li><a href="https://swc.rs/" target="_blank" rel="noopener noreferrer">https://swc.rs/</a></li>
<li><a href="https://parceljs.org/" target="_blank" rel="noopener noreferrer">https://parceljs.org/</a></li>
<li><a href="https://babeljs.io/" target="_blank" rel="noopener noreferrer">https://babeljs.io/</a></li>
<li><a href="https://vitejs.dev/" target="_blank" rel="noopener noreferrer">https://vitejs.dev/</a></li>
<li><a href="https://rome.tools/" target="_blank" rel="noopener noreferrer">https://rome.tools/</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="工具" term="工具"/>
        <category label="Web" term="Web"/>
        <category label="Web 前端" term="Web 前端"/>
        <category label="构建工具链" term="构建工具链"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[桥接模式：跨平台的事件机制设计]]></title>
        <id>https://wang1212.github.io/computer-technology/program-architecture-design/bridge-mode-design-of-cross-platform-event-mechanism</id>
        <link href="https://wang1212.github.io/computer-technology/program-architecture-design/bridge-mode-design-of-cross-platform-event-mechanism"/>
        <updated>2022-06-12T22:22:00.000Z</updated>
        <summary type="html"><![CDATA[最近在做图表组件库的技术调研的架构方案设计，参考了很多开源库的源码，发现其中跨平台的事件机制设计很值得学习，如果要用软件设计模式来解释，那大概就是桥接模式了。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-06-12 22:22:00</em></p>
</blockquote>
<p>对于 Web 的图表组件库来说，一些功能比较强大的开源库，渲染层可以支持 DOM、SVG、Canvas、WebGL 等多个平台的环境，而图表库的很多功能的实现都和渲染层紧密相关。</p>
<p>最近，在参考学习一些开源的图表组件库时，发现在跨平台设计中，事件机制的实现很有意思，所以在这里以最简化的代码来解释和记录一下这个方案。如果要用经典的软件设计模式来解释，大概就是<strong>桥接模式</strong>了。</p>
<p><strong>桥接模式（Bridge Pattern）</strong> 将一个功能的实现拆分为抽象（Abstraction）和实现（Implementor），让其相互独立的扩展和定义，借助该模式可以设计一种平台无关的软件架构。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="事件机制">事件机制<a href="https://wang1212.github.io/computer-technology/program-architecture-design/bridge-mode-design-of-cross-platform-event-mechanism#%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6" class="hash-link" aria-label="事件机制的直接链接" title="事件机制的直接链接">​</a></h2>
<p>事件机制是软件设计中最基础、最为常见的一种设计，对于 Web 图表组件库来说要提供一些处理用户交互（例如点击、拖动、右键点击等）的机制。一个典型的事件模型类如下：</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  _handlerMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">off</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于用户来说，对外暴露 <code>on()</code> 和 <code>off()</code> 方法来注册和取消事件，而图表库内部需要完成事件触发（<code>emit()</code>）的实现，而这里与渲染层耦合。以渲染层为 DOM 实现来举例，支持点击事件：</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Chart</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 渲染层为 DOM 实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__renderer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DOMRenderer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">off</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">off</span><span class="token punctuation" style="color:#393A34">(</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">__bindEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ! 事件触发（绑定）与渲染层耦合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__renderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">domElem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">otherArgs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="跨平台实现">跨平台实现<a href="https://wang1212.github.io/computer-technology/program-architecture-design/bridge-mode-design-of-cross-platform-event-mechanism#%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="跨平台实现的直接链接" title="跨平台实现的直接链接">​</a></h3>
<p>参考<strong>桥接模式</strong>，这里可以把图表类中的事件机制实现拆分为抽象（<code>Handler</code>）和实现（<code>HandlerProxy</code>），前者管理用户注册的事件池，后者负责特定平台的事件触发实现。示例代码如下：</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Handler</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">handlerProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__handlerProxy</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> handlerProxy</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 注册事件到代理类中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__handlerProxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ! 触发用户注册的事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DOMHandlerProxy</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">renderer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__renderer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> renderer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">__bindEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 根据渲染层的平台实现事件绑定，以 DOM 实现为例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">renderer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">domElem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'click'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ! 触发 Handler 注册的事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于图表类来说，<code>Handler</code> 类提供了完整的事件机制，但其内部把具体平台相关的事件触发实现交给 <code>HandlerProxy</code> 类去实现。这样就完成了事件机制的实现与特定平台实现分离的目标，针对不同平台实现不同的<code>HandlerProxy</code> 类即可。现在图表类的代码应该如下：</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Chart</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 渲染层为 DOM 实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__renderer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DOMRenderer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DOMHandlerProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__renderer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">off</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter spread operator" style="color:#393A34">...</span><span class="token parameter">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">off</span><span class="token punctuation" style="color:#393A34">(</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在来看，图表类中之前事件触发实现与平台相关的代码已经被独立出去，且可以根据不同的渲染层实现完成无缝衔接。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/computer-technology/program-architecture-design/bridge-mode-design-of-cross-platform-event-mechanism#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>以上就是利用桥接模式对跨平台的事件机制的简化设计，解决此类问题时，最重要的是划分<strong>抽象</strong>和<strong>实现</strong>两部分。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考">参考<a href="https://wang1212.github.io/computer-technology/program-architecture-design/bridge-mode-design-of-cross-platform-event-mechanism#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Bridge_pattern" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Bridge_pattern</a></li>
<li><a href="https://refactoringguru.cn/design-patterns/bridge" target="_blank" rel="noopener noreferrer">https://refactoringguru.cn/design-patterns/bridge</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="程序架构设计" term="程序架构设计"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[从贝塞尔曲线的计算感受数学建模的魅力]]></title>
        <id>https://wang1212.github.io/tools/tools-animation-math</id>
        <link href="https://wang1212.github.io/tools/tools-animation-math"/>
        <updated>2022-04-30T22:49:00.000Z</updated>
        <summary type="html"><![CDATA[最近在做可视化相关的东西，需要计算贝塞尔曲线上一点的坐标位置，从这个解决过程中感受到了数学建模的魅力。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-05-03 20:38:00</em></p>
</blockquote>
<p>最近在做前端可视化相关的东西，在完成动画效果时，遇到一个不是很好处理的问题，需要让一个元素在画布上以曲线的轨迹进行运动。因为动画这块之前基本也没有怎么接触过，做的也都是简单的线性动画效果，所以碰到这个需求点的时候觉得是有点难度的。</p>
<p>其实，要真的实现按照一定曲线轨迹运动的效果倒也不难，毕竟圆、椭圆方程在平时做布局计算的时候用的也挺多的。但是，用圆或者椭圆计算曲线相当于是找了个特殊场景，不具备通用性；另一方面，说到曲线的绘制，贝塞尔曲线是绕不开的，这也是非常值得考虑的方案。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="动画帧计算">动画帧计算<a href="https://wang1212.github.io/tools/tools-animation-math#%E5%8A%A8%E7%94%BB%E5%B8%A7%E8%AE%A1%E7%AE%97" class="hash-link" aria-label="动画帧计算的直接链接" title="动画帧计算的直接链接">​</a></h2>
<p>一段动画实际上是由多个静态帧组成的，当帧率达到人眼不可分辨的程度时（比如 60 FPS），就感觉像是一个无缝连续的视频在流畅的播放。而某一静态帧的状态用数学公式来表达如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">y = F(t) (0 &lt;= t &lt;= 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么对于一个物体从 <strong>x0</strong> 运动到 <strong>x1</strong>，如何计算 <strong>t</strong> 时刻的位置？按照我的思路来看，可以转化为以下数学公式：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">F(t) = (x1 - x0)*t + x0 (0 &lt;= t &lt;= 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这么算其实是没错的，但这个公式在数学建模的角度来看，其实是不好的，后面以计算贝塞尔曲线上一点的坐标为例解释为什么。这里先给出线性贝塞尔曲线数学公式：</p>
<blockquote>
<p>B(t) = (1 - t)<em>P0 + t</em>P1 (0 &lt;= t &lt;= 1)</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="贝塞尔曲线">贝塞尔曲线<a href="https://wang1212.github.io/tools/tools-animation-math#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF" class="hash-link" aria-label="贝塞尔曲线的直接链接" title="贝塞尔曲线的直接链接">​</a></h2>
<p>贝塞尔曲线（Bézier curve）在工业设计领域是一个非常重要的存在，应用非常广泛，在计算机图形学领域中贝塞尔曲线也有很好的支持，例如 Canvas API 原生就有提供贝塞尔曲线的绘制接口。</p>
<blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/bezierCurveTo" target="_blank" rel="noopener noreferrer">CanvasRenderingContext2D.bezierCurveTo()</a></p>
</blockquote>
<p>贝塞尔曲线从概念上来看是很难理解的，如何转化为数学公式来计算贝塞尔曲线，而这个过程是什么样的，刚开始理解起来也是比较抽象的。先来看看其（二次贝塞尔曲线）数学定义：</p>
<blockquote>
<p><img loading="lazy" alt="Quadratic Bezier Curve Formula" src="data:image/png;base64,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" title="Quadratic Bezier Curve Formula" width="653" height="41" class="img_ev3q"></p>
</blockquote>
<p>其中 <strong>P0</strong>、<strong>P1</strong>、<strong>P2</strong> 分别为起点、控制点、终点。</p>
<p>那么，有了公式计算二次贝塞尔曲线上一点按理来说已经可以实现了，但在这里之所以用贝塞尔曲线这个比较难理解的数学模型来探讨，其实是为了最终得到一个简化的具有普适性的解决动画帧计算的数学模型。对于熟悉动画计算的人来说，很多文档中对于开头提出的问题给出的数学公式为以下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">F(t) = (1 - t)*x0 + t*x1 (0 &lt;= t &lt;= 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个时候，你会发现无论是以上公式，还是一次、二次或更高次的贝塞尔曲线公式中都有一个类似的元素即 <strong>1 - t</strong>。当然，公式都是相互推导以不同形式展现的，即：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">F(t) = (1 - t)*x0 + t*x1 = (x1 - x0)*t + x0 (0 &lt;= t &lt;= 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>公式相等是本质，但不同的展现形式蕴含的思维模式不同（或者说有没有利用好数学建模来进行问题的抽象）。以上面的公式来分析，前者表达的是 <strong>x0</strong> 与 <strong>x1</strong> 分别在 <strong>t</strong> 时刻状态的叠加，后者则表达的是起始状态 <strong>x0</strong> 叠加从 <strong>x0</strong> 运动到 <strong>x1</strong> 过程中 <strong>t</strong> 时刻的状态。从其蕴含的思维模式来分析，<strong>前者关注的是结果，后者则先分析过程再得到结果。</strong></p>
<p>其实，说到这里，我觉得一个好的数学建模思维的魅力已经体现出来了，动画帧计算应尽可能的简单且关注核心问题，不要被过程所迷惑，这也是为何很多文档中的公式包含 <strong>1 - t</strong> 元素的原因。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="计算二次贝塞尔曲线上一点的坐标">计算二次贝塞尔曲线上一点的坐标<a href="https://wang1212.github.io/tools/tools-animation-math#%E8%AE%A1%E7%AE%97%E4%BA%8C%E6%AC%A1%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E4%B8%8A%E4%B8%80%E7%82%B9%E7%9A%84%E5%9D%90%E6%A0%87" class="hash-link" aria-label="计算��二次贝塞尔曲线上一点的坐标的直接链接" title="计算二次贝塞尔曲线上一点的坐标的直接链接">​</a></h3>
<p>接下来，结合 <a href="https://zh.wikipedia.org/zh-cn/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A#%E4%BA%8C%E6%AC%A1%E6%9B%B2%E7%B7%9A" target="_blank" rel="noopener noreferrer">wiki 中构建贝塞尔曲线一节的动态图</a> 对二次贝塞尔曲线的形成过程有个直观的理解，利用以上思路对计算二次贝塞尔曲线上一点的坐标这个问题进行数学建模：</p>
<p>给出 <strong>P0</strong>、<strong>P1</strong>、<strong>P2</strong> 分别为起点、控制点、终点，曲线上的点是控制点由 P0 运动到 P1 过程中点 P01 与终点由 P1 运动到 P2 过程中点 P12 连线上的点，转为数学公式如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">P01 = (1 - t)P0 + tP1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P12 = (1 - t)P1 + tP2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P012 = (1 - t)P01 + tP12</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样就得到了 <strong>t</strong> 时刻曲线上的点坐标为 <strong>P012</strong>，根据推导 P012 其实就等于前面给出的二次贝塞尔曲线的公式 <strong>B(t)</strong> 。按照这个思路和数学建模的思维，计算三次、四次贝塞尔曲线上点的坐标就很简单，不断叠加 t 时刻的状态即可。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="结语">结语<a href="https://wang1212.github.io/tools/tools-animation-math#%E7%BB%93%E8%AF%AD" class="hash-link" aria-label="结语的直接链接" title="结语的直接链接">​</a></h2>
<p>总结成一句话来说，用数学建模的思维把复杂问题高度抽象成简单问题，再用简单的方案去解决复杂的问题。对于动画帧计算来说，就要把问题高度抽象成起始状态与终止状态在 t 时刻状态的叠加，不应该关注过程，最终就可以得出线性轨迹和曲线轨迹的计算本质上都是一个线性插值的过程，无论多么复杂的轨迹问题都是要用线性插值的方案来解决。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考">参考<a href="https://wang1212.github.io/tools/tools-animation-math#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://zh.wikipedia.org/zh-cn/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A" target="_blank" rel="noopener noreferrer">https://zh.wikipedia.org/zh-cn/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A</a></li>
<li><a href="https://www.cnblogs.com/fangsmile/articles/11642607.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/fangsmile/articles/11642607.html</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="工具" term="工具"/>
        <category label="动画" term="动画"/>
        <category label="数学" term="数学"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[如何更好的维护开源项目]]></title>
        <id>https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools</id>
        <link href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools"/>
        <updated>2022-04-22T22:53:00.000Z</updated>
        <summary type="html"><![CDATA[一直以来开源精神被开发者所推崇，维护开源项目需要注意什么，有哪些工具可以帮助我们解决通用的复杂问题，值得学习了解。]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p><em>最后更新于 2022-05-03 16:43:00</em></p>
</blockquote>
<p>一直以来，开源精神被开发者所推崇，开源项目为开发者提供了不用付出除时间以外任何成本就可以学习前沿技术的最佳途径，另一方面，我们应该思考开源为何会成功，在全球开发者参与协作的情况下代码仓库为何能保持整洁、不出现大规模冲突而奔溃，上下游依赖如何管理，这背后有既定的规范进行强约束，也有一系列社区工具来完成复杂而有价值的工作。所以，从参与或者维护开源项目的角度来看，这些<strong>社区公认的最佳实践</strong>值得我们了解，学习这些东西也能在一定程度上提高我们管理项目的能力。</p>
<p>以下内容属于经验积累，持续更新，仅供参考。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="许可证license">许可证（License）<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%AE%B8%E5%8F%AF%E8%AF%81license" class="hash-link" aria-label="许可证（License）的直接链接" title="许可证（License）的直接链接">​</a></h2>
<p>代码本质上是开发者的创作成果，具有<strong>专利权</strong>，所以开发者应该意识到自己所享有的权利，同时在使用其他人所提供的代码时避免侵权。作为开源项目，有必要在开源之前选择一个合适的<strong>许可证</strong>，提前<strong>声明权利和义务</strong>（一般作为单独的 <em>LICENSE</em> 文本文件保存），避免在后期陷入麻烦之中，GitHub 官方为我们提供了一个简单的工具站点：</p>
<blockquote>
<p><a href="https://choosealicense.com/" target="_blank" rel="noopener noreferrer">Choose an open source license</a></p>
</blockquote>
<p>另外，在如今很多人喜欢自由创作并分享的氛围下，创作者应该了解一个比较有用的许可证类型：</p>
<blockquote>
<p><a href="https://creativecommons.org/" target="_blank" rel="noopener noreferrer">Creative Commons licenses</a></p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="贡献者许可协议cla">贡献者许可协议（CLA）<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%B4%A1%E7%8C%AE%E8%80%85%E8%AE%B8%E5%8F%AF%E5%8D%8F%E8%AE%AEcla" class="hash-link" aria-label="贡献者许可协议（CLA）的直接链接" title="贡献者许可协议（CLA）的直接链接">​</a></h2>
<p>对于一些大型开源项目，尤其是有商业公司背景的项目，个人开发者想参与贡献首先面临的是要签署相应的<strong>贡献者许可协议（Contributor License Agreement, CLA）</strong>，该协议本质上是要求开发者授予他们所贡献代码段的永久专利权，目前来看这是商业公司规避法律风险的一种通用做法。</p>
<p>作为示例，以下是 Facebook(Meta) 公司的贡献者许可协议：</p>
<blockquote>
<p><a href="https://code.facebook.com/cla" target="_blank" rel="noopener noreferrer">Contributing to Meta Open Source Projects</a></p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文档">文档<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E6%96%87%E6%A1%A3" class="hash-link" aria-label="文档的直接链接" title="文档的直接链接">​</a></h2>
<p>我们知道，在全球开发者参与协作的背景下，口头沟通是不现实的（即便有条件，长期来看我认为依赖口头沟通是一件非常低效的事情），所以文档也就成了最关键的东西，无论对于使用开源项目的开发者还是维护开源项目的开发者，文档都成了达成共识的关键，各种类型的文档也成为了默认的规范。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="markdown">Markdown<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#markdown" class="hash-link" aria-label="Markdown的直接链接" title="Markdown的直接链接">​</a></h3>
<p>首先，文档的载体是比较重要的，因为其必须满足易于使用、富有表现力的特点。Markdown 已是开发者群体使用最为广泛的文档格式了，目前许多创作者也用该格式来写博客文章，其最终可以被转换为 HTML 文件从而以更好的视觉效果发布在网络。</p>
<p>Markdown 格式没有统一的规范，由于平台差异和实现差异，在一些细节处有略微不同或者增强，但通过了解 <strong>CommonMark Spec</strong> 来学习使用 Markdown 应该是一个好的开始：</p>
<blockquote>
<p><a href="https://commonmark.org/" target="_blank" rel="noopener noreferrer">https://commonmark.org/</a></p>
</blockquote>
<p>这里有一个专门学习 Markdown 的网站，可以了解一些 Markdown 的扩展语法和相关的工具：</p>
<blockquote>
<p><a href="https://www.markdownguide.org/" target="_blank" rel="noopener noreferrer">Markdown Guide</a></p>
</blockquote>
<p>除此之外，为了使用 Markdown 编写文档更方便，有一种将 <a href="https://reactjs.org/docs/introducing-jsx.html" target="_blank" rel="noopener noreferrer">JSX</a> 和 Markdown 相结合的增强格式：</p>
<blockquote>
<p><a href="https://mdxjs.com/" target="_blank" rel="noopener noreferrer">MDX</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="自述文档">自述文档<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%87%AA%E8%BF%B0%E6%96%87%E6%A1%A3" class="hash-link" aria-label="自述文档的直接链接" title="自述文档的直接链接">​</a></h3>
<p>优秀的开源项目不仅仅只提供源代码，更附带了一系列非常有价值的文档，其中最基本且不可或缺的应该是<strong>自述文档（READMEs）</strong> 了（通常命名为 <em>README.md</em>），项目维护者应该通过这个文档向人们传递一些项目的基本信息，例如项目名称、作者的动机、建立项目的原因、解决了什么问题、简单的使用方法、注意事项、问题反馈途径、许可证、其它相关文档的引用链接等。</p>
<p>关于该文档的一些详细信息，可以看看 GitHub 官方对其的描述：</p>
<blockquote>
<p><a href="https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-readmes" target="_blank" rel="noopener noreferrer">About READMEs</a></p>
</blockquote>
<p>也许，这里有一个更好的站点可以学习了解：</p>
<blockquote>
<p><a href="https://www.makeareadme.com/" target="_blank" rel="noopener noreferrer">Make a README</a></p>
</blockquote>
<p>当然，对于一些刚开始的简单项目，可以借助一些社区提供的工具来自动生成自述文档，例如：</p>
<blockquote>
<p><a href="https://github.com/kefranabg/readme-md-generator" target="_blank" rel="noopener noreferrer">readme-md-generator</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="架构概述文档">架构概述文档<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0%E6%96%87%E6%A1%A3" class="hash-link" aria-label="架构概述文档的直接链接" title="架构概述文档的直接链接">​</a></h3>
<p>对于一个大型复杂的项目来说，开发者参与贡献有一定的困难，这个困难体现在开发者无法了解庞大项目背后的整体架构设计理念和原则，难以评估局部代码改动对整体项目的影响，所以项目中如果拥有一个<strong>架构概述文档（Architecture Overview）</strong> 那么这种状况就会得到改善。</p>
<p>最简单的方式就是在项目中提供一个 <em>ARCHITECTURE.md</em>，通过下面这篇文章也可以进一步了解：</p>
<blockquote>
<p><a href="https://matklad.github.io/2021/02/06/ARCHITECTURE.md.html" target="_blank" rel="noopener noreferrer">ARCHITECTURE.md</a></p>
</blockquote>
<p>作为示例，这是 Google 的一个项目的架构概述文档：</p>
<blockquote>
<p><a href="https://github.com/google/crosvm/blob/main/ARCHITECTURE.md" target="_blank" rel="noopener noreferrer">crosvm Architecture</a></p>
</blockquote>
<p>事实上，架构概述文档不止是解决了贡献者参与困难的问题，也是一种非常有价值的学习资料，作为一种行业的通用方案，向社区公开其背后的架构设计理念，可以促进技术改进和变革。这里，以 React Native 的文档为例：</p>
<blockquote>
<p><a href="https://reactnative.dev/architecture/overview" target="_blank" rel="noopener noreferrer">React Native Architecture Overview</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="行为准则声明">行为准则声明<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%A1%8C%E4%B8%BA%E5%87%86%E5%88%99%E5%A3%B0%E6%98%8E" class="hash-link" aria-label="行为准则声明的直接链接" title="行为准则声明的直接链接">​</a></h3>
<p>开源社区之所以发展到如今的规模，是因为参与其中的人们遵守共同的价值观、具备契约精神，所以声明你的态度以及表明你的价值观会消除人们的不信任感，鼓励人们积极参与进来。</p>
<p><strong>开源社区的行为准则（A Code of Conduct for Open Source Communities）</strong> 声明通常以 <em>CODE_OF_CONDUCT.md</em> 文档的形式存在于项目中，通过以下站点了解更多信息：</p>
<blockquote>
<p><a href="https://www.contributor-covenant.org/" target="_blank" rel="noopener noreferrer">Contributor Covenant</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="贡献指南文档">贡献指南文档<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%B4%A1%E7%8C%AE%E6%8C%87%E5%8D%97%E6%96%87%E6%A1%A3" class="hash-link" aria-label="贡献指南文档的直接链接" title="贡献指南文档的直接链接">​</a></h3>
<p>开源项目参与协作的开发者来自全球各个国家，他们有不同的习惯和文化，如何保证项目代码的整洁、风格统一、项目的管理不会由此崩溃，需要指导贡献者按照既定的规则完成整个过程的工作，社区通用的做法是在项目中提供一份<strong>贡献指南（Contributing guidelines）</strong> 文档，一般被命名为 <em>CONTRIBUTING.md</em>。</p>
<p>具体内容参考以下 Mozilla Science Lab 的文档：</p>
<blockquote>
<p><a href="https://mozillascience.github.io/working-open-workshop/contributing/" target="_blank" rel="noopener noreferrer">How to Build a CONTRIBUTING.md</a></p>
</blockquote>
<p>作为示例，Atom 项目的贡献指南非常具有参考意义：</p>
<blockquote>
<p><a href="https://github.com/atom/atom/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">Contributing to Atom</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rfc-文档">RFC 文档<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#rfc-%E6%96%87%E6%A1%A3" class="hash-link" aria-label="RFC 文档的直接链接" title="RFC 文档的直接链接">​</a></h3>
<p><strong>RFC (Request for Comments) 文档</strong>在互联网世界是一个重要的存在，早期是网络技术标准工作组用来在互联网上针对即将推出的技术标准征求意见进行记录的，最著名的组织是 Internet Engineering Task Force (IETF)。</p>
<p>事实上，这种模式已在各行各业被采纳，作为开源项目来说，项目的主导方一般在大版本更新中预期引入的重大变化或者新的功能等也会采用 RFC 文档的形式向所有的贡献者和使用者等群体征求意见并记录，这也是项目维护团队针对项目进一步的发展方向达成共识的关键所在。</p>
<p>作为示例，以下是 React.js 官方的 RFC 文档仓库：</p>
<blockquote>
<p><a href="https://github.com/reactjs/rfcs" target="_blank" rel="noopener noreferrer">https://github.com/reactjs/rfcs</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="国际化与本地化">国际化与本地化<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E5%9B%BD%E9%99%85%E5%8C%96%E4%B8%8E%E6%9C%AC%E5%9C%B0%E5%8C%96" class="hash-link" aria-label="国际化与本地化的直接链接" title="国际化与本地化的直接链接">​</a></h3>
<p>开源社区是全球开发者都可以参与其中的，所以文档方面应当考虑到<a href="https://en.wikipedia.org/wiki/Internationalization_and_localization" target="_blank" rel="noopener noreferrer"><strong>国际化与本地化（i18n &amp; L10n）</strong></a>的有限支持，这里为什么说有限支持呢？因为文档的翻译事实上是比较耗费时间成本的一件事情，而且要有高质量的文档翻译则需要了解相应国家文化的人来完成这项工作，所以折衷方案是视项目情况而定，一般来说至少提供一份用国际通用语言英语编写的文档，再提供一份用项目核心开发者群体所在国家的主流语言编写的文档。</p>
<p>文档的命名应该相同，不同的是本地化的文档用相应的<a href="https://www.w3.org/International/articles/language-tags/" target="_blank" rel="noopener noreferrer">语言标签</a>（参考<a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/language-strings" target="_blank" rel="noopener noreferrer">微软文档</a>）进行标识，例如：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">README.zh-CN.md</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="源代码管理">源代码管理<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E6%BA%90%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86" class="hash-link" aria-label="源代码管理的直接链接" title="源代码管理的直接链接">​</a></h2>
<p>源代码管理通常借助 SVN 和 Git 等类似版本控制软件进行，现今主流的方案多是采用 Git，所以下面的内容可能更多的倾向于 Git 相关。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="git-工作流">Git 工作流<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#git-%E5%B7%A5%E4%BD%9C%E6%B5%81" class="hash-link" aria-label="Git 工作流的直接链接" title="Git 工作流的直接链接">​</a></h3>
<p>Git 非常适合多人协作的项目源代码管理，而协作的模式要视具体项目情况而定，一般来说社区推荐的有以下几种 <strong>Git 工作流（Workflow）</strong>，可以进行学习了解，根据情况采用或改进：</p>
<ul>
<li><a href="https://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener noreferrer">Git Flow - A successful Git branching model</a></li>
<li><a href="https://docs.gitlab.com/ee/topics/gitlab_flow.html" target="_blank" rel="noopener noreferrer">GitLab Flow</a></li>
<li><a href="http://githubflow.github.io/" target="_blank" rel="noopener noreferrer">GitHub Flow</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="提交信息格式">提交信息格式<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E6%8F%90%E4%BA%A4%E4%BF%A1%E6%81%AF%E6%A0%BC%E5%BC%8F" class="hash-link" aria-label="提交信息格式的直接链接" title="提交信息格式的直接链接">​</a></h3>
<p>Git 的提交日志信息可能是除通过看源代码以外最快速最直观的了解某次提交做了哪些变动、对项目产生了哪些影响的最佳途径，所以项目拥有一个达成共识的<strong>提交信息格式（Commit Message Format）</strong> 的约束规则是保证项目质量的一大举措。</p>
<p>社区有一个推荐的提交信息格式的规范：</p>
<blockquote>
<p><a href="https://www.conventionalcommits.org/" target="_blank" rel="noopener noreferrer">Conventional Commits</a></p>
</blockquote>
<p>作为示例，Google 的 Angular 项目的提交信息格式规范非常具有参考意义：</p>
<blockquote>
<p><a href="https://github.com/angular/angular/blob/master/CONTRIBUTING.md#-commit-message-format" target="_blank" rel="noopener noreferrer">Angular Commit Message Format</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码审查">代码审查<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5" class="hash-link" aria-label="代码审查的直接链接" title="代码审查的直接链接">​</a></h3>
<p>开源项目的代码贡献是受严格控制的，一般来说参与者分为维护者（Maintainer）和贡献者（Contributor），贡献者对项目代码所做的更改需要提交 PR（Pull Request，GitLab 为 Merge Request）经过维护者的<strong>代码审查（Code Review）</strong> 后才能成功合并到项目中。</p>
<p>对于代码审查的意义，不仅在于控制项目的代码质量，还有益于项目成员之间进行相互学习。社区有非常多的代码审查指南可以进行参考，这里推荐谷歌的工程实践进行学习：</p>
<blockquote>
<p><a href="https://google.github.io/eng-practices/" target="_blank" rel="noopener noreferrer">Google Engineering Practices Documentation</a></p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="软件发布的生命周期">软件发布的生命周期<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%BD%AF%E4%BB%B6%E5%8F%91%E5%B8%83%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" class="hash-link" aria-label="软件发布的生命周期的直接链接" title="软件发布的生命周期的直接链接">​</a></h2>
<p>无论是使用软件还是维护软件项目的开发者，都应该了解<strong>软件发布的生命周期</strong>，尽管现今的 Web 应用弱化了软件版本的概念。遵循行业惯例的好处是可以大大降低人们的理解成本，也能更好的融入社区，以下是关于软件发布的生命周期的详细信息，可以作为很好的参考进行学习：</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Software_release_life_cycle" target="_blank" rel="noopener noreferrer">Software release life cycle</a></p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="语义化版本控制">语义化版本控制<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%AF%AD%E4%B9%89%E5%8C%96%E7%89%88%E6%9C%AC%EF%BF%BD%E6%8E%A7%E5%88%B6" class="hash-link" aria-label="语义化版本控制的直接链接" title="语义化版本控制的直接链接">​</a></h3>
<p>互联网软件会随着时间变化不断的迭代更新以提供新的功能和更好的用户体验，前面所说的软件发布的生命周期是一个概念性的东西，真正运用在软件发布过程中的则是一种推荐性规范<strong>语义化版本控制（Semantic Versioning）</strong>：</p>
<blockquote>
<p><a href="https://semver.org/" target="_blank" rel="noopener noreferrer">https://semver.org/</a></p>
</blockquote>
<p>为了便于管理软件发布和版本控制，不同语言的生态中都有基于该规范所开发的一些自动化发布管理工具，借助这些工具则可以在遵守规范的同时省心省力，也不会因为手动管理导致出错。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="变更日志">变更日志<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E5%8F%98%E6%9B%B4%E6%97%A5%E5%BF%97" class="hash-link" aria-label="变更日志的直接链接" title="变更日志的直接链接">​</a></h3>
<p>随着软件版本的迭代发布，应该维护一个<strong>变更日志（Changelog）</strong>，因为软件的版本号变动可传递的信息是有限的，尤其是对于大版本更新、重要问题修复以及破坏性更新等需要更多更详细的信息，这样便于依赖方、使用方对于是否同步更新版本进行决策，也对旧版本用户迁移到新版本有一个比较明确的向导信息。</p>
<p>开源项目的代码仓库中，比较常见的变更日志文件通常为 <em>CHANGELOG.md</em>，这也是一个社区公认的最佳实践，更多信息可以从以下站点进行了解：</p>
<blockquote>
<p><a href="https://keepachangelog.com/" target="_blank" rel="noopener noreferrer">keep a changelog</a></p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="devops">DevOps<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#devops" class="hash-link" aria-label="DevOps的直接链接" title="DevOps的直接链接">​</a></h2>
<p>开源项目不同于商业公司的内部项目，缺少非常多的资源来保证项目的质量和管理，例如自动化测试、自动发布、自动漏洞监测修复等等，或者我们可以称之为 <a href="https://en.wikipedia.org/wiki/DevOps" target="_blank" rel="noopener noreferrer"><strong>DevOps</strong></a> 工具链。不过，好在现今有非常多的工具免费提供给开源项目使用，借助这些工具，我们可以让开源项目和商业公司的项目一样拥有规范的开发、测试、交付流程，从而保证项目质量，也能节省更多的时间专注于编码，而不是花费更多时间去做管理项目这种有价值但复杂又通用的事情。</p>
<p>下面推荐一些可以加入 CI/CD 工具链中的工具帮助开发者自动化完成开源项目的诸多管理工作。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cicd-平台">CI/CD 平台<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#cicd-%E5%B9%B3%E5%8F%B0" class="hash-link" aria-label="CI/CD 平台的直接链接" title="CI/CD 平台的直接链接">​</a></h3>
<ul>
<li><a href="https://circleci.com/" target="_blank" rel="noopener noreferrer">CircleCI</a></li>
<li><a href="https://github.com/features/actions" target="_blank" rel="noopener noreferrer">GitHub Actions</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码审查与质量评估">代码审查与质量评估<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%B8%8E%E8%B4%A8%E9%87%8F%E8%AF%84%E4%BC%B0" class="hash-link" aria-label="代码审查与质量评估的直接链接" title="代码审查与质量评估的直接链接">​</a></h3>
<ul>
<li><a href="https://about.codecov.io/" target="_blank" rel="noopener noreferrer">Codecov</a></li>
<li><a href="https://app.codacy.com/" target="_blank" rel="noopener noreferrer">Codacy</a></li>
<li><a href="https://www.codefactor.io/" target="_blank" rel="noopener noreferrer">CodeFactor</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="依赖更新">依赖更新<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E4%BE%9D%E8%B5%96%E6%9B%B4%E6%96%B0" class="hash-link" aria-label="依赖更新的直接链接" title="依赖更新的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.renovatebot.com/" target="_blank" rel="noopener noreferrer">Renovate</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="漏洞监测和修复">漏洞监测和修复<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E6%BC%8F%E6%B4%9E%E7%9B%91%E6%B5%8B%E5%92%8C%E4%BF%AE%E5%A4%8D" class="hash-link" aria-label="漏洞监测和修复的直接链接" title="漏洞监测和修复的直接链接">​</a></h3>
<ul>
<li><a href="https://snyk.io/" target="_blank" rel="noopener noreferrer">Snyk</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="版本控制和发布">版本控制和发布<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%92%8C%E5%8F%91%E5%B8%83" class="hash-link" aria-label="版本控制和发布的直接链接" title="版本控制和发布的直接链接">​</a></h3>
<ul>
<li><a href="https://semantic-release.gitbook.io/semantic-release/" target="_blank" rel="noopener noreferrer">semantic-release</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="api-文档管理">API 文档管理<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#api-%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86" class="hash-link" aria-label="API 文档管理的直接链接" title="API 文档管理的直接链接">​</a></h3>
<ul>
<li><a href="https://hoppscotch.io/" target="_blank" rel="noopener noreferrer">hoppscotch</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="其它">其它<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E5%85%B6%E5%AE%83" class="hash-link" aria-label="其它的直接链接" title="其它的直接链接">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="财务管理">财务管理<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E8%B4%A2%E5%8A%A1%E7%AE%A1%E7%90%86" class="hash-link" aria-label="财务管理的直接链接" title="财务管理的直接链接">​</a></h3>
<p>很多时候，开源是免费且无偿的，但开源的本质是源代码自由而不是技术免费，开源社区发展到至今繁荣的程度与参与者遵守共同的价值观有很大的关系，开源社区为改变世界的技术变革付出了很多。另一方面，正是在这种强包容性和开放性的社区环境氛围中，开源事业才发展的越来越好，现今有很多人可以因为自己的开源项目给别人带来商业价值而获得财务收益，对于更懂代码的开发者来说，如何进行项目的财务收益管理和分配成了个一个棘手的问题，而社区也给出了相应的方案来帮助项目维护者改善这个局面。</p>
<ul>
<li><a href="https://opencollective.com/opensource" target="_blank" rel="noopener noreferrer">Open Source Collective</a></li>
<li><a href="https://github.com/sponsors" target="_blank" rel="noopener noreferrer">GitHub Sponsors</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资料">参考资料<a href="https://wang1212.github.io/computer-technology/tools/tools-maintain-open-source-projects-with-tools#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://the-turing-way.netlify.app/" target="_blank" rel="noopener noreferrer">The Turing Way</a></li>
<li><a href="https://opensource.guide/" target="_blank" rel="noopener noreferrer">Open Source Guides</a></li>
</ul>]]></content>
        <author>
            <name>不如怀念</name>
            <email>mrwang1212@126.com</email>
            <uri>https://github.com/wang1212</uri>
        </author>
        <category label="计算机技术" term="计算机技术"/>
        <category label="工具" term="工具"/>
        <category label="项目管理" term="项目管理"/>
        <category label="开源" term="开源"/>
    </entry>
</feed>