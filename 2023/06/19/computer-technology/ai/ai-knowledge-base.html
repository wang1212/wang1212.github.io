<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">结合 AI 技术构建可视化知识库的尝试 | 不如怀念</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="结合 AI 技术构建可视化知识库的尝试 | 不如怀念"><meta data-rh="true" name="description" content="在 OpenAI 引领 AI 技术潮流的当下，LLM 成为很多企业跃跃欲试并尝试进行商业化的一个重要技术领域，其中结合 AI 技术进行知识库构建成为了开源社区在该领域最成功的经典案例，恰好团队也有机会基于此进行探索尝试。"><meta data-rh="true" property="og:description" content="在 OpenAI 引领 AI 技术潮流的当下，LLM 成为很多企业跃跃欲试并尝试进行商业化的一个重要技术领域，其中结合 AI 技术进行知识库构建成为了开源社区在该领域最成功的经典案例，恰好团队也有机会基于此进行探索尝试。"><meta data-rh="true" name="keywords" content="计算机技术,AI,向量搜索,LangChain,实践案例"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-06-19T22:30:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/wang1212"><meta data-rh="true" property="article:tag" content="计算机技术,AI,向量搜索,LangChain,实践案例"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base"><link data-rh="true" rel="alternate" href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://wang1212.github.io/2023/06/19/computer-technology/ai/ai-knowledge-base" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="不如怀念 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="不如怀念 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.d922b5cb.css">
<script src="/assets/js/runtime~main.aa5213f4.js" defer="defer"></script>
<script src="/assets/js/main.3ffab7ee.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">不如怀念</b></a><a class="navbar__item navbar__link" href="/archive">归档</a><a class="navbar__item navbar__link" href="/record">记录</a><a class="navbar__item navbar__link" href="/timeline">历程</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">近期文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/16/life/tourism/tourism-shaoxing">绍兴鲁迅故居之行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/10/computer-technology/web-frontend/morph-animation">解析 ECharts 的 UniversalTransition 动画</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/08/27/life/tourism/tourism-nanjing">此行南京</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/07/22/tools/notes-app">谈谈笔记记录和知识管理工具</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2023/06/19/computer-technology/ai/ai-knowledge-base">结合 AI 技术构建可视化知识库的尝试</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/05/28/computer-technology/nodejs/nodejs-loader">通过 Node.js 自定义加载器运行代码</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/computer-technology/web-frontend/api/webgpu-gpgpu">WebGPU – Web 平台的通用计算 API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/computer-technology/3d/forward-rendering-and-deferred-rendering">3D 开发：正向渲染与延迟渲染</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/03/12/life/tourism/tourism-huangshan">黄山之行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/03/05/life/reading/index">速读《设计原本》</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="在 OpenAI 引领 AI 技术潮流的当下，LLM 成为很多企业跃跃欲试并尝试进行商业化的一个重要技术领域，其中结合 AI 技术进行知识库构建成为了开源社区在该领域最成功的经典案例，恰好团队也有机会基于此进行探索尝试。"><meta itemprop="keywords" content="计算机技术,AI,向量搜索,LangChain,实践案例"><header><h1 class="title_f1Hy" itemprop="headline">结合 AI 技术构建可视化知识库的尝试</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-06-19T22:30:00.000Z" itemprop="datePublished">2023年6月19日</time> · <!-- -->阅读需 13 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/wang1212" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/wang1212.png" alt="不如怀念" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/wang1212" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">不如怀念</span></a></div><small class="avatar__subtitle" itemprop="description">Web 前端工程师 (Web Front-end Engineer)</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><blockquote>
<p><em>最后更新于 2024-01-27 20:37:00</em></p>
</blockquote>
<p>在 OpenAI 引领 AI 技术潮流的当下，LLM 成为很多企业跃跃欲试并尝试进行商业化的一个重要技术领域，其中结合 AI 技术进行知识库构建成为了开源社区在该领域最成功的经典案例，恰好团队也有机会基于此进行探索尝试。</p>
<p>有此机会也是因为目前业务侧也在探索 AI 落地的应用场景和可能性，利用社区已经成熟的经验在团队基建方面进行探索尝试也是熟悉 AI 相关技术应用的一个很好的途径。</p>
<p>目前，利用 LLM 构建知识库，其核心是<strong>基于向量搜索（Vector Search）和机器学习（Machine Learning）技术提升搜索的效率和准确性</strong>，简单来说传统的搜索是基于关键字匹配，当你无法了解查找的目标的信息和关键字时，你可以以你认为相近的描述信息进行搜索，这大大增强了搜索体验。</p>
<blockquote>
<p>关于向量搜索推荐参考 <a href="https://www.elastic.co/cn/what-is/vector-search" target="_blank" rel="noopener noreferrer">Elastic 官方对其的描述</a>。</p>
</blockquote>
<p>站在业务层面来看，数据可视化属于一个细分领域，有一定的专业门槛，基于此提升普通开发者使用文档的搜索体验是再合适不过了。初期，我们主要关注的是文本数据的检索。</p>
<p>具体的技术方案可以大致概括为以下两个部分。</p>
<p>首先，准备数据集构建向量数据库：</p>
<!-- -->
<p>然后，实现向量搜素和 LLM 文本生成的查询链路：</p>
<!-- -->
<p>为了快速验证技术可行性，我们直接采用 <a href="https://www.langchain.com/" target="_blank" rel="noopener noreferrer">LangChain</a> 框架来构建产品原型。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="构建向量数据库">构建向量数据库<a href="#构建向量数据库" class="hash-link" aria-label="构建向量数据库的直接链接" title="构建向量数据库的直接链接">​</a></h2>
<p>虽然整个技术路径开源社区已有大量的成熟经验可供参考，但<strong>关键环节在于数据预处理和分割策略要视需求和具体情况而进行选择，其会对最终效果产生显著影响。</strong></p>
<p>近半年来，关于 AI 相关的商业化尝试也是一直备受关注，有一家创业公司的产品 <a href="https://markprompt.com/" target="_blank" rel="noopener noreferrer">MarkPrompt</a> 目标是解决技术文档的检索问题，与我们的需求非常相似。在其一篇<a href="https://markprompt.com/blog/content-structure" target="_blank" rel="noopener noreferrer">博客文章</a>中我们了解到了他们是如何处理技术文档的，再结合一些其它参考资料，我们最终选择也采用类似的策略，即<strong>技术文档一般大多以 Markdown 格式存在且篇幅较少，对其按标题为单位进行分割，构建向量数据库记录。</strong></p>
<p>此时，有三个问题待解决：</p>
<ol>
<li>收集原始数据，得到 Markdown 格式数据集；</li>
<li>实现对 Markdown 文件按标题进行分割；</li>
<li>选择向量数据库。</li>
</ol>
<p>第一步，考虑到方便后期对原始文档进行引用，不直接用文档的 Markdown 源文件，而是将在线文档网页抓取下来，利用工具库将 HTML 文件先进行预处理，去掉多余无用信息再转换为 Markdown 格式，同时保存其<strong>元信息</strong>。由于技术文档本身的简单性，效果还是不错的，这样也能 兼顾到源文件不是 Markdown 格式的数据。</p>
<p>第二步，由于 LangChain 框架提供了一些处理文档的组件，所以寄希望于最好能用现成的方案，遗憾的是当时 LangChain 的 JavaScript 实现中并没有提供相关组件。不过，在查看 LangChain 的 Python 版本文档时，却发现了社区近期贡献的一个组件（<code>MarkdownHeaderTextSplitter</code>）刚好能满足按标题对 Markdown 文件进行分割的需求，这就致使了我们数据处理环节本来打算使用更熟悉的 Node 技术栈实现，结果最终全用了 Python 技术栈，不过代码倒也不复杂。</p>
<p>问题基本都顺利解决了，来到最后一步，向量数据库的选择。经过简单的调研，了解到 Redis 支持向量搜索，但目前公司内部运维资源具体情况也不太清楚，而且没有前端团队有过类似成功案例可借鉴，考虑到为了快速验证可行性和迅速上线测试版，寻求基于本地文件的向量数据库实现，Python 倒是有，但是目前线上只有 Node 服务环境，只能先看看有没有 Node 方案。</p>
<p>经过查找，找到了<strong>基于本地文件的向量数据库</strong>的 Node 方案 <a href="https://github.com/Stevenic/vectra#readme" target="_blank" rel="noopener noreferrer">vectra</a>，尴尬的是该库目前是 0.0.1 版本，而且发布于半个月前，不得已的情况下仔细看了其文档和源码大致的实现后，确定应该问题不大能满足基本需求，做了简单的验证后遂采用了此方案。</p>
<p>至此，以上三个问题均已解决。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文本嵌入服务">文本嵌入服务<a href="#文本嵌入服务" class="hash-link" aria-label="文本嵌入服务的直接链接" title="文本嵌入服务的直接链接">​</a></h2>
<p>实际上，这里面有一个重要的概念需要简单的解释一下，即文本数据是如何转换为向量数据入库的？</p>
<p>这里使用到了机 器学习领域的<a href="https://en.wikipedia.org/wiki/Word_embedding" target="_blank" rel="noopener noreferrer">嵌入（Embeddings）</a>技术，简单来说就是<strong>将高维数据编码为低维空间的向量数据，在这里就是将文本数据编码为向量数据（数学表示形式）。</strong></p>
<p>公司内部提供了 OpenAI 的嵌入服务接口资源，但是每个团队有配额，考虑到上线后的调用量会消耗大量的 Token，做缓存的话初期比较麻烦，随即转变思路，结合前段时间对 AI 技术应用的一些细节的了解，<strong>一个大任务往往是由多个环节，甚至多个大小模型配合完成的</strong>，那嵌入服务是否也可以寻找开源方案自己部署呢？</p>
<p>当然是可以的，LangChain 就提供了基于 Google 的 <a href="https://js.langchain.com/docs/integrations/text_embedding/tensorflow" target="_blank" rel="noopener noreferrer">TensorFlow 机器学习框架的本地离线嵌入方案</a>，其使用的是 Google <a href="https://www.kaggle.com/models/google/universal-sentence-encoder/frameworks/TensorFlow1/variations/lite/versions/1" target="_blank" rel="noopener noreferrer">universal-sentence-encoder</a> 模型的 Lite 版本。</p>
<p>这个时候，出现了一个致命问题，即 Google 的这个嵌入模型只对英文进行了预训练，虽然在文档中找到了支持其它语言的方案，但效果肯定无法达到预期。比较幸运的是，公司内部有做 NLP 的团队，经过和同事沟通过后，推荐了<strong>专门针对中文做了预训练优化</strong>的 <a href="https://huggingface.co/moka-ai/m3e-small" target="_blank" rel="noopener noreferrer">m3e 嵌入模型</a>，经过简单调研和验证其效果确实不错。在 Hugging Face 上可以看到其有两个版本，我们初期选择了 m3e-small 版本，资源占用低，效果也能达到预期。</p>
<p>至此，使用 <a href="https://www.sbert.net/" target="_blank" rel="noopener noreferrer">SentenceTransformer</a> 框架配合 Flask 服务框架，寥寥几行代码就能实现在本地部署一个文本嵌入服务。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sentence_transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SentenceTransformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># model = SentenceTransformer(&#x27;moka-ai/m3e-base&#x27;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SentenceTransformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;moka-ai/m3e-small&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/embeddings&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">embeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;texts&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;code&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;data&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;vectors&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="实现查询链路">实现查询链路<a href="#实现查询链路" class="hash-link" aria-label="实现查询链路的直接链接" title="实现查询链路的直接链接">​</a></h2>
<p>接下来就是实现具体的查询链路了，也是结合 LLM 构建知识库的优势所在。</p>
<p><strong>首先将用户的问句文本进行嵌入，转换为向量数据，再通过相似度匹配从之前构建的向量数据库中召回 TopK（一般选择 5 条）的记录，然后根据这些结果构建提示词（Prompt）模板，调用 LLM 的文本生成服务，获取到模型的输出结果，再做一定处理后返回给用户。</strong></p>
<p>整条查询链路较长，实际上最简化的版本不需要工程手段介入，但效果会比较差，之所以需要工程手段介入是因为根据具体的需求场景可以定制化，得到更好的结果。</p>
<p>例如，在构建向量数据库的过程中我们保留了每条记录的一些元信息，例如链接引用，这样就可以在得到 LLM 的输出后，再添 加相关的链接信息，帮助用户在得不到预期的结果时，还可以主动查看相关的引用信息。</p>
<p>另外，为了使结果的信息展现更丰富（包含纯文本、代码片段、链接、图片等），会在提示词模板中要求 LLM 返回 Markdown 格式的结果，我们再渲染到页面上，为了保证结果的稳定性，我们还会对 LLM 的 Markdown 输出做进一步的校正。</p>
<p>所以，查询链路的实现关键在于<strong>如何结合多种能力将同一件事情做的更好</strong>。随着 LLM 的 Token 限制越来越宽容，我们可以在提示词中加入更多内容，这也催生了大量的优化手段来确保输出的质量，其中值得关注的是 RAG（retrieval augmented generation，检索增强生成）技术，可以参考 StackOverflow 一篇<a href="https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/" target="_blank" rel="noopener noreferrer">博文</a>对其的介绍。</p>
<p>总的来说，借此机会我们对构建 AIGC 产品涉及的技术有了进一步的了解，认识到目前 LLM 的能力域和局限性，当然更多的是 AI 技术带来的产品构建的想象力是值得我们对其持续关注的。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="参考资源">参考资源<a href="#参考资源" class="hash-link" aria-label="参考资源的直接链接" title="参考资源的直接链接">​</a></h2>
<ul>
<li><a href="https://www.elastic.co/cn/what-is/vector-search" target="_blank" rel="noopener noreferrer">https://www.elastic.co/cn/what-is/vector-search</a></li>
<li><a href="https://en.wikipedia.org/wiki/Word_embedding" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Word_embedding</a></li>
<li><a href="https://js.langchain.com/docs/get_started/introduction" target="_blank" rel="noopener noreferrer">https://js.langchain.com/docs/get_started/introduction</a></li>
<li><a href="https://flask.palletsprojects.com/en/" target="_blank" rel="noopener noreferrer">https://flask.palletsprojects.com/en/</a></li>
<li><a href="https://huggingface.co/moka-ai/m3e-small" target="_blank" rel="noopener noreferrer">https://huggingface.co/moka-ai/m3e-small</a></li>
<li><a href="https://www.sbert.net/" target="_blank" rel="noopener noreferrer">https://www.sbert.net/</a></li>
<li><a href="https://www.tensorflow.org/js" target="_blank" rel="noopener noreferrer">https://www.tensorflow.org/js</a></li>
<li><a href="https://www.kaggle.com/models/tensorflow/universal-sentence-encoder" target="_blank" rel="noopener noreferrer">https://www.kaggle.com/models/tensorflow/universal-sentence-encoder</a></li>
<li><a href="https://github.com/Stevenic/vectra#readme" target="_blank" rel="noopener noreferrer">https://github.com/Stevenic/vectra#readme</a></li>
<li><a href="https://markprompt.com/blog/content-structure" target="_blank" rel="noopener noreferrer">https://markprompt.com/blog/content-structure</a></li>
<li><a href="https://www.pinecone.io/learn/chunking-strategies/" target="_blank" rel="noopener noreferrer">https://www.pinecone.io/learn/chunking-strategies/</a></li>
<li><a href="https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/" target="_blank" rel="noopener noreferrer">https://stackoverflow.blog/2023/10/18/retrieval-augmented-generation-keeping-llms-relevant-and-current/</a></li>
</ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/计算机技术">计算机技术</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/向量搜索">向量搜索</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/lang-chain">LangChain</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/实践案例">实践案例</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/wang1212/wang1212.github.io/tree/master/blog/computer-technology/ai/2023-06-19-ai-knowledge-base.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/2023/07/22/tools/notes-app"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">谈谈笔记记录和知识管理工具</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2023/05/28/computer-technology/nodejs/nodejs-loader"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">通过 Node.js 自定义加载器运行代码</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#构建向量数据库" class="table-of-contents__link toc-highlight">构建向量数据库</a></li><li><a href="#文本嵌入服务" class="table-of-contents__link toc-highlight">文本嵌入服务</a></li><li><a href="#实现查询链路" class="table-of-contents__link toc-highlight">实现查询链路</a></li><li><a href="#参考资源" class="table-of-contents__link toc-highlight">参考资源</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://github.com/wang1212/awesome-favorites-list" target="_blank" rel="noopener noreferrer" class="footer__link-item">收藏 列表<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://wang1212.github.io/the-book-of-ruby/" target="_blank" rel="noopener noreferrer" class="footer__link-item">The Book Of Ruby(zh)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="mailto:mrwang1212@126.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://github.com/wang1212" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://gitee.com/i_wang1212" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Blog. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>