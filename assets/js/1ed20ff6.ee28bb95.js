"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([[4475],{40651:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var s=t(85893),a=t(11151);const i={title:"\u89e3\u6790 Konva \u8bbe\u8ba1\uff1a\u4e8b\u4ef6\u7cfb\u7edf",date:new Date("2023-08-08T21:21:00.000Z"),update:new Date("2024-06-02T19:47:00.000Z"),authors:"wang1212",tags:["\u8ba1\u7b97\u673a\u6280\u672f","Web \u524d\u7aef","Konva.js","Canvas","\u6e90\u7801\u5206\u6790"],keywords:["\u8ba1\u7b97\u673a\u6280\u672f","Web \u524d\u7aef","Konva.js","Canvas","\u6e90\u7801\u5206\u6790"],description:"\u7ed8\u56fe\u5f15\u64ce\u652f\u6301\u4e30\u5bcc\u4ea4\u4e92\u7684\u524d\u63d0\u662f\u62e5\u6709\u4e00\u5957\u4e8b\u4ef6\u7cfb\u7edf\uff0c\u800c\u5728\u753b\u5e03\u4e2d\u5982\u4f55\u62fe\u53d6\u5143\u7d20\u662f\u5b9e\u73b0\u7684\u5173\u952e\uff0c\u4ece Konva.js \u7684\u6e90\u7801\u6765\u770b\u770b\u5176\u4e8b\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u8bbe\u8ba1\u7684\u3002"},r=void 0,o={permalink:"/2023/08/08/computer-technology/web-frontend/konva/event-system",editUrl:"https://github.com/wang1212/wang1212.github.io/tree/master/blog/computer-technology/web-frontend/konva/2023-08-08-event-system.md",source:"@site/blog/computer-technology/web-frontend/konva/2023-08-08-event-system.md",title:"\u89e3\u6790 Konva \u8bbe\u8ba1\uff1a\u4e8b\u4ef6\u7cfb\u7edf",description:"\u7ed8\u56fe\u5f15\u64ce\u652f\u6301\u4e30\u5bcc\u4ea4\u4e92\u7684\u524d\u63d0\u662f\u62e5\u6709\u4e00\u5957\u4e8b\u4ef6\u7cfb\u7edf\uff0c\u800c\u5728\u753b\u5e03\u4e2d\u5982\u4f55\u62fe\u53d6\u5143\u7d20\u662f\u5b9e\u73b0\u7684\u5173\u952e\uff0c\u4ece Konva.js \u7684\u6e90\u7801\u6765\u770b\u770b\u5176\u4e8b\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u8bbe\u8ba1\u7684\u3002",date:"2023-08-08T21:21:00.000Z",tags:[{inline:!0,label:"\u8ba1\u7b97\u673a\u6280\u672f",permalink:"/tags/\u8ba1\u7b97\u673a\u6280\u672f"},{inline:!0,label:"Web \u524d\u7aef",permalink:"/tags/web-\u524d\u7aef"},{inline:!0,label:"Konva.js",permalink:"/tags/konva-js"},{inline:!0,label:"Canvas",permalink:"/tags/canvas"},{inline:!0,label:"\u6e90\u7801\u5206\u6790",permalink:"/tags/\u6e90\u7801\u5206\u6790"}],readingTime:12.92,hasTruncateMarker:!0,authors:[{name:"\u4e0d\u5982\u6000\u5ff5",title:"Web \u524d\u7aef\u5de5\u7a0b\u5e08 (Web Front-end Engineer)",url:"https://github.com/wang1212",email:"mrwang1212@126.com",imageURL:"/img/authors/wang1212.png",key:"wang1212"}],frontMatter:{title:"\u89e3\u6790 Konva \u8bbe\u8ba1\uff1a\u4e8b\u4ef6\u7cfb\u7edf",date:"2023-08-08T21:21:00.000Z",update:"2024-06-02T19:47:00.000Z",authors:"wang1212",tags:["\u8ba1\u7b97\u673a\u6280\u672f","Web \u524d\u7aef","Konva.js","Canvas","\u6e90\u7801\u5206\u6790"],keywords:["\u8ba1\u7b97\u673a\u6280\u672f","Web \u524d\u7aef","Konva.js","Canvas","\u6e90\u7801\u5206\u6790"],description:"\u7ed8\u56fe\u5f15\u64ce\u652f\u6301\u4e30\u5bcc\u4ea4\u4e92\u7684\u524d\u63d0\u662f\u62e5\u6709\u4e00\u5957\u4e8b\u4ef6\u7cfb\u7edf\uff0c\u800c\u5728\u753b\u5e03\u4e2d\u5982\u4f55\u62fe\u53d6\u5143\u7d20\u662f\u5b9e\u73b0\u7684\u5173\u952e\uff0c\u4ece Konva.js \u7684\u6e90\u7801\u6765\u770b\u770b\u5176\u4e8b\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u8bbe\u8ba1\u7684\u3002"},unlisted:!1,prevItem:{title:"\u6b64\u884c\u5357\u4eac",permalink:"/2023/08/27/life/tourism/tourism-nanjing"},nextItem:{title:"\u8c08\u8c08\u7b14\u8bb0\u8bb0\u5f55\u548c\u77e5\u8bc6\u7ba1\u7406\u5de5\u5177",permalink:"/2023/07/22/tools/notes-app"}},h={authorsImageUrls:[void 0]},c=[{value:"\u7ed1\u5b9a\u5bbf\u4e3b\u73af\u5883\u4e8b\u4ef6",id:"\u7ed1\u5b9a\u5bbf\u4e3b\u73af\u5883\u4e8b\u4ef6",level:2},{value:"\u5143\u7d20\u62fe\u53d6",id:"\u5143\u7d20\u62fe\u53d6",level:2},{value:"\u5ef6\u4f38\uff1a\u91cd\u53e0\u5143\u7d20\u7684\u62fe\u53d6",id:"\u5ef6\u4f38\u91cd\u53e0\u5143\u7d20\u7684\u62fe\u53d6",level:2},{value:"\u53c2\u8003\u8d44\u6e90",id:"\u53c2\u8003\u8d44\u6e90",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"\u6700\u540e\u66f4\u65b0\u4e8e 2024-06-02 19:47:00"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u7ed8\u56fe\u5f15\u64ce\u652f\u6301\u4e30\u5bcc\u4ea4\u4e92\u7684\u524d\u63d0\u662f\u62e5\u6709\u4e00\u5957\u4e8b\u4ef6\u7cfb\u7edf\uff0c\u800c\u5728\u753b\u5e03\u4e2d\u5982\u4f55\u62fe\u53d6\u5143\u7d20\u662f\u5b9e\u73b0\u7684\u5173\u952e\uff0c\u4ece ",(0,s.jsx)(n.a,{href:"https://konvajs.org/",children:"Konva.js"})," \u7684\u6e90\u7801\u6765\u770b\u770b\u5176\u4e8b\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u8bbe\u8ba1\u7684\u3002"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"\uff08\u4e4b\u524d\u5206\u6790\u8fc7 ZRender \u7684\u6e90\u7801\u5b9e\u73b0\uff0c\u5176\u91c7\u7528\u4e86\u51e0\u4f55\u5224\u65ad\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u5143\u7d20\u62fe\u53d6\uff0c\u800c Konva.js \u91c7\u7528\u4e86\u4e0d\u540c\u7684\u65b9\u6848\u3002\uff09"})}),"\n",(0,s.jsx)(n.mermaid,{value:'---\ntitle: Konva\'s Event System(v9.3.11)\n---\nflowchart BT\n    subgraph bind2dom\n        canvas["canvas (dom)"]\n\n        subgraph Stage\n            getIntersection("getIntersection()")\n        end\n\n        Stage -- addEventListener() --\x3e canvas\n        canvas -- trigger() --\x3e Stage\n    end\n\n    subgraph pick\n        subgraph Layer\n            SceneCanvas\n            HitCanvas\n            LayerGetIntersection("getIntersection()")\n\n            HitCanvas -. "fillStyle: colorKey" .-> SceneCanvas\n            LayerGetIntersection -- "getImageData()" --\x3e HitCanvas\n        end\n\n        subgraph Shape\n            colorKey\n            shapes\n            sceneFunc("sceneFunc()")\n            hitFunc("hitFunc()")\n            Shape_FireAndBubble("_fireAndBubble()")\n\n            hitFunc -. "default" .-> sceneFunc\n            colorKey ---\x3e shapes\n            shapes -. "find" .-> Shape_FireAndBubble\n        end\n\n        SceneCanvas ---\x3e sceneFunc\n        HitCanvas ---\x3e hitFunc\n        HitCanvas -.-> colorKey\n    end\n\n    User("User")\n\n    getIntersection --\x3e pick\n\n    User -. on() .-> Shape\n    Shape -. trigger() .-> User\n\n    User -. interact .-> canvas\n\n    linkStyle 3,9,10 stroke: red,color: red;\n    linkStyle 5,6,11,12 stroke: green,color: green;\n    linkStyle 13 stroke: orange,color: orange;\n\n    style User fill: orange;\n    style pick fill: transparent,color: gray,stroke: gray,stroke-width: 2px,stroke-dasharray: 10 5;\n    style bind2dom fill: transparent,color: gray,stroke: gray,stroke-width: 2px,stroke-dasharray: 10 5;\n'}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u5e38\uff0c\u753b\u5e03\uff08Canvas\uff09\u5143\u7d20\u4f5c\u4e3a\u539f\u751f DOM \u4f1a\u63d0\u4f9b\u76f8\u5e94\u7684\u4e8b\u4ef6 APIs\uff0c\u4f46\u753b\u5e03\u4e2d\u7ed8\u5236\u7684\u5185\u5bb9\u7531\u4e0d\u540c\u7684\u7ed8\u56fe\u5e93\u8fdb\u884c\u62bd\u8c61\u8bbe\u8ba1\uff0c\u57fa\u7840\u5143\u7d20\uff08\u4f8b\u5982\u77e9\u5f62\u3001\u5706\u3001\u7ebf\u7b49\uff09\u7684\u4e8b\u4ef6\u7531\u7ed8\u56fe\u5e93\u8fdb\u884c\u652f\u6301\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u7ed8\u56fe\u5e93\u4e3a\u4e86\u5b9e\u73b0\u4e8b\u4ef6\u7cfb\u7edf\uff0c\u4e00\u822c\u7684\u7b56\u7565\u5206\u4e3a\u4e24\u6b65\uff1a",(0,s.jsx)(n.strong,{children:"\u9996\u5148\uff0c\u901a\u8fc7\u7ed1\u5b9a\u753b\u5e03\u5143\u7d20\u7684\u539f\u751f DOM \u4e8b\u4ef6\u6765\u652f\u6301\u5bf9\u7528\u6237\u4ea4\u4e92\u4e8b\u4ef6\u7684\u54cd\u5e94\uff1b\u5176\u6b21\uff0c\u5728\u54cd\u5e94\u753b\u5e03\u7684\u539f\u751f DOM \u4e8b\u4ef6\u65f6\uff0c\u83b7\u53d6\u5750\u6807\u7b49\u4fe1\u606f\u5728\u753b\u5e03\u4e0a\u8fdb\u884c\u5143\u7d20\u62fe\u53d6\uff0c\u6765\u8fdb\u4e00\u6b65\u5224\u65ad\u89e6\u53d1\u4ea4\u4e92\u4e8b\u4ef6\u7684\u5177\u4f53\u5143\u7d20\u3002"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u5176\u4e2d\uff0c",(0,s.jsx)(n.code,{children:"Node"})," \u662f Konva.js \u4e2d\u5f88\u91cd\u8981\u7684\u57fa\u7c7b\uff0c\u51e0\u4e4e\u6240\u6709\u7ed8\u56fe\u76f8\u5173\u7684\u7c7b\uff08",(0,s.jsx)(n.code,{children:"Stage"}),"\u3001",(0,s.jsx)(n.code,{children:"Layer"}),"\u3001",(0,s.jsx)(n.code,{children:"Shape"}),"\uff09\u90fd\u7ee7\u627f\u81ea\u5b83\uff0c\u5176\u5b9e\u73b0\u4e86\u4e8b\u4ef6\u76f8\u5173\u7684 APIs\uff08\u4f8b\u5982 ",(0,s.jsx)(n.code,{children:"on()"}),"\u3001",(0,s.jsx)(n.code,{children:"off()"})," \u7b49\u7b49\uff09\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u4e0b\u9762\u6839\u636e\u6e90\u7801\u6765\u5206\u6790\u5177\u4f53\u903b\u8f91\u7684\u5b9e\u73b0\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u7ed1\u5b9a\u5bbf\u4e3b\u73af\u5883\u4e8b\u4ef6",children:"\u7ed1\u5b9a\u5bbf\u4e3b\u73af\u5883\u4e8b\u4ef6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://konvajs.org/docs/overview.html"',children:"// first we need to create a stage\nvar stage = new Konva.Stage({\n  container: 'container',   // id of container <div>\n  width: 500,\n  height: 500\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u7b2c\u4e00\u9636\u6bb5\uff0c\u5728 Konva.js \u5b9e\u4f8b\u5316\u8fc7\u7a0b\u4e2d\u5c31\u4f1a\u7ed1\u5b9a\u5bbf\u4e3b\u73af\u5883\u7684\u4e8b\u4ef6\u3002\u5177\u4f53\u8fc7\u7a0b\u4e3a\uff0c\u5728\u5b9e\u4f8b\u5316 ",(0,s.jsx)(n.code,{children:"Stage"})," \u65f6\uff0c\u4f1a\u5728\u5185\u90e8\u76f4\u63a5\u7ed1\u5b9a\u5bb9\u5668 DOM \u5143\u7d20\u7684\u5bbf\u4e3b\u4e8b\u4ef6\uff08\u540c\u65f6\u652f\u6301\u9f20\u6807\u3001\u89e6\u6478\u3001\u6307\u9488\u4e09\u79cd\u7c7b\u578b\u4e8b\u4ef6\uff09\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u7ed1\u5b9a\u5bbf\u4e3b\u73af\u5883\u4e8b\u4ef6\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L177"',children:"export class Stage extends Container<Layer> {\n  constructor(config: StageConfig) {\n    super(checkNoClip(config));\n    this._buildDOM();\n    // highlight-next-line\n    this._bindContentEvents();\n\n    // ...\n  }\n\n  _bindContentEvents() {\n    if (!Konva.isBrowser) {\n      return;\n    }\n    // highlight-start\n    EVENTS.forEach(([event, methodName]) => {\n      this.content.addEventListener(\n        event,\n        (evt) => {\n          this[methodName](evt);\n        },\n        { passive: false }\n      );\n    });\n    // highlight-end\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u753b\u5e03\u5143\u7d20\u7684\u539f\u751f DOM \u4e8b\u4ef6\u7684\u54cd\u5e94\u903b\u8f91\u5728 ",(0,s.jsx)(n.code,{children:"Stage"})," \u7c7b\u4e2d\u76f4\u63a5\u5b9e\u73b0\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L589"',children:"export class Stage extends Container<Layer> {\n  _pointermove(evt: TouchEvent | MouseEvent | PointerEvent) {\n    // ...\n\n    // highlight-next-line\n    this.setPointersPositions(evt);\n\n    // ...\n\n    var processedShapesIds = {};\n    let triggeredOnShape = false;\n    var targetShape = this._getTargetShape(eventType);\n    this._changedPointerPositions.forEach((pos) => {\n      // highlight-start\n      const shape = (PointerEvents.getCapturedShape(pos.id) ||\n        this.getIntersection(pos)) as Shape;\n      // highlight-end\n      const pointerId = pos.id;\n      const event = { evt: evt, pointerId };\n\n      var differentTarget = targetShape !== shape;\n\n      if (differentTarget && targetShape) {\n        // highlight-next-line\n        targetShape._fireAndBubble(events.pointerout, { ...event }, shape);\n        // highlight-next-line\n        targetShape._fireAndBubble(events.pointerleave, { ...event }, shape);\n      }\n\n      if (shape) {\n        if (processedShapesIds[shape._id]) {\n          return;\n        }\n        processedShapesIds[shape._id] = true;\n      }\n\n      if (shape && shape.isListening()) {\n        triggeredOnShape = true;\n        if (differentTarget) {\n          // highlight-next-line\n          shape._fireAndBubble(events.pointerover, { ...event }, targetShape);\n          // highlight-next-line\n          shape._fireAndBubble(events.pointerenter, { ...event }, targetShape);\n          this[eventType + 'targetShape'] = shape;\n        }\n        // highlight-next-line\n        shape._fireAndBubble(events.pointermove, { ...event });\n      } else {\n        if (targetShape) {\n          this._fire(events.pointerover, {\n            evt: evt,\n            target: this,\n            currentTarget: this,\n            pointerId,\n          });\n          this[eventType + 'targetShape'] = null;\n        }\n      }\n    });\n\n    if (!triggeredOnShape) {\n      this._fire(events.pointermove, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: this._changedPointerPositions[0].id,\n      });\n    }\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4e0a\u8ff0\u6e90\u7801\u662f ",(0,s.jsx)(n.code,{children:"pointermove"})," \u4e8b\u4ef6\u7684\u54cd\u5e94\u903b\u8f91\uff0c\u5176\u4e2d",(0,s.jsxs)(n.strong,{children:["\u6700\u5173\u952e\u7684\u4fbf\u662f\u5bf9 ",(0,s.jsx)(n.code,{children:"this.getIntersection(pos)"})," \u7684\u8c03\u7528\uff0c\u8fd9\u4e00\u6b65\u5b9e\u73b0\u4e86\u6307\u5b9a\u5750\u6807\u70b9\u7684\u5143\u7d20\u62fe\u53d6"]}),"\u3002\u62fe\u53d6\u5230\u5143\u7d20\u540e\uff0c\u5219\u4f1a\u8c03\u7528\u5143\u7d20\u7684 ",(0,s.jsx)(n.code,{children:"_fireAndBubble()"})," \u65b9\u6cd5\u6765\u89e6\u53d1\u7528\u6237\u7ed1\u5b9a\u7684\u4e8b\u4ef6\u56de\u8c03\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L365"',children:"export class Stage extends Container<Layer> {\n  /**\n   * get visible intersection shape. This is the preferred\n   *  method for determining if a point intersects a shape or not\n   * @method\n   * @name Konva.Stage#getIntersection\n   * @param {Object} pos\n   * @param {Number} pos.x\n   * @param {Number} pos.y\n   * @returns {Konva.Node}\n   * @example\n   * var shape = stage.getIntersection({x: 50, y: 50});\n   */\n  getIntersection(pos: Vector2d) {\n    if (!pos) {\n      return null;\n    }\n    var layers = this.children,\n      len = layers.length,\n      end = len - 1,\n      n;\n\n    for (n = end; n >= 0; n--) {\n      // highlight-next-line\n      const shape = layers[n].getIntersection(pos);\n      if (shape) {\n        return shape;\n      }\n    }\n\n    return null;\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728 ",(0,s.jsx)(n.code,{children:"Stage"})," \u7c7b\u4e2d\uff0c\u5143\u7d20\u62fe\u53d6\u8fc7\u7a0b\u662f\u904d\u5386\u6240\u6709\u7684\u5c42\uff08",(0,s.jsx)(n.code,{children:"Layer"}),"\uff09\uff0c\u5e76\u8c03\u7528\u5176 ",(0,s.jsx)(n.code,{children:"getIntersection()"})," \u65b9\u6cd5\uff0c\u56e0\u6b64\u771f\u6b63\u7684\u5143\u7d20\u62fe\u53d6\u903b\u8f91\u5b9e\u73b0\u5728 ",(0,s.jsx)(n.code,{children:"Layer"})," \u4e2d\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5143\u7d20\u62fe\u53d6",children:"\u5143\u7d20\u62fe\u53d6"}),"\n",(0,s.jsxs)(n.p,{children:["\u7b2c\u4e8c\u9636\u6bb5\uff0c\u662f\u5143\u7d20\u62fe\u53d6\u7684\u5177\u4f53\u5b9e\u73b0\uff0cKonva.js \u91c7\u7528\u4e86",(0,s.jsx)(n.strong,{children:"\u7f13\u5b58 Canvas \u989c\u8272\u62fe\u53d6\uff08Color Pick\uff09"})," \u7684\u5224\u5b9a\u7b56\u7565\uff0c\u610f\u5473\u7740",(0,s.jsxs)(n.strong,{children:["\u6bcf\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"Layer"})," \u90fd\u5bf9\u5e94\u7740\u4e24\u4e2a Canvas \u5143\u7d20\uff1a\u7528\u4e8e\u6e32\u67d3\u7684\u573a\u666f\u753b\u5e03\uff08SceneCanvas\uff09\u548c\u7528\u4e8e\u5143\u7d20\u62fe\u53d6\u7684\u547d\u4e2d\u6d4b\u8bd5\u7f13\u5b58\u753b\u5e03\uff08HitCanvas\uff09\u3002"]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Layer.ts#L57"',children:"export class Layer extends Container<Group | Shape> {\n  // highlight-start\n  canvas = new SceneCanvas();\n  hitCanvas = new HitCanvas({\n    pixelRatio: 1,\n  });\n  // highlight-end\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u6765\u770b\u770b ",(0,s.jsx)(n.code,{children:"getIntersection()"})," \u65b9\u6cd5\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Layer.ts#L321"',children:"export class Layer extends Container<Group | Shape> {\n  /**\n   * get visible intersection shape. This is the preferred\n   * method for determining if a point intersects a shape or not\n   * also you may pass optional selector parameter to return ancestor of intersected shape\n   * @method\n   * @name Konva.Layer#getIntersection\n   * @param {Object} pos\n   * @param {Number} pos.x\n   * @param {Number} pos.y\n   * @returns {Konva.Node}\n   * @example\n   * var shape = layer.getIntersection({x: 50, y: 50});\n   */\n  getIntersection(pos: Vector2d) {\n    if (!this.isListening() || !this.isVisible()) {\n      return null;\n    }\n    // in some cases antialiased area may be bigger than 1px\n    // it is possible if we will cache node, then scale it a lot\n    // highlight-next-line\n    var spiralSearchDistance = 1;\n    var continueSearch = false;\n    while (true) {\n      for (let i = 0; i < INTERSECTION_OFFSETS_LEN; i++) {\n        const intersectionOffset = INTERSECTION_OFFSETS[i];\n        // highlight-start\n        const obj = this._getIntersection({\n          x: pos.x + intersectionOffset.x * spiralSearchDistance,\n          y: pos.y + intersectionOffset.y * spiralSearchDistance,\n        });\n        const shape = obj.shape;\n        if (shape) {\n            return shape;\n        }\n        // highlight-end\n        // we should continue search if we found antialiased pixel\n        // that means our node somewhere very close\n        continueSearch = !!obj.antialiased;\n        // stop search if found empty pixel\n        if (!obj.antialiased) {\n          break;\n        }\n      }\n      // if no shape, and no antialiased pixel, we should end searching\n      if (continueSearch) {\n        // highlight-next-line\n        spiralSearchDistance += 1;\n      } else {\n        return null;\n      }\n    }\n  }\n\n  _getIntersection(pos: Vector2d): { shape?: Shape; antialiased?: boolean } {\n    const ratio = this.hitCanvas.pixelRatio;\n    // highlight-start\n    const p = this.hitCanvas.context.getImageData(\n      Math.round(pos.x * ratio),\n      Math.round(pos.y * ratio),\n      1,\n      1\n    ).data;\n    // highlight-end\n    const p3 = p[3];\n\n    // fully opaque pixel\n    if (p3 === 255) {\n      // highlight-start\n      const colorKey = Util._rgbToHex(p[0], p[1], p[2]);\n      const shape = shapes[HASH + colorKey];\n      if (shape) {\n        return {\n          shape: shape,\n        };\n      }\n      // highlight-end\n      return {\n        antialiased: true,\n      };\n    } else if (p3 > 0) {\n      // antialiased pixel\n      return {\n        antialiased: true,\n      };\n    }\n    // empty pixel\n    return {};\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u6839\u636e\u4ee5\u4e0a\u6e90\u7801\u6765\u770b\uff0c",(0,s.jsxs)(n.strong,{children:["\u9996\u5148\u4ee5\u62fe\u53d6\u5750\u6807\u4e3a\u4e2d\u5fc3\u7684 2\xd72 \u77e9\u5f62\u4e2d\u627e\u51fa 5 \u4e2a\u5173\u952e\u70b9\uff08",(0,s.jsx)(n.code,{children:"INTERSECTION_OFFSETS"}),"\uff0c\u4e2d\u5fc3\u548c\u56db\u4e2a\u9876\u70b9\uff09\u8fdb\u884c\u904d\u5386\uff0c\u5206\u522b\u901a\u8fc7\u8c03\u7528\u7f13\u5b58\u753b\u5e03\uff08hitCanvas\uff09\u7684 ",(0,s.jsx)(n.code,{children:"getImageData()"})," \u6765\u83b7\u53d6\u5750\u6807\u70b9\u7684\u50cf\u7d20\u503c\uff0c\u7136\u540e\u5728\u989c\u8272\u4e0e\u56fe\u5f62\u5143\u7d20\u5b9e\u4f8b\u7684\u6620\u5c04\u8868 ",(0,s.jsx)(n.code,{children:"shapes"})," \u4e2d\u627e\u5230\u76ee\u6807\u5143\u7d20"]}),"\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u5b9e\u9645\u4e0a\u4e5f\u8003\u8651\u4e86\u6297\u952f\u9f7f\u50cf\u7d20\u5bf9\u5143\u7d20\u62fe\u53d6\u4ea7\u751f\u7684\u5f71\u54cd\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u6bcf\u4e00\u4e2a\u5143\u7d20\u5b9e\u4f8b\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684 ",(0,s.jsx)(n.code,{children:"colorKey"}),"\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L184"',children:"export class Shape<Config extends ShapeConfig = ShapeConfig> extends Node<Config> {\n  constructor(config?: Config) {\n    super(config);\n    // set colorKey\n    let key: string;\n\n    // highlight-start\n    while (true) {\n      key = Util.getRandomColor();\n      if (key && !(key in shapes)) {\n        break;\n      }\n    }\n\n    this.colorKey = key;\n    shapes[key] = this;\n    // highlight-end\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2a\u5143\u7d20\u4f1a\u540c\u65f6\u5728\u6e32\u67d3\u753b\u5e03\u548c\u7f13\u5b58\u753b\u5e03\u4e2d\u7ed8\u5236\u4e00\u904d\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L572"',children:"export class Shape<Config extends ShapeConfig = ShapeConfig> extends Node<Config> {\n  getSceneFunc() {\n    return this.attrs.sceneFunc || this['_sceneFunc'];\n  }\n\n  getHitFunc() {\n    return this.attrs.hitFunc || this['_hitFunc'];\n  }\n\n  drawScene(can?: SceneCanvas, top?: Node, bufferCanvas?: SceneCanvas) {\n    var canvas = can || layer!.getCanvas(),\n      context = canvas.getContext() as SceneContext,\n      cachedCanvas = this._getCanvasCache(),\n      // highlight-next-line\n      drawFunc = this.getSceneFunc();\n\n    // ...\n  }\n\n  drawHit(can?: HitCanvas, top?: Node, skipDragCheck = false) {\n    var layer = this.getLayer(),\n      canvas = can || layer!.hitCanvas,\n      context = canvas && canvas.getContext(),\n      // highlight-next-line\n      drawFunc = this.hitFunc() || this.sceneFunc();\n\n    // ...\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u6839\u636e\u6e90\u7801\u53ef\u4ee5\u770b\u5230\uff0c\u7ed8\u5236\u65f6\u5206\u522b\u8c03\u7528\u4e86 ",(0,s.jsx)(n.code,{children:"sceneFunc()"})," \u548c ",(0,s.jsx)(n.code,{children:"hitFunc()"}),"\uff0c\u4f46\u524d\u8005\u4f5c\u4e3a\u540e\u8005\u7684\u5907\u9009\u9879\uff0c\u4e5f\u5c31\u662f\u8bf4\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6e32\u67d3\u4e24\u6b21\u5b9e\u9645\u4e0a\u8c03\u7528\u7684\u90fd\u662f ",(0,s.jsx)(n.code,{children:"sceneFunc()"}),"\uff0c\u786e\u4fdd\u56fe\u5f62\u5143\u7d20\u7684\u7ed8\u5236\u7ed3\u679c\uff08\u5373\u5f62\u72b6\uff09\u4e00\u81f4\uff08",(0,s.jsx)(n.code,{children:"hitFunc()"})," \u53ef\u4ee5\u81ea\u5b9a\u4e49\u5b9e\u73b0\uff0c\u53c2\u8003",(0,s.jsx)(n.a,{href:"https://konvajs.org/docs/events/Custom_Hit_Region.html",children:"\u6587\u6863"}),"\uff09\u3002\u4e0d\u540c\u7684\u662f\uff0c\u7f13\u5b58\u753b\u5e03\u4e2d\u7ed8\u5236\u65f6\u4f7f\u7528\u4e86\u5143\u7d20\u7684 ",(0,s.jsx)(n.code,{children:"colorKey"})," \u5bf9\u5e94\u7684\u989c\u8272\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Context.ts#L984"',children:"export class HitContext extends Context {\n  _stroke(shape) {\n    if (shape.hasHitStroke()) {\n      // ignore strokeScaleEnabled for Text\n      const strokeScaleEnabled = shape.getStrokeScaleEnabled();\n      if (!strokeScaleEnabled) {\n        this.save();\n        var pixelRatio = this.getCanvas().getPixelRatio();\n        this.setTransform(pixelRatio, 0, 0, pixelRatio, 0, 0);\n      }\n      this._applyLineCap(shape);\n\n      var hitStrokeWidth = shape.hitStrokeWidth();\n      var strokeWidth =\n        hitStrokeWidth === 'auto' ? shape.strokeWidth() : hitStrokeWidth;\n\n      this.setAttr('lineWidth', strokeWidth);\n      // highlight-next-line\n      this.setAttr('strokeStyle', shape.colorKey);\n      shape._strokeFuncHit(this);\n      if (!strokeScaleEnabled) {\n        this.restore();\n      }\n    }\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee5\u4e0a\u5c31\u662f Konva.js \u4e8b\u4ef6\u7cfb\u7edf\u5b9e\u73b0\u7684\u5927\u81f4\u539f\u7406\u3002\u7b80\u5355\u7684\u6765\u8bf4\uff0c",(0,s.jsxs)(n.strong,{children:["Konva.js \u4f1a\u5728\u5b9e\u4f8b\u5316\u6bcf\u4e2a\u5143\u7d20\u65f6\uff0c\u4e3a\u5176\u751f\u6210\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"colorKey"}),"\uff0c\u8be5\u503c\u5b9e\u9645\u4e0a\u4ee3\u8868\u4e00\u4e2a\u968f\u673a\u989c\u8272\uff0c\u5728\u7ed8\u5236\u8be5\u5143\u7d20\u65f6\uff0c\u4f1a\u4ee5\u8be5\u968f\u673a\u989c\u8272\u4e3a\u586b\u5145\u8272\u5c06\u8be5\u5143\u7d20\u56fe\u5f62\u540c\u65f6\u7ed8\u5236\u5728\u7f13\u5b58\u753b\u5e03\uff08HitCanvas\uff09\u4e2d\uff0c\u5f53\u7528\u6237\u5728\u6e32\u67d3\u753b\u5e03\uff08SceneCanvas\uff09\u4e2d\u8fdb\u884c\u4ea4\u4e92\u65f6\uff0c\u4f1a\u6839\u636e\u89e6\u53d1\u7684 DOM \u4e8b\u4ef6\u5f97\u5230\u4e00\u4e2a\u5750\u6807\uff0c\u6839\u636e\u8be5\u5750\u6807\u4ece\u7f13\u5b58\u753b\u5e03\uff08HitCanvas\uff09\u4e2d\u62fe\u53d6\u50cf\u7d20\u503c\uff0c\u518d\u6839\u636e\u8be5\u8272\u503c\u4ece\u5143\u7d20\u4e0e\u989c\u8272\u6620\u5c04\u8868\u4e2d\u83b7\u53d6\u5143\u7d20\u5b9e\u4f8b\u3002"]})]}),"\n",(0,s.jsx)(n.h2,{id:"\u5ef6\u4f38\u91cd\u53e0\u5143\u7d20\u7684\u62fe\u53d6",children:"\u5ef6\u4f38\uff1a\u91cd\u53e0\u5143\u7d20\u7684\u62fe\u53d6"}),"\n",(0,s.jsx)(n.p,{children:"\u4e0a\u8ff0\u5206\u6790\u4e2d\uff0c\u5b9e\u9645\u4e0a\u6ca1\u6709\u8003\u8651\u5230\u5f53\u591a\u4e2a\u5143\u7d20\u5728\u540c\u4e00\u4e2a\u5750\u6807\u70b9\u91cd\u53e0\u65f6\u7684\u60c5\u51b5\u3002\u6839\u636e\u4e0a\u8ff0\u5b9e\u73b0\uff0c\u5728\u6e32\u67d3\u8fc7\u7a0b\u4e2d\uff0c\u5728\u540c\u4e00\u4e2a\u5750\u6807\u70b9\u4e0a\u540e\u6e32\u67d3\u7684\u5143\u7d20\u4f1a\u8986\u76d6\u6389\u4e4b\u524d\u6e32\u67d3\u5143\u7d20\u7684\u989c\u8272\uff0c\u6700\u7ec8\u62fe\u53d6\u65f6\u5f97\u5230\u7684\u662f\u6700\u540e\u4e00\u6b21\u6e32\u67d3\u5143\u7d20\u7684\u989c\u8272\uff0c\u8fd9\u9002\u7528\u4e8e\u5927\u591a\u6570\u4e1a\u52a1\u573a\u666f\uff0c\u4ec5\u83b7\u53d6\u6700\u9876\u5c42\u5143\u7d20\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u5b9e\u9645\u4e0a\uff0cKonva.js \u63d0\u4f9b\u4e86\u4e00\u4e2a\u62fe\u53d6\u91cd\u53e0\u5143\u7d20\u7684 APIs ",(0,s.jsx)(n.a,{href:"https://konvajs.org/api/Konva.Stage.html#getAllIntersections__anchor",children:(0,s.jsx)(n.code,{children:"getAllIntersections()"})}),"\uff0c\u6765\u770b\u770b\u5176\u6e90\u7801\u5b9e\u73b0\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Container.ts#L317"',children:"export abstract class Container<ChildType extends Node = Node> extends Node<ContainerConfig> {\n  /**\n   * get all shapes that intersect a point.  Note: because this method must clear a temporary\n   * canvas and redraw every shape inside the container, it should only be used for special situations\n   * because it performs very poorly.  Please use the {@link Konva.Stage#getIntersection} method if at all possible\n   * because it performs much better\n   * @method\n   * @name Konva.Container#getAllIntersections\n   * @param {Object} pos\n   * @param {Number} pos.x\n   * @param {Number} pos.y\n   * @returns {Array} array of shapes\n   */\n  getAllIntersections(pos) {\n    var arr: Shape[] = [];\n\n    this.find<Shape>('Shape').forEach((shape) => {\n      if (shape.isVisible() && shape.intersects(pos)) {\n        arr.push(shape);\n      }\n    });\n\n    return arr;\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u904d\u5386\u573a\u666f\u4e2d\u7684\u6240\u6709\u53ef\u89c1\u5143\u7d20\uff0c\u5e76\u8c03\u7528\u5143\u7d20\u7684 ",(0,s.jsx)(n.code,{children:"intersects()"})," \u65b9\u6cd5\u8fdb\u884c\u76f8\u4ea4\u6d4b\u8bd5\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L440"',children:"export class Shape<Config extends ShapeConfig = ShapeConfig> extends Node<Config> {\n  /**\n   * determines if point is in the shape, regardless if other shapes are on top of it.  Note: because\n   *  this method clears a temporary canvas and then redraws the shape, it performs very poorly if executed many times\n   *  consecutively.  Please use the {@link Konva.Stage#getIntersection} method if at all possible\n   *  because it performs much better\n   * @method\n   * @name Konva.Shape#intersects\n   * @param {Object} point\n   * @param {Number} point.x\n   * @param {Number} point.y\n   * @returns {Boolean}\n   */\n  intersects(point) {\n    var stage = this.getStage();\n    if (!stage) {\n      return false;\n    }\n    const bufferHitCanvas = stage.bufferHitCanvas;\n\n    bufferHitCanvas.getContext().clear();\n    this.drawHit(bufferHitCanvas, undefined, true);\n    const p = bufferHitCanvas.context.getImageData(\n      Math.round(point.x),\n      Math.round(point.y),\n      1,\n      1\n    ).data;\n    return p[3] > 0;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4f9d\u6b21\u5c06\u6bcf\u4e2a\u5143\u7d20\u7684\u7f13\u5b58\u56fe\u50cf\u6570\u636e\u7ed8\u5236\u5230\u5168\u5c40\u7684\u7f13\u5b58\u753b\u5e03\u4e2d\uff0c\u5e76\u62fe\u53d6\u5750\u6807\u70b9\u7684\u50cf\u7d20\u989c\u8272\u6765\u5224\u65ad\u662f\u5426\u76f8\u4ea4\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6e90",children:"\u53c2\u8003\u8d44\u6e90"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://konvajs.org/",children:"https://konvajs.org/"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://konvajs.org/docs/events/Image_Events.html",children:"https://konvajs.org/docs/events/Image_Events.html"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>r});var s=t(67294);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);