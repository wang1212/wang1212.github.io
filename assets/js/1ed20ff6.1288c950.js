"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["6331"],{5328:function(e,n,t){t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var s=t(61150),a=t(85893),i=t(50065);let r={title:"\u89E3\u6790 Konva \u8BBE\u8BA1\uFF1A\u4E8B\u4EF6\u7CFB\u7EDF",date:new Date("2023-08-08T21:21:00.000Z"),update:new Date("2024-06-02T19:47:00.000Z"),authors:"wang1212",tags:["\u8BA1\u7B97\u673A\u6280\u672F","Web \u524D\u7AEF","\u6570\u636E\u53EF\u89C6\u5316","Konva.js","Canvas","\u6E90\u7801\u89E3\u6790"],keywords:["\u8BA1\u7B97\u673A\u6280\u672F","Web \u524D\u7AEF","\u6570\u636E\u53EF\u89C6\u5316","Konva.js","Canvas","\u6E90\u7801\u89E3\u6790"],description:"\u7ED8\u56FE\u5F15\u64CE\u652F\u6301\u4E30\u5BCC\u4EA4\u4E92\u7684\u524D\u63D0\u662F\u62E5\u6709\u4E00\u5957\u4E8B\u4EF6\u7CFB\u7EDF\uFF0C\u800C\u5728\u753B\u5E03\u4E2D\u5982\u4F55\u62FE\u53D6\u5143\u7D20\u662F\u5B9E\u73B0\u7684\u5173\u952E\uFF0C\u4ECE Konva.js \u7684\u6E90\u7801\u6765\u770B\u770B\u5176\u4E8B\u4EF6\u7CFB\u7EDF\u662F\u5982\u4F55\u8BBE\u8BA1\u7684\u3002"},o=void 0,h={authorsImageUrls:[void 0]},c=[{value:"\u7ED1\u5B9A\u5BBF\u4E3B\u73AF\u5883\u4E8B\u4EF6",id:"\u7ED1\u5B9A\u5BBF\u4E3B\u73AF\u5883\u4E8B\u4EF6",level:2},{value:"\u5143\u7D20\u62FE\u53D6",id:"\u5143\u7D20\u62FE\u53D6",level:2},{value:"\u5EF6\u4F38\uFF1A\u91CD\u53E0\u5143\u7D20\u7684\u62FE\u53D6",id:"\u5EF6\u4F38\u91CD\u53E0\u5143\u7D20\u7684\u62FE\u53D6",level:2},{value:"\u53C2\u8003\u8D44\u6E90",id:"\u53C2\u8003\u8D44\u6E90",level:2}];function l(e){let n={a:"a",code:"code",em:"em",h2:"h2",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["\u7ED8\u56FE\u5F15\u64CE\u652F\u6301\u4E30\u5BCC\u4EA4\u4E92\u7684\u524D\u63D0\u662F\u62E5\u6709\u4E00\u5957\u4E8B\u4EF6\u7CFB\u7EDF\uFF0C\u800C\u5728\u753B\u5E03\u4E2D\u5982\u4F55\u62FE\u53D6\u5143\u7D20\u662F\u5B9E\u73B0\u7684\u5173\u952E\uFF0C\u4ECE ",(0,a.jsx)(n.a,{href:"https://konvajs.org/",children:"Konva.js"})," \u7684\u6E90\u7801\u6765\u770B\u770B\u5176\u4E8B\u4EF6\u7CFB\u7EDF\u662F\u5982\u4F55\u8BBE\u8BA1\u7684\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.em,{children:"\uFF08\u4E4B\u524D\u5206\u6790\u8FC7 ZRender \u7684\u6E90\u7801\u5B9E\u73B0\uFF0C\u5176\u91C7\u7528\u4E86\u51E0\u4F55\u5224\u65AD\u7684\u65B9\u5F0F\u6765\u5B9E\u73B0\u5143\u7D20\u62FE\u53D6\uFF0C\u800C Konva.js \u91C7\u7528\u4E86\u4E0D\u540C\u7684\u65B9\u6848\u3002\uFF09"})}),"\n",(0,a.jsx)(n.mermaid,{value:'---\ntitle: Konva\'s Event System(v9.3.11)\n---\nflowchart BT\n    subgraph bind2dom\n        canvas["canvas (dom)"]\n\n        subgraph Stage\n            getIntersection("getIntersection()")\n        end\n\n        Stage -- addEventListener() --\x3e canvas\n        canvas -- trigger() --\x3e Stage\n    end\n\n    subgraph pick\n        subgraph Layer\n            SceneCanvas\n            HitCanvas\n            LayerGetIntersection("getIntersection()")\n\n            HitCanvas -. "fillStyle: colorKey" .-> SceneCanvas\n            LayerGetIntersection -- "getImageData()" --\x3e HitCanvas\n        end\n\n        subgraph Shape\n            colorKey\n            shapes\n            sceneFunc("sceneFunc()")\n            hitFunc("hitFunc()")\n            Shape_FireAndBubble("_fireAndBubble()")\n\n            hitFunc -. "default" .-> sceneFunc\n            colorKey ---\x3e shapes\n            shapes -. "find" .-> Shape_FireAndBubble\n        end\n\n        SceneCanvas ---\x3e sceneFunc\n        HitCanvas ---\x3e hitFunc\n        HitCanvas -.-> colorKey\n    end\n\n    User("User")\n\n    getIntersection --\x3e pick\n\n    User -. on() .-> Shape\n    Shape -. trigger() .-> User\n\n    User -. interact .-> canvas\n\n    linkStyle 3,9,10 stroke: red,color: red;\n    linkStyle 5,6,11,12 stroke: green,color: green;\n    linkStyle 13 stroke: orange,color: orange;\n\n    style User fill: orange;\n    style pick fill: transparent,color: gray,stroke: gray,stroke-width: 2px,stroke-dasharray: 10 5;\n    style bind2dom fill: transparent,color: gray,stroke: gray,stroke-width: 2px,stroke-dasharray: 10 5;\n'}),"\n",(0,a.jsx)(n.p,{children:"\u901A\u5E38\uFF0C\u753B\u5E03\uFF08Canvas\uFF09\u5143\u7D20\u4F5C\u4E3A\u539F\u751F DOM \u4F1A\u63D0\u4F9B\u76F8\u5E94\u7684\u4E8B\u4EF6 APIs\uFF0C\u4F46\u753B\u5E03\u4E2D\u7ED8\u5236\u7684\u5185\u5BB9\u7531\u4E0D\u540C\u7684\u7ED8\u56FE\u5E93\u8FDB\u884C\u62BD\u8C61\u8BBE\u8BA1\uFF0C\u57FA\u7840\u5143\u7D20\uFF08\u4F8B\u5982\u77E9\u5F62\u3001\u5706\u3001\u7EBF\u7B49\uFF09\u7684\u4E8B\u4EF6\u7531\u7ED8\u56FE\u5E93\u8FDB\u884C\u652F\u6301\u3002"}),"\n",(0,a.jsxs)(n.p,{children:["\u7ED8\u56FE\u5E93\u4E3A\u4E86\u5B9E\u73B0\u4E8B\u4EF6\u7CFB\u7EDF\uFF0C\u4E00\u822C\u7684\u7B56\u7565\u5206\u4E3A\u4E24\u6B65\uFF1A",(0,a.jsx)(n.strong,{children:"\u9996\u5148\uFF0C\u901A\u8FC7\u7ED1\u5B9A\u753B\u5E03\u5143\u7D20\u7684\u539F\u751F DOM \u4E8B\u4EF6\u6765\u652F\u6301\u5BF9\u7528\u6237\u4EA4\u4E92\u4E8B\u4EF6\u7684\u54CD\u5E94\uFF1B\u5176\u6B21\uFF0C\u5728\u54CD\u5E94\u753B\u5E03\u7684\u539F\u751F DOM \u4E8B\u4EF6\u65F6\uFF0C\u83B7\u53D6\u5750\u6807\u7B49\u4FE1\u606F\u5728\u753B\u5E03\u4E0A\u8FDB\u884C\u5143\u7D20\u62FE\u53D6\uFF0C\u6765\u8FDB\u4E00\u6B65\u5224\u65AD\u89E6\u53D1\u4EA4\u4E92\u4E8B\u4EF6\u7684\u5177\u4F53\u5143\u7D20\u3002"})]}),"\n",(0,a.jsxs)(n.p,{children:["\u5176\u4E2D\uFF0C",(0,a.jsx)(n.code,{children:"Node"})," \u662F Konva.js \u4E2D\u5F88\u91CD\u8981\u7684\u57FA\u7C7B\uFF0C\u51E0\u4E4E\u6240\u6709\u7ED8\u56FE\u76F8\u5173\u7684\u7C7B\uFF08",(0,a.jsx)(n.code,{children:"Stage"}),"\u3001",(0,a.jsx)(n.code,{children:"Layer"}),"\u3001",(0,a.jsx)(n.code,{children:"Shape"}),"\uFF09\u90FD\u7EE7\u627F\u81EA\u5B83\uFF0C\u5176\u5B9E\u73B0\u4E86\u4E8B\u4EF6\u76F8\u5173\u7684 APIs\uFF08\u4F8B\u5982 ",(0,a.jsx)(n.code,{children:"on()"}),"\u3001",(0,a.jsx)(n.code,{children:"off()"})," \u7B49\u7B49\uFF09\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u4E0B\u9762\u6839\u636E\u6E90\u7801\u6765\u5206\u6790\u5177\u4F53\u903B\u8F91\u7684\u5B9E\u73B0\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"\u7ED1\u5B9A\u5BBF\u4E3B\u73AF\u5883\u4E8B\u4EF6",children:"\u7ED1\u5B9A\u5BBF\u4E3B\u73AF\u5883\u4E8B\u4EF6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://konvajs.org/docs/overview.html"',children:"// first we need to create a stage\nvar stage = new Konva.Stage({\n  container: 'container',   // id of container <div>\n  width: 500,\n  height: 500\n});\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u7B2C\u4E00\u9636\u6BB5\uFF0C\u5728 Konva.js \u5B9E\u4F8B\u5316\u8FC7\u7A0B\u4E2D\u5C31\u4F1A\u7ED1\u5B9A\u5BBF\u4E3B\u73AF\u5883\u7684\u4E8B\u4EF6\u3002\u5177\u4F53\u8FC7\u7A0B\u4E3A\uFF0C\u5728\u5B9E\u4F8B\u5316 ",(0,a.jsx)(n.code,{children:"Stage"})," \u65F6\uFF0C\u4F1A\u5728\u5185\u90E8\u76F4\u63A5\u7ED1\u5B9A\u5BB9\u5668 DOM \u5143\u7D20\u7684\u5BBF\u4E3B\u4E8B\u4EF6\uFF08\u540C\u65F6\u652F\u6301\u9F20\u6807\u3001\u89E6\u6478\u3001\u6307\u9488\u4E09\u79CD\u7C7B\u578B\u4E8B\u4EF6\uFF09\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u7ED1\u5B9A\u5BBF\u4E3B\u73AF\u5883\u4E8B\u4EF6\uFF1A"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L177"',children:"export class Stage extends Container<Layer> {\n  constructor(config: StageConfig) {\n    super(checkNoClip(config));\n    this._buildDOM();\n    // highlight-next-line\n    this._bindContentEvents();\n\n    // ...\n  }\n\n  _bindContentEvents() {\n    if (!Konva.isBrowser) {\n      return;\n    }\n    // highlight-start\n    EVENTS.forEach(([event, methodName]) => {\n      this.content.addEventListener(\n        event,\n        (evt) => {\n          this[methodName](evt);\n        },\n        { passive: false }\n      );\n    });\n    // highlight-end\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u753B\u5E03\u5143\u7D20\u7684\u539F\u751F DOM \u4E8B\u4EF6\u7684\u54CD\u5E94\u903B\u8F91\u5728 ",(0,a.jsx)(n.code,{children:"Stage"})," \u7C7B\u4E2D\u76F4\u63A5\u5B9E\u73B0\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L589"',children:"export class Stage extends Container<Layer> {\n  _pointermove(evt: TouchEvent | MouseEvent | PointerEvent) {\n    // ...\n\n    // highlight-next-line\n    this.setPointersPositions(evt);\n\n    // ...\n\n    var processedShapesIds = {};\n    let triggeredOnShape = false;\n    var targetShape = this._getTargetShape(eventType);\n    this._changedPointerPositions.forEach((pos) => {\n      // highlight-start\n      const shape = (PointerEvents.getCapturedShape(pos.id) ||\n        this.getIntersection(pos)) as Shape;\n      // highlight-end\n      const pointerId = pos.id;\n      const event = { evt: evt, pointerId };\n\n      var differentTarget = targetShape !== shape;\n\n      if (differentTarget && targetShape) {\n        // highlight-next-line\n        targetShape._fireAndBubble(events.pointerout, { ...event }, shape);\n        // highlight-next-line\n        targetShape._fireAndBubble(events.pointerleave, { ...event }, shape);\n      }\n\n      if (shape) {\n        if (processedShapesIds[shape._id]) {\n          return;\n        }\n        processedShapesIds[shape._id] = true;\n      }\n\n      if (shape && shape.isListening()) {\n        triggeredOnShape = true;\n        if (differentTarget) {\n          // highlight-next-line\n          shape._fireAndBubble(events.pointerover, { ...event }, targetShape);\n          // highlight-next-line\n          shape._fireAndBubble(events.pointerenter, { ...event }, targetShape);\n          this[eventType + 'targetShape'] = shape;\n        }\n        // highlight-next-line\n        shape._fireAndBubble(events.pointermove, { ...event });\n      } else {\n        if (targetShape) {\n          this._fire(events.pointerover, {\n            evt: evt,\n            target: this,\n            currentTarget: this,\n            pointerId,\n          });\n          this[eventType + 'targetShape'] = null;\n        }\n      }\n    });\n\n    if (!triggeredOnShape) {\n      this._fire(events.pointermove, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: this._changedPointerPositions[0].id,\n      });\n    }\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u4E0A\u8FF0\u6E90\u7801\u662F ",(0,a.jsx)(n.code,{children:"pointermove"})," \u4E8B\u4EF6\u7684\u54CD\u5E94\u903B\u8F91\uFF0C\u5176\u4E2D",(0,a.jsxs)(n.strong,{children:["\u6700\u5173\u952E\u7684\u4FBF\u662F\u5BF9 ",(0,a.jsx)(n.code,{children:"this.getIntersection(pos)"})," \u7684\u8C03\u7528\uFF0C\u8FD9\u4E00\u6B65\u5B9E\u73B0\u4E86\u6307\u5B9A\u5750\u6807\u70B9\u7684\u5143\u7D20\u62FE\u53D6"]}),"\u3002\u62FE\u53D6\u5230\u5143\u7D20\u540E\uFF0C\u5219\u4F1A\u8C03\u7528\u5143\u7D20\u7684 ",(0,a.jsx)(n.code,{children:"_fireAndBubble()"})," \u65B9\u6CD5\u6765\u89E6\u53D1\u7528\u6237\u7ED1\u5B9A\u7684\u4E8B\u4EF6\u56DE\u8C03\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Stage.ts#L365"',children:"export class Stage extends Container<Layer> {\n  /**\n   * get visible intersection shape. This is the preferred\n   *  method for determining if a point intersects a shape or not\n   * @method\n   * @name Konva.Stage#getIntersection\n   * @param {Object} pos\n   * @param {Number} pos.x\n   * @param {Number} pos.y\n   * @returns {Konva.Node}\n   * @example\n   * var shape = stage.getIntersection({x: 50, y: 50});\n   */\n  getIntersection(pos: Vector2d) {\n    if (!pos) {\n      return null;\n    }\n    var layers = this.children,\n      len = layers.length,\n      end = len - 1,\n      n;\n\n    for (n = end; n >= 0; n--) {\n      // highlight-next-line\n      const shape = layers[n].getIntersection(pos);\n      if (shape) {\n        return shape;\n      }\n    }\n\n    return null;\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"Stage"})," \u7C7B\u4E2D\uFF0C\u5143\u7D20\u62FE\u53D6\u8FC7\u7A0B\u662F\u904D\u5386\u6240\u6709\u7684\u5C42\uFF08",(0,a.jsx)(n.code,{children:"Layer"}),"\uFF09\uFF0C\u5E76\u8C03\u7528\u5176 ",(0,a.jsx)(n.code,{children:"getIntersection()"})," \u65B9\u6CD5\uFF0C\u56E0\u6B64\u771F\u6B63\u7684\u5143\u7D20\u62FE\u53D6\u903B\u8F91\u5B9E\u73B0\u5728 ",(0,a.jsx)(n.code,{children:"Layer"})," \u4E2D\u3002"]}),"\n",(0,a.jsx)(n.h2,{id:"\u5143\u7D20\u62FE\u53D6",children:"\u5143\u7D20\u62FE\u53D6"}),"\n",(0,a.jsxs)(n.p,{children:["\u7B2C\u4E8C\u9636\u6BB5\uFF0C\u662F\u5143\u7D20\u62FE\u53D6\u7684\u5177\u4F53\u5B9E\u73B0\uFF0CKonva.js \u91C7\u7528\u4E86",(0,a.jsx)(n.strong,{children:"\u7F13\u5B58 Canvas \u989C\u8272\u62FE\u53D6\uFF08Color Pick\uFF09"})," \u7684\u5224\u5B9A\u7B56\u7565\uFF0C\u610F\u5473\u7740",(0,a.jsxs)(n.strong,{children:["\u6BCF\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"Layer"})," \u90FD\u5BF9\u5E94\u7740\u4E24\u4E2A Canvas \u5143\u7D20\uFF1A\u7528\u4E8E\u6E32\u67D3\u7684\u573A\u666F\u753B\u5E03\uFF08SceneCanvas\uFF09\u548C\u7528\u4E8E\u5143\u7D20\u62FE\u53D6\u7684\u547D\u4E2D\u6D4B\u8BD5\u7F13\u5B58\u753B\u5E03\uFF08HitCanvas\uFF09\u3002"]})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Layer.ts#L57"',children:"export class Layer extends Container<Group | Shape> {\n  // highlight-start\n  canvas = new SceneCanvas();\n  hitCanvas = new HitCanvas({\n    pixelRatio: 1,\n  });\n  // highlight-end\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6765\u770B\u770B ",(0,a.jsx)(n.code,{children:"getIntersection()"})," \u65B9\u6CD5\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Layer.ts#L321"',children:"export class Layer extends Container<Group | Shape> {\n  /**\n   * get visible intersection shape. This is the preferred\n   * method for determining if a point intersects a shape or not\n   * also you may pass optional selector parameter to return ancestor of intersected shape\n   * @method\n   * @name Konva.Layer#getIntersection\n   * @param {Object} pos\n   * @param {Number} pos.x\n   * @param {Number} pos.y\n   * @returns {Konva.Node}\n   * @example\n   * var shape = layer.getIntersection({x: 50, y: 50});\n   */\n  getIntersection(pos: Vector2d) {\n    if (!this.isListening() || !this.isVisible()) {\n      return null;\n    }\n    // in some cases antialiased area may be bigger than 1px\n    // it is possible if we will cache node, then scale it a lot\n    // highlight-next-line\n    var spiralSearchDistance = 1;\n    var continueSearch = false;\n    while (true) {\n      for (let i = 0; i < INTERSECTION_OFFSETS_LEN; i++) {\n        const intersectionOffset = INTERSECTION_OFFSETS[i];\n        // highlight-start\n        const obj = this._getIntersection({\n          x: pos.x + intersectionOffset.x * spiralSearchDistance,\n          y: pos.y + intersectionOffset.y * spiralSearchDistance,\n        });\n        const shape = obj.shape;\n        if (shape) {\n            return shape;\n        }\n        // highlight-end\n        // we should continue search if we found antialiased pixel\n        // that means our node somewhere very close\n        continueSearch = !!obj.antialiased;\n        // stop search if found empty pixel\n        if (!obj.antialiased) {\n          break;\n        }\n      }\n      // if no shape, and no antialiased pixel, we should end searching\n      if (continueSearch) {\n        // highlight-next-line\n        spiralSearchDistance += 1;\n      } else {\n        return null;\n      }\n    }\n  }\n\n  _getIntersection(pos: Vector2d): { shape?: Shape; antialiased?: boolean } {\n    const ratio = this.hitCanvas.pixelRatio;\n    // highlight-start\n    const p = this.hitCanvas.context.getImageData(\n      Math.round(pos.x * ratio),\n      Math.round(pos.y * ratio),\n      1,\n      1\n    ).data;\n    // highlight-end\n    const p3 = p[3];\n\n    // fully opaque pixel\n    if (p3 === 255) {\n      // highlight-start\n      const colorKey = Util._rgbToHex(p[0], p[1], p[2]);\n      const shape = shapes[HASH + colorKey];\n      if (shape) {\n        return {\n          shape: shape,\n        };\n      }\n      // highlight-end\n      return {\n        antialiased: true,\n      };\n    } else if (p3 > 0) {\n      // antialiased pixel\n      return {\n        antialiased: true,\n      };\n    }\n    // empty pixel\n    return {};\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6839\u636E\u4EE5\u4E0A\u6E90\u7801\u6765\u770B\uFF0C",(0,a.jsxs)(n.strong,{children:["\u9996\u5148\u4EE5\u62FE\u53D6\u5750\u6807\u4E3A\u4E2D\u5FC3\u7684 2\xd72 \u77E9\u5F62\u4E2D\u627E\u51FA 5 \u4E2A\u5173\u952E\u70B9\uFF08",(0,a.jsx)(n.code,{children:"INTERSECTION_OFFSETS"}),"\uFF0C\u4E2D\u5FC3\u548C\u56DB\u4E2A\u9876\u70B9\uFF09\u8FDB\u884C\u904D\u5386\uFF0C\u5206\u522B\u901A\u8FC7\u8C03\u7528\u7F13\u5B58\u753B\u5E03\uFF08hitCanvas\uFF09\u7684 ",(0,a.jsx)(n.code,{children:"getImageData()"})," \u6765\u83B7\u53D6\u5750\u6807\u70B9\u7684\u50CF\u7D20\u503C\uFF0C\u7136\u540E\u5728\u989C\u8272\u4E0E\u56FE\u5F62\u5143\u7D20\u5B9E\u4F8B\u7684\u6620\u5C04\u8868 ",(0,a.jsx)(n.code,{children:"shapes"})," \u4E2D\u627E\u5230\u76EE\u6807\u5143\u7D20"]}),"\u3002\u8FD9\u4E2A\u8FC7\u7A0B\u4E2D\uFF0C\u5B9E\u9645\u4E0A\u4E5F\u8003\u8651\u4E86\u6297\u952F\u9F7F\u50CF\u7D20\u5BF9\u5143\u7D20\u62FE\u53D6\u4EA7\u751F\u7684\u5F71\u54CD\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u6BCF\u4E00\u4E2A\u5143\u7D20\u5B9E\u4F8B\u90FD\u6709\u4E00\u4E2A\u552F\u4E00\u7684 ",(0,a.jsx)(n.code,{children:"colorKey"}),"\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L184"',children:"export class Shape<Config extends ShapeConfig = ShapeConfig> extends Node<Config> {\n  constructor(config?: Config) {\n    super(config);\n    // set colorKey\n    let key: string;\n\n    // highlight-start\n    while (true) {\n      key = Util.getRandomColor();\n      if (key && !(key in shapes)) {\n        break;\n      }\n    }\n\n    this.colorKey = key;\n    shapes[key] = this;\n    // highlight-end\n  }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u6BCF\u4E00\u4E2A\u5143\u7D20\u4F1A\u540C\u65F6\u5728\u6E32\u67D3\u753B\u5E03\u548C\u7F13\u5B58\u753B\u5E03\u4E2D\u7ED8\u5236\u4E00\u904D\uFF1A"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L572"',children:"export class Shape<Config extends ShapeConfig = ShapeConfig> extends Node<Config> {\n  getSceneFunc() {\n    return this.attrs.sceneFunc || this['_sceneFunc'];\n  }\n\n  getHitFunc() {\n    return this.attrs.hitFunc || this['_hitFunc'];\n  }\n\n  drawScene(can?: SceneCanvas, top?: Node, bufferCanvas?: SceneCanvas) {\n    var canvas = can || layer!.getCanvas(),\n      context = canvas.getContext() as SceneContext,\n      cachedCanvas = this._getCanvasCache(),\n      // highlight-next-line\n      drawFunc = this.getSceneFunc();\n\n    // ...\n  }\n\n  drawHit(can?: HitCanvas, top?: Node, skipDragCheck = false) {\n    var layer = this.getLayer(),\n      canvas = can || layer!.hitCanvas,\n      context = canvas && canvas.getContext(),\n      // highlight-next-line\n      drawFunc = this.hitFunc() || this.sceneFunc();\n\n    // ...\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6839\u636E\u6E90\u7801\u53EF\u4EE5\u770B\u5230\uFF0C\u7ED8\u5236\u65F6\u5206\u522B\u8C03\u7528\u4E86 ",(0,a.jsx)(n.code,{children:"sceneFunc()"})," \u548C ",(0,a.jsx)(n.code,{children:"hitFunc()"}),"\uFF0C\u4F46\u524D\u8005\u4F5C\u4E3A\u540E\u8005\u7684\u5907\u9009\u9879\uFF0C\u4E5F\u5C31\u662F\u8BF4\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u6E32\u67D3\u4E24\u6B21\u5B9E\u9645\u4E0A\u8C03\u7528\u7684\u90FD\u662F ",(0,a.jsx)(n.code,{children:"sceneFunc()"}),"\uFF0C\u786E\u4FDD\u56FE\u5F62\u5143\u7D20\u7684\u7ED8\u5236\u7ED3\u679C\uFF08\u5373\u5F62\u72B6\uFF09\u4E00\u81F4\uFF08",(0,a.jsx)(n.code,{children:"hitFunc()"})," \u53EF\u4EE5\u81EA\u5B9A\u4E49\u5B9E\u73B0\uFF0C\u53C2\u8003",(0,a.jsx)(n.a,{href:"https://konvajs.org/docs/events/Custom_Hit_Region.html",children:"\u6587\u6863"}),"\uFF09\u3002\u4E0D\u540C\u7684\u662F\uFF0C\u7F13\u5B58\u753B\u5E03\u4E2D\u7ED8\u5236\u65F6\u4F7F\u7528\u4E86\u5143\u7D20\u7684 ",(0,a.jsx)(n.code,{children:"colorKey"})," \u5BF9\u5E94\u7684\u989C\u8272\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Context.ts#L984"',children:"export class HitContext extends Context {\n  _stroke(shape) {\n    if (shape.hasHitStroke()) {\n      // ignore strokeScaleEnabled for Text\n      const strokeScaleEnabled = shape.getStrokeScaleEnabled();\n      if (!strokeScaleEnabled) {\n        this.save();\n        var pixelRatio = this.getCanvas().getPixelRatio();\n        this.setTransform(pixelRatio, 0, 0, pixelRatio, 0, 0);\n      }\n      this._applyLineCap(shape);\n\n      var hitStrokeWidth = shape.hitStrokeWidth();\n      var strokeWidth =\n        hitStrokeWidth === 'auto' ? shape.strokeWidth() : hitStrokeWidth;\n\n      this.setAttr('lineWidth', strokeWidth);\n      // highlight-next-line\n      this.setAttr('strokeStyle', shape.colorKey);\n      shape._strokeFuncHit(this);\n      if (!strokeScaleEnabled) {\n        this.restore();\n      }\n    }\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u4EE5\u4E0A\u5C31\u662F Konva.js \u4E8B\u4EF6\u7CFB\u7EDF\u5B9E\u73B0\u7684\u5927\u81F4\u539F\u7406\u3002\u7B80\u5355\u7684\u6765\u8BF4\uFF0C",(0,a.jsxs)(n.strong,{children:["Konva.js \u4F1A\u5728\u5B9E\u4F8B\u5316\u6BCF\u4E2A\u5143\u7D20\u65F6\uFF0C\u4E3A\u5176\u751F\u6210\u4E00\u4E2A ",(0,a.jsx)(n.code,{children:"colorKey"}),"\uFF0C\u8BE5\u503C\u5B9E\u9645\u4E0A\u4EE3\u8868\u4E00\u4E2A\u968F\u673A\u989C\u8272\uFF0C\u5728\u7ED8\u5236\u8BE5\u5143\u7D20\u65F6\uFF0C\u4F1A\u4EE5\u8BE5\u968F\u673A\u989C\u8272\u4E3A\u586B\u5145\u8272\u5C06\u8BE5\u5143\u7D20\u56FE\u5F62\u540C\u65F6\u7ED8\u5236\u5728\u7F13\u5B58\u753B\u5E03\uFF08HitCanvas\uFF09\u4E2D\uFF0C\u5F53\u7528\u6237\u5728\u6E32\u67D3\u753B\u5E03\uFF08SceneCanvas\uFF09\u4E2D\u8FDB\u884C\u4EA4\u4E92\u65F6\uFF0C\u4F1A\u6839\u636E\u89E6\u53D1\u7684 DOM \u4E8B\u4EF6\u5F97\u5230\u4E00\u4E2A\u5750\u6807\uFF0C\u6839\u636E\u8BE5\u5750\u6807\u4ECE\u7F13\u5B58\u753B\u5E03\uFF08HitCanvas\uFF09\u4E2D\u62FE\u53D6\u50CF\u7D20\u503C\uFF0C\u518D\u6839\u636E\u8BE5\u8272\u503C\u4ECE\u5143\u7D20\u4E0E\u989C\u8272\u6620\u5C04\u8868\u4E2D\u83B7\u53D6\u5143\u7D20\u5B9E\u4F8B\u3002"]})]}),"\n",(0,a.jsx)(n.h2,{id:"\u5EF6\u4F38\u91CD\u53E0\u5143\u7D20\u7684\u62FE\u53D6",children:"\u5EF6\u4F38\uFF1A\u91CD\u53E0\u5143\u7D20\u7684\u62FE\u53D6"}),"\n",(0,a.jsx)(n.p,{children:"\u4E0A\u8FF0\u5206\u6790\u4E2D\uFF0C\u5B9E\u9645\u4E0A\u6CA1\u6709\u8003\u8651\u5230\u5F53\u591A\u4E2A\u5143\u7D20\u5728\u540C\u4E00\u4E2A\u5750\u6807\u70B9\u91CD\u53E0\u65F6\u7684\u60C5\u51B5\u3002\u6839\u636E\u4E0A\u8FF0\u5B9E\u73B0\uFF0C\u5728\u6E32\u67D3\u8FC7\u7A0B\u4E2D\uFF0C\u5728\u540C\u4E00\u4E2A\u5750\u6807\u70B9\u4E0A\u540E\u6E32\u67D3\u7684\u5143\u7D20\u4F1A\u8986\u76D6\u6389\u4E4B\u524D\u6E32\u67D3\u5143\u7D20\u7684\u989C\u8272\uFF0C\u6700\u7EC8\u62FE\u53D6\u65F6\u5F97\u5230\u7684\u662F\u6700\u540E\u4E00\u6B21\u6E32\u67D3\u5143\u7D20\u7684\u989C\u8272\uFF0C\u8FD9\u9002\u7528\u4E8E\u5927\u591A\u6570\u4E1A\u52A1\u573A\u666F\uFF0C\u4EC5\u83B7\u53D6\u6700\u9876\u5C42\u5143\u7D20\u3002"}),"\n",(0,a.jsxs)(n.p,{children:["\u5B9E\u9645\u4E0A\uFF0CKonva.js \u63D0\u4F9B\u4E86\u4E00\u4E2A\u62FE\u53D6\u91CD\u53E0\u5143\u7D20\u7684 APIs ",(0,a.jsx)(n.a,{href:"https://konvajs.org/api/Konva.Stage.html#getAllIntersections__anchor",children:(0,a.jsx)(n.code,{children:"getAllIntersections()"})}),"\uFF0C\u6765\u770B\u770B\u5176\u6E90\u7801\u5B9E\u73B0\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Container.ts#L317"',children:"export abstract class Container<ChildType extends Node = Node> extends Node<ContainerConfig> {\n  /**\n   * get all shapes that intersect a point.  Note: because this method must clear a temporary\n   * canvas and redraw every shape inside the container, it should only be used for special situations\n   * because it performs very poorly.  Please use the {@link Konva.Stage#getIntersection} method if at all possible\n   * because it performs much better\n   * @method\n   * @name Konva.Container#getAllIntersections\n   * @param {Object} pos\n   * @param {Number} pos.x\n   * @param {Number} pos.y\n   * @returns {Array} array of shapes\n   */\n  getAllIntersections(pos) {\n    var arr: Shape[] = [];\n\n    this.find<Shape>('Shape').forEach((shape) => {\n      if (shape.isVisible() && shape.intersects(pos)) {\n        arr.push(shape);\n      }\n    });\n\n    return arr;\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u904D\u5386\u573A\u666F\u4E2D\u7684\u6240\u6709\u53EF\u89C1\u5143\u7D20\uFF0C\u5E76\u8C03\u7528\u5143\u7D20\u7684 ",(0,a.jsx)(n.code,{children:"intersects()"})," \u65B9\u6CD5\u8FDB\u884C\u76F8\u4EA4\u6D4B\u8BD5\uFF1A"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",metastring:'title="https://github.com/konvajs/konva/blob/9.3.11/src/Shape.ts#L440"',children:"export class Shape<Config extends ShapeConfig = ShapeConfig> extends Node<Config> {\n  /**\n   * determines if point is in the shape, regardless if other shapes are on top of it.  Note: because\n   *  this method clears a temporary canvas and then redraws the shape, it performs very poorly if executed many times\n   *  consecutively.  Please use the {@link Konva.Stage#getIntersection} method if at all possible\n   *  because it performs much better\n   * @method\n   * @name Konva.Shape#intersects\n   * @param {Object} point\n   * @param {Number} point.x\n   * @param {Number} point.y\n   * @returns {Boolean}\n   */\n  intersects(point) {\n    var stage = this.getStage();\n    if (!stage) {\n      return false;\n    }\n    const bufferHitCanvas = stage.bufferHitCanvas;\n\n    bufferHitCanvas.getContext().clear();\n    this.drawHit(bufferHitCanvas, undefined, true);\n    const p = bufferHitCanvas.context.getImageData(\n      Math.round(point.x),\n      Math.round(point.y),\n      1,\n      1\n    ).data;\n    return p[3] > 0;\n  }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u4F9D\u6B21\u5C06\u6BCF\u4E2A\u5143\u7D20\u7684\u7F13\u5B58\u56FE\u50CF\u6570\u636E\u7ED8\u5236\u5230\u5168\u5C40\u7684\u7F13\u5B58\u753B\u5E03\u4E2D\uFF0C\u5E76\u62FE\u53D6\u5750\u6807\u70B9\u7684\u50CF\u7D20\u989C\u8272\u6765\u5224\u65AD\u662F\u5426\u76F8\u4EA4\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"\u53C2\u8003\u8D44\u6E90",children:"\u53C2\u8003\u8D44\u6E90"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://konvajs.org/",children:"https://konvajs.org/"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://konvajs.org/docs/events/Image_Events.html",children:"https://konvajs.org/docs/events/Image_Events.html"})}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},50065:function(e,n,t){t.d(n,{Z:()=>o,a:()=>r});var s=t(67294);let a={},i=s.createContext(a);function r(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}},61150:function(e){e.exports=JSON.parse('{"permalink":"/2023/08/08/computer-technology/web-frontend/konva/event-system","editUrl":"https://github.com/wang1212/wang1212.github.io/tree/master/blog/computer-technology/web-frontend/konva/2023-08-08-event-system.md","source":"@site/blog/computer-technology/web-frontend/konva/2023-08-08-event-system.md","title":"\u89E3\u6790 Konva \u8BBE\u8BA1\uFF1A\u4E8B\u4EF6\u7CFB\u7EDF","description":"\u7ED8\u56FE\u5F15\u64CE\u652F\u6301\u4E30\u5BCC\u4EA4\u4E92\u7684\u524D\u63D0\u662F\u62E5\u6709\u4E00\u5957\u4E8B\u4EF6\u7CFB\u7EDF\uFF0C\u800C\u5728\u753B\u5E03\u4E2D\u5982\u4F55\u62FE\u53D6\u5143\u7D20\u662F\u5B9E\u73B0\u7684\u5173\u952E\uFF0C\u4ECE Konva.js \u7684\u6E90\u7801\u6765\u770B\u770B\u5176\u4E8B\u4EF6\u7CFB\u7EDF\u662F\u5982\u4F55\u8BBE\u8BA1\u7684\u3002","date":"2023-08-08T21:21:00.000Z","tags":[{"inline":true,"label":"\u8BA1\u7B97\u673A\u6280\u672F","permalink":"/tags/\u8BA1\u7B97\u673A\u6280\u672F"},{"inline":true,"label":"Web \u524D\u7AEF","permalink":"/tags/web-\u524D\u7AEF"},{"inline":true,"label":"\u6570\u636E\u53EF\u89C6\u5316","permalink":"/tags/\u6570\u636E\u53EF\u89C6\u5316"},{"inline":true,"label":"Konva.js","permalink":"/tags/konva-js"},{"inline":true,"label":"Canvas","permalink":"/tags/canvas"},{"inline":true,"label":"\u6E90\u7801\u89E3\u6790","permalink":"/tags/\u6E90\u7801\u89E3\u6790"}],"readingTime":10.26,"hasTruncateMarker":true,"authors":[{"name":"\u4E0D\u5982\u6000\u5FF5","title":"Web \u524D\u7AEF\u5DE5\u7A0B\u5E08 (Web Front-end Engineer)","url":"https://github.com/wang1212","email":"mrwang1212@126.com","socials":{"github":"https://github.com/wang1212"},"imageURL":"/img/authors/wang1212.png","key":"wang1212","page":null}],"frontMatter":{"title":"\u89E3\u6790 Konva \u8BBE\u8BA1\uFF1A\u4E8B\u4EF6\u7CFB\u7EDF","date":"2023-08-08T21:21:00.000Z","update":"2024-06-02T19:47:00.000Z","authors":"wang1212","tags":["\u8BA1\u7B97\u673A\u6280\u672F","Web \u524D\u7AEF","\u6570\u636E\u53EF\u89C6\u5316","Konva.js","Canvas","\u6E90\u7801\u89E3\u6790"],"keywords":["\u8BA1\u7B97\u673A\u6280\u672F","Web \u524D\u7AEF","\u6570\u636E\u53EF\u89C6\u5316","Konva.js","Canvas","\u6E90\u7801\u89E3\u6790"],"description":"\u7ED8\u56FE\u5F15\u64CE\u652F\u6301\u4E30\u5BCC\u4EA4\u4E92\u7684\u524D\u63D0\u662F\u62E5\u6709\u4E00\u5957\u4E8B\u4EF6\u7CFB\u7EDF\uFF0C\u800C\u5728\u753B\u5E03\u4E2D\u5982\u4F55\u62FE\u53D6\u5143\u7D20\u662F\u5B9E\u73B0\u7684\u5173\u952E\uFF0C\u4ECE Konva.js \u7684\u6E90\u7801\u6765\u770B\u770B\u5176\u4E8B\u4EF6\u7CFB\u7EDF\u662F\u5982\u4F55\u8BBE\u8BA1\u7684\u3002"},"unlisted":false,"prevItem":{"title":"\u6B64\u884C\u5357\u4EAC","permalink":"/2023/08/27/life/tourism/tourism-nanjing"},"nextItem":{"title":"\u8C08\u8C08\u7B14\u8BB0\u8BB0\u5F55\u548C\u77E5\u8BC6\u7BA1\u7406\u5DE5\u5177","permalink":"/2023/07/22/tools/notes-app"}}')}}]);