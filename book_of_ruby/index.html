<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1, user-scalable=no">	
	<title>Book Of Ruby</title>
	<meta name="keywords" content="Ruby,编程" />
	<meta name="description" content="这是一本关于Ruby的书籍，带领读者深入Ruby的编程世界，感受编程的乐趣" />	
	<link rel="stylesheet" href="/source/css/bootstrap.min.css">
	<link rel="stylesheet" href="/source/css/font-awesome.min.css">
	<link rel="stylesheet" href="/source/css/prism.css">
	<style>
		body {
			font-family: "FontAwesome", Helvetica,Tahoma,Arial,"Microsoft YaHei","华文细黑",sans-serif;	
		}
		#content {
			text-align: justify;
			padding-top: 2rem;
			padding-bottom: 4rem;
		}
		#content h1, #content h2 {
			text-align: center;
		}		
		.head-indent {
			text-indent: 2em;
		}
		.note {
			border: 1px solid rgba(88, 88, 88, .3);
			border-radius: 5px;
			box-shadow: 3px 3px 8px rgba(88, 88, 88, .8);
			padding: 1rem;
			margin-bottom: 1rem;
		}		
		#progress-bar {
			height: 3px;
			background-color: orange;
		}
		#side-bar {
			color: white;
			background-color: rgba(0,0,0, .75);
			padding: 2rem 1rem 1rem 1.5rem;
			position: fixed;
			top: 0;
			left: -100%;
			z-index: 1020;
			height: 100%;
			overflow:  auto;
		}
		#side-bar ul {
			font-size: 0.9em;
			list-style-type: none;
			padding-left: 1rem;
		}		
		#side-bar > ul {
			font-size: 1rem;
			list-style-type: disc;
			padding-left: 2rem;
			display: block !important;
		}		
		#side-bar a {
			color: white;
			text-decoration: none;
		}
		#side-bar .on-scroll {
			color: orange;
		}
		.my-nav-item {
			font-size: 1.75rem;
			color: black;
			text-align: center;
			width: 2.5rem;
			height: 2.5rem;
			line-height: 2.5rem;
			border: 1px solid rgba(10,10,10, .6);
			border-radius: 2.5rem;
			cursor: pointer;
		}
		.my-nav-item a {
			color: black;
			text-decoration: none;
		}		
		#foot-nav {
			position: fixed;
			right: 2.25rem;
			bottom: 1.25rem;
			z-index: 20;
		}
		#foot-nav .my-nav-item {
			float: right;
		}
		#foot-nav .my-nav-item:not(:last-child) {
			margin-left: 0.75rem;
		}
		#open-sidebar, #close-sidebar {
			color: orange;
			border: none;
			border-radius: 0;
			position: fixed;
			bottom: 1.25rem;
			z-index: 1050;
		}		
		#open-sidebar {
			left: 1.25rem;
		}
		@media (min-width: 768px) {
			.my-nav-item {
				color: white;
				background-color: black;
				opacity: 0.5;
				transition: opacity .8s,0s linear;
			}			
			.my-nav-item:hover {
				opacity: 1;
			}
			.my-nav-item a {
				color: white;
			}		
			#side-bar {
				background-color: rgba(0,0,0, 1);
				padding-left: 2rem;
				left: 0 !important;
			}
			#side-bar a:hover {
				color: orange;
			}
		}		
	</style>
</head>
<body>
	<div id="progress-bar" class="pos-f-t"></div>
	<div class="container">
		<div class="row">
			<nav id="side-bar" class="col-xl-3 col-md-4 col-sm-8 col-xs-10 text-xs-left">
				<p class="h1">Book Of Ruby</p>
				<p>作者：Huw Collingbourne</p>
				<p>翻译：<a href="https://wang1212.github.io/">不如怀念</a></p>
				<p>目录：</p>
				<ul>
					<li><a href="#homepage">主页</a></li>
					<li><a href="#author">关于作者</a></li>
					<li><a href="#introduction">前言</a></li>
					<li><a href="#chapter1">第一章</a></li>
					<li><a href="#chapter2">第二章</a></li>
					<li><a href="#chapter3">第三章</a></li>
					<li><a href="#chapter4">第四章</a></li>
					<li><a href="#chapter5">第五章</a></li>
					<li><a href="#chapter6">第六章</a></li>
					<li><a href="#chapter7">第七章</a></li>
					<li><a href="#chapter8">第八章</a></li>
					<li><a href="#chapter9">第九章</a></li>
					<li><a href="#chapter10">第十章</a></li>
					<li><a href="#chapter11">第十一章</a></li>
					<li><a href="#chapter12">第十二章</a></li>
					<li><a href="#chapter13">第十三章</a></li>
					<li><a href="#chapter14">第十四章</a></li>
					<li><a href="#chapter15">第十五章</a></li>
					<li><a href="#chapter16">第十六章</a></li>
					<li><a href="#chapter17">第十七章</a></li>
					<li><a href="#chapter18">第十八章</a></li>
					<li><a href="#chapter19">第十九章</a></li>
					<li><a href="#chapter20">第二十章</a></li>
					<li><a href="#appendices">附录</a></li>
					<li><a href="#indexes">索引</a></li>
				</ul>
				<div id="close-sidebar" style="display:none" class="my-nav-item hidden-md-up">
					<span class="fa fa-angle-double-left"></span>
				</div>
			</nav>
			<div id="content" class="col-xl-9 offset-xl-3 col-md-8 offset-md-4"></div>	
		</div>
	</div>
	<nav id="foot-nav">
		<div id="to-top" style="display:none" class="my-nav-item">
			<span class="fa fa-arrow-up"></span>
		</div>
		<div class="my-nav-item">
			<a href="/" class="fa fa-home"></a>
		</div>
		<div id="open-sidebar" class="my-nav-item hidden-md-up">
			<span class="fa fa-angle-double-right"></span>
		</div>
	</nav>

	<script src="/source/js/jquery-3.1.0.min.js"></script>
	<script>
		$(function(){
			var url = location.hash.match(/\w+(?=-)?/) + '',
				$body = $('body'),
				$progress_bar = $('#progress-bar'),
				$side_bar = $('#side-bar'),
				sidebar_width = $side_bar.outerWidth(),
				$close_sidebar = $('#close-sidebar'),
				$open_sidebar = $('#open-sidebar'),
				$content = $('#content'),
				$to_top = $('#to-top'),
				$foot_nav = $('#foot-nav');

			function showContent(url){
				$content.html("<h1>正在奋力加载哟...</h1>");
				$progress_bar.width(0);
				$side_bar.find('a').removeClass('on-scroll').siblings('ul').slideUp(500);

				if (url) {
					$.ajax({
						url: url + '.html',
						dataType: 'html',
					})
					.done(function(html){
						var $a = $side_bar.find('a[href="#'+url+'"]');

						$a.addClass('on-scroll');
						$content.fadeOut(0).html(html).fadeIn(1000).append($('<script src="/source/js/prism.js">'));
						// Generate Catelog
						generateCatelog($a.parent('li'));
						document.title = $a.text() + ' : ' + $content.find('section > h2').first().text();
					})
					.fail(function(){
						$content.html("<h1>加载失败了，请求的页面不存在</h1>")
						document.title = "错误，页面不存在";
					});
				}else{
					location.hash = '#homepage';
					showContent(url = 'homepage');
				}
			}

			function generateCatelog($_target){
				var _id = url + '-',
					$_newCate = $_target.children('ul'),
					$_sections = $('#content section');

				$_sections.each(function() {
					var $self = $(this),
						$parent = $self.parent('section'),
						$prev = $self.prevAll('section'),
						$target,
						id = _id;

					if ($parent.length === 0) {
						id += 'paragraph' + $prev.length;

						if ($_newCate.length === 0) {
							$target = $_target.children('ul');

							if ($target.length === 0) {
								$target = $_target.append($('<ul style="display:none">')).children('ul:last-of-type');
							} else {
								$target = $target.last();
							}							
						}
					} else {
						$parent = $parent.last();
						id = $parent.attr('id') + '-' + $prev.length;

						if ($_newCate.length === 0) {
							if ($prev.length === 0) {
								$target = $_target
									.find('a[href="#' + $parent.attr('id') + '"]')
									.parent('li')
									.append($('<ul>'))
									.children('ul:last-of-type');
							} else {
								$target = $_target.find('a[href="#' + $prev.attr('id') + '"]').parent('li').parent('ul');
							}							
						}
					}

					$self.attr('id', id);

					if ($target && $target.find('a[href="#'+id+'"]').length === 0) {
						$('<li>')
							.append($('<a>')
								.attr('href', '#' + id)
								.text($self.children('h2,h3,h4,h5,h6').first().text())
							).appendTo($target);
					}
				});	

				if ($_newCate.length === 0) {
					$_target.children('ul').last().slideDown(1500);
				} else {
					$_newCate.last().slideDown(1000);
				}
			}

			// Auto loading
			$(window).on("hashchange", function(){
				var newUrl = location.hash.match(/\w+(?=-)?/) + '';

				if(url != newUrl){
					showContent(url = newUrl);
				}
			});

			$(window).on('scroll', function(){
				var $self = $(window),
					w_scrollTop = $self.scrollTop();

				// Reading progress
				$progress_bar.width((w_scrollTop + $self.height()) / $body.height() * $self.width());

				// Auto merge
				$('section').each(function() {
					var $self = $(this),
						$a = $('a[href="#' + $self.attr('id') + '"]'),
						dif = w_scrollTop - $self.offset().top;

					if (dif >= -20 && dif <= $self.outerHeight(true)) {
						$a.addClass('on-scroll').siblings('ul').slideDown(1000);
					} else {
						$a.removeClass('on-scroll').siblings('ul').slideUp(500);
					}
				});

				// Show top
				w_scrollTop > $self.height() ? $to_top.show(1000) : $to_top.hide(1000);
			});

			$to_top.on('click', function(){
				$(window).scrollTop(0);
			});

			// Open sidebar
			$open_sidebar.on('click', function(){
				$foot_nav.hide(1000);
				$side_bar.animate({ left: '0px' }, 1000);
				$close_sidebar.offset({ left: sidebar_width - 56 }).show(2000);
			});

			// Close sidebar
			$close_sidebar.on('click', function(){
				$(this).hide(500);
				$side_bar.animate({ left: -sidebar_width }, 1000);
				$foot_nav.show(500);
			});

			showContent(url);
		});
	</script>
</body>
</html>